<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <title>Kalkulator Permintaan & Bekalan Air UMS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Chart.js (graf) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- SheetJS (Export Excel) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- html2canvas untuk render HTML ke kanvas (PDF) -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <!-- jsPDF (Penjanaan PDF profesional) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root {
      --primary: #0d6efd;
      --primary-light: #e0f4ff;
      --primary-dark: #054a91;
      --accent: #00bcd4;
      --danger: #ff1744;
      --success: #00c853;
      --bg: #f5fbff;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        Roboto, sans-serif;
      color: #12324a;
      background:
        radial-gradient(circle at top, #cbe9ff 0, #f5fbff 45%, #ffffff 100%);
      position: relative;
      overflow-x: hidden;
    }

    /* background ‚Äúair‚Äù halus */
    body::before {
      content: "";
      position: fixed;
      inset: -20vh -10vw auto;
      height: 60vh;
      background:
        radial-gradient(circle at 20% 20%, rgba(255,255,255,0.7) 0, transparent 55%),
        radial-gradient(circle at 80% 10%, rgba(255,255,255,0.6) 0, transparent 55%),
        linear-gradient(135deg, rgba(13,110,253,0.25), rgba(0,188,212,0.15));
      opacity: 0.7;
      z-index: -2;
      pointer-events: none;
    }

    header {
      background: linear-gradient(135deg, var(--primary-dark), var(--accent));
      color: #fff;
      padding: 1.4rem 1rem;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.18);
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(6px);
    }

    .header-inner {
      max-width: 1100px;
      margin: 0 auto;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }

    header h1 {
      margin: 0;
      font-size: 1.45rem;
      letter-spacing: 0.02em;
    }

    header p {
      margin: 0.15rem 0 0;
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.35rem 0.8rem;
      border-radius: 999px;
      background-color: rgba(255, 255, 255, 0.15);
      font-size: 0.8rem;
      align-self: flex-start;
    }

    .badge span { font-size: 1.1rem; }

    .pill-group {
      display: inline-flex;
      gap: 0.35rem;
      flex-wrap: wrap;
    }

    .pill {
      padding: 0.35rem 0.75rem;
      border-radius: 999px;
      border: 1px solid #c5d9ec;
      background: #f7fbff;
      font-weight: 700;
      color: #1e3f63;
      cursor: pointer;
      user-select: none;
      transition: all 0.15s ease;
    }

    .pill.active {
      border-color: var(--primary);
      background: linear-gradient(135deg, var(--primary-light), #ffffff);
      box-shadow: 0 6px 16px rgba(13, 110, 253, 0.15);
    }

    .pill small { display: block; font-weight: 500; color: #4c6480; }

    .mode-note {
      font-size: 0.85rem;
      color: #4f6a86;
      margin-top: 0.4rem;
    }

    .inline-alert {
      border-radius: 0.75rem;
      padding: 0.75rem 0.9rem;
      background: #fff4f4;
      color: #b3261e;
      border: 1px solid rgba(255, 23, 68, 0.25);
      margin-top: 0.7rem;
      font-size: 0.86rem;
    }

    .inline-alert ul { margin: 0.35rem 0 0 1rem; padding: 0; }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      align-items: center;
    }

    .scenario-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
      gap: 0.7rem;
    }

    .scenario-card {
      border: 1px solid #cfe1f5;
      border-radius: 0.9rem;
      padding: 0.75rem 0.8rem;
      background: #f9fcff;
      position: relative;
    }

    .scenario-card.active {
      border-color: var(--primary);
      box-shadow: 0 6px 16px rgba(13, 110, 253, 0.12);
      background: linear-gradient(135deg, #f3f8ff, #ffffff);
    }

    .scenario-title {
      margin: 0;
      font-weight: 700;
      color: #12324a;
    }

    .scenario-meta {
      font-size: 0.82rem;
      color: #4d6a87;
      margin: 0.2rem 0 0.4rem;
    }

    .scenario-actions {
      display: flex;
      gap: 0.35rem;
      flex-wrap: wrap;
    }

    .scenario-actions button {
      border-radius: 0.55rem;
      padding: 0.32rem 0.6rem;
      font-size: 0.82rem;
    }

    .mini-input {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      border: 1px solid #cfe1f5;
      padding: 0.25rem 0.5rem;
      border-radius: 0.65rem;
      background: #f7fbff;
    }

    .stacked {
      display: grid;
      gap: 0.6rem;
    }

    .pill-badge {
      display: inline-block;
      padding: 0.18rem 0.5rem;
      border-radius: 0.6rem;
      background: #e8f2ff;
      color: #1d3a57;
      font-size: 0.78rem;
      font-weight: 700;
    }

    .compare-grid {
      overflow-x: auto;
    }

    .accordion {
      border: 1px solid #cfe1f5;
      border-radius: 0.9rem;
      overflow: hidden;
    }

    .accordion summary {
      list-style: none;
      cursor: pointer;
      padding: 0.75rem 1rem;
      background: linear-gradient(135deg, #f3f8ff, #ffffff);
      font-weight: 700;
      color: #12324a;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .accordion summary::-webkit-details-marker { display: none; }

    .accordion .content {
      padding: 0.8rem 1rem 1rem;
      background: #ffffff;
    }

    .tagline {
      font-size: 0.82rem;
      color: #5b7693;
      margin-top: 0.15rem;
    }

    main {
      max-width: 1100px;
      margin: 1.5rem auto 2.5rem;
      padding: 0 1rem;
    }

    .card {
      background: #ffffff;
      border-radius: 1rem;
      padding: 1.3rem 1.5rem;
      margin-bottom: 1.3rem;
      box-shadow: 0 8px 25px rgba(13, 110, 253, 0.08);
      border: 1px solid rgba(13, 110, 253, 0.09);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: auto -30% -40%;
      height: 120px;
      background:
        radial-gradient(circle at 10% 0%, rgba(13,110,253,0.06) 0, transparent 55%),
        radial-gradient(circle at 90% 40%, rgba(0,188,212,0.06) 0, transparent 55%);
      z-index: -1;
    }

    .card h2 {
      margin-top: 0;
      font-size: 1.15rem;
      color: var(--primary-dark);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .card h2 span.icon { font-size: 1.25rem; }

    .card p.lead {
      margin-top: 0;
      font-size: 0.9rem;
      color: #476582;
    }

    label {
      font-size: 0.85rem;
      font-weight: 600;
      color: #23405b;
      display: block;
      margin-bottom: 0.2rem;
    }

    input[type="number"],
    input[type="text"],
    select {
      width: 100%;
      padding: 0.4rem 0.55rem;
      border-radius: 0.5rem;
      border: 1px solid #c5d9ec;
      font-size: 0.9rem;
      outline: none;
      background-color: #fafdff;
    }

    input[type="number"]:focus,
    input[type="text"]:focus,
    select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.15);
      background-color: #ffffff;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
      margin-top: 0.5rem;
      background-color: #fdfefe;
    }

    th,
    td {
      padding: 0.4rem 0.5rem;
      border-bottom: 1px solid #dde7f3;
      text-align: right;
      word-break: break-word;
      overflow-wrap: anywhere;
      white-space: normal;
    }

    th:first-child,
    td:first-child { text-align: left; }

    thead {
      background: linear-gradient(
        90deg,
        rgba(13, 110, 253, 0.1),
        rgba(0, 188, 212, 0.06)
      );
    }

    tfoot td {
      font-weight: 700;
      background-color: #f3f8ff;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      margin-top: 0.6rem;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 0.45rem 0.9rem;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      transition: transform 0.05s ease, box-shadow 0.12s ease,
        background-color 0.12s ease;
    }

    button.primary {
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color: #fff;
      box-shadow: 0 4px 12px rgba(13, 110, 253, 0.35);
    }

    button.secondary {
      background-color: var(--primary-light);
      color: var(--primary-dark);
    }

    button.export {
      background: linear-gradient(135deg, #00c853, #00e676);
      color: #fff;
      box-shadow: 0 4px 12px rgba(0, 200, 83, 0.4);
    }

    button:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }

    .two-column {
      display: grid;
      grid-template-columns: minmax(0, 1.5fr) minmax(0, 1.2fr);
      gap: 1.2rem;
    }

    .status-pill {
      display: inline-flex;
      border-radius: 999px;
      padding: 0.18rem 0.6rem;
      font-size: 0.8rem;
      font-weight: 600;
      align-items: center;
      gap: 0.35rem;
    }

    .status-surplus {
      background-color: #e0ffe9;
      color: #008a2f;
      border: 1px solid #00c853;
    }

    .status-deficit {
      background-color: #ffebee;
      color: #c62828;
      border: 1px solid #ff1744;
    }

    .summary-text {
      font-size: 0.88rem;
      margin-top: 0.5rem;
      color: #36526f;
    }

    .note {
      font-size: 0.78rem;
      color: #627d96;
      margin-top: 0.2rem;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.75rem;
      padding: 0.2rem 0.5rem;
      border-radius: 999px;
      background-color: rgba(13, 110, 253, 0.05);
      color: #2d4c69;
      margin-right: 0.4rem;
      margin-top: 0.2rem;
    }

    canvas {
      background: radial-gradient(circle at top, #f2fbff, #ffffff);
      border-radius: 0.8rem;
      padding: 0.5rem;
    }

    .summary-row-surplus td:nth-child(2),
    .summary-row-surplus td:nth-child(4) {
      background-color: #e0ffe9;
      color: #006622;
      font-weight: 700;
    }

    .summary-row-deficit td:nth-child(2),
    .summary-row-deficit td:nth-child(4) {
      background-color: #ffebee;
      color: #b71c1c;
      font-weight: 700;
    }

    .disclaimer {
      font-size: 0.8rem;
      color: #455a64;
      line-height: 1.5;
    }

    footer {
      text-align: center;
      padding: 0.8rem 1rem 1.2rem;
      font-size: 0.78rem;
      color: #607d8b;
      background: #f1f7fd;
      border-top: 1px solid #d3e1f2;
    }

    .input-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 0.8rem 1rem;
      margin-top: 0.6rem;
    }

    .mini {
      font-size: 0.78rem;
      color: #607d8b;
    }

    .hidden { display: none !important; }
    .invalid {
      border-color: #d32f2f !important;
      box-shadow: 0 0 0 2px rgba(211, 47, 47, 0.2);
      background: #fff7f7;
    }

    .error-text {
      color: #b3261e;
      font-size: 0.82rem;
      margin-top: 0.15rem;
    }

    .confidential-toggle {
      display: inline-flex;
      align-items: center;
      gap: 0.45rem;
      font-size: 0.86rem;
      color: #23405b;
      margin-top: 0.4rem;
    }

    .confidential-toggle input {
      width: 1rem;
      height: 1rem;
      accent-color: var(--primary);
    }

    /* Kontena laporan HTML legacy (tidak lagi digunakan untuk penjanaan jsPDF) */
    #reportRoot.rendering {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      margin: 0 auto;
      /* Kekalkan keterlihatan jika diperlukan semasa debug paparan HTML */
      opacity: 1;
      pointer-events: none;
      overflow: visible;
      background: #ffffff;
      z-index: 999;
    }

    #reportRoot .logo-box img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      display: block;
    }

    /* Laporan Profesional (PDF) */
    @page {
      size: A4;
      margin: 18mm;
    }

    #reportRoot {
      width: 210mm;
      margin: 0 auto;
      background: #ffffff;
      color: #1b2744;
      font-family: "Arial", "Helvetica Neue", sans-serif;
      box-shadow: 0 8px 24px rgba(13, 46, 79, 0.12);
    }

    #reportRoot, #reportRoot * {
      box-sizing: border-box;
      max-width: 100%;
    }

    #reportRoot.offscreen {
      position: absolute;
      left: -9999px;
      top: 0;
      pointer-events: none;
    }

    #reportRoot h1,
    #reportRoot h2,
    #reportRoot h3,
    #reportRoot h4 {
      font-family: "Arial", "Helvetica Neue", sans-serif;
      color: #0c2d57;
      margin-top: 0;
      font-weight: 700;
    }

    #reportRoot h1 { font-size: 16pt; }
    #reportRoot h2 { font-size: 14pt; }
    #reportRoot h3 { font-size: 12.5pt; }
    #reportRoot h4 { font-size: 11.5pt; }

    #reportRoot p,
    #reportRoot li {
      font-size: 11pt;
      line-height: 1.5;
      text-align: justify;
      text-justify: inter-word;
      color: #1b2744;
    }

    #reportRoot .report-table {
      width: 100%;
      max-width: 100%;
      border-collapse: collapse;
      margin: 0.4rem 0 0.9rem;
      font-size: 9.5pt;
      table-layout: fixed;
      page-break-inside: avoid;
      break-inside: avoid;
    }

    #reportRoot .report-table th,
    #reportRoot .report-table td {
      border: 1px solid #0f3057;
      padding: 5px 6px;
      text-align: left;
      background: #fff;
      word-break: break-word;
      overflow-wrap: anywhere;
      white-space: normal;
      line-height: 1.35;
      vertical-align: top;
      page-break-inside: avoid;
      break-inside: avoid;
    }

    #reportRoot .report-table.wide-table {
      font-size: 9pt;
    }

    #reportRoot .report-table.wide-table th,
    #reportRoot .report-table.wide-table td {
      padding: 4px 5px;
    }

    #reportRoot .report-table thead th {
      background: linear-gradient(135deg, rgba(13, 110, 253, 0.18), rgba(0, 188, 212, 0.2));
    }

    #reportRoot .zebra tbody tr:nth-child(even) td {
      background: #f5f8ff;
    }

    #reportRoot .page-break { page-break-before: always; }

    #reportRoot .cover {
      min-height: 297mm;
      padding: 32mm 28mm;
      position: relative;
      display: grid;
      place-items: center;
      text-align: center;
      gap: 1.5rem;
      color: #0c2d57;
      background: #ffffff;
      border: 1px solid #e3ebf6;
    }

    #reportRoot .cover .logo-box {
      width: 170px;
      height: auto;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      background: transparent;
      box-shadow: none;
      margin: 0 auto 0.8rem;
    }

    #reportRoot .cover h1 {
      font-size: 20pt;
      line-height: 1.4;
      letter-spacing: 0.01em;
      margin: 0;
    }

    #reportRoot .cover .meta,
    #reportRoot .cover .tagline {
      font-size: 11pt;
      line-height: 1.5;
      margin: 0.25rem 0;
    }

    #reportRoot .toc {
      padding: 25mm;
      background: #ffffff;
    }

    #reportRoot .toc ol {
      counter-reset: item;
      padding-left: 1rem;
    }

    #reportRoot .toc li {
      margin: 0.25rem 0;
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      font-size: 11pt;
      break-inside: avoid;
      page-break-inside: avoid;
    }

    #reportRoot .toc li::before {
      counter-increment: item;
      content: counters(item, ".") " ";
      font-weight: bold;
      margin-right: 0.35rem;
      color: #0c2d57;
    }

    #reportRoot .toc .page-num {
      color: #0c2d57;
      font-variant-numeric: tabular-nums;
    }

    #reportRoot .section-tag {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.16rem 0.55rem;
      background: rgba(13, 110, 253, 0.12);
      color: #0d2e55;
      border-radius: 999px;
      font-size: 0.78rem;
      letter-spacing: 0.02em;
    }

    #reportRoot .figure {
      text-align: center;
      margin: 0.3rem 0 0.9rem;
    }

    #reportRoot .figure img {
      max-width: 100%;
      border: 1px solid #cdd9eb;
      border-radius: 8px;
      background: #fff;
    }

    #reportRoot .figure .caption {
      font-size: 10px;
      margin-top: 0.35rem;
      color: #425c7a;
    }

    #reportRoot .kicker {
      font-size: 0.92rem;
      letter-spacing: 0.08em;
      color: #0d2e55;
      text-transform: uppercase;
    }

    #reportRoot .meta {
      color: #244a75;
      font-size: 0.95rem;
    }

    #reportRoot .highlight-box {
      border: 1px solid rgba(13, 110, 253, 0.3);
      background: rgba(13, 110, 253, 0.04);
      padding: 0.8rem 1rem;
      border-radius: 10px;
      margin: 0.7rem 0 1rem;
    }

    #reportRoot .risk-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
      gap: 0.7rem;
    }

    #reportRoot .risk-card {
      border: 1px solid #c8d7ec;
      border-radius: 10px;
      padding: 0.7rem 0.9rem;
      background: #fbfdff;
    }

    #reportRoot .tagline {
      color: #244a75;
      font-style: italic;
      margin-top: 0.4rem;
    }

    #reportRoot .footer-note {
      text-align: center;
      font-size: 10px;
      margin-top: 0.9rem;
      color: #3e5674;
    }

    #reportRoot .page-note {
      font-size: 10px;
      color: #4c6079;
    }

    #reportRoot .watermark-underline {
      height: 5px;
      background: linear-gradient(90deg, rgba(13, 110, 253, 0.3), rgba(0, 188, 212, 0.4));
      border-radius: 12px;
      margin: 0.4rem 0 0.8rem;
    }

    #reportRoot .list-tight li { margin: 0.12rem 0; }

    #reportRoot .phase-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 0.8rem;
    }

    #reportRoot .phase-card {
      border: 1px solid #d1e2f5;
      border-radius: 10px;
      padding: 0.8rem 0.95rem;
      background: linear-gradient(135deg, #f8fbff, #fdfefe);
      page-break-inside: avoid;
      break-inside: avoid;
    }

    #reportRoot .phase-card h4 {
      margin: 0 0 0.25rem;
      font-size: 0.96rem;
    }

    #reportRoot .phase-card ul { padding-left: 1rem; margin: 0; }

    #reportRoot .inline-table {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 0.7rem;
    }

    #reportRoot .inline-table .box {
      border: 1px solid #cfdff0;
      border-radius: 10px;
      padding: 0.7rem 0.85rem;
      background: #fbfdff;
      page-break-inside: avoid;
      break-inside: avoid;
    }

    #reportRoot .inline-table .label {
      font-size: 0.82rem;
      color: #36526f;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-bottom: 0.2rem;
    }

    #reportRoot .report-page {
      min-height: 297mm;
      padding: 18mm;
      background: #ffffff;
      display: flex;
      flex-direction: column;
      gap: 0.55rem;
      position: relative;
      overflow: hidden;
      page-break-after: always;
    }

    #reportRoot .report-page .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.6rem;
      padding-bottom: 0.45rem;
      border-bottom: 1px solid #e2e8f0;
      color: #0c2d57;
      font-size: 9pt;
    }

    #reportRoot .report-page .page-footer {
      margin-top: auto;
      padding-top: 0.55rem;
      border-top: 1px solid #e2e8f0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: #3f5c78;
      font-size: 9pt;
    }

    #reportRoot .report-page .page-number {
      font-variant-numeric: tabular-nums;
    }

    #reportRoot .section-block {
      display: grid;
      gap: 0.3rem;
    }

    #reportRoot .section-title {
      font-size: 13pt;
      margin: 0;
      color: #0a355e;
    }

    #reportRoot .section-tagline {
      color: #2c5f88;
      font-size: 11pt;
      margin: 0;
    }

    #reportRoot .captioned-image,
    #reportRoot .figure {
      page-break-inside: avoid;
      break-inside: avoid;
    }

    #reportRoot .captioned-image img,
    #reportRoot .figure img {
      max-width: 100%;
      height: auto;
      object-fit: contain;
    }

    #reportRoot .toc-list {
      list-style: none;
      padding-left: 0;
      margin: 0.4rem 0 0;
      display: grid;
      gap: 0.3rem;
    }

    #reportRoot .toc-list li {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.3rem 0.4rem;
      border-bottom: 1px dashed #d6e2f2;
      color: #23405b;
      font-size: 12px;
    }

    #reportRoot .toc-list li span.label {
      font-weight: 600;
      color: #0c2d57;
    }

    #reportRoot .toc-list li span.page {
      font-variant-numeric: tabular-nums;
      color: #3f5c78;
    }

    #reportRoot .page-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 0.6rem;
    }

    #reportRoot .page-card {
      border: 1px solid #d8e5f5;
      border-radius: 10px;
      padding: 0.65rem 0.8rem;
      background: linear-gradient(135deg, #f8fbff, #fefeff);
      page-break-inside: avoid;
      break-inside: avoid;
    }

    #reportRoot .page-card h4 {
      margin: 0 0 0.25rem;
      color: #0a355e;
    }

    #reportRoot .justified {
      text-align: justify;
    }

    #reportRoot .captioned-image {
      text-align: center;
      margin: 0.4rem 0 0.9rem;
      page-break-inside: avoid;
      break-inside: avoid;
    }

    #reportRoot .captioned-image img {
      max-width: 100%;
      max-height: 240px;
      border: 1px solid #d8e5f5;
      border-radius: 8px;
      background: #fff;
      object-fit: contain;
    }

    #reportRoot .captioned-image .caption {
      margin-top: 0.3rem;
      color: #48607a;
      font-size: 10px;
    }

    @media (max-width: 768px) {
      header { padding: 1.15rem 1rem; }
      header h1 { font-size: 1.25rem; }
      .two-column { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div>
        <h1>Kalkulator Permintaan & Bekalan Air UMS</h1>
        <p>
          Anggaran demand‚Äìsupply air kampus termasuk sumber alternatif
          (tangkapan air hujan, reuse, air tasik, kondensasi penghawa dingin)
          dan analisis kos‚Äìfaedah asas.
        </p>
      </div>
      <div class="badge">
        <span>üíß</span> Alat perancangan permintaan & kos-faedah air
      </div>
    </div>
  </header>

  <main>
    <section class="card">
      <h2><span class="icon">üéõÔ∏è</span> Pemilih Mod & Senario</h2>
      <div class="toolbar">
        <div class="pill-group" role="group" aria-label="Pemilih mod" id="mode-selector">
          <div class="pill active" data-mode="quick">
            Quick Estimate
            <small>1‚Äì2 min</small>
          </div>
          <div class="pill" data-mode="operational">
            Operational Planning
            <small>10‚Äì15 min</small>
          </div>
          <div class="pill" data-mode="full">
            Full CBA (Advanced)
            <small>30‚Äì60 min</small>
          </div>
        </div>
        <button type="button" class="secondary" id="btn-autofill">
          ‚ö° Auto-fill nilai contoh
        </button>
        <button type="button" class="secondary" id="btn-fix-inputs">
          üõ†Ô∏è Baiki input
        </button>
        <div class="mini-input">
          <label for="pdf-scope">Laporan PDF:</label>
          <select id="pdf-scope">
            <option value="active">Senario aktif sahaja</option>
            <option value="all">Semua senario</option>
          </select>
        </div>
      </div>
      <p class="mode-note" id="mode-note">
        Quick Estimate: isi populasi atau permintaan harian + faktor puncak & bekalan asas. Mod ini memaparkan ringkasan pantas serta NPV/BCR/payback jika CAPEX/OPEX diisi.
      </p>
      <div class="inline-alert hidden" id="validation-box">
        <strong>Semak input diperlukan:</strong>
        <ul id="validation-list"></ul>
      </div>
    </section>

    <section class="card mode-block" data-modes="full,operational,quick">
      <h2><span class="icon">üß™</span> Analisis Sensitiviti (+/‚àí10%)</h2>
      <p class="lead">Lihat kesan perubahan kos/manfaat terhadap NPV & BCR projek alternatif.</p>
      <div class="input-grid">
        <div>
          <div class="label">Senario asas</div>
          <div id="sens-base" class="pill-badge">NPV: ‚Äì, BCR: ‚Äì</div>
        </div>
        <div>
          <div class="label">CAPEX +10%</div>
          <div id="sens-capex" class="pill-badge">NPV: ‚Äì, BCR: ‚Äì</div>
        </div>
        <div>
          <div class="label">OPEX +10%</div>
          <div id="sens-opex" class="pill-badge">NPV: ‚Äì, BCR: ‚Äì</div>
        </div>
        <div>
          <div class="label">Manfaat/penjimatan +10%</div>
          <div id="sens-benefit" class="pill-badge">NPV: ‚Äì, BCR: ‚Äì</div>
        </div>
      </div>
      <div class="tagline">Analisis sensitiviti menggunakan PV manfaat & kos terkira semasa.</div>
    </section>

    <section class="card">
      <h2><span class="icon">üßÆ</span> Perbandingan Senario A/B/C</h2>
      <p class="lead">Bandingkan metrik utama (permintaan, bekalan, defisit, NPV, BCR, IRR, Payback) untuk senario yang disimpan.</p>
      <div class="compare-grid">
        <table id="scenario-compare-table">
          <thead>
            <tr>
              <th>Metrik</th>
              <th>Senario A</th>
              <th>Senario B</th>
              <th>Senario C</th>
            </tr>
          </thead>
          <tbody>
            <tr><td>Permintaan purata (MLD)</td><td class="sc-a-avg">‚Äì</td><td class="sc-b-avg">‚Äì</td><td class="sc-c-avg">‚Äì</td></tr>
            <tr><td>Permintaan puncak (MLD)</td><td class="sc-a-peak">‚Äì</td><td class="sc-b-peak">‚Äì</td><td class="sc-c-peak">‚Äì</td></tr>
            <tr><td>Bekalan efektif (MLD)</td><td class="sc-a-supply">‚Äì</td><td class="sc-b-supply">‚Äì</td><td class="sc-c-supply">‚Äì</td></tr>
            <tr><td>Lebihan/Defisit purata</td><td class="sc-a-surplus">‚Äì</td><td class="sc-b-surplus">‚Äì</td><td class="sc-c-surplus">‚Äì</td></tr>
            <tr><td>NPV (RM)</td><td class="sc-a-npv">‚Äì</td><td class="sc-b-npv">‚Äì</td><td class="sc-c-npv">‚Äì</td></tr>
            <tr><td>BCR</td><td class="sc-a-bcr">‚Äì</td><td class="sc-b-bcr">‚Äì</td><td class="sc-c-bcr">‚Äì</td></tr>
            <tr><td>IRR (%)</td><td class="sc-a-irr">‚Äì</td><td class="sc-b-irr">‚Äì</td><td class="sc-c-irr">‚Äì</td></tr>
            <tr><td>Payback (tahun)</td><td class="sc-a-payback">‚Äì</td><td class="sc-b-payback">‚Äì</td><td class="sc-c-payback">‚Äì</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <section class="card mode-block" data-modes="quick">
      <h2><span class="icon">‚è±Ô∏è</span> Input Pantas (Quick Estimate)</h2>
      <div class="input-grid">
        <div>
          <label for="quick-pop">Jumlah populasi / headcount</label>
          <input type="number" id="quick-pop" min="0" placeholder="cth: 15000" />
          <div class="tagline">Boleh kosong jika anda masukkan permintaan harian terus.</div>
        </div>
        <div>
          <label for="quick-percap">Kadar per kapita (L/org/hari)</label>
          <input type="number" id="quick-percap" min="0" step="0.1" placeholder="cth: 150" />
        </div>
        <div>
          <label for="quick-demand">Jumlah permintaan harian (m¬≥/hari)</label>
          <input type="number" id="quick-demand" min="0" step="0.01" placeholder="cth: 2000" />
          <div class="tagline">Jika diisi, kalkulator abaikan populasi √ó per kapita.</div>
        </div>
        <div>
          <label for="quick-peak">Faktor puncak (disyorkan 1.2‚Äì1.5)</label>
          <input type="number" id="quick-peak" min="1" step="0.05" value="1.3" />
        </div>
        <div>
          <label for="quick-base-supply">Bekalan asas (MLD)</label>
          <input type="number" id="quick-base-supply" min="0" step="0.1" placeholder="cth: 5" />
          <div class="tagline">Nilai ini akan disalin ke bekalan JANS di bahagian utama.</div>
        </div>
      </div>
      <div class="accordion" style="margin-top:0.8rem;">
        <details open>
          <summary>Opsyen sumber alternatif ringkas</summary>
          <div class="content">
            <div class="input-grid">
              <div>
                <label for="quick-alt-name">Nama sumber</label>
                <input type="text" id="quick-alt-name" placeholder="cth: Tangkapan air hujan mini" />
              </div>
              <div>
                <label for="quick-alt-capacity">Kapasiti (m¬≥/hari)</label>
                <input type="number" id="quick-alt-capacity" min="0" step="0.1" />
              </div>
              <div>
                <label for="quick-alt-util">Faktor penggunaan (% hari/tahun)</label>
                <input type="number" id="quick-alt-util" min="0" max="100" step="1" />
              </div>
              <div>
                <label for="quick-alt-capex">CAPEX kasar (RM)</label>
                <input type="number" id="quick-alt-capex" min="0" step="1000" />
              </div>
              <div>
                <label for="quick-alt-opex">OPEX tahunan kasar (RM/tahun)</label>
                <input type="number" id="quick-alt-opex" min="0" step="100" />
              </div>
            </div>
          </div>
        </details>
      </div>
    </section>

    <section class="card">
      <h2><span class="icon">üóÇÔ∏è</span> Pengurus Senario (A/B/C)</h2>
      <div class="toolbar stacked">
        <div class="scenario-actions">
          <button type="button" class="secondary" id="btn-add-scenario">‚ûï Senario baharu</button>
          <button type="button" class="secondary" id="btn-duplicate-scenario">üìë Gandakan</button>
          <button type="button" class="secondary" id="btn-rename-scenario">‚úèÔ∏è Namakan semula</button>
          <button type="button" class="secondary" id="btn-delete-scenario">üóëÔ∏è Padam</button>
          <button type="button" class="primary" id="btn-save-scenario">üíæ Simpan senario</button>
        </div>
        <div class="scenario-list" id="scenario-list"></div>
      </div>
      <p class="mode-note">Setiap senario menyimpan input & output (permintaan, bekalan, NPV/BCR, payback). Data kekal dalam pelayar melalui localStorage.</p>
    </section>
    <!-- INPUT KATEGORI DEMAND -->
    <section class="card mode-block" data-modes="operational,full">
      <h2><span class="icon">üì•</span> Input Permintaan Air Mengikut Kategori</h2>
      <p class="lead">
        Tetapkan kategori (contoh: Asrama, Fakulti & Pentadbiran, Masjid, Sukan)
        bersama bilangan pengguna, kadar penggunaan per kapita, dan faktor
        permintaan puncak (peak factor).
      </p>

      <div class="note">
        Tip: 1 m¬≥/hari = 1,000 L/hari. Peak factor biasa 1.2‚Äì1.5 untuk asrama
        & kawasan tumpuan pelajar.
      </div>

      <div style="overflow-x: auto; margin-top: 0.6rem;">
        <table id="category-input-table">
          <thead>
            <tr>
              <th>Kategori</th>
              <th>Populasi (orang)</th>
              <th>Per kapita (L/org/hari)</th>
              <th>Faktor puncak</th>
            </tr>
          </thead>
          <tbody id="category-body">
            <tr class="category-row">
              <td><input type="text" class="cat-name" value="Asrama" /></td>
              <td><input type="number" class="cat-pop" value="6621" min="0" /></td>
              <td><input type="number" class="cat-percap" value="200" min="0" /></td>
              <td><input type="number" class="cat-peak" value="1.3" min="1" step="0.05" /></td>
            </tr>
            <tr class="category-row">
              <td>
                <input type="text" class="cat-name" value="Fakulti & Pentadbiran" />
              </td>
              <td><input type="number" class="cat-pop" value="8000" min="0" /></td>
              <td><input type="number" class="cat-percap" value="50" min="0" /></td>
              <td><input type="number" class="cat-peak" value="1.2" min="1" step="0.05" /></td>
            </tr>
            <tr class="category-row">
              <td><input type="text" class="cat-name" value="Masjid & Surau" /></td>
              <td><input type="number" class="cat-pop" value="3000" min="0" /></td>
              <td><input type="number" class="cat-percap" value="15" min="0" /></td>
              <td><input type="number" class="cat-peak" value="1.5" min="1" step="0.05" /></td>
            </tr>
            <tr class="category-row">
              <td><input type="text" class="cat-name" value="Sukan & Rekreasi" /></td>
              <td><input type="number" class="cat-pop" value="1500" min="0" /></td>
              <td><input type="number" class="cat-percap" value="60" min="0" /></td>
              <td><input type="number" class="cat-peak" value="1.4" min="1" step="0.05" /></td>
            </tr>
            <tr class="category-row">
              <td>
                <input type="text" class="cat-name"
                       placeholder="Kategori tambahan (jika ada)" />
              </td>
              <td><input type="number" class="cat-pop" min="0" /></td>
              <td><input type="number" class="cat-percap" min="0" /></td>
              <td><input type="number" class="cat-peak" value="1.3" min="1" step="0.05" /></td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="btn-row">
        <button id="add-row-btn" type="button" class="secondary">
          ‚ûï Tambah baris kategori
        </button>
        <button id="calculate-btn" type="button" class="primary">
          üîç Kira permintaan & banding dengan bekalan
        </button>
      </div>
    </section>

    <!-- INPUT SUPPLY (JANS) -->
    <section class="card">
      <h2><span class="icon">üö∞</span> Input Bekalan Air (Supply Sedia Ada)</h2>
      <p class="lead">
        Masukkan anggaran kapasiti bekalan air harian yang diterima kampus
        (daripada JANS dan sumber utama lain). Nilai dalam juta liter sehari (MLD).
      </p>

      <label for="supply-mld">Kapasiti bekalan harian sedia ada (MLD)</label>
      <input type="number" id="supply-mld" value="5" min="0" step="0.1" />
      <div class="note">
        Contoh: jika UMS menerima sekitar 4.5‚Äì5.0 MLD daripada loji rawatan.
      </div>
    </section>

    <!-- PARAMETER TARIF & KEWANGAN -->
    <section class="card">
      <h2><span class="icon">üíπ</span> Parameter Tarif & Kewangan</h2>
      <p class="lead">
        Parameter ini digunakan untuk mengira penjimatan bil air & pembetungan
        serta NPV, BCR dan anggaran payback bagi setiap sumber air alternatif.
      </p>

      <div class="input-grid">
        <div>
          <label for="tariff-water">Tarif air terawat (RM/m¬≥)</label>
          <input type="number" id="tariff-water" value="1.20" min="0" step="0.01" />
        </div>
        <div>
          <label for="tariff-sewer">Kadar pembetungan (RM/m¬≥)</label>
          <input type="number" id="tariff-sewer" value="0.80" min="0" step="0.01" />
        </div>
        <div>
          <label for="analysis-years">Tempoh analisis kewangan (tahun)</label>
          <input type="number" id="analysis-years" value="20" min="1" step="1" />
        </div>
        <div>
          <label for="discount-rate">Kadar diskaun (% setahun)</label>
          <input type="number" id="discount-rate" value="5" min="0" step="0.1" />
        </div>
      </div>

      <div class="note">
        Kebiasaannya kadar diskaun 3‚Äì7% digunakan untuk projek infrastruktur
        awam, bergantung kepada garis panduan agensi.
      </div>
    </section>

    <!-- INPUT SUMBER AIR ALTERNATIF -->
    <section class="card mode-block" data-modes="operational,full">
      <h2><span class="icon">üíß</span> Sumber Air Alternatif (Extra Supply & CBA)</h2>
      <p class="lead">
        Masukkan kapasiti teknikal, faktor penggunaan, CAPEX, OPEX dan nota
        perincian kos bagi setiap sumber air alternatif. Sumber ini akan menambah
        bekalan efektif dan digunakan dalam analisis kos‚Äìfaedah.
      </p>

      <div style="overflow-x: auto; margin-top: 0.6rem;">
        <table id="alt-input-table">
          <thead>
            <tr>
              <th>Sumber</th>
              <th>Kapasiti (m¬≥/hari)</th>
              <th>Faktor penggunaan (% hari/tahun)</th>
              <th>Kebolehpercayaan operasi (%)</th>
              <th>CAPEX (RM)</th>
              <th>Butiran CAPEX (ringkas)</th>
              <th>OPEX tetap (RM/tahun)</th>
              <th>OPEX berubah (RM/m¬≥)</th>
              <th>Butiran OPEX (ringkas)</th>
              <th>Jangka hayat (tahun)</th>
            </tr>
          </thead>
          <tbody id="alt-body">
            <tr class="alt-row">
              <td><input type="text" class="alt-name" value="Tangkapan air hujan" /></td>
              <td><input type="number" class="alt-capacity" value="300" min="0" /></td>
              <td><input type="number" class="alt-util" value="80" min="0" max="100" /></td>
              <td><input type="number" class="alt-reliability" value="90" min="0" max="100" /></td>
              <td><input type="number" class="alt-capex" value="1200000" min="0" /></td>
              <td><input type="text" class="alt-capex-note"
                     value="Struktur tangki, gutter, paip agihan, pam dan panel kawalan" /></td>
              <td><input type="number" class="alt-opex-fixed" value="60000" min="0" /></td>
              <td><input type="number" class="alt-opex-var" value="0.10" min="0" step="0.01" /></td>
              <td><input type="text" class="alt-opex-note"
                     value="Elektrik pam, penyelenggaraan berkala dan pembersihan tangki" /></td>
              <td><input type="number" class="alt-life" value="25" min="1" /></td>
            </tr>
            <tr class="alt-row">
              <td><input type="text" class="alt-name" value="Air tasik / tasik kampus" /></td>
              <td><input type="number" class="alt-capacity" value="200" min="0" /></td>
              <td><input type="number" class="alt-util" value="70" min="0" max="100" /></td>
              <td><input type="number" class="alt-reliability" value="90" min="0" max="100" /></td>
              <td><input type="number" class="alt-capex" value="900000" min="0" /></td>
              <td><input type="text" class="alt-capex-note"
                     value="Pam pengabstrakan, paip penghantaran, sistem penapisan" /></td>
              <td><input type="number" class="alt-opex-fixed" value="45000" min="0" /></td>
              <td><input type="number" class="alt-opex-var" value="0.15" min="0" step="0.01" /></td>
              <td><input type="text" class="alt-opex-note"
                     value="Elektrik pam, bahan kimia dan penyelenggaraan penapis" /></td>
              <td><input type="number" class="alt-life" value="20" min="1" /></td>
            </tr>
            <tr class="alt-row">
              <td><input type="text" class="alt-name" value="Reuse (greywater / RO)" /></td>
              <td><input type="number" class="alt-capacity" value="250" min="0" /></td>
              <td><input type="number" class="alt-util" value="80" min="0" max="100" /></td>
              <td><input type="number" class="alt-reliability" value="85" min="0" max="100" /></td>
              <td><input type="number" class="alt-capex" value="1500000" min="0" /></td>
              <td><input type="text" class="alt-capex-note"
                     value="Unit rawatan, tangki imbangan, sistem paip dwi-saluran" /></td>
              <td><input type="number" class="alt-opex-fixed" value="90000" min="0" /></td>
              <td><input type="number" class="alt-opex-var" value="0.25" min="0" step="0.01" /></td>
              <td><input type="text" class="alt-opex-note"
                     value="Bahan kimia, tenaga elektrik dan operator" /></td>
              <td><input type="number" class="alt-life" value="20" min="1" /></td>
            </tr>
            <tr class="alt-row">
              <td><input type="text" class="alt-name" value="Kondensasi penghawa dingin" /></td>
              <td><input type="number" class="alt-capacity" value="50" min="0" /></td>
              <td><input type="number" class="alt-util" value="90" min="0" max="100" /></td>
              <td><input type="number" class="alt-reliability" value="95" min="0" max="100" /></td>
              <td><input type="number" class="alt-capex" value="200000" min="0" /></td>
              <td><input type="text" class="alt-capex-note"
                     value="Pengumpulan kondensat, tangki kecil dan pam pemindahan" /></td>
              <td><input type="number" class="alt-opex-fixed" value="15000" min="0" /></td>
              <td><input type="number" class="alt-opex-var" value="0.05" min="0" step="0.01" /></td>
              <td><input type="text" class="alt-opex-note"
                     value="Elektrik tambahan dan penyelenggaraan" /></td>
              <td><input type="number" class="alt-life" value="15" min="1" /></td>
            </tr>
            <tr class="alt-row">
              <td><input type="text" class="alt-name" placeholder="Sumber tambahan" /></td>
              <td><input type="number" class="alt-capacity" min="0" /></td>
              <td><input type="number" class="alt-util" min="0" max="100" /></td>
              <td><input type="number" class="alt-reliability" min="0" max="100" value="90" /></td>
              <td><input type="number" class="alt-capex" min="0" /></td>
              <td><input type="text" class="alt-capex-note"
                     placeholder="Butiran CAPEX (jika ada)" /></td>
              <td><input type="number" class="alt-opex-fixed" min="0" /></td>
              <td><input type="number" class="alt-opex-var" min="0" step="0.01" /></td>
              <td><input type="text" class="alt-opex-note"
                     placeholder="Butiran OPEX (jika ada)" /></td>
              <td><input type="number" class="alt-life" min="1" /></td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="btn-row">
        <button id="add-alt-row-btn" type="button" class="secondary">
          ‚ûï Tambah baris sumber alternatif
        </button>
      </div>
      <p class="mini">
        Nota: Butiran CAPEX dan OPEX membantu penjajaran dengan garis panduan EPU/MOF
        (contoh pecahan kepada infrastruktur, peralatan, tenaga kerja, O&M).
      </p>
    </section>

    <!-- PENGIRAAN TERPERINCI CAPEX & OPEX MENGIKUT ITEM -->
    <section class="card mode-block" data-modes="full">
      <h2><span class="icon">üßæ</span> Pengiraan Terperinci CAPEX & OPEX Mengikut Item</h2>
      <p class="lead">
        Jadual mini ini membolehkan pecahan CAPEX dan OPEX mengikut item
        (contoh: tangki, pam, paip, operator, elektrik). Jumlah CAPEX dan OPEX
        boleh dirujuk semula apabila mengisi jadual sumber air alternatif.
      </p>

      <div style="overflow-x:auto;">
        <table id="capex-opex-items-table">
          <thead>
            <tr>
              <th>Jenis</th>
              <th>Item / Komponen</th>
              <th>Kuantiti</th>
              <th>Kos seunit (RM)</th>
              <th>Jumlah kos (RM)</th>
              <th>Catatan</th>
            </tr>
          </thead>
          <tbody id="capex-opex-body">
            <tr class="capex-opex-row">
              <td>
                <select class="item-type">
                  <option value="CAPEX">CAPEX</option>
                  <option value="OPEX">OPEX</option>
                </select>
              </td>
              <td><input type="text" class="item-name" value="Tangki simpanan air hujan" /></td>
              <td><input type="number" class="item-qty" value="2" min="0" step="0.01" /></td>
              <td><input type="number" class="item-cost" value="150000" min="0" step="0.01" /></td>
              <td class="item-total">0.00</td>
              <td><input type="text" class="item-note" value="Termasuk asas konkrit dan pemasangan" /></td>
            </tr>
            <tr class="capex-opex-row">
              <td>
                <select class="item-type">
                  <option value="CAPEX">CAPEX</option>
                  <option value="OPEX">OPEX</option>
                </select>
              </td>
              <td><input type="text" class="item-name" value="Pam dan paip agihan utama" /></td>
              <td><input type="number" class="item-qty" value="1" min="0" step="0.01" /></td>
              <td><input type="number" class="item-cost" value="250000" min="0" step="0.01" /></td>
              <td class="item-total">0.00</td>
              <td><input type="text" class="item-note" value="Termasuk panel kawalan" /></td>
            </tr>
            <tr class="capex-opex-row">
              <td>
                <select class="item-type">
                  <option value="OPEX" selected>OPEX</option>
                  <option value="CAPEX">CAPEX</option>
                </select>
              </td>
              <td><input type="text" class="item-name" value="Elektrik pam air hujan" /></td>
              <td><input type="number" class="item-qty" value="12" min="0" step="1" /></td>
              <td><input type="number" class="item-cost" value="4000" min="0" step="0.01" /></td>
              <td class="item-total">0.00</td>
              <td><input type="text" class="item-note" value="Anggaran bil elektrik setahun" /></td>
            </tr>
          </tbody>
          <tfoot>
            <tr>
              <td colspan="4"><strong>Jumlah CAPEX (daripada jadual item)</strong></td>
              <td id="capex-items-total">0.00</td>
              <td></td>
            </tr>
            <tr>
              <td colspan="4"><strong>Jumlah OPEX (daripada jadual item)</strong></td>
              <td id="opex-items-total">0.00</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="btn-row">
        <button id="add-capex-opex-item-btn" type="button" class="secondary">
          ‚ûï Tambah baris item
        </button>
      </div>
      <p class="mini">
        Nota: Jumlah CAPEX dan OPEX di sini boleh dijadikan rujukan dan dipadankan
        secara manual dengan CAPEX/OPEX mengikut sumber air alternatif di atas.
      </p>
    </section>

    <!-- ANALISIS KATEGORI DEMAND -->
    <section class="card">
      <h2><span class="icon">üìä</span> Analisis Permintaan Air Mengikut Kategori</h2>
      <p class="lead">
        Jadual ini menunjukkan permintaan purata dan puncak (peak) bagi setiap
        kategori berdasarkan input yang dimasukkan.
      </p>

      <div style="overflow-x: auto;">
        <table id="results-table">
          <thead>
            <tr>
              <th>Kategori</th>
              <th>Populasi</th>
              <th>Per kapita (L/org/hari)</th>
              <th>Purata (m¬≥/hari)</th>
              <th>Faktor puncak</th>
              <th>Permintaan puncak (m¬≥/hari)</th>
            </tr>
          </thead>
          <tbody id="results-body">
            <!-- JS akan isi -->
          </tbody>
          <tfoot>
            <tr>
              <td>Jumlah</td>
              <td id="total-pop">‚Äì</td>
              <td>‚Äì</td>
              <td id="total-avg-m3">‚Äì</td>
              <td>‚Äì</td>
              <td id="total-peak-m3">‚Äì</td>
            </tr>
            <tr>
              <td>Jumlah dalam MLD</td>
              <td colspan="2"></td>
              <td id="total-avg-mld">‚Äì</td>
              <td></td>
              <td id="total-peak-mld">‚Äì</td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="chip">üîπ Purata = Populasi √ó Per kapita / 1,000</div>
      <div class="chip">üîπ Puncak = Purata √ó Faktor puncak</div>
    </section>

    <!-- DEMAND VS SUPPLY + EXPORT -->
    <section class="card">
      <h2><span class="icon">‚öñÔ∏è</span> Ringkasan Demand‚ÄìSupply (MLD)</h2>
      <div class="two-column">
        <div>
          <table id="summary-table">
            <thead>
              <tr>
                <th>Item</th>
                <th>Nilai (MLD)</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <tr id="row-avg">
                <td>Jumlah permintaan purata</td>
                <td id="summary-avg-mld">‚Äì</td>
                <td id="status-avg">‚Äì</td>
              </tr>
              <tr id="row-peak">
                <td>Jumlah permintaan puncak</td>
                <td id="summary-peak-mld">‚Äì</td>
                <td id="status-peak">‚Äì</td>
              </tr>
              <tr>
                <td>Bekalan sedia ada (JANS)</td>
                <td id="supply-avg-mld">‚Äì</td>
                <td></td>
              </tr>
              <tr>
                <td>Extra supply (air hujan / reuse / tasik / AC)</td>
                <td id="alt-supply-mld">‚Äì</td>
                <td></td>
              </tr>
              <tr>
                <td><strong>Bekalan efektif (JANS + sumber alternatif)</strong></td>
                <td id="effective-supply-mld">‚Äì</td>
                <td></td>
              </tr>
              <tr>
                <td>Lebihan / Defisit purata</td>
                <td id="surplus-avg-mld">‚Äì</td>
                <td></td>
              </tr>
              <tr>
                <td>Lebihan / Defisit semasa puncak</td>
                <td id="surplus-peak-mld">‚Äì</td>
                <td></td>
              </tr>
            </tbody>
          </table>

          <div class="btn-row" style="margin-top: 0.8rem;">
            <button id="export-excel-btn" type="button" class="export">
              üì§ Eksport Excel (.xlsx)
            </button>
            <button id="btn-generate-report" type="button" class="primary">
              Jana Laporan
            </button>
          </div>
          <label class="confidential-toggle">
            <input type="checkbox" id="confidential-toggle" />
            <span>Sertakan footer ‚ÄúSulit/Untuk Kegunaan Dalaman (Jika perlu)‚Äù dalam PDF</span>
          </label>

          <div class="summary-text" id="summary-text">
            Tekan butang <strong>‚ÄúKira permintaan & banding dengan bekalan‚Äù</strong>
            untuk melihat ringkasan analisis termasuk kesan sumber alternatif.
          </div>
        </div>

        <div>
          <canvas id="demand-by-category-chart" height="200"></canvas>
        </div>
      </div>
    </section>

    <!-- PIE CHART DEMAND SHARE -->
    <section class="card">
      <h2><span class="icon">üìà</span> Agihan Permintaan Mengikut Kategori</h2>
      <p class="lead">
        Rajah menunjukkan sumbangan (%) setiap kategori kepada permintaan purata
        keseluruhan kampus.
      </p>
      <canvas id="demand-share-chart" height="200"></canvas>
    </section>

    <!-- ANALISIS CBA SUMBER ALTERNATIF -->
    <section class="card">
      <h2><span class="icon">üíº</span> Analisis Kewangan Sumber Air Alternatif</h2>
      <p class="lead">
        Jadual di bawah merumuskan volum, penjimatan, CAPEX, OPEX, aliran tunai
        bersih, payback period, NPV dan BCR bagi setiap sumber air alternatif.
      </p>

      <div style="overflow-x: auto;">
        <table id="alt-results-table">
          <thead>
            <tr>
              <th>Sumber</th>
              <th>Kapasiti (m¬≥/hari)</th>
              <th>Utilisasi (% hari)</th>
              <th>Kebolehpercayaan (%)</th>
              <th>Vol. tahunan (m¬≥/tahun)</th>
              <th>CAPEX (RM)</th>
              <th>OPEX tahunan (RM/tahun)</th>
              <th>Saving air + pembetungan (RM/tahun)</th>
              <th>CF bersih (RM/tahun)</th>
              <th>Tempoh pulangan modal (tahun)</th>
              <th>NPV (RM)</th>
              <th>BCR</th>
            </tr>
          </thead>
          <tbody id="alt-results-body">
            <!-- JS akan isi -->
          </tbody>
          <tfoot>
            <tr>
              <td>Jumlah / Agregat</td>
              <td id="alt-total-capacity">‚Äì</td>
              <td>‚Äì</td>
              <td>‚Äì</td>
              <td id="alt-total-volume">‚Äì</td>
              <td id="alt-total-capex">‚Äì</td>
              <td id="alt-total-opex">‚Äì</td>
              <td id="alt-total-saving">‚Äì</td>
              <td id="alt-total-netcf">‚Äì</td>
              <td>‚Äì</td>
              <td id="alt-total-npv">‚Äì</td>
              <td id="alt-total-bcr">‚Äì</td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="two-column" style="margin-top: 1rem;">
        <div>
          <h3 style="font-size:0.96rem; margin-top:0;">Ringkasan Kewangan Projek</h3>
          <table id="alt-summary-table">
            <tbody>
              <tr>
                <td>Jumlah CAPEX semua sumber</td>
                <td id="sum-capex">‚Äì</td>
              </tr>
              <tr>
                <td>Jumlah penjimatan air + pembetungan / tahun</td>
                <td id="sum-saving">‚Äì</td>
              </tr>
              <tr>
                <td>Jumlah OPEX / tahun</td>
                <td id="sum-opex">‚Äì</td>
              </tr>
              <tr>
                <td>Aliran tunai bersih tahunan</td>
                <td id="sum-netcf">‚Äì</td>
              </tr>
              <tr>
                <td>NPV projek (semua sumber)</td>
                <td id="sum-npv">‚Äì</td>
              </tr>
              <tr>
                <td>BCR projek (semua sumber)</td>
                <td id="sum-bcr">‚Äì</td>
              </tr>
              <tr>
                <td>Anggaran IRR projek (mengikut aliran tunai bersih)</td>
                <td id="sum-irr">‚Äì</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div>
          <canvas id="cba-npv-chart" height="200" style="margin-bottom:0.8rem;"></canvas>
          <canvas id="cba-payback-chart" height="200"></canvas>
        </div>
      </div>
    </section>

    <!-- METODOLOGI + DISCLAIMER -->
    <section class="card">
      <h2><span class="icon">üßÆ</span> Nota Metodologi (Ringkas) & Penafian</h2>
      <div class="disclaimer">
        <p><strong>Metodologi ringkas:</strong></p>
        <ul style="margin-top: 0.2rem; padding-left: 1.1rem;">
          <li>
            <strong>Langkah 1 ‚Äì Per kapita:</strong> Untuk setiap kategori demand,
            permintaan purata dikira berdasarkan bilangan pengguna dikali kadar
            penggunaan per kapita (L/org/hari), ditukar kepada m¬≥/hari.
          </li>
          <li>
            <strong>Langkah 2 ‚Äì Permintaan puncak:</strong> Nilai purata
            digandakan dengan faktor puncak (contoh 1.3) bagi menggambarkan hari
            atau masa penggunaan tertinggi.
          </li>
          <li>
            <strong>Langkah 3 ‚Äì Extra supply:</strong> Kapasiti sumber air
            alternatif ditukar kepada bekalan efektif (m¬≥/hari) menggunakan
            faktor penggunaan (% hari/tahun) dan ditambah kepada bekalan JANS.
          </li>
          <li>
            <strong>Langkah 4 ‚Äì Penjimatan & CBA:</strong> Volum air alternatif
            dikalikan dengan tarif air + pembetungan untuk mendapatkan penjimatan
            tahunan, ditolak OPEX untuk mendapatkan aliran tunai bersih.
            NPV dan BCR dikira menggunakan tempoh analisis dan kadar diskaun
            yang ditetapkan.
          </li>
        </ul>

        <p style="margin-top: 0.7rem;"><strong>Penafian:</strong></p>
        <p>
          Kalkulator ini disediakan untuk tujuan perancangan dan analisis awal
          (planning-level estimate) berdasarkan andaian input pengguna. Nilai
          yang dijana bukanlah rekod rasmi penggunaan atau bekalan air
          Universiti Malaysia Sabah dan tidak menggantikan data meter/bil air
          yang disahkan oleh pihak berkuasa berkaitan. Sebarang keputusan
          kejuruteraan atau pelaburan sebenar hendaklah dirujuk dan disahkan
          dengan data teknikal terperinci serta pihak berkepentingan rasmi.
        </p>
      </div>
    </section>
  </main>

  <div id="reportRoot" class="report hidden offscreen" aria-hidden="true"></div>

  <footer>
    ¬© 2025 Assis, Fera, Sarimah & Sani @ RuWaS UMS. Hak cipta terpelihara.
  </footer>

  <script>
    window.addEventListener("DOMContentLoaded", () => {
      const addRowBtn = document.getElementById("add-row-btn");
      const calcBtn = document.getElementById("calculate-btn");
      const exportBtn = document.getElementById("export-excel-btn");
      const generateReportBtn = document.getElementById("btn-generate-report");
      const confidentialToggle = document.getElementById("confidential-toggle");
      const modeSelector = document.getElementById("mode-selector");
      const modeNote = document.getElementById("mode-note");
      const validationBox = document.getElementById("validation-box");
      const validationList = document.getElementById("validation-list");
      const fixInputBtn = document.getElementById("btn-fix-inputs");
      const autofillBtn = document.getElementById("btn-autofill");
      const pdfScopeSelect = document.getElementById("pdf-scope");
      const reportRoot = document.getElementById("reportRoot");
      const categoryBody = document.getElementById("category-body");

      const addAltRowBtn = document.getElementById("add-alt-row-btn");
      const altBody = document.getElementById("alt-body");
      const quickAltInputs = {
        name: document.getElementById("quick-alt-name"),
        capacity: document.getElementById("quick-alt-capacity"),
        util: document.getElementById("quick-alt-util"),
        capex: document.getElementById("quick-alt-capex"),
        opex: document.getElementById("quick-alt-opex"),
      };
      const quickInputs = {
        pop: document.getElementById("quick-pop"),
        percap: document.getElementById("quick-percap"),
        demand: document.getElementById("quick-demand"),
        peak: document.getElementById("quick-peak"),
        baseSupply: document.getElementById("quick-base-supply"),
      };

      const resultsBody = document.getElementById("results-body");
      const totalPopEl = document.getElementById("total-pop");
      const totalAvgM3El = document.getElementById("total-avg-m3");
      const totalPeakM3El = document.getElementById("total-peak-m3");
      const totalAvgMLDEl = document.getElementById("total-avg-mld");
      const totalPeakMLDEl = document.getElementById("total-peak-mld");

      const supplyInput = document.getElementById("supply-mld");
      const summaryAvgMLDEl = document.getElementById("summary-avg-mld");
      const summaryPeakMLDEl = document.getElementById("summary-peak-mld");
      const supplyAvgMLDEl = document.getElementById("supply-avg-mld");
      const altSupplyMLDEl = document.getElementById("alt-supply-mld");
      const effectiveSupplyMLDEl = document.getElementById("effective-supply-mld");
      const surplusAvgMLDEl = document.getElementById("surplus-avg-mld");
      const surplusPeakMLDEl = document.getElementById("surplus-peak-mld");
      const statusAvgEl = document.getElementById("status-avg");
      const statusPeakEl = document.getElementById("status-peak");
      const summaryTextEl = document.getElementById("summary-text");

      const rowAvg = document.getElementById("row-avg");
      const rowPeak = document.getElementById("row-peak");

      // CBA elements
      const altResultsBody = document.getElementById("alt-results-body");
      const altTotalCapacityEl = document.getElementById("alt-total-capacity");
      const altTotalVolumeEl = document.getElementById("alt-total-volume");
      const altTotalCapexEl = document.getElementById("alt-total-capex");
      const altTotalOpexEl = document.getElementById("alt-total-opex");
      const altTotalSavingEl = document.getElementById("alt-total-saving");
      const altTotalNetCFEl = document.getElementById("alt-total-netcf");
      const altTotalNPVEl = document.getElementById("alt-total-npv");
      const altTotalBCREl = document.getElementById("alt-total-bcr");

      const sumCapexEl = document.getElementById("sum-capex");
      const sumSavingEl = document.getElementById("sum-saving");
      const sumOpexEl = document.getElementById("sum-opex");
      const sumNetCFEl = document.getElementById("sum-netcf");
      const sumNPVEl = document.getElementById("sum-npv");
      const sumBCREl = document.getElementById("sum-bcr");
      const sumIRREl = document.getElementById("sum-irr");

      const tariffWaterInput = document.getElementById("tariff-water");
      const tariffSewerInput = document.getElementById("tariff-sewer");
      const analysisYearsInput = document.getElementById("analysis-years");
      const discountRateInput = document.getElementById("discount-rate");

      // CAPEX/OPEX itemised
      const capexOpexBody = document.getElementById("capex-opex-body");
      const capexItemsTotalEl = document.getElementById("capex-items-total");
      const opexItemsTotalEl = document.getElementById("opex-items-total");
      const addItemBtn = document.getElementById("add-capex-opex-item-btn");
      const scenarioListEl = document.getElementById("scenario-list");
      const addScenarioBtn = document.getElementById("btn-add-scenario");
      const duplicateScenarioBtn = document.getElementById("btn-duplicate-scenario");
      const renameScenarioBtn = document.getElementById("btn-rename-scenario");
      const deleteScenarioBtn = document.getElementById("btn-delete-scenario");
      const saveScenarioBtn = document.getElementById("btn-save-scenario");

      const categoryChartCtx = document
        .getElementById("demand-by-category-chart")
        .getContext("2d");
      const shareChartCtx = document
        .getElementById("demand-share-chart")
        .getContext("2d");
      const cbaNPVCtx = document
        .getElementById("cba-npv-chart")
        .getContext("2d");
      const cbaPaybackCtx = document
        .getElementById("cba-payback-chart")
        .getContext("2d");
      const scenarioCompareTable = document.getElementById("scenario-compare-table");
      const sensitivityLabels = {
        base: document.getElementById("sens-base"),
        capex: document.getElementById("sens-capex"),
        opex: document.getElementById("sens-opex"),
        benefit: document.getElementById("sens-benefit"),
      };

      if (window.Chart && Chart.defaults) {
        Chart.defaults.animation = false;
        Chart.defaults.transitions = Chart.defaults.transitions || {};
        Chart.defaults.transitions.active = Chart.defaults.transitions.active || {};
        Chart.defaults.transitions.active.animation = { duration: 0 };
      }

      const umsLogoPath = "UMS logo.png";
      let umsLogoDataUrl = "";

      let categoryChart = null;
      let shareChart = null;
      let cbaNpvChart = null;
      let cbaPaybackChart = null;

      let lastAltSources = [];
      let lastAltSummary = {
        totalPVBenefits: 0,
        totalPVCosts: 0,
        pvCapex: 0,
        pvOpex: 0,
        payback: NaN,
      };

      const STORAGE_KEY = "ums-water-calculator-v2";
      const LEGACY_KEY = "ums-water-calculator";
      const SCHEMA_VERSION = 2;
      let appState = {
        version: SCHEMA_VERSION,
        mode: "quick",
        activeScenarioId: "A",
        scenarios: {},
      };

      function formatNumber(num) {
        if (!isFinite(num)) return "‚Äì";
        return num.toLocaleString("ms-MY", { maximumFractionDigits: 2 });
      }

      function parseNumberFromText(value) {
        const cleaned = String(value ?? "")
          .replace(/\s/g, "")
          .replace(/[^\d.-]/g, "");
        const num = parseFloat(cleaned);
        return isFinite(num) ? num : 0;
      }

      function getCanvasDataURL(canvasId) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return "";
        try {
          return canvas.toDataURL("image/png", 1);
        } catch (err) {
          console.warn("Gagal eksport canvas", canvasId, err);
          return "";
        }
      }

      function chartToImage(chart, fallbackId) {
        if (chart && typeof chart.toBase64Image === "function") {
          try {
            return chart.toBase64Image("image/png", 1);
          } catch (err) {
            console.warn("Gagal eksport chart melalui toBase64Image", err);
          }
        }
        return getCanvasDataURL(fallbackId);
      }

      function buildBarChartImage({ title, labels, datasets }) {
        if (typeof Chart === "undefined" || !labels.length || !datasets.length) {
          return "";
        }
        const canvas = document.createElement("canvas");
        canvas.width = 1100;
        canvas.height = 620;
        const ctx = canvas.getContext("2d");
        const chart = new Chart(ctx, {
          type: "bar",
          data: { labels, datasets },
          options: {
            responsive: false,
            animation: false,
            plugins: {
              legend: { position: "top" },
              title: { display: true, text: title },
            },
            scales: {
              y: { beginAtZero: true, title: { display: true, text: "Nilai" } },
            },
          },
        });
        const url = canvas.toDataURL("image/png", 1);
        chart.destroy();
        return url;
      }

      function buildSupplyDemandChartImage(summary) {
        const labels = ["Purata (MLD)", "Puncak (MLD)"];
        const demand = [summary.avgMLD, summary.peakMLD];
        const supply = [summary.effectiveMLD, summary.effectiveMLD];
        return buildBarChartImage({
          title: "Permintaan vs Bekalan Efektif",
          labels,
          datasets: [
            {
              label: "Permintaan",
              data: demand,
              backgroundColor: "rgba(255, 87, 34, 0.85)",
            },
            {
              label: "Bekalan Efektif",
              data: supply,
              backgroundColor: "rgba(13, 110, 253, 0.82)",
            },
          ],
        });
      }

      function buildAltCompositionChartImage(altSources) {
        if (!altSources || !altSources.length) return "";
        const labels = altSources.map((s) => s.name || "Sumber");
        const data = altSources.map((s) =>
          (parseFloat(s.capacity) || 0) *
          ((parseFloat(s.utilPercent) || 0) / 100) *
          ((parseFloat(s.reliabilityPercent) || 100) / 100)
        );
        return buildBarChartImage({
          title: "Komposisi Sumber Air Alternatif (m¬≥/hari berkesan)",
          labels,
          datasets: [
            {
              label: "Bekalan berkesan",
              data,
              backgroundColor: "rgba(0, 188, 212, 0.8)",
            },
          ],
        });
      }

      function formatStatusLabel(status, isPeak) {
        if (!status) return "‚Äì";
        if (status === "Surplus") {
          return isPeak ? "Lebihan (Puncak)" : "Lebihan (Purata)";
        }
        if (status === "Deficit" || status === "Defisit") {
          return isPeak ? "Defisit (Puncak)" : "Defisit (Purata)";
        }
        return status;
      }

      function normalizeNumber(val, fallback = 0) {
        const num = parseFloat(val);
        return isFinite(num) ? num : fallback;
      }

      function createEmptyScenario(id = "A", name = `Senario ${id}`) {
        return {
          id,
          name,
          mode: "quick",
          inputs: {},
          outputs: {},
          updatedAt: Date.now(),
        };
      }

      function migrateLegacy(payload) {
        if (!payload || typeof payload !== "object") return null;
        // Legacy payload assumed flat; keep minimal fields.
        const scenario = createEmptyScenario("A", "Senario A (Legacy)");
        scenario.mode = payload.mode || "operational";
        scenario.inputs = {
          supply: payload.supply || "",
          tariffWater: payload.tariffWater || "",
          tariffSewer: payload.tariffSewer || "",
          analysisYears: payload.analysisYears || "",
          discount: payload.discount || "",
          categories: payload.categories || [],
          altRows: payload.altRows || [],
          capexRows: payload.capexRows || [],
          quick: payload.quick || {},
        };
        return {
          version: SCHEMA_VERSION,
          mode: scenario.mode,
          activeScenarioId: "A",
          scenarios: { A: scenario },
        };
      }

      function loadState() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (raw) {
            const parsed = JSON.parse(raw);
            if (parsed.version === SCHEMA_VERSION) {
              appState = parsed;
              return;
            }
          }
          const legacyRaw = localStorage.getItem(LEGACY_KEY);
          if (legacyRaw) {
            const migrated = migrateLegacy(JSON.parse(legacyRaw));
            if (migrated) {
              appState = migrated;
              persistState();
              return;
            }
          }
        } catch (err) {
          console.warn("Gagal memuat state:", err);
        }
        appState = {
          version: SCHEMA_VERSION,
          mode: "quick",
          activeScenarioId: "A",
          scenarios: { A: createEmptyScenario("A", "Senario A") },
        };
      }

      function persistState() {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(appState));
        } catch (err) {
          console.warn("Gagal simpan state:", err);
        }
      }

      function activeScenario() {
        return appState.scenarios[appState.activeScenarioId];
      }

      function toggleModeBlocks(mode) {
        document.querySelectorAll(".mode-block").forEach((section) => {
          const allowed = (section.dataset.modes || "").split(",").map((m) => m.trim());
          if (allowed.includes(mode)) {
            section.classList.remove("hidden");
          } else {
            section.classList.add("hidden");
          }
        });
      }

      function setMode(mode) {
        appState.mode = mode;
        modeSelector.querySelectorAll(".pill").forEach((pill) => {
          pill.classList.toggle("active", pill.dataset.mode === mode);
        });
        const noteText =
          mode === "quick"
            ? "Quick Estimate: isi populasi atau permintaan harian + faktor puncak & bekalan asas. Output: ringkasan permintaan-bekalan pantas dan NPV/BCR jika CAPEX/OPEX diisi."
            : mode === "operational"
            ? "Operational Planning: buka jadual kategori, sumber alternatif berganda dengan faktor utiliti & kebolehpercayaan. Gunakan untuk perancangan 10‚Äì15 minit."
            : "Full CBA (Advanced): kekalkan pecahan CAPEX/OPEX, kitaran penggantian, penjimatan terperinci dan sensitiviti +/-10%.";
        modeNote.textContent = noteText;
        toggleModeBlocks(mode);
        persistState();
      }

      function clearElement(el) {
        while (el.firstChild) el.removeChild(el.firstChild);
      }

      function createCategoryRow(data = {}) {
        const tr = document.createElement("tr");
        tr.className = "category-row";
        tr.innerHTML = `
          <td><input type="text" class="cat-name" value="${data.name || ""}" placeholder="Nama kategori" /></td>
          <td><input type="number" class="cat-pop" value="${data.pop || ""}" min="0" /></td>
          <td><input type="number" class="cat-percap" value="${data.percap || ""}" min="0" /></td>
          <td><input type="number" class="cat-peak" value="${data.peak || "1.3"}" min="1" step="0.05" /></td>
        `;
        return tr;
      }

      function setCategoryRows(rows) {
        clearElement(categoryBody);
        if (!rows || !rows.length) {
          ["Asrama", "Fakulti & Pentadbiran", "Masjid & Surau"].forEach((name) => {
            categoryBody.appendChild(
              createCategoryRow({ name, pop: "", percap: "", peak: 1.3 })
            );
          });
        } else {
          rows.forEach((r) => categoryBody.appendChild(createCategoryRow(r)));
        }
      }

      function createAltRow(data = {}) {
        const tr = document.createElement("tr");
        tr.className = "alt-row";
        tr.innerHTML = `
          <td><input type="text" class="alt-name" placeholder="Nama sumber" value="${data.name || ""}" /></td>
          <td><input type="number" class="alt-capacity" min="0" value="${data.capacity || ""}" /></td>
          <td><input type="number" class="alt-util" min="0" max="100" value="${data.util || ""}" /></td>
          <td><input type="number" class="alt-capex" min="0" value="${data.capex || ""}" /></td>
          <td><input type="text" class="alt-capex-note" placeholder="Butiran CAPEX (jika ada)" value="${data.capexNote || ""}" /></td>
          <td><input type="number" class="alt-opex-fixed" min="0" value="${data.opexFixed || ""}" /></td>
          <td><input type="number" class="alt-opex-var" min="0" step="0.01" value="${data.opexVar || ""}" /></td>
          <td><input type="text" class="alt-opex-note" placeholder="Butiran OPEX (jika ada)" value="${data.opexNote || ""}" /></td>
          <td><input type="number" class="alt-life" min="1" value="${data.life || ""}" /></td>
        `;
        return tr;
      }

      function setAltRows(rows) {
        clearElement(altBody);
        if (!rows || !rows.length) {
          ["Tangkapan air hujan", "Air tasik / tasik kampus"].forEach((name) => {
            altBody.appendChild(createAltRow({ name }));
          });
          altBody.appendChild(createAltRow());
        } else {
          rows.forEach((r) => altBody.appendChild(createAltRow(r)));
        }
      }

      function createCapexOpexRow(data = {}) {
        const tr = document.createElement("tr");
        tr.className = "capex-opex-row";
        tr.innerHTML = `
          <td>
            <select class="item-type">
              <option value="CAPEX" ${data.type === "OPEX" ? "" : "selected"}>CAPEX</option>
              <option value="OPEX" ${data.type === "OPEX" ? "selected" : ""}>OPEX</option>
            </select>
          </td>
          <td><input type="text" class="item-name" value="${data.name || ""}" placeholder="Nama item" /></td>
          <td><input type="number" class="item-qty" value="${data.qty || 1}" min="0" step="0.01" /></td>
          <td><input type="number" class="item-cost" value="${data.cost || 0}" min="0" step="0.01" /></td>
          <td class="item-total">0.00</td>
          <td><input type="text" class="item-note" value="${data.note || ""}" placeholder="Catatan (jika ada)" /></td>
        `;
        return tr;
      }

      function setCapexRows(rows) {
        clearElement(capexOpexBody);
        if (!rows || !rows.length) {
          capexOpexBody.appendChild(createCapexOpexRow());
        } else {
          rows.forEach((r) => capexOpexBody.appendChild(createCapexOpexRow(r)));
        }
        recalcCapexOpexItems();
      }

      function captureScenarioInputs() {
        const categories = Array.from(document.querySelectorAll(".category-row")).map(
          (row) => ({
            name: row.querySelector(".cat-name")?.value || "",
            pop: row.querySelector(".cat-pop")?.value || "",
            percap: row.querySelector(".cat-percap")?.value || "",
            peak: row.querySelector(".cat-peak")?.value || "",
          })
        );
        const altRows = Array.from(document.querySelectorAll(".alt-row")).map(
          (row) => ({
            name: row.querySelector(".alt-name")?.value || "",
            capacity: row.querySelector(".alt-capacity")?.value || "",
            util: row.querySelector(".alt-util")?.value || "",
            capex: row.querySelector(".alt-capex")?.value || "",
            capexNote: row.querySelector(".alt-capex-note")?.value || "",
            opexFixed: row.querySelector(".alt-opex-fixed")?.value || "",
            opexVar: row.querySelector(".alt-opex-var")?.value || "",
            opexNote: row.querySelector(".alt-opex-note")?.value || "",
            life: row.querySelector(".alt-life")?.value || "",
          })
        );
        const capexRows = Array.from(document.querySelectorAll(".capex-opex-row")).map(
          (row) => ({
            type: row.querySelector(".item-type")?.value || "CAPEX",
            name: row.querySelector(".item-name")?.value || "",
            qty: row.querySelector(".item-qty")?.value || 1,
            cost: row.querySelector(".item-cost")?.value || 0,
            note: row.querySelector(".item-note")?.value || "",
          })
        );
        return {
          mode: appState.mode,
          quick: {
            pop: quickInputs.pop.value,
            percap: quickInputs.percap.value,
            demand: quickInputs.demand.value,
            peak: quickInputs.peak.value,
            baseSupply: quickInputs.baseSupply.value,
            alt: {
              name: quickAltInputs.name.value,
              capacity: quickAltInputs.capacity.value,
              util: quickAltInputs.util.value,
              capex: quickAltInputs.capex.value,
              opex: quickAltInputs.opex.value,
            },
          },
          supply: supplyInput.value,
          tariffWater: tariffWaterInput.value,
          tariffSewer: tariffSewerInput.value,
          analysisYears: analysisYearsInput.value,
          discount: discountRateInput.value,
          categories,
          altRows,
          capexRows,
        };
      }

      function applyScenarioInputs(data) {
        if (!data) return;
        setMode(data.mode || "quick");
        quickInputs.pop.value = data.quick?.pop || "";
        quickInputs.percap.value = data.quick?.percap || "";
        quickInputs.demand.value = data.quick?.demand || "";
        quickInputs.peak.value = data.quick?.peak || "1.3";
        quickInputs.baseSupply.value = data.quick?.baseSupply || "";

        quickAltInputs.name.value = data.quick?.alt?.name || "";
        quickAltInputs.capacity.value = data.quick?.alt?.capacity || "";
        quickAltInputs.util.value = data.quick?.alt?.util || "";
        quickAltInputs.capex.value = data.quick?.alt?.capex || "";
        quickAltInputs.opex.value = data.quick?.alt?.opex || "";

        supplyInput.value = data.supply || supplyInput.value;
        tariffWaterInput.value = data.tariffWater || tariffWaterInput.value;
        tariffSewerInput.value = data.tariffSewer || tariffSewerInput.value;
        analysisYearsInput.value = data.analysisYears || analysisYearsInput.value;
        discountRateInput.value = data.discount || discountRateInput.value;

        setCategoryRows(data.categories || []);
        setAltRows(data.altRows || []);
        setCapexRows(data.capexRows || []);
      }

      function renderScenarioList() {
        clearElement(scenarioListEl);
        Object.values(appState.scenarios).forEach((sc) => {
          const card = document.createElement("div");
          card.className = "scenario-card" + (sc.id === appState.activeScenarioId ? " active" : "");
          card.dataset.id = sc.id;
          card.innerHTML = `
            <p class="scenario-title">${sc.name}</p>
            <p class="scenario-meta">Mod: ${sc.mode || "quick"} ¬∑ Dikemas kini: ${new Date(
              sc.updatedAt || Date.now()
            ).toLocaleDateString("ms-MY")}</p>
            <div class="scenario-actions">
              <button type="button" class="secondary btn-load-scenario" data-id="${sc.id}">Muat & kira</button>
            </div>
          `;
          scenarioListEl.appendChild(card);
        });
      }

      function updateScenarioOutputs(summary, finance) {
        const sc = activeScenario();
        if (!sc) return;
        sc.mode = appState.mode;
        sc.outputs = {
          summary,
          finance,
        };
        sc.updatedAt = Date.now();
      }

      function updateCompareTable() {
        const cells = {
          A: appState.scenarios.A,
          B: appState.scenarios.B,
          C: appState.scenarios.C,
        };
        ["avg", "peak", "supply", "surplus", "npv", "bcr", "irr", "payback"].forEach((k) => {
          ["A", "B", "C"].forEach((id) => {
            const cls = `sc-${id.toLowerCase()}-${k}`;
            const td = scenarioCompareTable.querySelector(`.${cls}`);
            const sc = cells[id];
            if (!td) return;
            if (sc?.outputs?.summary && sc?.outputs?.finance) {
              const sum = sc.outputs.summary;
              const fin = sc.outputs.finance;
              const mapping = {
                avg: sum.avgMLD,
                peak: sum.peakMLD,
                supply: sum.effectiveMLD,
                surplus: sum.surplusAvg,
                npv: fin.npv,
                bcr: fin.bcr,
                irr: fin.irr,
                payback: fin.payback,
              };
              td.textContent = isFinite(mapping[k]) ? formatNumber(mapping[k]) : mapping[k] || "‚Äì";
            } else {
              td.textContent = "‚Äì";
            }
          });
        });
      }

      function setActiveScenario(id) {
        if (!appState.scenarios[id]) return;
        appState.activeScenarioId = id;
        applyScenarioInputs(appState.scenarios[id].inputs || {});
        renderScenarioList();
        persistState();
        calculate();
      }

      function addScenario() {
        const letters = ["A", "B", "C"];
        const available = letters.find((l) => !appState.scenarios[l]);
        if (!available) {
          alert("Hanya tiga senario (A/B/C) disokong. Padam satu sebelum menambah.");
          return;
        }
        appState.scenarios[available] = createEmptyScenario(available, `Senario ${available}`);
        appState.activeScenarioId = available;
        renderScenarioList();
        persistState();
        applyScenarioInputs(appState.scenarios[available].inputs);
      }

      function duplicateScenario() {
        const letters = ["A", "B", "C"];
        const available = letters.find((l) => !appState.scenarios[l]);
        if (!available) {
          alert("Hanya tiga senario (A/B/C) disokong.");
          return;
        }
        const current = activeScenario();
        if (!current) return;
        appState.scenarios[available] = {
          ...JSON.parse(JSON.stringify(current)),
          id: available,
          name: `${current.name} (Salinan)`,
          updatedAt: Date.now(),
        };
        appState.activeScenarioId = available;
        renderScenarioList();
        persistState();
      }

      function renameScenario() {
        const sc = activeScenario();
        if (!sc) return;
        const name = prompt("Nama baharu senario:", sc.name);
        if (name) {
          sc.name = name;
          sc.updatedAt = Date.now();
          renderScenarioList();
          persistState();
        }
      }

      function deleteScenario() {
        if (Object.keys(appState.scenarios).length <= 1) {
          alert("Sekurang-kurangnya satu senario mesti wujud.");
          return;
        }
        const id = appState.activeScenarioId;
        delete appState.scenarios[id];
        appState.activeScenarioId = Object.keys(appState.scenarios)[0];
        renderScenarioList();
        persistState();
        applyScenarioInputs(activeScenario().inputs);
      }

      function saveActiveScenario() {
        const sc = activeScenario();
        if (!sc) return;
        sc.inputs = captureScenarioInputs();
        sc.mode = appState.mode;
        sc.updatedAt = Date.now();
        persistState();
        renderScenarioList();
      }

      function updateSensitivityUI() {
        const { totalPVBenefits, totalPVCosts, pvCapex, pvOpex } = lastAltSummary;
        const baseNPV = totalPVBenefits - totalPVCosts;
        const baseBCR = totalPVCosts > 0 ? totalPVBenefits / totalPVCosts : NaN;
        const scenarios = {
          base: { npv: baseNPV, bcr: baseBCR },
          capex: {
            npv: totalPVBenefits - (pvCapex * 1.1 + pvOpex),
            bcr: (totalPVBenefits) / (pvCapex * 1.1 + pvOpex || 1),
          },
          opex: {
            npv: totalPVBenefits - (pvCapex + pvOpex * 1.1),
            bcr: (totalPVBenefits) / (pvCapex + pvOpex * 1.1 || 1),
          },
          benefit: {
            npv: totalPVBenefits * 1.1 - totalPVCosts,
            bcr: totalPVCosts > 0 ? (totalPVBenefits * 1.1) / totalPVCosts : NaN,
          },
        };
        Object.entries(scenarios).forEach(([key, val]) => {
          const el = sensitivityLabels[key];
          if (!el) return;
          el.textContent = `NPV: ${formatNumber(val.npv)} | BCR: ${isFinite(val.bcr) ? formatNumber(val.bcr) : "‚Äì"}`;
        });
      }

      function showValidation(messages) {
        if (!messages.length) {
          validationBox.classList.add("hidden");
          validationList.innerHTML = "";
          return;
        }
        validationList.innerHTML = messages.map((m) => `<li>${m}</li>`).join("");
        validationBox.classList.remove("hidden");
      }

      function validateInputs(mode) {
        const errors = [];
        const markInvalid = (el) => el && el.classList.add("invalid");
        const clearInvalid = (el) => el && el.classList.remove("invalid");

        [...document.querySelectorAll("input")].forEach(clearInvalid);

        if (mode === "quick") {
          const pop = normalizeNumber(quickInputs.pop.value);
          const percap = normalizeNumber(quickInputs.percap.value);
          const demand = normalizeNumber(quickInputs.demand.value);
          const peak = normalizeNumber(quickInputs.peak.value);
          if (!(demand > 0 || (pop > 0 && percap > 0))) {
            errors.push("Isi sama ada jumlah permintaan harian atau populasi + per kapita untuk Quick Estimate.");
            markInvalid(quickInputs.demand);
            markInvalid(quickInputs.pop);
            markInvalid(quickInputs.percap);
          }
          if (peak <= 0) {
            errors.push("Faktor puncak mesti melebihi 0.");
            markInvalid(quickInputs.peak);
          } else if (peak < 1.2 || peak > 1.5) {
            errors.push("Amaran: faktor puncak disyorkan antara 1.2‚Äì1.5 (dibolehkan jika sengaja).");
          }
        } else {
          const rows = Array.from(document.querySelectorAll(".category-row"));
          const validRow = rows.some((r) => normalizeNumber(r.querySelector(".cat-pop").value) > 0 && normalizeNumber(r.querySelector(".cat-percap").value) > 0);
          if (!validRow) {
            errors.push("Isi sekurang-kurangnya satu baris kategori dengan populasi & kadar per kapita.");
            rows.forEach((r) => {
              markInvalid(r.querySelector(".cat-pop"));
              markInvalid(r.querySelector(".cat-percap"));
            });
          }
          rows.forEach((r) => {
            const peak = normalizeNumber(r.querySelector(".cat-peak").value);
            if (peak < 1.2 || peak > 1.5) {
              errors.push("Amaran: faktor puncak biasa 1.2‚Äì1.5. Semak baris kategori jika perlu.");
            }
          });
        }

        if (normalizeNumber(supplyInput.value) < 0) {
          errors.push("Bekalan asas tidak boleh negatif.");
          markInvalid(supplyInput);
        }
        [tariffWaterInput, tariffSewerInput, analysisYearsInput, discountRateInput].forEach((el) => {
          if (normalizeNumber(el.value) < 0) {
            errors.push("Nilai tarif/parameter kewangan tidak boleh negatif.");
            markInvalid(el);
          }
        });

        const invalidEls = document.querySelectorAll(".invalid");
        return {
          ok: !errors.some((e) => !e.startsWith("Amaran")),
          errors,
          firstInvalid: invalidEls.length ? invalidEls[0] : null,
        };
      }

      function blobToDataURL(blob) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(blob);
        });
      }

      async function loadUmsLogoDataUrl() {
        if (umsLogoDataUrl) return umsLogoDataUrl;
        try {
          const res = await fetch(encodeURI(umsLogoPath));
          if (!res.ok) throw new Error(`Logo gagal dimuat (status ${res.status})`);
          const blob = await res.blob();
          umsLogoDataUrl = await blobToDataURL(blob);
        } catch (err) {
          console.warn("Gagal memuat logo UMS untuk laporan:", err);
          umsLogoDataUrl = "";
        }
        return umsLogoDataUrl;
      }

      function waitForNextFrame() {
        return new Promise((resolve) => requestAnimationFrame(() => resolve()));
      }

      function wait(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }

      function waitForImages(container) {
        const imgs = Array.from(container.querySelectorAll("img"));
        const pending = imgs.filter((img) => !img.complete || img.naturalWidth === 0);
        if (!pending.length) return Promise.resolve();
        return Promise.allSettled(
          pending.map(
            (img) =>
              new Promise((resolve) => {
                img.addEventListener("load", resolve, { once: true });
                img.addEventListener("error", resolve, { once: true });
              })
          )
        );
      }

      function waitForFonts() {
        if (document.fonts && document.fonts.ready) {
          return document.fonts.ready.catch(() => undefined);
        }
        return Promise.resolve();
      }

      function calculate() {
        const validation = validateInputs(appState.mode);
        showValidation(validation.errors);
        if (!validation.ok) {
          if (validation.firstInvalid) {
            validation.firstInvalid.focus();
          }
          return;
        }

        const demandRows = [];
        const categoryNames = [];
        const peakDemands = [];
        const avgDemands = [];
        let totalPop = 0;
        let totalAvgM3 = 0;
        let totalPeakM3 = 0;

        resultsBody.innerHTML = "";

        if (appState.mode === "quick") {
          const pop = normalizeNumber(quickInputs.pop.value);
          const percap = normalizeNumber(quickInputs.percap.value);
          const demand = normalizeNumber(quickInputs.demand.value);
          const peak = normalizeNumber(quickInputs.peak.value) || 1.3;
          let avgM3 = demand > 0 ? demand : (pop * percap) / 1000;
          avgM3 = isFinite(avgM3) ? avgM3 : 0;
          const peakM3 = avgM3 * peak;
          totalPop = pop;
          totalAvgM3 = avgM3;
          totalPeakM3 = peakM3;
          demandRows.push({
            name: "Anggaran pantas",
            pop,
            percap,
            avgM3,
            peakFactor: peak,
            peakM3,
          });
          categoryNames.push("Anggaran pantas");
          avgDemands.push(avgM3);
          peakDemands.push(peakM3);
        } else {
          const rows = Array.from(document.querySelectorAll(".category-row"));
          rows.forEach((row) => {
            const nameInput = row.querySelector(".cat-name");
            const popInput = row.querySelector(".cat-pop");
            const perCapInput = row.querySelector(".cat-percap");
            const peakInput = row.querySelector(".cat-peak");

            const name = (nameInput.value || "").trim();
            const pop = parseFloat(popInput.value);
            const perCap = parseFloat(perCapInput.value);
            const peak = parseFloat(peakInput.value);

            if (!name || !isFinite(pop) || pop <= 0 || !isFinite(perCap)) {
              return;
            }

            const avgM3 = (pop * perCap) / 1000;
            const peakM3 = avgM3 * (isFinite(peak) && peak > 0 ? peak : 1);

            totalPop += pop;
            totalAvgM3 += avgM3;
            totalPeakM3 += peakM3;

            categoryNames.push(name);
            avgDemands.push(avgM3);
            peakDemands.push(peakM3);

            demandRows.push({
              name,
              pop,
              percap,
              avgM3,
              peakFactor: peak,
              peakM3,
            });
          });
        }

        demandRows.forEach((row) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${row.name}</td>
            <td>${formatNumber(row.pop)}</td>
            <td>${formatNumber(row.percap)}</td>
            <td>${formatNumber(row.avgM3)}</td>
            <td>${isFinite(row.peakFactor) ? formatNumber(row.peakFactor) : "‚Äì"}</td>
            <td>${formatNumber(row.peakM3)}</td>
          `;
          resultsBody.appendChild(tr);
        });

        const totalAvgMLD = totalAvgM3 / 1000;
        const totalPeakMLD = totalPeakM3 / 1000;

        totalPopEl.textContent = totalPop ? formatNumber(totalPop) : "‚Äì";
        totalAvgM3El.textContent = formatNumber(totalAvgM3);
        totalPeakM3El.textContent = formatNumber(totalPeakM3);
        totalAvgMLDEl.textContent = formatNumber(totalAvgMLD);
        totalPeakMLDEl.textContent = formatNumber(totalPeakMLD);

        if (appState.mode === "quick" && quickInputs.baseSupply.value) {
          supplyInput.value = quickInputs.baseSupply.value;
        }

        // 2. Baseline supply (JANS)
        const supplyBaseMLD = parseFloat(supplyInput.value);
        const supplyValid = isFinite(supplyBaseMLD) && supplyBaseMLD >= 0;

        supplyAvgMLDEl.textContent = supplyValid
          ? formatNumber(supplyBaseMLD)
          : "‚Äì";

        // 3. Alternative supply + build altData for CBA
        const altData = [];
        let altAvgM3PerDayTotal = 0;
        if (appState.mode === "quick") {
          const name = (quickAltInputs.name.value || "").trim();
          const cap = normalizeNumber(quickAltInputs.capacity.value);
          const util = normalizeNumber(quickAltInputs.util.value);
          if (name && cap > 0 && util > 0) {
            const capex = normalizeNumber(quickAltInputs.capex.value);
            const opex = normalizeNumber(quickAltInputs.opex.value);
            const avgM3PerDayEff = cap * (util / 100);
            altAvgM3PerDayTotal += avgM3PerDayEff;
            altData.push({
              name,
              capacity: cap,
              utilPercent: util,
              reliabilityPercent: 100,
              capex,
              capexNote: "",
              opexFixed: opex,
              opexVar: 0,
              opexNote: "",
              lifeYears: NaN,
            });
          }
        } else {
          const altRows = Array.from(document.querySelectorAll(".alt-row"));
          altRows.forEach((row) => {
            const name = (row.querySelector(".alt-name").value || "").trim();
            const cap = parseFloat(row.querySelector(".alt-capacity").value);
            const util = parseFloat(row.querySelector(".alt-util").value);
            const reliability = parseFloat(row.querySelector(".alt-reliability").value) || 100;
            const capex = parseFloat(row.querySelector(".alt-capex").value);
            const capexNote = (row.querySelector(".alt-capex-note")?.value || "").trim();
            const opexFixed = parseFloat(
              row.querySelector(".alt-opex-fixed").value
            );
            const opexVar = parseFloat(
              row.querySelector(".alt-opex-var").value
            );
            const opexNote = (row.querySelector(".alt-opex-note")?.value || "").trim();
            const lifeYears = parseFloat(row.querySelector(".alt-life").value);

            if (!name || !isFinite(cap) || cap <= 0 || !isFinite(util) || util <= 0) {
              return;
            }

            const avgM3PerDayEff = cap * (util / 100) * (reliability / 100);
            altAvgM3PerDayTotal += avgM3PerDayEff;

            altData.push({
              name,
              capacity: cap,
              utilPercent: util,
              reliabilityPercent: reliability,
              capex: isFinite(capex) ? capex : 0,
              capexNote,
              opexFixed: isFinite(opexFixed) ? opexFixed : 0,
              opexVar: isFinite(opexVar) ? opexVar : 0,
              opexNote,
              lifeYears: isFinite(lifeYears) ? lifeYears : NaN,
            });
          });
        }

        const altSupplyMLD = altAvgM3PerDayTotal / 1000;
        altSupplyMLDEl.textContent = altData.length
          ? formatNumber(altSupplyMLD)
          : "0.00";

        const effectiveSupplyMLD = (supplyValid ? supplyBaseMLD : 0) + altSupplyMLD;
        effectiveSupplyMLDEl.textContent = effectiveSupplyMLD
          ? formatNumber(effectiveSupplyMLD)
          : "‚Äì";

        // 4. Demand vs effective supply
        summaryAvgMLDEl.textContent = formatNumber(totalAvgMLD);
        summaryPeakMLDEl.textContent = formatNumber(totalPeakMLD);

        let surplusAvg = null;
        let surplusPeak = null;
        let statusAvg = "";
        let statusPeak = "";

        rowAvg.classList.remove("summary-row-surplus", "summary-row-deficit");
        rowPeak.classList.remove("summary-row-surplus", "summary-row-deficit");

        if (effectiveSupplyMLD > 0) {
          surplusAvg = effectiveSupplyMLD - totalAvgMLD;
          surplusPeak = effectiveSupplyMLD - totalPeakMLD;

          surplusAvgMLDEl.textContent = formatNumber(surplusAvg);
          surplusPeakMLDEl.textContent = formatNumber(surplusPeak);

          if (totalAvgMLD > 0) {
            statusAvg = surplusAvg >= 0 ? "Surplus" : "Deficit";
          }
          if (totalPeakMLD > 0) {
            statusPeak = surplusPeak >= 0 ? "Surplus" : "Deficit";
          }

          if (statusAvg === "Surplus") {
            rowAvg.classList.add("summary-row-surplus");
          } else if (statusAvg === "Deficit") {
            rowAvg.classList.add("summary-row-deficit");
          }

          if (statusPeak === "Surplus") {
            rowPeak.classList.add("summary-row-surplus");
          } else if (statusPeak === "Deficit") {
            rowPeak.classList.add("summary-row-deficit");
          }
        } else {
          surplusAvgMLDEl.textContent = "‚Äì";
          surplusPeakMLDEl.textContent = "‚Äì";
        }

        statusAvgEl.textContent = formatStatusLabel(statusAvg, false);
        statusPeakEl.textContent = formatStatusLabel(statusPeak, true);

        // 5. Ringkasan teks
        if (!categoryNames.length) {
          summaryTextEl.innerHTML =
            "Sila masukkan sekurang-kurangnya satu kategori dengan populasi dan kadar per kapita untuk menjana analisis.";
        } else if (!supplyValid && !altData.length) {
          summaryTextEl.innerHTML =
            "Permintaan purata dianggarkan sebanyak <strong>" +
            formatNumber(totalAvgMLD) +
            " MLD</strong>, manakala permintaan puncak sebanyak <strong>" +
            formatNumber(totalPeakMLD) +
            " MLD</strong>. Sila masukkan nilai bekalan JANS dan/atau sumber alternatif untuk menilai surplus atau defisit.";
        } else {
          const baseText = supplyValid
            ? "Bekalan sedia ada (JANS) dianggarkan <strong>" +
              formatNumber(supplyBaseMLD) +
              " MLD</strong>."
            : "Bekalan JANS tidak ditetapkan dengan jelas.";

          const altText = altData.length
            ? " Sumber alternatif menambah kira-kira <strong>" +
              formatNumber(altSupplyMLD) +
              " MLD</strong> kepada bekalan."
            : " Tiada sumber alternatif dimasukkan setakat ini.";

          const effText =
            " Bekalan efektif (JANS + alternatif) dianggarkan <strong>" +
            formatNumber(effectiveSupplyMLD) +
            " MLD</strong>.";

          const avgWord = surplusAvg >= 0 ? "lebihan" : "defisit";
          const peakWord = surplusPeak >= 0 ? "lebihan" : "defisit";

          summaryTextEl.innerHTML =
            baseText +
            altText +
            effText +
            " Jumlah permintaan purata kampus dianggarkan <strong>" +
            formatNumber(totalAvgMLD) +
            " MLD</strong> (" +
            avgWord +
            " " +
            formatNumber(Math.abs(surplusAvg)) +
            " MLD), manakala permintaan puncak dianggarkan <strong>" +
            formatNumber(totalPeakMLD) +
            " MLD</strong> (" +
            peakWord +
            " " +
            formatNumber(Math.abs(surplusPeak)) +
            " MLD).";
        }

        // 6. Update demand charts
        updateDemandCharts(categoryNames, avgDemands, peakDemands);

        // 7. CBA for alternative sources
        const finance = calculateAltCBA(altData) || {};

        // 8. Simpan ke senario & jadual perbandingan
        const summaryOut = {
          avgMLD: totalAvgMLD,
          peakMLD: totalPeakMLD,
          effectiveMLD: effectiveSupplyMLD,
          surplusAvg,
          surplusPeak,
        };
        updateScenarioOutputs(summaryOut, finance);
        saveActiveScenario();
        updateCompareTable();
        updateSensitivityUI();
      }

      function updateDemandCharts(labels, avgData, peakData) {
        if (categoryChart) categoryChart.destroy();
        if (shareChart) shareChart.destroy();

        if (!labels.length) return;

        categoryChart = new Chart(categoryChartCtx, {
          type: "bar",
          data: {
            labels,
            datasets: [
              {
                label: "Purata (m¬≥/hari)",
                data: avgData,
                backgroundColor: "rgba(13, 110, 253, 0.7)",
                borderRadius: 6,
              },
              {
                label: "Puncak (m¬≥/hari)",
                data: peakData,
                backgroundColor: "rgba(0, 188, 212, 0.7)",
                borderRadius: 6,
              },
            ],
          },
            options: {
              responsive: true,
              animation: false,
              plugins: {
                legend: { position: "top" },
                title: {
                display: true,
                text: "Permintaan Air Mengikut Kategori",
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                title: { display: true, text: "m¬≥/hari" },
              },
            },
          },
        });

        shareChart = new Chart(shareChartCtx, {
          type: "pie",
          data: {
            labels,
            datasets: [
              {
                data: avgData,
                backgroundColor: [
                  "rgba(13, 110, 253, 0.85)",
                  "rgba(0, 188, 212, 0.85)",
                  "rgba(3, 169, 244, 0.85)",
                  "rgba(0, 150, 136, 0.85)",
                  "rgba(63, 81, 181, 0.85)",
                  "rgba(33, 150, 243, 0.85)",
                ],
              },
            ],
          },
          options: {
            responsive: true,
            animation: false,
            plugins: {
              legend: { position: "right" },
              title: {
                display: true,
                text: "Agihan Permintaan Purata Mengikut Kategori",
              },
            },
          },
        });
      }

      function computeIRR(initialCapex, netCF, years) {
        if (!(isFinite(initialCapex) && isFinite(netCF) && initialCapex > 0 && netCF > 0 && years > 0)) {
          return NaN;
        }
        let low = 0.0;
        let high = 0.3; // 0%‚Äì30%
        function npv(rate) {
          let val = -initialCapex;
          for (let t = 1; t <= years; t++) {
            val += netCF / Math.pow(1 + rate, t);
          }
          return val;
        }
        let npvLow = npv(low);
        let npvHigh = npv(high);
        if (npvLow * npvHigh > 0) {
          return NaN;
        }
        for (let i = 0; i < 40; i++) {
          const mid = (low + high) / 2;
          const npvMid = npv(mid);
          if (Math.abs(npvMid) < 1e-3) {
            return mid;
          }
          if (npvLow * npvMid < 0) {
            high = mid;
            npvHigh = npvMid;
          } else {
            low = mid;
            npvLow = npvMid;
          }
        }
        return (low + high) / 2;
      }

      function calculateAltCBA(altData) {
        // Clear if no data
        altResultsBody.innerHTML = "";
        if (cbaNpvChart) cbaNpvChart.destroy();
        if (cbaPaybackChart) cbaPaybackChart.destroy();

        const tariffWater = parseFloat(tariffWaterInput.value) || 0;
        const tariffSewer = parseFloat(tariffSewerInput.value) || 0;
        const tariffTotal = tariffWater + tariffSewer;

        const analysisYears = parseInt(analysisYearsInput.value, 10) || 0;
        const discountRate = parseFloat(discountRateInput.value) || 0;
        const r = discountRate / 100;

        let totalCap = 0;
        let totalVol = 0;
        let totalCapex = 0;
        let totalOpex = 0;
        let totalSaving = 0;
        let totalNetCF = 0;

        let totalPVBenefits = 0;
        let totalPVCosts = 0;
        let pvCapexTotal = 0;
        let pvOpexTotal = 0;

        const labels = [];
        const npvData = [];
        const paybackData = [];

        if (!altData.length || analysisYears <= 0) {
          altTotalCapacityEl.textContent = "0.00";
          altTotalVolumeEl.textContent = "0.00";
          altTotalCapexEl.textContent = "0.00";
          altTotalOpexEl.textContent = "0.00";
          altTotalSavingEl.textContent = "0.00";
          altTotalNetCFEl.textContent = "0.00";
          altTotalNPVEl.textContent = "0.00";
          altTotalBCREl.textContent = "‚Äì";

          sumCapexEl.textContent = "0.00";
          sumSavingEl.textContent = "0.00";
          sumOpexEl.textContent = "0.00";
          sumNetCFEl.textContent = "0.00";
          sumNPVEl.textContent = "0.00";
          sumBCREl.textContent = "‚Äì";
          sumIRREl.textContent = "‚Äì";

          lastAltSources = [];
          lastAltSummary = {
            totalPVBenefits: 0,
            totalPVCosts: 0,
            pvCapex: 0,
            pvOpex: 0,
            payback: NaN,
          };
          return {
            capex: 0,
            saving: 0,
            opex: 0,
            netcf: 0,
            npv: 0,
            bcr: NaN,
            irr: NaN,
            payback: NaN,
          };
        }

        altData.forEach((s) => {
          const { name, capacity, utilPercent, reliabilityPercent = 100, capex, opexFixed, opexVar, lifeYears } = s;
          const volAnnual = capacity * (utilPercent / 100) * (reliabilityPercent / 100) * 365;

          const savingAnnual = volAnnual * tariffTotal;
          const opexAnnual = opexFixed + opexVar * volAnnual;
          const netCF = savingAnnual - opexAnnual;

          // Simple payback
          let payback = NaN;
          if (netCF > 0 && capex > 0) {
            payback = capex / netCF;
          }

          // NPV & BCR
          const horizon = isFinite(lifeYears) && lifeYears > 0
            ? Math.min(analysisYears, Math.round(lifeYears))
            : analysisYears;

          let pvBenefits = 0;
          let pvCosts = capex;
          let pvOpex = 0;

          for (let t = 1; t <= horizon; t++) {
            const df = Math.pow(1 + r, t);
            pvBenefits += savingAnnual / df;
            const opexPV = opexAnnual / df;
            pvCosts += opexPV;
            pvOpex += opexPV;
          }

          const npv = pvBenefits - pvCosts;
          const bcr = pvCosts > 0 ? pvBenefits / pvCosts : NaN;

          totalCap += capacity;
          totalVol += volAnnual;
          totalCapex += capex;
          totalOpex += opexAnnual;
          totalSaving += savingAnnual;
          totalNetCF += netCF;

          totalPVBenefits += pvBenefits;
          totalPVCosts += pvCosts;
          pvCapexTotal += capex;
          pvOpexTotal += pvOpex;

          labels.push(name);
          npvData.push(npv);
          paybackData.push(isFinite(payback) ? payback : null);

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${name}</td>
            <td>${formatNumber(capacity)}</td>
            <td>${formatNumber(utilPercent)}</td>
            <td>${formatNumber(reliabilityPercent)}</td>
            <td>${formatNumber(volAnnual)}</td>
            <td>${formatNumber(capex)}</td>
            <td>${formatNumber(opexAnnual)}</td>
            <td>${formatNumber(savingAnnual)}</td>
            <td>${formatNumber(netCF)}</td>
            <td>${isFinite(payback) ? formatNumber(payback) : "‚Äì"}</td>
            <td>${formatNumber(npv)}</td>
            <td>${isFinite(bcr) ? formatNumber(bcr) : "‚Äì"}</td>
          `;
          altResultsBody.appendChild(tr);
        });

        const totalNPV = totalPVBenefits - totalPVCosts;
        const totalBCR = totalPVCosts > 0 ? totalPVBenefits / totalPVCosts : NaN;
        const totalPayback = totalNetCF > 0 && totalCapex > 0 ? totalCapex / totalNetCF : NaN;

        altTotalCapacityEl.textContent = formatNumber(totalCap);
        altTotalVolumeEl.textContent = formatNumber(totalVol);
        altTotalCapexEl.textContent = formatNumber(totalCapex);
        altTotalOpexEl.textContent = formatNumber(totalOpex);
        altTotalSavingEl.textContent = formatNumber(totalSaving);
        altTotalNetCFEl.textContent = formatNumber(totalNetCF);
        altTotalNPVEl.textContent = formatNumber(totalNPV);
        altTotalBCREl.textContent = isFinite(totalBCR) ? formatNumber(totalBCR) : "‚Äì";

        sumCapexEl.textContent = formatNumber(totalCapex);
        sumSavingEl.textContent = formatNumber(totalSaving);
        sumOpexEl.textContent = formatNumber(totalOpex);
        sumNetCFEl.textContent = formatNumber(totalNetCF);
        sumNPVEl.textContent = formatNumber(totalNPV);
        sumBCREl.textContent = isFinite(totalBCR) ? formatNumber(totalBCR) : "‚Äì";

        // IRR anggaran untuk projek (menggunakan totalCapex & totalNetCF)
        const irr = computeIRR(totalCapex, totalNetCF, analysisYears);
        sumIRREl.textContent = isFinite(irr) ? (irr * 100).toFixed(2) + " %" : "‚Äì";

        // Simpan altData untuk laporan PDF (termasuk nota CAPEX/OPEX)
        lastAltSources = altData.slice();
        lastAltSummary = {
          totalPVBenefits,
          totalPVCosts,
          pvCapex: pvCapexTotal,
          pvOpex: pvOpexTotal,
          payback: totalPayback,
        };

        // Graf NPV & tempoh pulangan modal
        if (labels.length) {
          cbaNpvChart = new Chart(cbaNPVCtx, {
            type: "bar",
            data: {
              labels,
              datasets: [
                {
                  label: "NPV (RM)",
                  data: npvData,
                  backgroundColor: "rgba(3, 169, 244, 0.8)",
                  borderRadius: 6,
                },
              ],
            },
            options: {
              responsive: true,
              animation: false,
              plugins: {
                legend: { display: false },
                title: { display: true, text: "NPV Mengikut Sumber Air Alternatif" },
              },
              scales: {
                y: { beginAtZero: false, title: { display: true, text: "RM" } },
              },
            },
          });

          cbaPaybackChart = new Chart(cbaPaybackCtx, {
            type: "bar",
            data: {
              labels,
              datasets: [
                {
                  label: "Tempoh pulangan modal (tahun)",
                  data: paybackData,
                  backgroundColor: "rgba(255, 193, 7, 0.9)",
                  borderRadius: 6,
                },
              ],
            },
            options: {
              responsive: true,
              animation: false,
              plugins: {
                legend: { display: false },
                title: { display: true, text: "Tempoh Pulangan Modal Mengikut Sumber" },
              },
              scales: {
                y: {
                  beginAtZero: true,
                  title: { display: true, text: "Tahun" },
                },
              },
            },
          });
        }

        return {
          capex: totalCapex,
          saving: totalSaving,
          opex: totalOpex,
          netcf: totalNetCF,
          npv: totalNPV,
          bcr: totalBCR,
          irr: isFinite(irr) ? irr * 100 : NaN,
          payback: totalPayback,
        };
      }

      // CAPEX/OPEX itemised calculator
      function recalcCapexOpexItems() {
        const rows = Array.from(document.querySelectorAll(".capex-opex-row"));
        let capexTotal = 0;
        let opexTotal = 0;

        rows.forEach((row) => {
          const type = row.querySelector(".item-type").value;
          const qty = parseFloat(row.querySelector(".item-qty").value) || 0;
          const cost = parseFloat(row.querySelector(".item-cost").value) || 0;
          const total = qty * cost;
          row.querySelector(".item-total").textContent = formatNumber(total);
          if (type === "CAPEX") {
            capexTotal += total;
          } else {
            opexTotal += total;
          }
        });

        capexItemsTotalEl.textContent = formatNumber(capexTotal);
        opexItemsTotalEl.textContent = formatNumber(opexTotal);
      }

      async function collectReportData() {
        recalcCapexOpexItems();
        calculate();
        await waitForNextFrame();
        await wait(80);

        const now = new Date();
        const generatedDate = now.toLocaleDateString("ms-MY");
        const fileDate = now.toISOString().slice(0, 10);

        const summary = {
          avgMLD: parseNumberFromText(summaryAvgMLDEl.textContent),
          peakMLD: parseNumberFromText(summaryPeakMLDEl.textContent),
          supplyMLD: parseNumberFromText(supplyAvgMLDEl.textContent),
          altSupplyMLD: parseNumberFromText(altSupplyMLDEl.textContent),
          effectiveMLD: parseNumberFromText(effectiveSupplyMLDEl.textContent),
          surplusAvg: parseNumberFromText(surplusAvgMLDEl.textContent),
          surplusPeak: parseNumberFromText(surplusPeakMLDEl.textContent),
          text: {
            avg: summaryAvgMLDEl.textContent || "‚Äì",
            peak: summaryPeakMLDEl.textContent || "‚Äì",
            supply: supplyAvgMLDEl.textContent || "‚Äì",
            alt: altSupplyMLDEl.textContent || "‚Äì",
            effective: effectiveSupplyMLDEl.textContent || "‚Äì",
            surplusAvg: surplusAvgMLDEl.textContent || "‚Äì",
            surplusPeak: surplusPeakMLDEl.textContent || "‚Äì",
          },
          status: {
            avg: statusAvgEl.textContent || "‚Äì",
            peak: statusPeakEl.textContent || "‚Äì",
          },
        };

        const categoryInputs = Array.from(
          document.querySelectorAll(".category-row")
        )
          .map((row) => ({
            name: row.querySelector(".cat-name")?.value || "",
            pop: row.querySelector(".cat-pop")?.value || "",
            percap: row.querySelector(".cat-percap")?.value || "",
            peak: row.querySelector(".cat-peak")?.value || "",
          }))
          .filter(
            (r) =>
              r.name.trim() ||
              parseNumberFromText(r.pop) > 0 ||
              parseNumberFromText(r.percap) > 0
          );

        const demandByCategory = Array.from(
          document.querySelectorAll("#results-body tr")
        ).map((tr) => {
          const cells = tr.querySelectorAll("td");
          return {
            name: cells[0]?.textContent.trim() || "-",
            pop: cells[1]?.textContent.trim() || "‚Äì",
            percap: cells[2]?.textContent.trim() || "‚Äì",
            avg: cells[3]?.textContent.trim() || "‚Äì",
            peakFactor: cells[4]?.textContent.trim() || "‚Äì",
            peak: cells[5]?.textContent.trim() || "‚Äì",
          };
        });

        const altRows = Array.from(
          document.querySelectorAll("#alt-results-body tr")
        );
        const altSources = altRows.map((tr, idx) => {
          const cells = tr.querySelectorAll("td");
          return {
            name: cells[0]?.textContent.trim() || "-",
            capacity: cells[1]?.textContent.trim() || "‚Äì",
            util: cells[2]?.textContent.trim() || "‚Äì",
            volume: cells[3]?.textContent.trim() || "‚Äì",
            capex: cells[4]?.textContent.trim() || "‚Äì",
            opex: cells[5]?.textContent.trim() || "‚Äì",
            saving: cells[6]?.textContent.trim() || "‚Äì",
            netcf: cells[7]?.textContent.trim() || "‚Äì",
            payback: cells[8]?.textContent.trim() || "‚Äì",
            npv: cells[9]?.textContent.trim() || "‚Äì",
            bcr: cells[10]?.textContent.trim() || "‚Äì",
            capexNote: lastAltSources[idx]?.capexNote || "",
            opexNote: lastAltSources[idx]?.opexNote || "",
          };
        });

        const altTotals = {
          capacity: altTotalCapacityEl.textContent || "‚Äì",
          volume: altTotalVolumeEl.textContent || "‚Äì",
          capex: altTotalCapexEl.textContent || "‚Äì",
          opex: altTotalOpexEl.textContent || "‚Äì",
          saving: altTotalSavingEl.textContent || "‚Äì",
          netcf: altTotalNetCFEl.textContent || "‚Äì",
          npv: altTotalNPVEl.textContent || "‚Äì",
          bcr: altTotalBCREl.textContent || "‚Äì",
        };

        const financeSummary = {
          capex: sumCapexEl.textContent || "‚Äì",
          saving: sumSavingEl.textContent || "‚Äì",
          opex: sumOpexEl.textContent || "‚Äì",
          netcf: sumNetCFEl.textContent || "‚Äì",
          npv: sumNPVEl.textContent || "‚Äì",
          bcr: sumBCREl.textContent || "‚Äì",
          irr: sumIRREl.textContent || "‚Äì",
        };

        const capexOpexItems = Array.from(
          document.querySelectorAll("#capex-opex-body tr")
        )
          .map((tr) => ({
            type: tr.querySelector(".item-type")?.value || "",
            name: tr.querySelector(".item-name")?.value || "",
            qty: tr.querySelector(".item-qty")?.value || "",
            cost: tr.querySelector(".item-cost")?.value || "",
            total: tr.querySelector(".item-total")?.textContent || "",
            note: tr.querySelector(".item-note")?.value || "",
          }))
          .filter(
            (r) =>
              r.name.trim() ||
              parseNumberFromText(r.qty) > 0 ||
              parseNumberFromText(r.cost) > 0
          );

        const assumptions = {
          supply: supplyInput.value || "",
          tariffWater: tariffWaterInput.value || "",
          tariffSewer: tariffSewerInput.value || "",
          years: analysisYearsInput.value || "",
          discount: discountRateInput.value || "",
        };

        const scenariosForReport = Object.values(appState.scenarios || {}).map((s) => ({
          name: s.name,
          id: s.id,
          mode: s.mode,
          summary: s.outputs?.summary || {},
          finance: s.outputs?.finance || {},
        }));

        const sensitivity = {
          base: {
            npv: lastAltSummary.totalPVBenefits - lastAltSummary.totalPVCosts,
            bcr: lastAltSummary.totalPVCosts > 0 ? lastAltSummary.totalPVBenefits / lastAltSummary.totalPVCosts : NaN,
          },
          capex: {
            npv: lastAltSummary.totalPVBenefits - (lastAltSummary.pvCapex * 1.1 + lastAltSummary.pvOpex),
            bcr: lastAltSummary.pvCapex * 1.1 + lastAltSummary.pvOpex > 0
              ? lastAltSummary.totalPVBenefits / (lastAltSummary.pvCapex * 1.1 + lastAltSummary.pvOpex)
              : NaN,
          },
          opex: {
            npv: lastAltSummary.totalPVBenefits - (lastAltSummary.pvCapex + lastAltSummary.pvOpex * 1.1),
            bcr: lastAltSummary.pvCapex + lastAltSummary.pvOpex * 1.1 > 0
              ? lastAltSummary.totalPVBenefits / (lastAltSummary.pvCapex + lastAltSummary.pvOpex * 1.1)
              : NaN,
          },
          benefit: {
            npv: lastAltSummary.totalPVBenefits * 1.1 - lastAltSummary.totalPVCosts,
            bcr: lastAltSummary.totalPVCosts > 0
              ? (lastAltSummary.totalPVBenefits * 1.1) / lastAltSummary.totalPVCosts
              : NaN,
          },
        };

        const charts = {
          demandByCategory: chartToImage(categoryChart, "demand-by-category-chart"),
          demandShare: chartToImage(shareChart, "demand-share-chart"),
          cbaNPV: chartToImage(cbaNpvChart, "cba-npv-chart"),
          cbaPayback: chartToImage(cbaPaybackChart, "cba-payback-chart"),
        };
        const supplyDemandImg = buildSupplyDemandChartImage(summary);
        const altMixImg = buildAltCompositionChartImage(lastAltSources);
        if (supplyDemandImg) charts.supplyDemand = supplyDemandImg;
        if (altMixImg) charts.altComposition = altMixImg;

        const disclaimerText =
          "Laporan ini dijana secara automatik berdasarkan input semasa kalkulator. " +
          "Nilai kewangan dan teknikal adalah anggaran untuk tujuan perancangan awal " +
          "dan tertakluk kepada perubahan selepas audit data meter serta semakan " +
          "kejuruteraan terperinci.";

        return {
          generatedDate,
          fileDate,
          summary,
          categoryInputs,
          demandByCategory,
          altSources,
          altTotals,
          financeSummary,
          capexOpexItems,
          assumptions,
          mode: appState.mode,
          scenarioScope: pdfScopeSelect.value,
          scenariosForReport,
          sensitivity,
          charts,
          disclaimerText,
          logoDataUrl: umsLogoDataUrl,
          confidential: Boolean(confidentialToggle?.checked),
        };
      }

      // BEGIN REPORT UPDATE
      function renderReportHTML(data) {
        const statusAvg = formatStatusLabel(data.summary.status.avg, false);
        const statusPeak = formatStatusLabel(data.summary.status.peak, true);

        const tocItems = [
          { id: "exec-summary", label: "A. Ringkasan Eksekutif" },
          { id: "background", label: "B. Latar Belakang & Objektif" },
          { id: "method", label: "C. Kaedah & Andaian" },
          { id: "inputs", label: "D. Input Pengguna" },
          { id: "results", label: "E. Hasil & Jadual" },
          { id: "visuals", label: "F. Graf & Visual" },
          { id: "interpretation", label: "G. Tafsiran & Cadangan" },
          { id: "appendix", label: "H. Had, Penafian & Lampiran" },
        ];

        const demandRows = data.demandByCategory.length
          ? data.demandByCategory
              .map(
                (row) => `
                  <tr>
                    <td>${row.name}</td>
                    <td>${row.pop}</td>
                    <td>${row.percap}</td>
                    <td>${row.avg}</td>
                    <td>${row.peakFactor}</td>
                    <td>${row.peak}</td>
                  </tr>
                `
              )
              .join("")
          : `<tr><td colspan="6">Tiada data permintaan ditetapkan.</td></tr>`;

        const altRowsHtml = data.altSources.length
          ? data.altSources
              .map(
                (row) => `
                  <tr>
                    <td>${row.name}</td>
                    <td>${row.capacity}</td>
                    <td>${row.util}</td>
                    <td>${row.volume}</td>
                    <td>${row.capex}</td>
                    <td>${row.opex}</td>
                    <td>${row.saving}</td>
                    <td>${row.netcf}</td>
                    <td>${row.payback}</td>
                    <td>${row.npv}</td>
                    <td>${row.bcr}</td>
                  </tr>
                `
              )
              .join("")
          : `<tr><td colspan="11">Tiada sumber alternatif dimasukkan.</td></tr>`;

        const scenarioRows =
          data.scenarioScope === "all" && data.scenariosForReport.length
            ? data.scenariosForReport
                .map((s) => {
                  const sum = s.summary || {};
                  const fin = s.finance || {};
                  return `
                    <tr>
                      <td>${s.name} (${s.mode || "-"})</td>
                      <td>${formatNumber(sum.avgMLD)}</td>
                      <td>${formatNumber(sum.peakMLD)}</td>
                      <td>${formatNumber(sum.effectiveMLD)}</td>
                      <td>${formatNumber(sum.surplusAvg)}</td>
                      <td>${formatNumber(fin.npv)}</td>
                      <td>${isFinite(fin.bcr) ? formatNumber(fin.bcr) : "‚Äì"}</td>
                      <td>${isFinite(fin.irr) ? formatNumber(fin.irr) : "‚Äì"}</td>
                      <td>${isFinite(fin.payback) ? formatNumber(fin.payback) : "‚Äì"}</td>
                    </tr>
                  `;
                })
                .join("")
            : "";

        const capexOpexRows = data.capexOpexItems.length
          ? data.capexOpexItems
              .map(
                (item) => `
                  <tr>
                    <td>${item.type}</td>
                    <td>${item.name}</td>
                    <td>${item.qty}</td>
                    <td>${item.cost}</td>
                    <td>${item.total}</td>
                    <td>${item.note || "-"}</td>
                  </tr>
                `
              )
              .join("")
          : `<tr><td colspan="6">Belum ada pecahan CAPEX/OPEX item dimasukkan.</td></tr>`;

        const tocList = tocItems
          .map(
            (item) => `
              <li>
                <span class="label">${item.label}</span>
                <span class="page" data-page-ref="${item.id}">‚Äî</span>
              </li>
            `
          )
          .join("");

        const footerLabel = data.confidential
          ? "Sulit/Untuk Kegunaan Dalaman"
          : "&nbsp;";

        const cover = `
          <section class="report-page cover" id="cover">
            <div class="logo-box">
              ${
                data.logoDataUrl
                  ? `<img src="${data.logoDataUrl}" alt="Logo Universiti Malaysia Sabah" />`
                  : `<div>UMS</div>`
              }
            </div>
            <div>
              <div class="kicker" style="color:#0c2d57;">Kalkulator Permintaan &amp; Bekalan Air</div>
              <h1>LAPORAN PERMINTAAN, BEKALAN DAN SUMBER AIR ALTERNATIF<br/>UNIVERSITI MALAYSIA SABAH</h1>
              <p class="meta">Tarikh jana: ${data.generatedDate}</p>
              <p class="meta">Disediakan oleh: Prof. Madya Dr. Assis Kamu (Ketua); Dr. Fera @ Nony Cleophas; Dr. Sarimah Surianshah; Prof. Madya Ts. Dr. Mohd Sani Sarjadi</p>
              <p class="tagline">Dokumen rasmi untuk rujukan pengurusan, perancangan bekalan air kampus dan pembentangan dalaman.</p>
            </div>
          </section>
        `;

        const pageShell = (id, title, subtitle, body) => `
          <section class="report-page" id="${id}">
            <div class="page-header">
              <span>Laporan Permintaan &amp; Bekalan Air UMS</span>
              <span>${data.generatedDate}</span>
            </div>
            <div class="section-block">
              <p class="section-tagline">${title}</p>
              ${subtitle ? `<h2 class="section-title">${subtitle}</h2>` : ""}
              ${body}
            </div>
            <div class="page-footer">
              <span>${footerLabel}</span>
              <span>Laporan Air UMS ‚Äì ${data.generatedDate}</span>
              <span class="page-number"></span>
            </div>
          </section>
        `;

        const execPage = pageShell(
          "exec-summary",
          "A. Ringkasan Eksekutif",
          "Sorotan Utama",
          `
            <p class="justified">
              Permintaan purata kampus dianggarkan <strong>${data.summary.text.avg} MLD</strong> dan permintaan puncak <strong>${data.summary.text.peak} MLD</strong>.
              Bekalan asas (JANS) sebanyak <strong>${data.summary.text.supply} MLD</strong> digabungkan dengan sumber alternatif <strong>${data.summary.text.alt} MLD</strong> menghasilkan bekalan efektif <strong>${data.summary.text.effective} MLD</strong>.
              Status semasa: <strong>${statusAvg}</strong> untuk purata dan <strong>${statusPeak}</strong> untuk puncak.
            </p>
            <p class="justified">
              Mod analisis: <strong>${data.mode}</strong>. Skop laporan PDF: <strong>${data.scenarioScope === "all" ? "Semua senario" : "Senario aktif"}</strong>.
            </p>
            <div class="page-grid">
              <div class="page-card">
                <h4>Impak bekalan</h4>
                <p class="justified">Surplus/defisit purata: ${data.summary.text.surplusAvg} MLD. Surplus/defisit puncak: ${data.summary.text.surplusPeak} MLD.</p>
              </div>
              <div class="page-card">
                <h4>Sorotan kewangan</h4>
                <p class="justified">CAPEX: ${data.financeSummary.capex}; OPEX tahunan: ${data.financeSummary.opex}; Penjimatan tahunan: ${data.financeSummary.saving}; NPV: ${data.financeSummary.npv}; BCR: ${data.financeSummary.bcr}; IRR anggaran: ${data.financeSummary.irr}.</p>
              </div>
            </div>
            <p class="justified">
              Laporan ini menambah naratif pengurusan air, memaparkan jadual terperinci dan graf resolusi tinggi supaya sesuai dicetak.
              Seksyen berikut menerangkan latar belakang, kaedah, input pengguna, tafsiran jurang, cadangan fasa pelaksanaan serta lampiran.
            </p>
          `
        );

        const backgroundPage = pageShell(
          "background",
          "B. Latar Belakang & Objektif",
          "Mengapa laporan ini penting",
          `
            <p class="justified">
              UMS perlu mengimbangi permintaan air yang meningkat dengan bekalan yang stabil. Aktiviti akademik, asrama, ibadah dan sukan memerlukan perancangan rapi supaya bekalan asas tidak terganggu.
              Sumber alternatif seperti air hujan, reuse, air tasik dan kondensasi penghawa dingin dapat menutup jurang bekalan sekaligus menjimatkan kos utiliti.
            </p>
            <p class="justified">
              Objektif laporan ialah menganggarkan permintaan purata dan puncak, membandingkannya dengan bekalan asas, menilai sumbangan alternatif serta menyediakan pelan tindakan yang boleh dicetak untuk pihak pengurusan.
            </p>
            <ul class="list-tight">
              <li>Menyediakan gambaran cepat jurang permintaan‚Äìbekalan.</li>
              <li>Menyeragamkan naratif kewangan (CAPEX, OPEX, penjimatan, NPV, BCR, IRR).</li>
              <li>Menyusun cadangan mengikut fasa pelaksanaan.</li>
              <li>Merekod had analisis untuk rujukan audit data meter.</li>
            </ul>
          `
        );

        const methodPage = pageShell(
          "method",
          "C. Kaedah & Andaian",
          "Pendekatan pengiraan",
          `
            <p class="justified">
              Pengiraan menggunakan kadar per kapita, faktor puncak dan bekalan asas yang dimasukkan pengguna. Sumber alternatif dimodelkan dengan kapasiti teknikal, utiliti harian, CAPEX, OPEX dan jangka hayat.
              Penjimatan kewangan dikira menggunakan tarif air + pembetungan serta kadar diskaun analisis.
            </p>
            <p class="justified">
              Semua input dinormalisasi kepada unit m¬≥/hari dan m¬≥/tahun bagi memudahkan perbandingan. Kadar diskaun diterapkan secara konsisten ke atas manfaat dan kos bagi mengelakkan percanggahan antara projek, manakala payback dikemukakan sebagai indikator pantas untuk keputusan awal.
            </p>
            <div class="page-grid">
              <div class="page-card">
                <h4>Permintaan</h4>
                <ul class="list-tight">
                  <li>Populasi √ó per kapita (L/org/hari) ‚Üí m¬≥/hari.</li>
                  <li>Faktor puncak melaraskan variasi harian tertinggi.</li>
                  <li>Jadual kategori memastikan kesan setiap segmen jelas.</li>
                </ul>
              </div>
              <div class="page-card">
                <h4>Bekalan</h4>
                <ul class="list-tight">
                  <li>Bekalan asas (JANS) sebagai rujukan utama.</li>
                  <li>Sumber alternatif: kapasiti √ó utiliti (% hari) ‚Üí m¬≥/hari berkesan.</li>
                  <li>Campuran bekalan membentuk bekalan efektif.</li>
                </ul>
              </div>
              <div class="page-card">
                <h4>Ekonomi</h4>
                <ul class="list-tight">
                  <li>Penjimatan tahunan = volum alternatif √ó (tarif air + pembetungan).</li>
                  <li>NPV dan BCR menggunakan kadar diskaun & tempoh analisis.</li>
                  <li>Tempoh pulangan modal = CAPEX / aliran tunai bersih tahunan.</li>
                </ul>
              </div>
            </div>
            <p class="justified">
              Data yang dimasukkan perlu disemak bersama rekod meter, log operasi pam dan rekod penyelenggaraan supaya model sentiasa dikemas kini. Pengguna digalakkan menjalankan semakan sensitiviti (contoh: +/‚Äì10% populasi atau per kapita) bagi memahami julat risiko bekalan.
            </p>
            <p class="justified">
              Kajian ini disediakan untuk kegunaan dalaman dan memerlukan semakan semula apabila data meter baharu tersedia atau tarif dikemas kini. Jadual andaian boleh dijadikan lampiran mesyuarat untuk memudahkan semakan silang dengan pihak teknikal dan kewangan.
            </p>
          `
        );

        const inputsPage = pageShell(
          "inputs",
          "D. Input Pengguna",
          "Andaian dan parameter dikira",
          `
            <div class="inline-table">
              <div class="box">
                <div class="label">Bekalan asas (JANS)</div>
                <div><strong>${data.assumptions.supply || "‚Äì"} MLD</strong></div>
              </div>
              <div class="box">
                <div class="label">Tarif air (RM/m¬≥)</div>
                <div>${data.assumptions.tariffWater || "‚Äì"}</div>
              </div>
              <div class="box">
                <div class="label">Tarif pembetungan (RM/m¬≥)</div>
                <div>${data.assumptions.tariffSewer || "‚Äì"}</div>
              </div>
              <div class="box">
                <div class="label">Tempoh analisis (tahun)</div>
                <div>${data.assumptions.years || "‚Äì"}</div>
              </div>
              <div class="box">
                <div class="label">Kadar diskaun (%)</div>
                <div>${data.assumptions.discount || "‚Äì"}</div>
              </div>
            </div>
            <p class="justified">Jadual di bawah menyenaraikan input kategori pengguna yang dimasukkan.</p>
            <table class="report-table zebra wide-table">
              <thead>
                <tr>
                  <th>Kategori</th>
                  <th>Populasi</th>
                  <th>Per kapita (L/org/hari)</th>
                  <th>Purata (m¬≥/hari)</th>
                  <th>Faktor puncak</th>
                  <th>Permintaan puncak (m¬≥/hari)</th>
                </tr>
              </thead>
              <tbody>${demandRows}</tbody>
            </table>
          `
        );

        const resultsPage = pageShell(
          "results",
          "E. Hasil & Jadual",
          "Permintaan, bekalan dan alternatif",
          `
            <table class="report-table zebra wide-table">
              <thead>
                <tr>
                  <th>Item</th>
                  <th>Nilai</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                <tr><td>Permintaan purata</td><td>${data.summary.text.avg}</td><td>${statusAvg}</td></tr>
                <tr><td>Permintaan puncak</td><td>${data.summary.text.peak}</td><td>${statusPeak}</td></tr>
                <tr><td>Bekalan sedia ada (JANS)</td><td>${data.summary.text.supply}</td><td>‚Äî</td></tr>
                <tr><td>Bekalan sumber alternatif</td><td>${data.summary.text.alt}</td><td>‚Äî</td></tr>
                <tr><td>Bekalan efektif</td><td>${data.summary.text.effective}</td><td>‚Äî</td></tr>
                <tr><td>Lebihan / Defisit purata</td><td>${data.summary.text.surplusAvg}</td><td>‚Äî</td></tr>
                <tr><td>Lebihan / Defisit puncak</td><td>${data.summary.text.surplusPeak}</td><td>‚Äî</td></tr>
              </tbody>
            </table>
            ${
              scenarioRows
                ? `<p class="justified">Perbandingan semua senario (dipilih untuk laporan):</p>
            <table class="report-table zebra wide-table">
              <thead>
                <tr>
                  <th>Senario</th>
                  <th>Permintaan purata (MLD)</th>
                  <th>Permintaan puncak (MLD)</th>
                  <th>Bekalan efektif (MLD)</th>
                  <th>Lebihan/Defisit purata</th>
                  <th>NPV (RM)</th>
                  <th>BCR</th>
                  <th>IRR (%)</th>
                  <th>Payback (tahun)</th>
                </tr>
              </thead>
              <tbody>${scenarioRows}</tbody>
            </table>`
                : ""
            }
            <p class="justified">Ringkasan kewangan projek:</p>
            <div class="inline-table">
              <div class="box"><div class="label">CAPEX</div><div>${data.financeSummary.capex}</div></div>
              <div class="box"><div class="label">OPEX tahunan</div><div>${data.financeSummary.opex}</div></div>
              <div class="box"><div class="label">Penjimatan tahunan</div><div>${data.financeSummary.saving}</div></div>
              <div class="box"><div class="label">Aliran tunai bersih</div><div>${data.financeSummary.netcf}</div></div>
              <div class="box"><div class="label">NPV</div><div>${data.financeSummary.npv}</div></div>
              <div class="box"><div class="label">BCR</div><div>${data.financeSummary.bcr}</div></div>
              <div class="box"><div class="label">IRR anggaran</div><div>${data.financeSummary.irr}</div></div>
            </div>
            <p class="justified">
              Jadual permintaan dan bekalan menunjukkan bagaimana bekalan alternatif menutup jurang. Jika nilai surplus puncak negatif, tindakan segera perlu difokuskan kepada sumber berpayback pendek seperti tangkapan air hujan atau pengurangan kebocoran dalaman supaya bekalan asas tidak tertekan.
            </p>
            <p class="justified">
              Nilai kewangan menggambarkan kebolehlaksanaan awal. NPV positif dan BCR melebihi 1 menandakan projek wajar diteruskan; sekiranya NPV negatif, pelarasan kos atau fasa pelaksanaan berperingkat perlu dipertimbangkan sebelum pembentangan kepada pengurusan.
            </p>
            <p class="justified">Jadual sumber air alternatif:</p>
            <table class="report-table zebra wide-table">
              <thead>
                <tr>
                  <th>Sumber</th>
                  <th>Kapasiti (m¬≥/hari)</th>
                  <th>Utilisasi (% hari)</th>
                  <th>Vol. tahunan (m¬≥/tahun)</th>
                  <th>CAPEX (RM)</th>
                  <th>OPEX (RM/tahun)</th>
                  <th>Saving (RM/tahun)</th>
                  <th>CF bersih (RM/tahun)</th>
                  <th>Tempoh pulangan modal (tahun)</th>
                  <th>NPV (RM)</th>
                  <th>BCR</th>
                </tr>
              </thead>
              <tbody>${altRowsHtml}</tbody>
              <tfoot>
                <tr>
                  <td>Jumlah / Agregat</td>
                  <td>${data.altTotals.capacity}</td>
                  <td>‚Äî</td>
                  <td>${data.altTotals.volume}</td>
                  <td>${data.altTotals.capex}</td>
                  <td>${data.altTotals.opex}</td>
                  <td>${data.altTotals.saving}</td>
                  <td>${data.altTotals.netcf}</td>
                  <td>‚Äî</td>
                  <td>${data.altTotals.npv}</td>
                  <td>${data.altTotals.bcr}</td>
                </tr>
              </tfoot>
            </table>
          `
        );

        const visualsPage = pageShell(
          "visuals",
          "F. Graf & Visual",
          "Graf sokongan",
          `
            ${data.charts.supplyDemand ? `<div class="captioned-image"><img src="${data.charts.supplyDemand}" alt="Permintaan vs bekalan" /><div class="caption">Rajah 1: Permintaan purata & puncak berbanding bekalan efektif.</div></div>` : ""}
            ${data.charts.altComposition ? `<div class="captioned-image"><img src="${data.charts.altComposition}" alt="Komposisi sumber alternatif" /><div class="caption">Rajah 2: Komposisi bekalan berkesan sumber air alternatif.</div></div>` : ""}
            ${data.charts.demandByCategory ? `<div class="captioned-image"><img src="${data.charts.demandByCategory}" alt="Permintaan mengikut kategori" /><div class="caption">Rajah 3: Permintaan purata dan puncak mengikut kategori.</div></div>` : ""}
            ${data.charts.demandShare ? `<div class="captioned-image"><img src="${data.charts.demandShare}" alt="Agihan permintaan" /><div class="caption">Rajah 4: Agihan permintaan (%) mengikut kategori.</div></div>` : ""}
            ${data.charts.cbaNPV ? `<div class="captioned-image"><img src="${data.charts.cbaNPV}" alt="NPV sumber alternatif" /><div class="caption">Rajah 5: NPV mengikut sumber alternatif.</div></div>` : ""}
            ${data.charts.cbaPayback ? `<div class="captioned-image"><img src="${data.charts.cbaPayback}" alt="Pulangan modal sumber alternatif" /><div class="caption">Rajah 6: Tempoh pulangan modal mengikut sumber alternatif.</div></div>` : ""}
            <p class="page-note">Graf diambil terus daripada Chart.js menggunakan toBase64Image untuk mengelak ikon rosak dan menjaga resolusi cetakan.</p>
          `
        );

        const interpretationPage = pageShell(
          "interpretation",
          "G. Tafsiran & Cadangan",
          "Implikasi permintaan‚Äìbekalan & roadmap",
          `
            <p class="justified">
              Jurang bekalan ditentukan oleh perbezaan antara permintaan puncak dan bekalan efektif.
              Sekiranya defisit kekal, risiko gangguan operasi meningkat. Intervensi pengurusan permintaan
              (audit kebocoran, retrofit peralatan, kempen kesedaran) perlu dilaksanakan serentak dengan projek alternatif.
            </p>
            <p class="justified">
              Setiap cadangan perlu disandarkan kepada jadual CAPEX/OPEX supaya implikasi bajet jelas. Untuk projek dengan payback lebih panjang, pendekatan berfasa membolehkan universiti memaksimumkan penjimatan jangka pendek sambil merancang infrastruktur jangka panjang.
            </p>
            <div class="page-grid">
              <div class="page-card">
                <h4>Risiko operasi</h4>
                <ul class="list-tight">
                  <li>Defisit puncak boleh menjejaskan asrama dan makmal.</li>
                  <li>Kadar per kapita tinggi menunjukkan keperluan retrofit segera.</li>
                  <li>Kekurangan bekalan penimbal meningkatkan kebergantungan kepada JANS.</li>
                </ul>
              </div>
              <div class="page-card">
                <h4>Impak kewangan</h4>
                <ul class="list-tight">
                  <li>Tempoh pulangan modal yang pendek membantu meyakinkan pembuat keputusan.</li>
                  <li>NPV negatif perlu dikaji semula dengan data kos sebenar.</li>
                  <li>BCR &gt; 1 menunjukkan projek wajar diteruskan.</li>
                </ul>
              </div>
            </div>
            <p class="justified">
              Data sebenar meter air, log operasi dan rekod OPEX perlu digunakan untuk menala semula model.
              Laporan ini menyediakan rangka bercetak untuk dikongsi dengan pengurusan dan perunding.
            </p>
            <p class="justified">
              Hasil analisis juga boleh digunakan sebagai asas permohonan bajet atau geran. Nyatakan keutamaan berdasarkan risiko dan manfaat, serta tunjukkan kesan kepada kesinambungan operasi kampus bagi memperkukuh justifikasi projek.
            </p>
            <div class="phase-grid">
              <div class="phase-card">
                <h4>Fasa 1: Quick Wins (0‚Äì6 bulan)</h4>
                <ul class="list-tight">
                  <li>Tangkapan air hujan berskala kecil di bangunan tumpuan.</li>
                  <li>Pengumpulan kondensasi penghawa dingin untuk landskap.</li>
                  <li>Audit kebocoran dalaman dan pemasangan meter sub-zon.</li>
                </ul>
              </div>
              <div class="phase-card">
                <h4>Fasa 2: Pengukuhan (6‚Äì18 bulan)</h4>
                <ul class="list-tight">
                  <li>Sistem reuse untuk tandas/pembersihan dan sambungan tangki penimbal.</li>
                  <li>Kemas kini tarif &amp; OPEX berdasarkan kontrak sebenar.</li>
                  <li>Latihan operasi dan SOP kecemasan bekalan.</li>
                </ul>
              </div>
              <div class="phase-card">
                <h4>Fasa 3: Skala Penuh (18‚Äì36 bulan)</h4>
                <ul class="list-tight">
                  <li>Pembangunan sumber air tasik atau kolam rawatan awal.</li>
                  <li>Integrasi SCADA/IoT untuk pemantauan dan pengoptimuman.</li>
                  <li>Pelan campuran sumber untuk memaksimumkan BCR/NPV.</li>
                </ul>
              </div>
            </div>
            <p class="page-note">Keutamaan boleh dilaras mengikut bajet dan risiko operasi semasa kampus.</p>
          `
        );

        const appendixPage = pageShell(
          "appendix",
          "I. Had, Penafian & Lampiran",
          "Catatan tambahan",
          `
            <div class="risk-grid">
              <div class="risk-card">
                <strong>Had data</strong>
                <p class="justified">Populasi dan kadar per kapita mungkin berubah mengikut semester; kemas kini diperlukan.</p>
              </div>
              <div class="risk-card">
                <strong>Variasi iklim</strong>
                <p class="justified">Sumber air hujan bergantung kepada corak hujan; gunakan data tempatan yang terkini.</p>
              </div>
              <div class="risk-card">
                <strong>Ketidakpastian kos</strong>
                <p class="justified">Tarif dan OPEX sebenar perlu disahkan bagi mengelak over/under-estimate penjimatan.</p>
              </div>
              <div class="risk-card">
                <strong>Integrasi teknikal</strong>
                <p class="justified">Sambungan ke tangki, pam dan paip sedia ada memerlukan semakan teknikal terperinci.</p>
              </div>
            </div>
            <p class="justified">
              Had ini perlu dibaca bersama hasil analisis supaya pembuat keputusan memahami ketidakpastian. Ujian tekanan terhadap variasi hujan, gangguan tenaga dan penutupan loji rawatan akan membantu merancang kapasiti simpanan dan laluan pengagihan alternatif.
            </p>
            <p class="justified">
              <strong>Penafian:</strong> ${data.disclaimerText} Perincian tambahan hendaklah dilampirkan apabila data baharu diterima untuk memastikan angka terkini dan konsisten dengan audit dalaman.
            </p>
            <p class="justified">
              Ringkasan CAPEX/OPEX terperinci di bawah memudahkan semakan pantas oleh pihak kewangan dan teknikal. Item kosong boleh diisi kemudian tanpa menjejaskan format laporan.
            </p>
            <p class="justified"><strong>Analisis sensitiviti (+/‚àí10%):</strong></p>
            <table class="report-table zebra">
              <thead>
                <tr>
                  <th>Senario sensitiviti</th>
                  <th>NPV (RM)</th>
                  <th>BCR</th>
                </tr>
              </thead>
              <tbody>
                <tr><td>Asas</td><td>${formatNumber(data.sensitivity.base.npv)}</td><td>${isFinite(data.sensitivity.base.bcr) ? formatNumber(data.sensitivity.base.bcr) : "‚Äì"}</td></tr>
                <tr><td>CAPEX +10%</td><td>${formatNumber(data.sensitivity.capex.npv)}</td><td>${isFinite(data.sensitivity.capex.bcr) ? formatNumber(data.sensitivity.capex.bcr) : "‚Äì"}</td></tr>
                <tr><td>OPEX +10%</td><td>${formatNumber(data.sensitivity.opex.npv)}</td><td>${isFinite(data.sensitivity.opex.bcr) ? formatNumber(data.sensitivity.opex.bcr) : "‚Äì"}</td></tr>
                <tr><td>Manfaat +10%</td><td>${formatNumber(data.sensitivity.benefit.npv)}</td><td>${isFinite(data.sensitivity.benefit.bcr) ? formatNumber(data.sensitivity.benefit.bcr) : "‚Äì"}</td></tr>
              </tbody>
            </table>
            <table class="report-table zebra">
              <thead>
                <tr>
                  <th>Jenis</th>
                  <th>Item / Komponen</th>
                  <th>Kuantiti</th>
                  <th>Kos seunit (RM)</th>
                  <th>Jumlah kos (RM)</th>
                  <th>Catatan</th>
                </tr>
              </thead>
              <tbody>${capexOpexRows}</tbody>
            </table>
          `
        );

        return [
          cover,
          pageShell(
            "toc",
          "Isi Kandungan",
          "Senarai kandungan laporan",
          `
              <p class="justified">Senarai kandungan di bawah disusun mengikut urutan halaman laporan yang dijana.</p>
              <ol class="toc-list">${tocList}</ol>
            `
          ),
          execPage,
          backgroundPage,
          methodPage,
          inputsPage,
          resultsPage,
          visualsPage,
          interpretationPage,
          appendixPage,
        ].join("");
      }

      function applyPageNumbers(container) {
        const pages = Array.from(container.querySelectorAll(".report-page"));
        const total = pages.length;
        pages.forEach((page, idx) => {
          const numEl = page.querySelector(".page-number");
          if (numEl) {
            numEl.textContent = `Halaman ${idx + 1} daripada ${total}`;
          }
        });
        const tocRefs = container.querySelectorAll("[data-page-ref]");
        tocRefs.forEach((el) => {
          const target = el.getAttribute("data-page-ref");
          const pageIdx = pages.findIndex((p) => p.id === target);
          el.textContent = pageIdx >= 0 ? pageIdx + 1 : "‚Äì";
        });
      }

      async function generateReportPDF() {
        const { jsPDF } = window.jspdf || {};
        if (!jsPDF) {
          alert("Library jsPDF tidak dimuatkan.");
          return;
        }

        await loadUmsLogoDataUrl();
        const data = await collectReportData();
        reportRoot.innerHTML = renderReportHTML(data);
        reportRoot.classList.remove("hidden");
        reportRoot.classList.add("offscreen");

        await waitForFonts();
        await waitForImages(reportRoot);
        applyPageNumbers(reportRoot);

        const pages = Array.from(reportRoot.querySelectorAll(".report-page"));
        const doc = new jsPDF({ unit: "mm", format: "a4", orientation: "portrait" });
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();

        for (let i = 0; i < pages.length; i += 1) {
          const canvas = await html2canvas(pages[i], {
            scale: 2.5,
            useCORS: true,
            backgroundColor: "#ffffff",
          });
          const imgData = canvas.toDataURL("image/png", 1);
          const imgProps = doc.getImageProperties(imgData);
          const pdfWidth = pageWidth;
          const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
          if (i > 0) doc.addPage();
          doc.addImage(imgData, "PNG", 0, 0, pdfWidth, pdfHeight);
        }

        reportRoot.classList.add("hidden");
        doc.save(`Laporan_UMS_Water_${data.fileDate}.pdf`);
      }
      // END REPORT UPDATE

      addItemBtn.addEventListener("click", () => {
        const tr = createCapexOpexRow();
        capexOpexBody.appendChild(tr);
        recalcCapexOpexItems();
      });

      capexOpexBody.addEventListener("input", (e) => {
        if (
          e.target.classList.contains("item-qty") ||
          e.target.classList.contains("item-cost") ||
          e.target.classList.contains("item-type")
        ) {
          recalcCapexOpexItems();
        }
      });

      // Add rows for demand categories
      addRowBtn.addEventListener("click", () => {
        const tr = createCategoryRow();
        categoryBody.appendChild(tr);
      });

      // Add rows for alternative sources
      addAltRowBtn.addEventListener("click", () => {
        const tr = createAltRow();
        altBody.appendChild(tr);
      });

      calcBtn.addEventListener("click", () => {
        recalcCapexOpexItems();
        calculate();
      });

      // Export Excel
      exportBtn.addEventListener("click", () => {
        try {
          if (typeof XLSX === "undefined") {
            alert("Library Excel (SheetJS) tidak dimuatkan.");
            return;
          }

          // Ensure latest calculations
          recalcCapexOpexItems();
          calculate();

          const wb = XLSX.utils.book_new();

          // Sheet 0: Mod & Senario
          const metaRows = [
            ["Mod dipilih", appState.mode],
            ["Senario aktif", activeScenario()?.name || ""],
            ["Skop laporan PDF", pdfScopeSelect.value === "all" ? "Semua senario" : "Senario aktif"],
            ["Bekalan asas (MLD)", supplyInput.value],
            ["Tarif air (RM/m¬≥)", tariffWaterInput.value],
            ["Tarif pembetungan (RM/m¬≥)", tariffSewerInput.value],
            ["Tempoh analisis (tahun)", analysisYearsInput.value],
            ["Kadar diskaun (%)", discountRateInput.value],
          ];
          const scenarioRows = [
            ["Senario", "Mod", "Permintaan purata (MLD)", "Permintaan puncak (MLD)", "Bekalan efektif (MLD)", "Lebihan/Defisit purata", "NPV", "BCR", "IRR (%)", "Payback (tahun)"],
          ];
          Object.values(appState.scenarios).forEach((sc) => {
            const sum = sc.outputs?.summary || {};
            const fin = sc.outputs?.finance || {};
            scenarioRows.push([
              sc.name,
              sc.mode,
              formatNumber(sum.avgMLD),
              formatNumber(sum.peakMLD),
              formatNumber(sum.effectiveMLD),
              formatNumber(sum.surplusAvg),
              formatNumber(fin.npv),
              isFinite(fin.bcr) ? formatNumber(fin.bcr) : "‚Äì",
              isFinite(fin.irr) ? formatNumber(fin.irr) : "‚Äì",
              isFinite(fin.payback) ? formatNumber(fin.payback) : "‚Äì",
            ]);
          });
          const wsMeta = XLSX.utils.aoa_to_sheet(metaRows.concat([[]], scenarioRows));
          XLSX.utils.book_append_sheet(wb, wsMeta, "Mod_Senario");

          // Sheet 1: Kategori demand
          const catRows = [["Kategori", "Populasi", "Per kapita (L/org/hari)", "Purata (m¬≥/hari)", "Faktor puncak", "Permintaan puncak (m¬≥/hari)"]];
          document.querySelectorAll("#results-body tr").forEach((tr) => {
            const cells = Array.from(tr.querySelectorAll("td")).map((td) =>
              td.textContent.trim()
            );
            if (cells.length) catRows.push(cells);
          });
          const totalsRow1 = [
            "Jumlah",
            document.getElementById("total-pop").textContent,
            "",
            document.getElementById("total-avg-m3").textContent,
            "",
            document.getElementById("total-peak-m3").textContent,
          ];
          const totalsRow2 = [
            "Jumlah dalam MLD",
            "",
            "",
            document.getElementById("total-avg-mld").textContent,
            "",
            document.getElementById("total-peak-mld").textContent,
          ];
          catRows.push(totalsRow1, totalsRow2);
          const wsCat = XLSX.utils.aoa_to_sheet(catRows);
          XLSX.utils.book_append_sheet(wb, wsCat, "Kategori");

          // Sheet 2: Ringkasan demand‚Äìsupply
          const summaryRows = [
            ["Item", "Nilai (MLD)"],
            ["Jumlah permintaan purata", document.getElementById("summary-avg-mld").textContent],
            ["Jumlah permintaan puncak", document.getElementById("summary-peak-mld").textContent],
            ["Bekalan sedia ada (JANS)", document.getElementById("supply-avg-mld").textContent],
            ["Extra supply (alt sources)", document.getElementById("alt-supply-mld").textContent],
            ["Bekalan efektif", document.getElementById("effective-supply-mld").textContent],
            ["Lebihan / Defisit purata", document.getElementById("surplus-avg-mld").textContent],
            ["Lebihan / Defisit puncak", document.getElementById("surplus-peak-mld").textContent],
          ];
          const wsSum = XLSX.utils.aoa_to_sheet(summaryRows);
          XLSX.utils.book_append_sheet(wb, wsSum, "Ringkasan");

          // Sheet 3: CBA alternatif
          const cbaRows = [[
            "Sumber",
            "Kapasiti (m¬≥/hari)",
            "Utilisasi (% hari)",
            "Kebolehpercayaan (%)",
            "Vol. tahunan (m¬≥/tahun)",
            "CAPEX (RM)",
            "OPEX tahunan (RM/tahun)",
            "Saving air + pembetungan (RM/tahun)",
            "CF bersih (RM/tahun)",
            "Tempoh pulangan modal (tahun)",
            "NPV (RM)",
            "BCR"
          ]];
          document.querySelectorAll("#alt-results-body tr").forEach((tr) => {
            const cells = Array.from(tr.querySelectorAll("td")).map((td) =>
              td.textContent.trim()
            );
            if (cells.length) cbaRows.push(cells);
          });
          const cbaTotalsRow = [
            "Jumlah / Agregat",
            document.getElementById("alt-total-capacity").textContent,
            "",
            "",
            document.getElementById("alt-total-volume").textContent,
            document.getElementById("alt-total-capex").textContent,
            document.getElementById("alt-total-opex").textContent,
            document.getElementById("alt-total-saving").textContent,
            document.getElementById("alt-total-netcf").textContent,
            "",
            document.getElementById("alt-total-npv").textContent,
            document.getElementById("alt-total-bcr").textContent,
          ];
          cbaRows.push(cbaTotalsRow);
          const wsCBA = XLSX.utils.aoa_to_sheet(cbaRows);
          XLSX.utils.book_append_sheet(wb, wsCBA, "CBA_Alt_Sources");

          // Sheet 4: Itemised CAPEX & OPEX
          const itemRows = [[
            "Jenis",
            "Item / Komponen",
            "Kuantiti",
            "Kos seunit (RM)",
            "Jumlah kos (RM)",
            "Catatan"
          ]];
          document.querySelectorAll("#capex-opex-body tr").forEach((tr) => {
            const type = tr.querySelector(".item-type").value || "";
            const name = tr.querySelector(".item-name").value || "";
            const qty = tr.querySelector(".item-qty").value || "";
            const cost = tr.querySelector(".item-cost").value || "";
            const total = tr.querySelector(".item-total").textContent || "";
            const note = tr.querySelector(".item-note").value || "";
            if (name.trim() || parseFloat(qty) > 0 || parseFloat(cost) > 0) {
              itemRows.push([type, name, qty, cost, total, note]);
            }
          });
          itemRows.push(
            ["Jumlah CAPEX", "", "", "", document.getElementById("capex-items-total").textContent, ""],
            ["Jumlah OPEX", "", "", "", document.getElementById("opex-items-total").textContent, ""]
          );
          const wsItems = XLSX.utils.aoa_to_sheet(itemRows);
          XLSX.utils.book_append_sheet(wb, wsItems, "CAPEX_OPEX_Itemised");

          XLSX.writeFile(wb, "UMS_Water_Demand_Supply_CBA.xlsx");
        } catch (e) {
          console.error(e);
          alert("Ralat semasa export Excel. Sila cuba lagi.");
        }
      });

      generateReportBtn.addEventListener("click", () => {
        generateReportPDF();
      });

      modeSelector.addEventListener("click", (e) => {
        const pill = e.target.closest(".pill");
        if (!pill) return;
        setMode(pill.dataset.mode);
        calculate();
      });

      autofillBtn.addEventListener("click", () => {
        quickInputs.pop.value = 15000;
        quickInputs.percap.value = 160;
        quickInputs.demand.value = "";
        quickInputs.peak.value = 1.3;
        quickInputs.baseSupply.value = 5;
        quickAltInputs.name.value = "Tangkapan air hujan mini";
        quickAltInputs.capacity.value = 250;
        quickAltInputs.util.value = 80;
        quickAltInputs.capex.value = 900000;
        quickAltInputs.opex.value = 50000;
        supplyInput.value = 5;
        tariffWaterInput.value = 1.2;
        tariffSewerInput.value = 0.8;
        analysisYearsInput.value = 20;
        discountRateInput.value = 5;
        calculate();
      });

      fixInputBtn.addEventListener("click", () => {
        const invalid = document.querySelector(".invalid");
        if (invalid) {
          invalid.focus();
        } else {
          alert("Tiada input rosak dikesan. Anda boleh terus mengira.");
        }
      });

      scenarioListEl.addEventListener("click", (e) => {
        const btn = e.target.closest(".btn-load-scenario");
        if (btn) {
          setActiveScenario(btn.dataset.id);
        }
      });

      addScenarioBtn.addEventListener("click", addScenario);
      duplicateScenarioBtn.addEventListener("click", duplicateScenario);
      renameScenarioBtn.addEventListener("click", renameScenario);
      deleteScenarioBtn.addEventListener("click", deleteScenario);
      saveScenarioBtn.addEventListener("click", () => {
        saveActiveScenario();
        alert("Senario disimpan dalam pelayar.");
      });

      // Kiraan awal dengan nilai contoh
      loadState();
      renderScenarioList();
      setMode(appState.mode);
      applyScenarioInputs(activeScenario().inputs);
      loadUmsLogoDataUrl();
      recalcCapexOpexItems();
      calculate();
    });
  </script>
</body>
</html>
