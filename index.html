<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <title>Kalkulator Permintaan & Bekalan Air UMS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Chart.js (graf) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- SheetJS (Export Excel) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- html2canvas untuk render HTML ke kanvas (PDF) -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <!-- jsPDF (Penjanaan PDF profesional) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- jsPDF AutoTable untuk jadual berbilang halaman -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <!-- PptxGenJS (bundle termasuk JSZip) -->
  <script src="https://cdn.jsdelivr.net/gh/gitbrent/pptxgenjs/dist/pptxgen.bundle.js"></script>

  <style>
    :root {
      --primary: #0d6efd;
      --primary-light: #e0f4ff;
      --primary-dark: #054a91;
      --accent: #00bcd4;
      --danger: #ff1744;
      --success: #00c853;
      --bg: #f5fbff;
      --sticky-top-offset: 120px;
      --sticky-bottom-padding: 96px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        Roboto, sans-serif;
      color: #12324a;
      background:
        radial-gradient(circle at top, #cbe9ff 0, #f5fbff 45%, #ffffff 100%);
      position: relative;
      overflow-x: hidden;
    }

    /* background â€œairâ€ halus */
    body::before {
      content: "";
      position: fixed;
      inset: -20vh -10vw auto;
      height: 60vh;
      background:
        radial-gradient(circle at 20% 20%, rgba(255,255,255,0.7) 0, transparent 55%),
        radial-gradient(circle at 80% 10%, rgba(255,255,255,0.6) 0, transparent 55%),
        linear-gradient(135deg, rgba(13,110,253,0.25), rgba(0,188,212,0.15));
      opacity: 0.7;
      z-index: -2;
      pointer-events: none;
    }

    header {
      background: linear-gradient(135deg, var(--primary-dark), var(--accent));
      color: #fff;
      padding: 1.4rem 1rem;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.18);
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(6px);
    }

    .header-inner {
      max-width: 1100px;
      margin: 0 auto;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }

    header h1 {
      margin: 0;
      font-size: 1.45rem;
      letter-spacing: 0.02em;
    }

    header p {
      margin: 0.15rem 0 0;
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.35rem 0.8rem;
      border-radius: 999px;
      background-color: rgba(255, 255, 255, 0.15);
      font-size: 0.8rem;
      align-self: flex-start;
    }

    .badge span { font-size: 1.1rem; }

    .pill-group {
      display: inline-flex;
      gap: 0.35rem;
      flex-wrap: wrap;
    }

    .pill {
      padding: 0.35rem 0.75rem;
      border-radius: 999px;
      border: 1px solid #c5d9ec;
      background: #f7fbff;
      font-weight: 700;
      color: #1e3f63;
      cursor: pointer;
      user-select: none;
      transition: all 0.15s ease;
    }

    .pill.active {
      border-color: var(--primary);
      background: linear-gradient(135deg, var(--primary-light), #ffffff);
      box-shadow: 0 6px 16px rgba(13, 110, 253, 0.15);
    }

    .pill small { display: block; font-weight: 500; color: #4c6480; }

    .mode-note {
      font-size: 0.85rem;
      color: #4f6a86;
      margin-top: 0.4rem;
    }

    .inline-alert {
      border-radius: 0.75rem;
      padding: 0.75rem 0.9rem;
      background: #fff4f4;
      color: #b3261e;
      border: 1px solid rgba(255, 23, 68, 0.25);
      margin-top: 0.7rem;
      font-size: 0.86rem;
    }

    .calc-alert {
      border-radius: 0.85rem;
      padding: 0.85rem 0.95rem;
      background: #fff3f3;
      border: 1px solid rgba(211, 50, 47, 0.35);
      color: #8b1f1b;
      font-weight: 700;
    }

    .error-banner {
      display: none;
      border-radius: 0.85rem;
      padding: 0.85rem 0.95rem;
      background: #fff4f4;
      border: 1px solid rgba(211, 50, 47, 0.35);
      color: #8b1f1b;
      font-weight: 700;
      margin: 0.8rem 0 0;
    }

    .calc-alert ul {
      margin: 0.35rem 0 0.1rem 1rem;
      padding: 0;
      color: #6b1a17;
    }

    .field-missing {
      border-color: #d32f2f !important;
      background: #fff6f6 !important;
      outline: 2px solid rgba(211, 47, 47, 0.35);
    }

    .missing-hint {
      color: #b3261e;
      font-size: 0.82rem;
      margin-top: 0.25rem;
    }

    .row-error {
      background: #fff3f3;
    }

    .row-error input {
      border-color: #d32f2f;
      background: #fff8f8;
    }

    .row-error .error-hint {
      color: #b3261e;
      font-size: 0.8rem;
      margin-top: 0.15rem;
      display: block;
    }

    .inline-alert ul { margin: 0.35rem 0 0 1rem; padding: 0; }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      align-items: center;
    }

    .option-toggle {
      display: inline-flex;
      gap: 0.8rem;
      padding: 0.65rem 0.85rem;
      background: #f5f9ff;
      border: 1px solid #d5e6f8;
      border-radius: 0.85rem;
      font-weight: 700;
      color: #12324a;
    }

    .option-toggle label {
      display: inline-flex;
      gap: 0.4rem;
      align-items: center;
      cursor: pointer;
    }

    .excel-panel {
      border: 1px dashed #b5cdea;
      border-radius: 0.85rem;
      padding: 0.75rem 0.85rem;
      background: #f7fbff;
      margin: 0.55rem 0;
    }

    .upload-btn {
      display: inline-flex;
      gap: 0.35rem;
      align-items: center;
      padding: 0.45rem 0.75rem;
      border-radius: 0.6rem;
      background: #0d6efd;
      color: #fff;
      cursor: pointer;
      border: none;
      font-weight: 700;
    }

    .upload-btn input[type="file"] { display: none; }

    .scenario-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
      gap: 0.7rem;
    }

    .scenario-card {
      border: 1px solid #cfe1f5;
      border-radius: 0.9rem;
      padding: 0.75rem 0.8rem;
      background: #f9fcff;
      position: relative;
    }

    .scenario-card.active {
      border-color: var(--primary);
      box-shadow: 0 6px 16px rgba(13, 110, 253, 0.12);
      background: linear-gradient(135deg, #f3f8ff, #ffffff);
    }

    .scenario-title {
      margin: 0;
      font-weight: 700;
      color: #12324a;
    }

    .scenario-meta {
      font-size: 0.82rem;
      color: #4d6a87;
      margin: 0.2rem 0 0.4rem;
    }

    .scenario-actions {
      display: flex;
      gap: 0.35rem;
      flex-wrap: wrap;
    }

    .scenario-actions button {
      border-radius: 0.55rem;
      padding: 0.32rem 0.6rem;
      font-size: 0.82rem;
    }

    .mini-input {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      border: 1px solid #cfe1f5;
      padding: 0.25rem 0.5rem;
      border-radius: 0.65rem;
      background: #f7fbff;
    }

    .stacked {
      display: grid;
      gap: 0.6rem;
    }

    .pill-badge {
      display: inline-block;
      padding: 0.18rem 0.5rem;
      border-radius: 0.6rem;
      background: #e8f2ff;
      color: #1d3a57;
      font-size: 0.78rem;
      font-weight: 700;
    }

    .compare-grid {
      overflow-x: auto;
    }

    .accordion {
      border: 1px solid #cfe1f5;
      border-radius: 0.9rem;
      overflow: hidden;
    }

    .accordion summary {
      list-style: none;
      cursor: pointer;
      padding: 0.75rem 1rem;
      background: linear-gradient(135deg, #f3f8ff, #ffffff);
      font-weight: 700;
      color: #12324a;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .accordion summary::-webkit-details-marker { display: none; }

    .accordion .content {
      padding: 0.8rem 1rem 1rem;
      background: #ffffff;
    }

    .tagline {
      font-size: 0.82rem;
      color: #5b7693;
      margin-top: 0.15rem;
    }

    main {
      max-width: 1100px;
      margin: 1.5rem auto 2.5rem;
      padding: 0 1rem;
      scroll-padding-top: var(--sticky-top-offset);
    }

    .card {
      background: #ffffff;
      border-radius: 1rem;
      padding: 1.3rem 1.5rem;
      margin-bottom: 1.3rem;
      box-shadow: 0 8px 25px rgba(13, 110, 253, 0.08);
      border: 1px solid rgba(13, 110, 253, 0.09);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: auto -30% -40%;
      height: 120px;
      background:
        radial-gradient(circle at 10% 0%, rgba(13,110,253,0.06) 0, transparent 55%),
        radial-gradient(circle at 90% 40%, rgba(0,188,212,0.06) 0, transparent 55%);
      z-index: -1;
    }

    .card h2 {
      margin-top: 0;
      font-size: 1.15rem;
      color: var(--primary-dark);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .card h2 span.icon { font-size: 1.25rem; }

    .card p.lead {
      margin-top: 0;
      font-size: 0.9rem;
      color: #476582;
    }

    label {
      font-size: 0.85rem;
      font-weight: 600;
      color: #23405b;
      display: block;
      margin-bottom: 0.2rem;
    }

    input[type="number"],
    input[type="text"],
    select {
      width: 100%;
      padding: 0.4rem 0.55rem;
      border-radius: 0.5rem;
      border: 1px solid #c5d9ec;
      font-size: 0.9rem;
      outline: none;
      background-color: #fafdff;
    }

    input[type="number"]:focus,
    input[type="text"]:focus,
    select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.15);
      background-color: #ffffff;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
      margin-top: 0.5rem;
      background-color: #fdfefe;
    }

    th,
    td {
      padding: 0.4rem 0.5rem;
      border-bottom: 1px solid #dde7f3;
      text-align: right;
      word-break: break-word;
      overflow-wrap: anywhere;
      white-space: normal;
    }

    th:first-child,
    td:first-child { text-align: left; }

    thead {
      background: linear-gradient(
        90deg,
        rgba(13, 110, 253, 0.1),
        rgba(0, 188, 212, 0.06)
      );
    }

    tfoot td {
      font-weight: 700;
      background-color: #f3f8ff;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      margin-top: 0.6rem;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 0.45rem 0.9rem;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      transition: transform 0.05s ease, box-shadow 0.12s ease,
        background-color 0.12s ease;
    }

    button.primary {
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color: #fff;
      box-shadow: 0 4px 12px rgba(13, 110, 253, 0.35);
    }

    button.secondary {
      background-color: var(--primary-light);
      color: var(--primary-dark);
    }

    button.export {
      background: linear-gradient(135deg, #00c853, #00e676);
      color: #fff;
      box-shadow: 0 4px 12px rgba(0, 200, 83, 0.4);
    }

    button:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }

    .two-column {
      display: grid;
      grid-template-columns: minmax(0, 1.5fr) minmax(0, 1.2fr);
      gap: 1.2rem;
    }

    .status-pill {
      display: inline-flex;
      border-radius: 999px;
      padding: 0.18rem 0.6rem;
      font-size: 0.8rem;
      font-weight: 600;
      align-items: center;
      gap: 0.35rem;
    }

    .status-surplus {
      background-color: #e0ffe9;
      color: #008a2f;
      border: 1px solid #00c853;
    }

    .status-deficit {
      background-color: #ffebee;
      color: #c62828;
      border: 1px solid #ff1744;
    }

    .summary-text {
      font-size: 0.88rem;
      margin-top: 0.5rem;
      color: #36526f;
    }

    .note {
      font-size: 0.78rem;
      color: #627d96;
      margin-top: 0.2rem;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.75rem;
      padding: 0.2rem 0.5rem;
      border-radius: 999px;
      background-color: rgba(13, 110, 253, 0.05);
      color: #2d4c69;
      margin-right: 0.4rem;
      margin-top: 0.2rem;
    }

    canvas {
      background: radial-gradient(circle at top, #f2fbff, #ffffff);
      border-radius: 0.8rem;
      padding: 0.5rem;
    }

    .summary-row-surplus td:nth-child(2),
    .summary-row-surplus td:nth-child(4) {
      background-color: #e0ffe9;
      color: #006622;
      font-weight: 700;
    }

    .summary-row-deficit td:nth-child(2),
    .summary-row-deficit td:nth-child(4) {
      background-color: #ffebee;
      color: #b71c1c;
      font-weight: 700;
    }

    .disclaimer {
      font-size: 0.8rem;
      color: #455a64;
      line-height: 1.5;
    }

    footer {
      text-align: center;
      padding: 0.8rem 1rem 1.2rem;
      font-size: 0.78rem;
      color: #607d8b;
      background: #f1f7fd;
      border-top: 1px solid #d3e1f2;
    }

    .input-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 0.8rem 1rem;
      margin-top: 0.6rem;
    }

    .mini {
      font-size: 0.78rem;
      color: #607d8b;
    }

    .hidden { display: none !important; }
    body.show-advanced .mode-block { display: block !important; }
    .invalid {
      border-color: #d32f2f !important;
      box-shadow: 0 0 0 2px rgba(211, 47, 47, 0.2);
      background: #fff7f7;
    }

    .error-text {
      color: #b3261e;
      font-size: 0.82rem;
      margin-top: 0.15rem;
    }

    .confidential-toggle {
      display: inline-flex;
      align-items: center;
      gap: 0.45rem;
      font-size: 0.86rem;
      color: #23405b;
      margin-top: 0.4rem;
    }

    .confidential-toggle input {
      width: 1rem;
      height: 1rem;
      accent-color: var(--primary);
    }

    /* Kontena laporan HTML legacy (tidak lagi digunakan untuk penjanaan jsPDF) */
    #reportRoot.rendering {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      margin: 0 auto;
      /* Kekalkan keterlihatan jika diperlukan semasa debug paparan HTML */
      opacity: 1;
      pointer-events: none;
      overflow: visible;
      background: #ffffff;
      z-index: 999;
    }

    #reportRoot .logo-box img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      display: block;
    }

    /* Laporan Profesional (PDF) */
    @page {
      size: A4;
      margin: 18mm;
    }

    #reportRoot {
      width: 210mm;
      margin: 0 auto;
      background: #ffffff;
      color: #1b2744;
      font-family: "Arial", "Helvetica Neue", sans-serif;
      box-shadow: 0 8px 24px rgba(13, 46, 79, 0.12);
    }

    #reportRoot, #reportRoot * {
      box-sizing: border-box;
      max-width: 100%;
    }

    #reportRoot.offscreen {
      position: absolute;
      left: -9999px;
      top: 0;
      pointer-events: none;
    }

    #reportRoot h1,
    #reportRoot h2,
    #reportRoot h3,
    #reportRoot h4 {
      font-family: "Arial", "Helvetica Neue", sans-serif;
      color: #0c2d57;
      margin-top: 0;
      font-weight: 700;
    }

    #reportRoot h1 { font-size: 16pt; }
    #reportRoot h2 { font-size: 14pt; }
    #reportRoot h3 { font-size: 12.5pt; }
    #reportRoot h4 { font-size: 11.5pt; }

    #reportRoot p,
    #reportRoot li {
      font-size: 11pt;
      line-height: 1.5;
      text-align: justify;
      text-justify: inter-word;
      color: #1b2744;
    }

    #reportRoot .report-table {
      width: 100%;
      max-width: 100%;
      border-collapse: collapse;
      margin: 0.4rem 0 0.9rem;
      font-size: 9.5pt;
      table-layout: fixed;
      page-break-inside: avoid;
      break-inside: avoid;
    }

    #reportRoot .report-table th,
    #reportRoot .report-table td {
      border: 1px solid #0f3057;
      padding: 5px 6px;
      text-align: left;
      background: #fff;
      word-break: break-word;
      overflow-wrap: anywhere;
      white-space: normal;
      line-height: 1.35;
      vertical-align: top;
      page-break-inside: avoid;
      break-inside: avoid;
    }

    #reportRoot .report-table.wide-table {
      font-size: 9pt;
    }

    #reportRoot .report-table.wide-table th,
    #reportRoot .report-table.wide-table td {
      padding: 4px 5px;
    }

    #reportRoot .report-table thead th {
      background: linear-gradient(135deg, rgba(13, 110, 253, 0.18), rgba(0, 188, 212, 0.2));
    }

    #reportRoot .zebra tbody tr:nth-child(even) td {
      background: #f5f8ff;
    }

    #reportRoot .page-break { page-break-before: always; }

    #reportRoot .cover {
      min-height: 297mm;
      padding: 32mm 28mm;
      position: relative;
      display: grid;
      place-items: center;
      text-align: center;
      gap: 1.5rem;
      color: #0c2d57;
      background: #ffffff;
      border: 1px solid #e3ebf6;
    }

    #reportRoot .cover .logo-box {
      width: 170px;
      height: auto;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      background: transparent;
      box-shadow: none;
      margin: 0 auto 0.8rem;
    }

    #reportRoot .cover h1 {
      font-size: 20pt;
      line-height: 1.4;
      letter-spacing: 0.01em;
      margin: 0;
    }

    #reportRoot .cover .meta,
    #reportRoot .cover .tagline {
      font-size: 11pt;
      line-height: 1.5;
      margin: 0.25rem 0;
    }

    #reportRoot .toc {
      padding: 25mm;
      background: #ffffff;
    }

    #reportRoot .toc ol {
      counter-reset: item;
      padding-left: 1rem;
    }

    #reportRoot .toc li {
      margin: 0.25rem 0;
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      font-size: 11pt;
      break-inside: avoid;
      page-break-inside: avoid;
    }

    #reportRoot .toc li::before {
      counter-increment: item;
      content: counters(item, ".") " ";
      font-weight: bold;
      margin-right: 0.35rem;
      color: #0c2d57;
    }

    #reportRoot .toc .page-num {
      color: #0c2d57;
      font-variant-numeric: tabular-nums;
    }

    #reportRoot .section-tag {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.16rem 0.55rem;
      background: rgba(13, 110, 253, 0.12);
      color: #0d2e55;
      border-radius: 999px;
      font-size: 0.78rem;
      letter-spacing: 0.02em;
    }

    #reportRoot .figure {
      text-align: center;
      margin: 0.3rem 0 0.9rem;
    }

    #reportRoot .figure img {
      max-width: 100%;
      border: 1px solid #cdd9eb;
      border-radius: 8px;
      background: #fff;
    }

    #reportRoot .figure .caption {
      font-size: 10px;
      margin-top: 0.35rem;
      color: #425c7a;
    }

    #reportRoot .kicker {
      font-size: 0.92rem;
      letter-spacing: 0.08em;
      color: #0d2e55;
      text-transform: uppercase;
    }

    #reportRoot .meta {
      color: #244a75;
      font-size: 0.95rem;
    }

    #reportRoot .highlight-box {
      border: 1px solid rgba(13, 110, 253, 0.3);
      background: rgba(13, 110, 253, 0.04);
      padding: 0.8rem 1rem;
      border-radius: 10px;
      margin: 0.7rem 0 1rem;
    }

    #reportRoot .risk-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
      gap: 0.7rem;
    }

    #reportRoot .risk-card {
      border: 1px solid #c8d7ec;
      border-radius: 10px;
      padding: 0.7rem 0.9rem;
      background: #fbfdff;
    }

    #reportRoot .tagline {
      color: #244a75;
      font-style: italic;
      margin-top: 0.4rem;
    }

    #reportRoot .footer-note {
      text-align: center;
      font-size: 10px;
      margin-top: 0.9rem;
      color: #3e5674;
    }

    #reportRoot .page-note {
      font-size: 10px;
      color: #4c6079;
    }

    #reportRoot .watermark-underline {
      height: 5px;
      background: linear-gradient(90deg, rgba(13, 110, 253, 0.3), rgba(0, 188, 212, 0.4));
      border-radius: 12px;
      margin: 0.4rem 0 0.8rem;
    }

    #reportRoot .list-tight li { margin: 0.12rem 0; }

    #reportRoot .phase-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 0.8rem;
    }

    #reportRoot .phase-card {
      border: 1px solid #d1e2f5;
      border-radius: 10px;
      padding: 0.8rem 0.95rem;
      background: linear-gradient(135deg, #f8fbff, #fdfefe);
      page-break-inside: avoid;
      break-inside: avoid;
    }

    #reportRoot .phase-card h4 {
      margin: 0 0 0.25rem;
      font-size: 0.96rem;
    }

    #reportRoot .phase-card ul { padding-left: 1rem; margin: 0; }

    #reportRoot .inline-table {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 0.7rem;
    }

    #reportRoot .inline-table .box {
      border: 1px solid #cfdff0;
      border-radius: 10px;
      padding: 0.7rem 0.85rem;
      background: #fbfdff;
      page-break-inside: avoid;
      break-inside: avoid;
    }

    #reportRoot .inline-table .label {
      font-size: 0.82rem;
      color: #36526f;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-bottom: 0.2rem;
    }

    #reportRoot .report-page {
      min-height: 297mm;
      padding: 18mm;
      background: #ffffff;
      display: flex;
      flex-direction: column;
      gap: 0.55rem;
      position: relative;
      overflow: hidden;
      page-break-after: always;
    }

    #reportRoot .report-page .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.6rem;
      padding-bottom: 0.45rem;
      border-bottom: 1px solid #e2e8f0;
      color: #0c2d57;
      font-size: 8.5pt;
    }

    #reportRoot .report-page .page-footer {
      margin-top: auto;
      padding-top: 0.55rem;
      border-top: 1px solid #e2e8f0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: #3f5c78;
      font-size: 9pt;
    }

    #reportRoot .report-page .page-number {
      font-variant-numeric: tabular-nums;
    }

    #reportRoot .section-block {
      display: grid;
      gap: 0.3rem;
    }

    #reportRoot .section-title {
      font-size: 13pt;
      margin: 0;
      color: #0a355e;
    }

    #reportRoot .section-tagline {
      color: #2c5f88;
      font-size: 11pt;
      margin: 0;
    }

    #reportRoot .captioned-image,
    #reportRoot .figure {
      page-break-inside: avoid;
      break-inside: avoid;
    }

    #reportRoot .captioned-image img,
    #reportRoot .figure img {
      max-width: 100%;
      height: auto;
      object-fit: contain;
    }

    #reportRoot .toc-list {
      list-style: none;
      padding-left: 0;
      margin: 0.4rem 0 0;
      display: grid;
      gap: 0.3rem;
    }

    #reportRoot .toc-list li {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.3rem 0.4rem;
      border-bottom: 1px dashed #d6e2f2;
      color: #23405b;
      font-size: 12px;
    }

    #reportRoot .toc-list li span.label {
      font-weight: 600;
      color: #0c2d57;
    }

    #reportRoot .toc-list li span.page {
      font-variant-numeric: tabular-nums;
      color: #3f5c78;
    }

    #reportRoot .page-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 0.6rem;
    }

    #reportRoot .page-card {
      border: 1px solid #d8e5f5;
      border-radius: 10px;
      padding: 0.65rem 0.8rem;
      background: linear-gradient(135deg, #f8fbff, #fefeff);
      page-break-inside: avoid;
      break-inside: avoid;
    }

    #reportRoot .page-card h4 {
      margin: 0 0 0.25rem;
      color: #0a355e;
    }

    #reportRoot .justified {
      text-align: justify;
    }

    #reportRoot .captioned-image {
      text-align: center;
      margin: 0.4rem 0 0.9rem;
      page-break-inside: avoid;
      break-inside: avoid;
    }

    #reportRoot .captioned-image img {
      max-width: 100%;
      max-height: 240px;
      border: 1px solid #d8e5f5;
      border-radius: 8px;
      background: #fff;
      object-fit: contain;
    }

    #reportRoot .captioned-image .caption {
      margin-top: 0.3rem;
      color: #48607a;
      font-size: 10px;
    }

    @media (max-width: 768px) {
      header { padding: 1.15rem 1rem; }
      header h1 { font-size: 1.25rem; }
      .two-column { grid-template-columns: 1fr; }
    }

    /* Wizard overlay */
    .wizard-overlay {
      position: fixed;
      inset: 0;
      background: rgba(6, 32, 69, 0.55);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      z-index: 999;
      backdrop-filter: blur(2px);
    }

    .wizard-overlay.active { display: flex; }

    .wizard-dialog {
      background: #ffffff;
      border-radius: 1rem;
      width: min(900px, 100%);
      max-height: 90vh;
      overflow: hidden;
      box-shadow: 0 18px 42px rgba(0, 0, 0, 0.25);
      display: flex;
      flex-direction: column;
      border: 1px solid #d6e6f7;
    }

    .wizard-header {
      padding: 1rem 1.25rem;
      background: linear-gradient(135deg, var(--primary-dark), #0c74d4);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }

    .wizard-title { margin: 0; font-size: 1.1rem; }

    .wizard-body { padding: 1rem 1.25rem 0.5rem; overflow-y: auto; }

    .wizard-steps { display: flex; flex-wrap: wrap; gap: 0.35rem; margin: 0 0 0.8rem; padding: 0; list-style: none; }
    .wizard-steps li {
      padding: 0.45rem 0.65rem;
      border-radius: 0.65rem;
      border: 1px solid #d7e5f6;
      background: #f6f9ff;
      color: #1f3e64;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }
    .wizard-steps li.active { border-color: var(--primary); box-shadow: 0 6px 14px rgba(13, 110, 253, 0.12); }
    .wizard-steps li .idx { background: var(--primary); color: #fff; width: 26px; height: 26px; display: inline-flex; align-items: center; justify-content: center; border-radius: 999px; font-weight: 700; }

    .wizard-panel { background: #f9fbff; border: 1px solid #e1ecfa; border-radius: 0.85rem; padding: 0.9rem 1rem; margin-bottom: 0.75rem; }
    .wizard-panel h3 { margin: 0 0 0.35rem; font-size: 1rem; }
    .wizard-panel p { margin: 0.2rem 0 0.3rem; color: #3e5874; }
    .wizard-panel ul { margin: 0.35rem 0 0.35rem 1.1rem; color: #3b5573; }
    .wizard-hint { font-size: 0.9rem; color: #345; margin: 0.2rem 0; display: flex; gap: 0.35rem; align-items: center; }
    .wizard-actions { display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; padding: 0.75rem 1rem 1rem; border-top: 1px solid #e7edf5; background: #fff; }
    .wizard-actions .left { display: flex; gap: 0.5rem; align-items: center; }
    .wizard-actions .right { display: flex; gap: 0.5rem; align-items: center; }
    .wizard-badge { display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.2rem 0.45rem; border-radius: 0.5rem; background: #eef4ff; color: #1a3b63; font-size: 0.85rem; }
    .wizard-warning { color: #b3261e; font-weight: 600; }
    .wizard-success { color: #0d6efd; font-weight: 600; }
    .wizard-step-actions { display: flex; gap: 0.4rem; flex-wrap: wrap; margin-top: 0.4rem; }
    .wizard-helper { font-size: 0.88rem; color: #48607a; margin-top: 0.3rem; }

    .wizard-pointer { outline: 2px dashed var(--primary); outline-offset: 4px; border-radius: 6px; animation: pulse 1.6s ease-in-out infinite; }

    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(13, 110, 253, 0.35);} 70% { box-shadow: 0 0 0 10px rgba(13, 110, 253, 0);} 100% { box-shadow: 0 0 0 0 rgba(13, 110, 253, 0);} }

    .report-options {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      align-items: center;
    }

    .report-options .mini-input { margin-top: 0.25rem; }

    .toc-box {
      max-width: 1100px;
      margin: 0 auto 0.8rem;
      padding: 0.75rem 1rem;
      background: #ffffff;
      border: 1px solid #d6e6f7;
      border-radius: 0.9rem;
      box-shadow: 0 8px 18px rgba(13, 110, 253, 0.05);
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .toc-box .mini {
      margin: 0;
      font-weight: 700;
      color: #0d2e55;
    }

    .quick-stepper {
      position: sticky;
      top: 72px;
      z-index: 9;
      background: #ffffff;
      margin: 0 0 1rem;
      border-bottom: 1px solid #d5e4f7;
      box-shadow: 0 8px 22px rgba(13, 110, 253, 0.08);
    }

    .quick-stepper .stepper-inner {
      max-width: 1100px;
      margin: 0 auto;
    }

    .stepper-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      min-height: 44px;
      padding: 0.45rem 1rem;
      position: sticky;
      top: 0;
      background: linear-gradient(135deg, rgba(13, 110, 253, 0.07), rgba(0, 188, 212, 0.07));
      backdrop-filter: blur(6px);
      z-index: 2;
    }

    .stepper-bar-left {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      flex-wrap: wrap;
    }

    .stepper-title {
      margin: 0;
      color: #0d2e55;
      font-weight: 800;
      letter-spacing: 0.02em;
      font-size: 0.98rem;
    }

    .stepper-toggle {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.35rem 0.7rem;
      border-radius: 999px;
      background: #ffffff;
      border: 1px solid #cfe1f5;
      cursor: pointer;
      color: #0d2e55;
      font-weight: 700;
      box-shadow: 0 4px 10px rgba(13, 110, 253, 0.08);
    }

    .stepper-toggle:hover { background: #f4f8ff; }

    .stepper-panel {
      padding: 0.6rem 1rem 1rem;
      transition: max-height 0.25s ease, opacity 0.25s ease;
      background: #f9fcff;
      border-top: 1px solid #d5e4f7;
    }

    .stepper-panel.hidden {
      display: none;
    }

    .stepper-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.8rem;
      margin: 0 auto 0.4rem;
      max-width: 1100px;
      flex-wrap: wrap;
    }

    .stepper-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
      gap: 0.7rem;
      max-width: 1100px;
      margin: 0 auto;
    }

    .step-card {
      border: 1px solid #cfe1f5;
      border-radius: 0.85rem;
      background: #fff;
      padding: 0.75rem 0.85rem;
      display: grid;
      gap: 0.35rem;
      box-shadow: 0 6px 16px rgba(13, 110, 253, 0.06);
      position: relative;
    }

    .step-card.active { box-shadow: 0 8px 20px rgba(0, 188, 212, 0.15); border-color: var(--primary); }

    .step-card h3 {
      margin: 0;
      font-size: 0.98rem;
      color: #0d2e55;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .step-number {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color: #fff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 0.9rem;
    }

    .step-text { font-size: 0.85rem; color: #476582; margin: 0; }
    .step-example { font-size: 0.82rem; color: #2a5c87; margin: 0; }

    .step-actions { display: flex; flex-wrap: wrap; gap: 0.35rem; }

    .step-error {
      color: #b3261e;
      font-size: 0.83rem;
      margin: 0;
    }

    .floating-stepper-btn {
      position: fixed;
      right: 18px;
      bottom: 20px;
      padding: 0.75rem 0.95rem;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color: #fff;
      font-weight: 800;
      box-shadow: 0 10px 24px rgba(13, 110, 253, 0.2);
      cursor: pointer;
      z-index: 11;
      display: none;
    }

    .section-highlight {
      outline: 2px solid var(--accent);
      outline-offset: 4px;
      transition: outline-color 0.4s ease, outline-offset 0.4s ease;
    }

    .unit-label {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      font-size: 0.78rem;
      color: #2a5c87;
      background: #e8f4ff;
      padding: 0.18rem 0.45rem;
      border-radius: 999px;
      margin-left: 0.35rem;
      vertical-align: middle;
    }

    .muted {
      opacity: 0.5;
      filter: grayscale(0.15);
      pointer-events: none;
    }

    /* Susun atur baharu INPUT â†’ OUTPUT */
    .layout-hero {
      display: grid;
      gap: 0.8rem;
    }

    .layout-hero-inner { display: grid; gap: 0.7rem; }

    .layout-hero .hero-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.6rem;
      flex-wrap: wrap;
    }

    .layout-hero .hero-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.45rem;
      align-items: center;
    }

    .layout-hero .status-chip {
      padding: 0.35rem 0.8rem;
      border-radius: 999px;
      background: #e8f2ff;
      color: #0d2e55;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.9rem;
    }

    .layout-hero .hero-sub {
      display: grid;
      gap: 0.4rem;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      align-items: start;
    }

    .input-steps { display: grid; gap: 0.75rem; }
    .input-step {
      border: 1px solid #d5e6f8;
      border-radius: 0.95rem;
      background: #ffffff;
      box-shadow: 0 8px 20px rgba(13, 110, 253, 0.05);
      overflow: visible;
      min-height: 0;
    }

    .input-step summary {
      list-style: none;
      cursor: pointer;
      padding: 0.9rem 1rem;
      font-weight: 800;
      color: #0d2e55;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.4rem;
      background: linear-gradient(135deg, rgba(13,110,253,0.08), rgba(0,188,212,0.08));
    }

    .input-step summary::-webkit-details-marker { display: none; }

    .input-step .step-body { padding: 0.9rem 1rem 1rem; background: #ffffff; overflow: visible; }

    .input-step .step-label { font-size: 0.82rem; font-weight: 700; color: #0d6efd; }
    .input-step .step-meta { color: #48607a; font-size: 0.86rem; margin: 0.15rem 0 0.45rem; }
    .input-step .step-next { margin-top: 0.7rem; display: inline-flex; align-items: center; gap: 0.35rem; }

    .output-block { display: grid; gap: 1rem; }
    .output-hidden { display: none; }
    /* Sembunyikan seksyen CTA lama (diganti bar melekat) tanpa tinggal ruang. */
    #section-calc-actions.calc-removed { display: none !important; margin: 0 !important; padding: 0 !important; }
    /* Padam ruang berganda di bawah kad output (termasuk jadual kategori). */
    .output-section > .card { margin-bottom: 0; }

    .empty-output {
      border: 1px dashed #b5cdea;
      border-radius: 0.9rem;
      padding: 0.9rem 1rem;
      background: #f7fbff;
      color: #34526e;
      font-weight: 600;
    }

    .chart-explain-block { margin-top: 0.4rem; font-size: 0.86rem; color: #2d4c69; }

    .chart-area canvas {
      max-height: 320px;
    }

    #demand-by-category-chart,
    #demand-share-chart,
    #cba-npv-chart,
    #cba-payback-chart {
      max-height: 320px;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      padding: 0.2rem 0.55rem;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 700;
      border: 1px solid #cfe1f5;
      background: #f4f8ff;
      color: #12324a;
    }

    .status-badge.done {
      background: #e8fff3;
      border-color: #a7eec5;
      color: #006c3f;
    }

    .status-badge.calculated {
      background: #e6f2ff;
      border-color: #9ec9ff;
      color: #0d3f91;
    }

    .demand-toggle {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 0.6rem;
      margin: 0.6rem 0 0.2rem;
    }

    .demand-toggle label {
      display: flex;
      align-items: center;
      gap: 0.45rem;
      padding: 0.65rem 0.85rem;
      border-radius: 0.85rem;
      border: 1px solid #cfe1f5;
      background: #f9fcff;
      cursor: pointer;
      margin: 0;
      font-size: 0.9rem;
    }

    .demand-toggle input {
      width: 1.05rem;
      height: 1.05rem;
      accent-color: var(--primary);
    }

    .demand-mode-note {
      margin-top: 0.2rem;
      color: #476582;
      font-size: 0.85rem;
    }

    #section-demand {
      position: relative;
      z-index: 5;
      scroll-margin-top: calc(var(--sticky-top-offset) + 12px);
      scroll-margin-bottom: calc(var(--sticky-bottom-padding) + 12px);
      isolation: isolate;
      overflow: visible;
    }

    #section-demand.card { overflow: visible; }

    .demand-table-wrap {
      overflow-x: auto;
      overflow-y: visible;
      margin-top: 0.6rem;
      position: relative;
      z-index: 6;
      min-height: 0;
      padding-bottom: 0.2rem;
    }

    #category-input-table { margin-bottom: 0; }

    #category-input-table thead th {
      position: sticky;
      top: var(--sticky-top-offset);
      z-index: 3;
      background: #fff;
    }

    .sticky-action-bar {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 20;
      background: linear-gradient(90deg, #f3f9ff 0%, #f0f7ff 50%, #f3f9ff 100%);
      border-top: 1px solid #cfe1f5;
      box-shadow: 0 -8px 24px rgba(18, 50, 74, 0.08);
      display: flex;
      gap: 0.75rem;
      align-items: center;
      padding: 0.75rem 1.15rem;
      backdrop-filter: blur(4px);
    }

    .sticky-actions {
      margin-left: auto;
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .sticky-helper {
      color: #34526e;
      font-size: 0.86rem;
      line-height: 1.25;
    }

    body.has-sticky-bar,
    main.has-sticky-bar {
      padding-bottom: var(--sticky-bottom-padding);
    }

    @media (max-width: 720px) {
      .sticky-action-bar {
        flex-direction: column;
        align-items: stretch;
        gap: 0.65rem;
        padding: 0.85rem 0.9rem 1rem;
      }

      .sticky-actions {
        width: 100%;
        margin-left: 0;
        justify-content: center;
      }

      .sticky-actions button {
        flex: 1;
        min-height: 46px;
      }

      body.has-sticky-bar,
      main.has-sticky-bar {
        padding-bottom: calc(var(--sticky-bottom-padding) + 12px);
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div>
        <h1>Kalkulator Permintaan & Bekalan Air UMS</h1>
        <p>
          Anggaran demandâ€“supply air kampus termasuk sumber alternatif
          (tangkapan air hujan, reuse, air tasik, kondensasi penghawa dingin)
          dan analisis kosâ€“faedah asas.
        </p>
      </div>
      <div class="badge">
        <span>ğŸ’§</span> Alat perancangan permintaan & kos-faedah air
      </div>
    </div>
  </header>

  <main>
    <section class="card layout-hero" id="layout-hero-card">
      <div class="layout-hero-inner">
        <div class="hero-top">
          <div>
            <h2 style="margin:0 0 0.25rem; font-size:1.25rem;">UMS Water Calculator</h2>
            <p style="margin:0; color:#3b5574; max-width:640px;">
              Lengkapkan INPUT mengikut urutan di bawah, tekan <strong>KIRA SEKARANG</strong>, kemudian semak OUTPUT dan laporan.
            </p>
          </div>
          <div class="hero-actions">
            <button type="button" class="secondary" id="btn-jump-calc">â¬ Lompat ke Kira</button>
            <div class="status-chip" id="calc-status-chip">Belum dikira</div>
          </div>
        </div>
        <div class="hero-sub">
          <div class="mini-input">
            <button type="button" class="secondary" id="btn-reset-inputs">ğŸ”„ Reset input</button>
            <button type="button" class="secondary" id="btn-load-preset-hero">ğŸŒŸ Muatkan preset contoh</button>
          </div>
          <div style="display:flex; gap:0.5rem; flex-wrap:wrap; align-items:center;">
            <span class="pill-badge">Mod & Senario sentiasa kelihatan di sini.</span>
            <span class="pill-badge">Isi INPUT dahulu sebelum OUTPUT.</span>
          </div>
        </div>
        <div id="calc-inline-alert" class="calc-alert hidden" role="alert"></div>
        <div id="hero-mode-holder"></div>
        <div id="hero-scenario-holder"></div>
      </div>
    </section>

    <section class="card" id="input-wrapper">
      <h2><span class="icon">ğŸ“</span> INPUT (Isi dahulu)</h2>
      <p class="lead">Ikuti langkah INPUT. Setiap langkah label <strong>WAJIB</strong> atau <strong>Pilihan</strong>. Selesai semua, tekan <strong>KIRA SEKARANG</strong>.</p>
      <div id="input-steps" class="input-steps"></div>
    </section>

    <section class="card output-hidden" id="output-wrapper">
      <h2><span class="icon">ğŸ“¤</span> OUTPUT & Analisis</h2>
      <div class="btn-row" style="margin-top:0;">
        <button type="button" class="secondary" id="btn-back-to-input">â¬†ï¸ Kembali ke Input</button>
      </div>
      <div id="error-banner" class="error-banner" role="alert"></div>
      <div id="output-empty" class="empty-output">Belum ada hasil. Lengkapkan INPUT dan tekan <strong>KIRA SEKARANG</strong>.</div>
      <div id="output-block" class="output-block"></div>
    </section>

    <section class="card output-hidden" id="export-wrapper">
      <h2><span class="icon">ğŸ“¦</span> Eksport & Laporan</h2>
      <div id="export-slot"></div>
    </section>

    <section class="quick-stepper" id="quick-stepper" aria-label="Quick start stepper">
      <div class="stepper-inner">
        <div class="stepper-bar" id="stepper-bar">
          <div class="stepper-bar-left">
            <p class="stepper-title">Quick Start: 8 Langkah</p>
            <div class="status-badge" id="stepper-status-pill">Belum lengkap</div>
          </div>
          <button type="button" class="stepper-toggle" id="stepper-toggle" aria-expanded="false" aria-controls="stepper-panel">
            <span id="stepper-toggle-text">Papar</span>
            <span id="stepper-toggle-icon" aria-hidden="true">â–¸</span>
          </button>
        </div>
        <div class="stepper-panel hidden" id="stepper-panel">
          <div class="stepper-panel-header">
            <p style="margin:0;color:#34526e;font-size:0.9rem;">Ikut urutan ringkas di bawah. Setiap langkah ada contoh & pautan pantas.</p>
            <button type="button" class="secondary" id="stepper-close">Tutup âœ•</button>
          </div>
          <div class="stepper-grid" id="stepper-grid"></div>
        </div>
      </div>
    </section>
    <button type="button" class="floating-stepper-btn" id="stepper-floating-btn">Langkah</button>

    <div class="wizard-overlay" id="wizard-overlay" aria-hidden="true">
      <div class="wizard-dialog" role="dialog" aria-modal="true" aria-labelledby="wizard-title">
        <div class="wizard-header">
          <div>
            <p class="wizard-badge">Panduan langkah demi langkah</p>
            <h2 class="wizard-title" id="wizard-title">Wizard Kalkulator Air UMS</h2>
            <p style="margin:0; font-size:0.9rem; opacity:0.9;">Ikut 8 langkah mudah untuk set data dan jana laporan.</p>
          </div>
          <button type="button" class="secondary" id="btn-close-wizard">âœ– Tutup</button>
        </div>
        <div class="wizard-body">
          <ul class="wizard-steps" id="wizard-step-list"></ul>
          <div id="wizard-content"></div>
        </div>
        <div class="wizard-actions">
          <div class="left">
            <button type="button" class="secondary" id="wizard-back">â¬…ï¸ Kembali</button>
            <span id="wizard-status" class="wizard-helper"></span>
          </div>
          <div class="right">
            <button type="button" class="secondary" id="wizard-skip">Langkau</button>
            <button type="button" class="primary" id="wizard-next">Seterusnya â¡ï¸</button>
          </div>
        </div>
      </div>
    </div>

    <section class="card" id="section-mode">
      <h2><span class="icon">ğŸ›ï¸</span> Pemilih Mod & Senario <span class="mini" title="Mod Quick = input minimum; Operational = buka jadual kategori & alt; Full = tambah pecahan CAPEX/OPEX & sensitiviti.">Apa beza Mod?</span> <span class="mini" title="Senario A baseline (JANS). B/C untuk alternatif atau kombinasi.">Apa beza Senario?</span></h2>
      <div class="toolbar">
        <div class="pill-group" role="group" aria-label="Pemilih mod" id="mode-selector">
          <div class="pill active" data-mode="quick">
            Quick Estimate
            <small>1â€“2 min</small>
          </div>
          <div class="pill" data-mode="operational">
            Operational Planning
            <small>10â€“15 min</small>
          </div>
          <div class="pill" data-mode="full">
            Full CBA (Advanced)
            <small>30â€“60 min</small>
          </div>
        </div>
        <button type="button" class="secondary" id="btn-autofill">
          âš¡ Auto-fill nilai contoh
        </button>
        <button type="button" class="secondary" id="btn-fix-inputs">
          ğŸ› ï¸ Baiki input
        </button>
      </div>
      <p class="mode-note" id="mode-note">
        Quick Estimate: isi populasi atau permintaan harian + faktor puncak & bekalan asas. Mod ini memaparkan ringkasan pantas serta NPV/BCR/payback jika CAPEX/OPEX diisi.
      </p>
      <div class="inline-alert hidden" id="validation-box">
        <strong>Semak input diperlukan:</strong>
        <ul id="validation-list"></ul>
      </div>
    </section>

    <section class="card mode-block" data-modes="full,operational,quick" id="section-sensitivity">
      <h2><span class="icon">ğŸ§ª</span> Analisis Sensitiviti (+/âˆ’10%)</h2>
      <p class="lead">Lihat kesan perubahan kos/manfaat terhadap NPV & BCR projek alternatif.</p>
      <div class="inline-alert" id="sens-empty" style="display:none;">
        Analisis sensitiviti akan muncul selepas kiraan lengkap (Mod Full/Operational) dengan CAPEX, OPEX dan parameter kewangan lengkap.
      </div>
      <p class="mini" id="sens-placeholder" style="margin:0.2rem 0 0.6rem;">Akan dipaparkan selepas kiraan lengkap.</p>
      <div class="input-grid">
        <div>
          <div class="label">Senario asas</div>
          <div id="sens-base" class="pill-badge">NPV: â€“, BCR: â€“</div>
        </div>
        <div>
          <div class="label">CAPEX +10%</div>
          <div id="sens-capex" class="pill-badge">NPV: â€“, BCR: â€“</div>
        </div>
        <div>
          <div class="label">OPEX +10%</div>
          <div id="sens-opex" class="pill-badge">NPV: â€“, BCR: â€“</div>
        </div>
        <div>
          <div class="label">Manfaat/penjimatan +10%</div>
          <div id="sens-benefit" class="pill-badge">NPV: â€“, BCR: â€“</div>
        </div>
      </div>
      <div class="tagline">Analisis sensitiviti menggunakan PV manfaat & kos terkira semasa.</div>
    </section>

    <section class="card" id="section-compare">
      <h2><span class="icon">ğŸ§®</span> Perbandingan Senario A/B/C</h2>
      <p class="lead">Bandingkan metrik utama (permintaan, bekalan, defisit, NPV, BCR, IRR, Payback) untuk senario yang disimpan.</p>
      <div class="inline-alert" id="compare-empty" style="display:none;">
        Perbandingan memerlukan sekurang-kurangnya dua senario yang telah dikira. Gandakan atau tambah senario, jalankan kiraan, kemudian semak semula di sini.
      </div>
      <p class="mini" id="compare-placeholder" style="margin:0.2rem 0 0.6rem;">Akan dipaparkan selepas kiraan lengkap.</p>
      <div class="compare-grid">
        <table id="scenario-compare-table">
          <thead>
            <tr>
              <th>Metrik</th>
              <th>Senario A</th>
              <th>Senario B</th>
              <th>Senario C</th>
            </tr>
          </thead>
          <tbody>
            <tr><td>Permintaan purata (MLD)</td><td class="sc-a-avg">â€“</td><td class="sc-b-avg">â€“</td><td class="sc-c-avg">â€“</td></tr>
            <tr><td>Permintaan puncak (MLD)</td><td class="sc-a-peak">â€“</td><td class="sc-b-peak">â€“</td><td class="sc-c-peak">â€“</td></tr>
            <tr><td>Bekalan efektif (MLD)</td><td class="sc-a-supply">â€“</td><td class="sc-b-supply">â€“</td><td class="sc-c-supply">â€“</td></tr>
            <tr><td>Lebihan/Defisit purata</td><td class="sc-a-surplus">â€“</td><td class="sc-b-surplus">â€“</td><td class="sc-c-surplus">â€“</td></tr>
            <tr><td>NPV (RM)</td><td class="sc-a-npv">â€“</td><td class="sc-b-npv">â€“</td><td class="sc-c-npv">â€“</td></tr>
            <tr><td>BCR</td><td class="sc-a-bcr">â€“</td><td class="sc-b-bcr">â€“</td><td class="sc-c-bcr">â€“</td></tr>
            <tr><td>IRR (%)</td><td class="sc-a-irr">â€“</td><td class="sc-b-irr">â€“</td><td class="sc-c-irr">â€“</td></tr>
            <tr><td>Payback (tahun)</td><td class="sc-a-payback">â€“</td><td class="sc-b-payback">â€“</td><td class="sc-c-payback">â€“</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <section class="card mode-block" data-modes="quick" id="section-quick">
      <h2><span class="icon">â±ï¸</span> Input Pantas (Quick Estimate)</h2>
      <div class="demand-toggle" role="radiogroup" aria-label="Pilih mod permintaan">
        <label>
          <input type="radio" name="demand-mode" value="quick" checked />
          <div>
            <div><strong>Gunakan Demand Quick (ringkas)</strong></div>
            <div class="demand-mode-note">Isi jumlah permintaan harian atau Populasi Ã— per kapita.</div>
          </div>
        </label>
        <label>
          <input type="radio" name="demand-mode" value="category" />
          <div>
            <div><strong>Gunakan Demand Mengikut Kategori (terperinci)</strong></div>
            <div class="demand-mode-note">Buka jadual kategori di bahagian bawah dan isi sekurang-kurangnya satu baris.</div>
          </div>
        </label>
      </div>
      <div class="btn-row" style="margin-top:0;">
        <button type="button" class="secondary" id="btn-toggle-advanced">ğŸ‘€ Papar input terperinci</button>
      </div>
      <div class="input-grid">
        <div>
          <label for="quick-pop">Jumlah populasi / headcount</label>
          <div class="mini-input">
            <input type="number" id="quick-pop" min="0" placeholder="cth: 15000" />
            <span class="unit-label">orang</span>
          </div>
          <div class="tagline">Boleh kosong jika anda masukkan permintaan harian terus.</div>
        </div>
        <div>
          <label for="quick-percap">Kadar per kapita (L/org/hari)</label>
          <div class="mini-input">
            <input type="number" id="quick-percap" min="0" step="0.1" placeholder="cth: 150" />
            <span class="unit-label">L/org/hari</span>
          </div>
        </div>
        <div>
          <label for="quick-demand">Jumlah permintaan harian (mÂ³/hari)</label>
          <div class="mini-input">
            <input type="number" id="quick-demand" min="0" step="0.01" placeholder="cth: 2000" />
            <span class="unit-label">mÂ³/hari</span>
          </div>
          <div class="tagline">Jika diisi, kalkulator abaikan populasi Ã— per kapita.</div>
        </div>
        <div>
          <label for="quick-peak">Faktor puncak (disyorkan 1.2â€“1.5)</label>
          <input type="number" id="quick-peak" min="1" step="0.05" value="1.3" />
        </div>
        <div>
          <label for="quick-base-supply">Bekalan asas (MLD)</label>
          <div class="mini-input">
            <input type="number" id="quick-base-supply" min="0" step="0.1" placeholder="cth: 5" />
            <span class="unit-label">MLD</span>
          </div>
          <div class="tagline">Nilai ini akan disalin ke bekalan JANS di bahagian utama.</div>
        </div>
      </div>
      <div class="accordion" style="margin-top:0.8rem;">
        <details open>
          <summary>Pilihan sumber alternatif ringkas</summary>
          <div class="content">
            <div class="input-grid">
              <div>
                <label for="quick-alt-name">Nama sumber</label>
                <input type="text" id="quick-alt-name" placeholder="cth: Tangkapan air hujan mini" />
              </div>
              <div>
                <label for="quick-alt-capacity">Kapasiti (mÂ³/hari)</label>
                <div class="mini-input">
                  <input type="number" id="quick-alt-capacity" min="0" step="0.1" />
                  <span class="unit-label">mÂ³/hari</span>
                </div>
              </div>
              <div>
                <label for="quick-alt-util">Faktor penggunaan (% hari/tahun)</label>
                <div class="mini-input">
                  <input type="number" id="quick-alt-util" min="0" max="100" step="1" />
                  <span class="unit-label">% hari</span>
                </div>
              </div>
              <div>
                <label for="quick-alt-capex">CAPEX kasar (RM)</label>
                <div class="mini-input">
                  <input type="number" id="quick-alt-capex" min="0" step="1000" />
                  <span class="unit-label">RM</span>
                </div>
              </div>
              <div>
                <label for="quick-alt-opex">OPEX tahunan kasar (RM/tahun)</label>
                <div class="mini-input">
                  <input type="number" id="quick-alt-opex" min="0" step="100" />
                  <span class="unit-label">RM/tahun</span>
                </div>
              </div>
            </div>
          </div>
        </details>
      </div>
    </section>

    <section class="card" id="section-scenario">
      <h2><span class="icon">ğŸ—‚ï¸</span> Pengurus Senario (A/B/C)</h2>
      <p id="active-scenario-banner" class="lead" style="font-weight:700;color:#0d2e55;">Senario aktif: A (Baseline) Â· Status: Belum disimpan</p>
      <p class="mode-note" id="scenario-save-status">Belum disimpan</p>
      <div class="toolbar stacked">
        <div class="scenario-actions">
          <button type="button" class="secondary" id="btn-add-scenario">â• Senario baharu</button>
          <button type="button" class="secondary" id="btn-duplicate-scenario">ğŸ“‘ Gandakan</button>
          <button type="button" class="secondary" id="btn-rename-scenario">âœï¸ Namakan semula</button>
          <button type="button" class="secondary" id="btn-delete-scenario">ğŸ—‘ï¸ Padam</button>
          <button type="button" class="secondary" id="btn-reset-scenario">ğŸ”„ Reset senario</button>
          <button type="button" class="primary" id="btn-save-scenario">ğŸ’¾ Simpan senario</button>
          <button type="button" class="secondary" id="btn-load-preset">ğŸŒŸ Muatkan contoh (preset)</button>
        </div>
        <div class="scenario-list" id="scenario-list"></div>
      </div>
      <p class="mode-note">Setiap senario menyimpan input & output (permintaan, bekalan, NPV/BCR, payback). Data kekal dalam pelayar melalui localStorage.</p>
    </section>
    <!-- INPUT KATEGORI DEMAND -->
    <section class="card mode-block" data-modes="operational,full" id="section-demand">
      <h2><span class="icon">ğŸ“¥</span> Input Permintaan Air Mengikut Kategori</h2>
      <div class="demand-mode-note" id="category-guard">Pilih â€œGunakan Demand Mengikut Kategoriâ€ untuk mengaktifkan jadual ini. Input Quick akan dikunci.</div>
      <p class="lead">
        Tetapkan kategori (contoh: Asrama, Fakulti & Pentadbiran, Masjid, Sukan)
        bersama bilangan pengguna, kadar penggunaan per kapita, dan faktor
        permintaan puncak (peak factor).
      </p>

      <div class="option-toggle" id="category-input-toggle">
        <label>
          <input type="radio" name="category-input-mode" value="manual" checked />
          Isi terus (manual)
        </label>
        <label>
          <input type="radio" name="category-input-mode" value="excel" />
          Muat naik Excel
        </label>
      </div>

      <div class="excel-panel hidden" id="excel-panel">
        <div class="btn-row" style="margin-top:0;">
          <button type="button" class="secondary" id="btn-download-template">ğŸ“¥ Muat turun template Excel</button>
          <label class="upload-btn">
            ğŸ“¤ Muat naik Excel
            <input type="file" id="excel-upload" accept=".xlsx,.xls" />
          </label>
        </div>
        <p class="mini" id="excel-summary">Sokong fail .xlsx dengan lajur: nama_bangunan, populasi_orang, per_kapita_L_org_hari, faktor_puncak.</p>
      </div>

      <div class="note">
        Tip: 1 mÂ³/hari = 1,000 L/hari. Peak factor biasa 1.2â€“1.5 untuk asrama
        & kawasan tumpuan pelajar.
      </div>

      <div class="demand-table-wrap">
        <table id="category-input-table">
          <thead>
            <tr>
              <th>Kategori</th>
              <th>Populasi (orang)</th>
              <th>Per kapita (L/org/hari)</th>
              <th>Faktor puncak</th>
            </tr>
          </thead>
          <tbody id="category-body">
            <tr class="category-row">
              <td><input type="text" class="cat-name" value="Asrama" /></td>
              <td><input type="number" class="cat-pop" value="6621" min="0" /></td>
              <td><input type="number" class="cat-percap" value="200" min="0" /></td>
              <td><input type="number" class="cat-peak" value="1.3" min="1" step="0.05" /></td>
            </tr>
            <tr class="category-row">
              <td>
                <input type="text" class="cat-name" value="Fakulti & Pentadbiran" />
              </td>
              <td><input type="number" class="cat-pop" value="8000" min="0" /></td>
              <td><input type="number" class="cat-percap" value="50" min="0" /></td>
              <td><input type="number" class="cat-peak" value="1.2" min="1" step="0.05" /></td>
            </tr>
            <tr class="category-row">
              <td><input type="text" class="cat-name" value="Masjid & Surau" /></td>
              <td><input type="number" class="cat-pop" value="3000" min="0" /></td>
              <td><input type="number" class="cat-percap" value="15" min="0" /></td>
              <td><input type="number" class="cat-peak" value="1.5" min="1" step="0.05" /></td>
            </tr>
            <tr class="category-row">
              <td><input type="text" class="cat-name" value="Sukan & Rekreasi" /></td>
              <td><input type="number" class="cat-pop" value="1500" min="0" /></td>
              <td><input type="number" class="cat-percap" value="60" min="0" /></td>
              <td><input type="number" class="cat-peak" value="1.4" min="1" step="0.05" /></td>
            </tr>
            <tr class="category-row">
              <td>
                <input type="text" class="cat-name"
                       placeholder="Kategori tambahan (jika ada)" />
              </td>
              <td><input type="number" class="cat-pop" min="0" /></td>
              <td><input type="number" class="cat-percap" min="0" /></td>
              <td><input type="number" class="cat-peak" value="1.3" min="1" step="0.05" /></td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="btn-row">
        <button id="add-row-btn" type="button" class="secondary">
          â• Tambah baris kategori
        </button>
      </div>
    </section>

    <!-- INPUT SUPPLY (JANS) -->
    <section class="card" id="section-supply">
      <h2><span class="icon">ğŸš°</span> Input Bekalan Air (Supply Sedia Ada)</h2>
      <p class="lead">
        Masukkan anggaran kapasiti bekalan air harian yang diterima kampus
        (daripada JANS dan sumber utama lain). Nilai dalam juta liter sehari (MLD).
      </p>

      <label for="supply-mld">Kapasiti bekalan harian sedia ada (MLD)</label>
      <div class="mini-input">
        <input type="number" id="supply-mld" value="5" min="0" step="0.1" />
        <span class="unit-label">MLD</span>
      </div>
      <div class="note">
        Contoh: jika UMS menerima sekitar 4.5â€“5.0 MLD daripada loji rawatan.
      </div>
    </section>

    <!-- PARAMETER TARIF & KEWANGAN -->
    <section class="card" id="section-finance">
      <h2><span class="icon">ğŸ’¹</span> Parameter Tarif & Kewangan</h2>
      <p class="lead">
        Parameter ini digunakan untuk mengira penjimatan bil air & pembetungan
        serta NPV, BCR dan anggaran payback bagi setiap sumber air alternatif.
      </p>

      <div class="input-grid">
        <div>
          <label for="tariff-water">Tarif air terawat (RM/mÂ³)</label>
          <div class="mini-input">
            <input type="number" id="tariff-water" value="1.20" min="0" step="0.01" />
            <span class="unit-label">RM/mÂ³</span>
          </div>
        </div>
        <div>
          <label for="tariff-sewer">Kadar pembetungan (RM/mÂ³)</label>
          <div class="mini-input">
            <input type="number" id="tariff-sewer" value="0.80" min="0" step="0.01" />
            <span class="unit-label">RM/mÂ³</span>
          </div>
        </div>
        <div>
          <label for="analysis-years">Tempoh analisis kewangan (tahun)</label>
          <div class="mini-input">
            <input type="number" id="analysis-years" value="20" min="1" step="1" />
            <span class="unit-label">tahun</span>
          </div>
        </div>
        <div>
          <label for="discount-rate">Kadar diskaun (% setahun)</label>
          <div class="mini-input">
            <input type="number" id="discount-rate" value="5" min="0" step="0.1" />
            <span class="unit-label">%/tahun</span>
          </div>
        </div>
      </div>

      <div class="note">
        Kebiasaannya kadar diskaun 3â€“7% digunakan untuk projek infrastruktur
        awam, bergantung kepada garis panduan agensi.
      </div>
    </section>

    <section class="card calc-removed" id="section-calc-actions">
      <!-- Disimpan untuk keserasian JS tetapi disembunyikan di CSS; bar melekat mengendalikan KIRA & simpan. -->
      <h2><span class="icon">ğŸš€</span> Jalankan Kiraan & Simpan Senario</h2>
      <div id="calc-alert" class="calc-alert hidden"></div>
      <div class="btn-row">
        <button id="btnKira" type="button" class="primary">
          ğŸš€ KIRA SEKARANG
        </button>
        <button type="button" class="secondary" id="btn-save-scenario-cta">ğŸ’¾ SIMPAN SENARIO</button>
      </div>
      <p class="tagline" id="calc-location-note">Pastikan Langkah 1â€“3 diisi (Permintaan, Bekalan, Kewangan). Untuk Mod Full CBA, semak CAPEX/OPEX sebelum mengira.</p>
    </section>

    <!-- INPUT SUMBER AIR ALTERNATIF -->
    <section class="card mode-block" data-modes="operational,full" id="section-alt">
      <h2><span class="icon">ğŸ’§</span> Sumber Air Alternatif (Extra Supply & CBA)</h2>
      <p class="lead">
        Masukkan kapasiti teknikal, faktor penggunaan, CAPEX, OPEX dan nota
        perincian kos bagi setiap sumber air alternatif. Sumber ini akan menambah
        bekalan efektif dan digunakan dalam analisis kosâ€“faedah.
      </p>

      <div style="overflow-x: auto; margin-top: 0.6rem;">
        <table id="alt-input-table">
          <thead>
            <tr>
              <th>Sumber</th>
              <th>Kapasiti (mÂ³/hari)</th>
              <th>Faktor penggunaan (% hari/tahun)</th>
              <th>Kebolehpercayaan operasi (%)</th>
              <th>CAPEX (RM)</th>
              <th>Butiran CAPEX (ringkas)</th>
              <th>OPEX tetap (RM/tahun)</th>
              <th>OPEX berubah (RM/mÂ³)</th>
              <th>Butiran OPEX (ringkas)</th>
              <th>Jangka hayat (tahun)</th>
            </tr>
          </thead>
          <tbody id="alt-body">
            <tr class="alt-row">
              <td><input type="text" class="alt-name" value="Tangkapan air hujan" /></td>
              <td><input type="number" class="alt-capacity" value="300" min="0" /></td>
              <td><input type="number" class="alt-util" value="80" min="0" max="100" /></td>
              <td><input type="number" class="alt-reliability" value="90" min="0" max="100" /></td>
              <td><input type="number" class="alt-capex" value="1200000" min="0" /></td>
              <td><input type="text" class="alt-capex-note"
                     value="Struktur tangki, gutter, paip agihan, pam dan panel kawalan" /></td>
              <td><input type="number" class="alt-opex-fixed" value="60000" min="0" /></td>
              <td><input type="number" class="alt-opex-var" value="0.10" min="0" step="0.01" /></td>
              <td><input type="text" class="alt-opex-note"
                     value="Elektrik pam, penyelenggaraan berkala dan pembersihan tangki" /></td>
              <td><input type="number" class="alt-life" value="25" min="1" /></td>
            </tr>
            <tr class="alt-row">
              <td><input type="text" class="alt-name" value="Air tasik / tasik kampus" /></td>
              <td><input type="number" class="alt-capacity" value="200" min="0" /></td>
              <td><input type="number" class="alt-util" value="70" min="0" max="100" /></td>
              <td><input type="number" class="alt-reliability" value="90" min="0" max="100" /></td>
              <td><input type="number" class="alt-capex" value="900000" min="0" /></td>
              <td><input type="text" class="alt-capex-note"
                     value="Pam pengabstrakan, paip penghantaran, sistem penapisan" /></td>
              <td><input type="number" class="alt-opex-fixed" value="45000" min="0" /></td>
              <td><input type="number" class="alt-opex-var" value="0.15" min="0" step="0.01" /></td>
              <td><input type="text" class="alt-opex-note"
                     value="Elektrik pam, bahan kimia dan penyelenggaraan penapis" /></td>
              <td><input type="number" class="alt-life" value="20" min="1" /></td>
            </tr>
            <tr class="alt-row">
              <td><input type="text" class="alt-name" value="Reuse (greywater / RO)" /></td>
              <td><input type="number" class="alt-capacity" value="250" min="0" /></td>
              <td><input type="number" class="alt-util" value="80" min="0" max="100" /></td>
              <td><input type="number" class="alt-reliability" value="85" min="0" max="100" /></td>
              <td><input type="number" class="alt-capex" value="1500000" min="0" /></td>
              <td><input type="text" class="alt-capex-note"
                     value="Unit rawatan, tangki imbangan, sistem paip dwi-saluran" /></td>
              <td><input type="number" class="alt-opex-fixed" value="90000" min="0" /></td>
              <td><input type="number" class="alt-opex-var" value="0.25" min="0" step="0.01" /></td>
              <td><input type="text" class="alt-opex-note"
                     value="Bahan kimia, tenaga elektrik dan operator" /></td>
              <td><input type="number" class="alt-life" value="20" min="1" /></td>
            </tr>
            <tr class="alt-row">
              <td><input type="text" class="alt-name" value="Kondensasi penghawa dingin" /></td>
              <td><input type="number" class="alt-capacity" value="50" min="0" /></td>
              <td><input type="number" class="alt-util" value="90" min="0" max="100" /></td>
              <td><input type="number" class="alt-reliability" value="95" min="0" max="100" /></td>
              <td><input type="number" class="alt-capex" value="200000" min="0" /></td>
              <td><input type="text" class="alt-capex-note"
                     value="Pengumpulan kondensat, tangki kecil dan pam pemindahan" /></td>
              <td><input type="number" class="alt-opex-fixed" value="15000" min="0" /></td>
              <td><input type="number" class="alt-opex-var" value="0.05" min="0" step="0.01" /></td>
              <td><input type="text" class="alt-opex-note"
                     value="Elektrik tambahan dan penyelenggaraan" /></td>
              <td><input type="number" class="alt-life" value="15" min="1" /></td>
            </tr>
            <tr class="alt-row">
              <td><input type="text" class="alt-name" placeholder="Sumber tambahan" /></td>
              <td><input type="number" class="alt-capacity" min="0" /></td>
              <td><input type="number" class="alt-util" min="0" max="100" /></td>
              <td><input type="number" class="alt-reliability" min="0" max="100" value="90" /></td>
              <td><input type="number" class="alt-capex" min="0" /></td>
              <td><input type="text" class="alt-capex-note"
                     placeholder="Butiran CAPEX (jika ada)" /></td>
              <td><input type="number" class="alt-opex-fixed" min="0" /></td>
              <td><input type="number" class="alt-opex-var" min="0" step="0.01" /></td>
              <td><input type="text" class="alt-opex-note"
                     placeholder="Butiran OPEX (jika ada)" /></td>
              <td><input type="number" class="alt-life" min="1" /></td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="btn-row">
        <button id="add-alt-row-btn" type="button" class="secondary">
          â• Tambah baris sumber alternatif
        </button>
      </div>
      <p class="mini">
        Nota: Butiran CAPEX dan OPEX membantu penjajaran dengan garis panduan EPU/MOF
        (contoh pecahan kepada infrastruktur, peralatan, tenaga kerja, O&M).
      </p>
    </section>

    <!-- PENGIRAAN TERPERINCI CAPEX & OPEX MENGIKUT ITEM -->
    <section class="card mode-block" data-modes="full" id="section-capex">
      <h2><span class="icon">ğŸ§¾</span> Pengiraan Terperinci CAPEX & OPEX Mengikut Item</h2>
      <p class="lead">
        Jadual mini ini membolehkan pecahan CAPEX dan OPEX mengikut item
        (contoh: tangki, pam, paip, operator, elektrik). Jumlah CAPEX dan OPEX
        boleh dirujuk semula apabila mengisi jadual sumber air alternatif.
      </p>

      <div style="overflow-x:auto;">
        <table id="capex-opex-items-table">
          <thead>
            <tr>
              <th>Jenis</th>
              <th>Item / Komponen</th>
              <th>Kuantiti</th>
              <th>Kos seunit (RM)</th>
              <th>Jumlah kos (RM)</th>
              <th>Catatan</th>
            </tr>
          </thead>
          <tbody id="capex-opex-body">
            <tr class="capex-opex-row">
              <td>
                <select class="item-type">
                  <option value="CAPEX">CAPEX</option>
                  <option value="OPEX">OPEX</option>
                </select>
              </td>
              <td><input type="text" class="item-name" value="Tangki simpanan air hujan" /></td>
              <td><input type="number" class="item-qty" value="2" min="0" step="0.01" /></td>
              <td><input type="number" class="item-cost" value="150000" min="0" step="0.01" /></td>
              <td class="item-total">0.00</td>
              <td><input type="text" class="item-note" value="Termasuk asas konkrit dan pemasangan" /></td>
            </tr>
            <tr class="capex-opex-row">
              <td>
                <select class="item-type">
                  <option value="CAPEX">CAPEX</option>
                  <option value="OPEX">OPEX</option>
                </select>
              </td>
              <td><input type="text" class="item-name" value="Pam dan paip agihan utama" /></td>
              <td><input type="number" class="item-qty" value="1" min="0" step="0.01" /></td>
              <td><input type="number" class="item-cost" value="250000" min="0" step="0.01" /></td>
              <td class="item-total">0.00</td>
              <td><input type="text" class="item-note" value="Termasuk panel kawalan" /></td>
            </tr>
            <tr class="capex-opex-row">
              <td>
                <select class="item-type">
                  <option value="OPEX" selected>OPEX</option>
                  <option value="CAPEX">CAPEX</option>
                </select>
              </td>
              <td><input type="text" class="item-name" value="Elektrik pam air hujan" /></td>
              <td><input type="number" class="item-qty" value="12" min="0" step="1" /></td>
              <td><input type="number" class="item-cost" value="4000" min="0" step="0.01" /></td>
              <td class="item-total">0.00</td>
              <td><input type="text" class="item-note" value="Anggaran bil elektrik setahun" /></td>
            </tr>
          </tbody>
          <tfoot>
            <tr>
              <td colspan="4"><strong>Jumlah CAPEX (daripada jadual item)</strong></td>
              <td id="capex-items-total">0.00</td>
              <td></td>
            </tr>
            <tr>
              <td colspan="4"><strong>Jumlah OPEX (daripada jadual item)</strong></td>
              <td id="opex-items-total">0.00</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="btn-row">
        <button id="add-capex-opex-item-btn" type="button" class="secondary">
          â• Tambah baris item
        </button>
      </div>
      <p class="mini">
        Nota: Jumlah CAPEX dan OPEX di sini boleh dijadikan rujukan dan dipadankan
        secara manual dengan CAPEX/OPEX mengikut sumber air alternatif di atas.
      </p>
    </section>

    <!-- ANALISIS KATEGORI DEMAND -->
    <section class="card" id="section-results">
      <h2><span class="icon">ğŸ“Š</span> Analisis Permintaan Air Mengikut Kategori</h2>
      <p class="lead">
        Jadual ini menunjukkan permintaan purata dan puncak (peak) bagi setiap
        kategori berdasarkan input yang dimasukkan.
      </p>

      <div style="overflow-x: auto;">
        <table id="results-table">
          <thead>
            <tr>
              <th>Kategori</th>
              <th>Populasi</th>
              <th>Per kapita (L/org/hari)</th>
              <th>Purata (mÂ³/hari)</th>
              <th>Faktor puncak</th>
              <th>Permintaan puncak (mÂ³/hari)</th>
            </tr>
          </thead>
          <tbody id="results-body">
            <!-- JS akan isi -->
          </tbody>
          <tfoot>
            <tr>
              <td>Jumlah</td>
              <td id="total-pop">â€“</td>
              <td>â€“</td>
              <td id="total-avg-m3">â€“</td>
              <td>â€“</td>
              <td id="total-peak-m3">â€“</td>
            </tr>
            <tr>
              <td>Jumlah dalam MLD</td>
              <td colspan="2"></td>
              <td id="total-avg-mld">â€“</td>
              <td></td>
              <td id="total-peak-mld">â€“</td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="chip">ğŸ”¹ Purata = Populasi Ã— Per kapita / 1,000</div>
      <div class="chip">ğŸ”¹ Puncak = Purata Ã— Faktor puncak</div>
    </section>

    <!-- DEMAND VS SUPPLY + EXPORT -->
    <section class="card" id="section-balance">
      <h2><span class="icon">âš–ï¸</span> Ringkasan Demandâ€“Supply (MLD)</h2>
      <div class="two-column">
        <div>
          <table id="summary-table">
            <thead>
              <tr>
                <th>Item</th>
                <th>Nilai (MLD)</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <tr id="row-avg">
                <td>Jumlah permintaan purata</td>
                <td id="summary-avg-mld">â€“</td>
                <td id="status-avg">â€“</td>
              </tr>
              <tr id="row-peak">
                <td>Jumlah permintaan puncak</td>
                <td id="summary-peak-mld">â€“</td>
                <td id="status-peak">â€“</td>
              </tr>
              <tr>
                <td>Bekalan sedia ada (JANS)</td>
                <td id="supply-avg-mld">â€“</td>
                <td></td>
              </tr>
              <tr>
                <td>Extra supply (air hujan / reuse / tasik / AC)</td>
                <td id="alt-supply-mld">â€“</td>
                <td></td>
              </tr>
              <tr>
                <td><strong>Bekalan efektif (JANS + sumber alternatif)</strong></td>
                <td id="effective-supply-mld">â€“</td>
                <td></td>
              </tr>
              <tr>
                <td>Lebihan / Defisit purata</td>
                <td id="surplus-avg-mld">â€“</td>
                <td></td>
              </tr>
              <tr>
                <td>Lebihan / Defisit semasa puncak</td>
                <td id="surplus-peak-mld">â€“</td>
                <td></td>
              </tr>
            </tbody>
          </table>

          <div class="report-options" style="margin:0.8rem 0;">
            <div class="mini-input">
              <label for="pdf-scope">Laporan untuk:</label>
              <select id="pdf-scope">
                <option value="active">Senario terpilih sahaja</option>
                <option value="all">Semua senario (Aâ€“C)</option>
              </select>
            </div>
            <div class="mini-input">
              <label for="pdf-level">Tahap laporan:</label>
              <select id="pdf-level">
                <option value="ringkas">Ringkas (Top Mgmt)</option>
                <option value="penuh">Penuh (Teknikal + Lampiran)</option>
              </select>
            </div>
            <div class="mini-input">
              <label for="prepared-by">Disediakan oleh (opsyenal)</label>
              <input type="text" id="prepared-by" placeholder="Nama penyedia laporan" />
            </div>
            <div class="mini-input">
              <label for="pdf-charts-toggle">Sertakan grafik</label>
              <select id="pdf-charts-toggle">
                <option value="yes">Ya, sertakan carta & rajah</option>
                <option value="no">Tidak perlu carta</option>
              </select>
            </div>
          </div>

          <div class="btn-row" style="margin-top: 0.8rem;">
            <button id="export-excel-btn" type="button" class="export">
              ğŸ“¤ Eksport Excel (.xlsx)
            </button>
            <button id="btn-download-pptx" type="button" class="secondary">
              ğŸ“‘ Muat turun PowerPoint (Top Mgmt)
            </button>
            <button id="btn-generate-report" type="button" class="primary">
              Jana Laporan (PDF)
            </button>
          </div>
          <label class="confidential-toggle">
            <input type="checkbox" id="confidential-toggle" />
            <span>Sertakan footer â€œSulit/Untuk Kegunaan Dalaman (Jika perlu)â€ dalam PDF</span>
          </label>

          <div class="summary-text" id="summary-text">
            Tekan butang <strong>â€œKira permintaan & banding dengan bekalanâ€</strong>
            untuk melihat ringkasan analisis termasuk kesan sumber alternatif.
          </div>
        </div>

        <div>
          <canvas id="demand-by-category-chart" height="200"></canvas>
          <div class="summary-text" id="chart-explain-category"></div>
        </div>
      </div>
    </section>

    <!-- PIE CHART DEMAND SHARE -->
    <section class="card" id="section-chart-category">
      <h2><span class="icon">ğŸ“ˆ</span> Agihan Permintaan Mengikut Kategori</h2>
      <p class="lead">
        Rajah menunjukkan sumbangan (%) setiap kategori kepada permintaan purata
        keseluruhan kampus.
      </p>
      <canvas id="demand-share-chart" height="200"></canvas>
      <div class="summary-text" id="chart-explain-share"></div>
    </section>

    <!-- ANALISIS CBA SUMBER ALTERNATIF -->
    <section class="card" id="section-alt-analysis">
      <h2><span class="icon">ğŸ’¼</span> Analisis Kewangan Sumber Air Alternatif</h2>
      <p class="lead">
        Jadual di bawah merumuskan volum, penjimatan, CAPEX, OPEX, aliran tunai
        bersih, payback period, NPV dan BCR bagi setiap sumber air alternatif.
      </p>

      <div style="overflow-x: auto;">
        <table id="alt-results-table">
          <thead>
            <tr>
              <th>Sumber</th>
              <th>Kapasiti (mÂ³/hari)</th>
              <th>Utilisasi (% hari)</th>
              <th>Kebolehpercayaan (%)</th>
              <th>Vol. tahunan (mÂ³/tahun)</th>
              <th>CAPEX (RM)</th>
              <th>OPEX tahunan (RM/tahun)</th>
              <th>Saving air + pembetungan (RM/tahun)</th>
              <th>CF bersih (RM/tahun)</th>
              <th>Tempoh pulangan modal (tahun)</th>
              <th>NPV (RM)</th>
              <th>BCR</th>
            </tr>
          </thead>
          <tbody id="alt-results-body">
            <!-- JS akan isi -->
          </tbody>
          <tfoot>
            <tr>
              <td>Jumlah / Agregat</td>
              <td id="alt-total-capacity">â€“</td>
              <td>â€“</td>
              <td>â€“</td>
              <td id="alt-total-volume">â€“</td>
              <td id="alt-total-capex">â€“</td>
              <td id="alt-total-opex">â€“</td>
              <td id="alt-total-saving">â€“</td>
              <td id="alt-total-netcf">â€“</td>
              <td>â€“</td>
              <td id="alt-total-npv">â€“</td>
              <td id="alt-total-bcr">â€“</td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="two-column" style="margin-top: 1rem;">
        <div>
          <h3 style="font-size:0.96rem; margin-top:0;">Ringkasan Kewangan Projek</h3>
          <table id="alt-summary-table">
            <tbody>
              <tr>
                <td>Jumlah CAPEX semua sumber</td>
                <td id="sum-capex">â€“</td>
              </tr>
              <tr>
                <td>Jumlah penjimatan air + pembetungan / tahun</td>
                <td id="sum-saving">â€“</td>
              </tr>
              <tr>
                <td>Jumlah OPEX / tahun</td>
                <td id="sum-opex">â€“</td>
              </tr>
              <tr>
                <td>Aliran tunai bersih tahunan</td>
                <td id="sum-netcf">â€“</td>
              </tr>
              <tr>
                <td>NPV projek (semua sumber)</td>
                <td id="sum-npv">â€“</td>
              </tr>
              <tr>
                <td>BCR projek (semua sumber)</td>
                <td id="sum-bcr">â€“</td>
              </tr>
              <tr>
                <td>Anggaran IRR projek (mengikut aliran tunai bersih)</td>
                <td id="sum-irr">â€“</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div>
          <canvas id="cba-npv-chart" height="200" style="margin-bottom:0.8rem;"></canvas>
          <div class="summary-text" id="chart-explain-npv"></div>
          <canvas id="cba-payback-chart" height="200"></canvas>
          <div class="summary-text" id="chart-explain-payback"></div>
        </div>
      </div>
    </section>

    <!-- METODOLOGI + DISCLAIMER -->
    <section class="card" id="section-method">
      <h2><span class="icon">ğŸ§®</span> Nota Metodologi (Ringkas) & Penafian</h2>
      <div class="disclaimer">
        <p><strong>Metodologi ringkas:</strong></p>
        <ul style="margin-top: 0.2rem; padding-left: 1.1rem;">
          <li>
            <strong>Langkah 1 â€“ Per kapita:</strong> Untuk setiap kategori demand,
            permintaan purata dikira berdasarkan bilangan pengguna dikali kadar
            penggunaan per kapita (L/org/hari), ditukar kepada mÂ³/hari.
          </li>
          <li>
            <strong>Langkah 2 â€“ Permintaan puncak:</strong> Nilai purata
            digandakan dengan faktor puncak (contoh 1.3) bagi menggambarkan hari
            atau masa penggunaan tertinggi.
          </li>
          <li>
            <strong>Langkah 3 â€“ Extra supply:</strong> Kapasiti sumber air
            alternatif ditukar kepada bekalan efektif (mÂ³/hari) menggunakan
            faktor penggunaan (% hari/tahun) dan ditambah kepada bekalan JANS.
          </li>
          <li>
            <strong>Langkah 4 â€“ Penjimatan & CBA:</strong> Volum air alternatif
            dikalikan dengan tarif air + pembetungan untuk mendapatkan penjimatan
            tahunan, ditolak OPEX untuk mendapatkan aliran tunai bersih.
            NPV dan BCR dikira menggunakan tempoh analisis dan kadar diskaun
            yang ditetapkan.
          </li>
        </ul>

        <p style="margin-top: 0.7rem;"><strong>Penafian:</strong></p>
        <p>
          Kalkulator ini disediakan untuk tujuan perancangan dan analisis awal
          (planning-level estimate) berdasarkan andaian input pengguna. Nilai
          yang dijana bukanlah rekod rasmi penggunaan atau bekalan air
          Universiti Malaysia Sabah dan tidak menggantikan data meter/bil air
          yang disahkan oleh pihak berkuasa berkaitan. Sebarang keputusan
          kejuruteraan atau pelaburan sebenar hendaklah dirujuk dan disahkan
          dengan data teknikal terperinci serta pihak berkepentingan rasmi.
        </p>
      </div>
    </section>
  </main>

  <div id="reportRoot" class="report hidden offscreen" aria-hidden="true"></div>

  <footer>
    Â© 2025 Assis, Fera, Sarimah & Sani @ RuWaS UMS. Hak cipta terpelihara.
  </footer>

  <script>
    window.addEventListener("DOMContentLoaded", () => {
      // Wizard elements
      const wizardOverlay = document.getElementById("wizard-overlay");
      const wizardContent = document.getElementById("wizard-content");
      const wizardStepList = document.getElementById("wizard-step-list");
      const quickStepper = document.getElementById("quick-stepper");
      const stepperPanel = document.getElementById("stepper-panel");
      const stepperGrid = document.getElementById("stepper-grid");
      const stepperStatusPill = document.getElementById("stepper-status-pill");
      const stepperToggle = document.getElementById("stepper-toggle");
      const stepperToggleIcon = document.getElementById("stepper-toggle-icon");
      const stepperToggleText = document.getElementById("stepper-toggle-text");
      const stepperCloseBtn = document.getElementById("stepper-close");
      const stepperFloatingBtn = document.getElementById("stepper-floating-btn");
      const wizardOpenBtn = document.getElementById("btn-open-wizard");
      const wizardCloseBtn = document.getElementById("btn-close-wizard");
      const wizardNextBtn = document.getElementById("wizard-next");
      const wizardBackBtn = document.getElementById("wizard-back");
      const wizardSkipBtn = document.getElementById("wizard-skip");
      const wizardStatus = document.getElementById("wizard-status");
      const mainEl = document.querySelector("main");
      const heroModeHolder = document.getElementById("hero-mode-holder");
      const heroScenarioHolder = document.getElementById("hero-scenario-holder");
      const inputStepsContainer = document.getElementById("input-steps");
      const outputWrapper = document.getElementById("output-wrapper");
      const outputBlock = document.getElementById("output-block");
      const outputEmpty = document.getElementById("output-empty");
      const errorBanner = document.getElementById("error-banner");
      const exportWrapper = document.getElementById("export-wrapper");
      const exportSlot = document.getElementById("export-slot");
      const jumpCalcBtn = document.getElementById("btn-jump-calc");
      const calcStatusChip = document.getElementById("calc-status-chip");
      const calcInlineAlert = document.getElementById("calc-inline-alert");
      const resetInputsBtn = document.getElementById("btn-reset-inputs");
      const presetHeroBtn = document.getElementById("btn-load-preset-hero");
      const calcActionsSection = document.getElementById("section-calc-actions");
      const calcAlertBox = document.getElementById("calc-alert");
      const calcLocationNote = document.getElementById("calc-location-note");
      const sectionMap = {
        mode: document.getElementById("section-mode"),
        quick: document.getElementById("section-quick"),
        scenario: document.getElementById("section-scenario"),
        demand: document.getElementById("section-demand"),
        supply: document.getElementById("section-supply"),
        finance: document.getElementById("section-finance"),
        alt: document.getElementById("section-alt"),
        capex: document.getElementById("section-capex"),
        calc: document.getElementById("section-calc-actions"),
        results: document.getElementById("section-results"),
      };

      const addRowBtn = document.getElementById("add-row-btn");
      const calcBtn = document.getElementById("btnKira");
      const exportBtn = document.getElementById("export-excel-btn");
      const pptxBtn = document.getElementById("btn-download-pptx");
      const generateReportBtn = document.getElementById("btn-generate-report");
      const backToInputBtn = document.getElementById("btn-back-to-input");
      const confidentialToggle = document.getElementById("confidential-toggle");
      const modeSelector = document.getElementById("mode-selector");
      const modeNote = document.getElementById("mode-note");
      const validationBox = document.getElementById("validation-box");
      const validationList = document.getElementById("validation-list");
      const fixInputBtn = document.getElementById("btn-fix-inputs");
      const autofillBtn = document.getElementById("btn-autofill");
      const pdfScopeSelect = document.getElementById("pdf-scope");
      const pdfLevelSelect = document.getElementById("pdf-level");
      const preparedByInput = document.getElementById("prepared-by");
      const pdfChartsToggle = document.getElementById("pdf-charts-toggle");
      const reportRoot = document.getElementById("reportRoot");
      const categoryBody = document.getElementById("category-body");
      const toggleAdvancedBtn = document.getElementById("btn-toggle-advanced");
      const demandModeRadios = document.querySelectorAll("input[name='demand-mode']");
      const categoryGuard = document.getElementById("category-guard");
      const categoryInputToggle = document.getElementById("category-input-toggle");
      const excelPanel = document.getElementById("excel-panel");
      const excelUpload = document.getElementById("excel-upload");
      const excelSummary = document.getElementById("excel-summary");
      const downloadTemplateBtn = document.getElementById("btn-download-template");

      const addAltRowBtn = document.getElementById("add-alt-row-btn");
      const altBody = document.getElementById("alt-body");
      const quickAltInputs = {
        name: document.getElementById("quick-alt-name"),
        capacity: document.getElementById("quick-alt-capacity"),
        util: document.getElementById("quick-alt-util"),
        capex: document.getElementById("quick-alt-capex"),
        opex: document.getElementById("quick-alt-opex"),
      };
      const quickInputs = {
        pop: document.getElementById("quick-pop"),
        percap: document.getElementById("quick-percap"),
        demand: document.getElementById("quick-demand"),
        peak: document.getElementById("quick-peak"),
        baseSupply: document.getElementById("quick-base-supply"),
      };

      const resultsBody = document.getElementById("results-body");
      const totalPopEl = document.getElementById("total-pop");
      const totalAvgM3El = document.getElementById("total-avg-m3");
      const totalPeakM3El = document.getElementById("total-peak-m3");
      const totalAvgMLDEl = document.getElementById("total-avg-mld");
      const totalPeakMLDEl = document.getElementById("total-peak-mld");

      const supplyInput = document.getElementById("supply-mld");
      const summaryAvgMLDEl = document.getElementById("summary-avg-mld");
      const summaryPeakMLDEl = document.getElementById("summary-peak-mld");
      const supplyAvgMLDEl = document.getElementById("supply-avg-mld");
      const altSupplyMLDEl = document.getElementById("alt-supply-mld");
      const effectiveSupplyMLDEl = document.getElementById("effective-supply-mld");
      const surplusAvgMLDEl = document.getElementById("surplus-avg-mld");
      const surplusPeakMLDEl = document.getElementById("surplus-peak-mld");
      const statusAvgEl = document.getElementById("status-avg");
      const statusPeakEl = document.getElementById("status-peak");
      const summaryTextEl = document.getElementById("summary-text");
      const chartExplainCategory = document.getElementById("chart-explain-category");
      const chartExplainShare = document.getElementById("chart-explain-share");
      const chartExplainNPV = document.getElementById("chart-explain-npv");
      const chartExplainPayback = document.getElementById("chart-explain-payback");

      const rowAvg = document.getElementById("row-avg");
      const rowPeak = document.getElementById("row-peak");

      // CBA elements
      const altResultsBody = document.getElementById("alt-results-body");
      const altTotalCapacityEl = document.getElementById("alt-total-capacity");
      const altTotalVolumeEl = document.getElementById("alt-total-volume");
      const altTotalCapexEl = document.getElementById("alt-total-capex");
      const altTotalOpexEl = document.getElementById("alt-total-opex");
      const altTotalSavingEl = document.getElementById("alt-total-saving");
      const altTotalNetCFEl = document.getElementById("alt-total-netcf");
      const altTotalNPVEl = document.getElementById("alt-total-npv");
      const altTotalBCREl = document.getElementById("alt-total-bcr");

      const sumCapexEl = document.getElementById("sum-capex");
      const sumSavingEl = document.getElementById("sum-saving");
      const sumOpexEl = document.getElementById("sum-opex");
      const sumNetCFEl = document.getElementById("sum-netcf");
      const sumNPVEl = document.getElementById("sum-npv");
      const sumBCREl = document.getElementById("sum-bcr");
      const sumIRREl = document.getElementById("sum-irr");
      const activeScenarioBanner = document.getElementById("active-scenario-banner");

      const tariffWaterInput = document.getElementById("tariff-water");
      const tariffSewerInput = document.getElementById("tariff-sewer");
      const analysisYearsInput = document.getElementById("analysis-years");
      const discountRateInput = document.getElementById("discount-rate");

      // CAPEX/OPEX itemised
      const capexOpexBody = document.getElementById("capex-opex-body");
      const capexItemsTotalEl = document.getElementById("capex-items-total");
      const opexItemsTotalEl = document.getElementById("opex-items-total");
      const addItemBtn = document.getElementById("add-capex-opex-item-btn");
      const scenarioListEl = document.getElementById("scenario-list");
      const addScenarioBtn = document.getElementById("btn-add-scenario");
      const duplicateScenarioBtn = document.getElementById("btn-duplicate-scenario");
      const renameScenarioBtn = document.getElementById("btn-rename-scenario");
      const deleteScenarioBtn = document.getElementById("btn-delete-scenario");
      const saveScenarioBtn = document.getElementById("btn-save-scenario");
      const saveScenarioCtaBtn = document.getElementById("btn-save-scenario-cta");
      const resetScenarioBtn = document.getElementById("btn-reset-scenario");
      const presetBtn = document.getElementById("btn-load-preset");

      const categoryChartCtx = document
        .getElementById("demand-by-category-chart")
        .getContext("2d");
      const shareChartCtx = document
        .getElementById("demand-share-chart")
        .getContext("2d");
      const cbaNPVCtx = document
        .getElementById("cba-npv-chart")
        .getContext("2d");
      const cbaPaybackCtx = document
        .getElementById("cba-payback-chart")
        .getContext("2d");
      const scenarioCompareTable = document.getElementById("scenario-compare-table");
      const sensitivityLabels = {
        base: document.getElementById("sens-base"),
        capex: document.getElementById("sens-capex"),
        opex: document.getElementById("sens-opex"),
        benefit: document.getElementById("sens-benefit"),
      };
      const compareEmpty = document.getElementById("compare-empty");
      const sensEmpty = document.getElementById("sens-empty");
      const comparePlaceholder = document.getElementById("compare-placeholder");
      const sensPlaceholder = document.getElementById("sens-placeholder");
      const scenarioSaveStatus = document.getElementById("scenario-save-status");
      const defaultSummaryText = summaryTextEl?.innerHTML || "";
      const defaultChartExplainers = {
        category: chartExplainCategory?.innerHTML || "",
        share: chartExplainShare?.innerHTML || "",
        npv: chartExplainNPV?.innerHTML || "",
        payback: chartExplainPayback?.innerHTML || "",
      };
      const defaultInputValues = {
        supply: supplyInput.value,
        tariffWater: tariffWaterInput.value,
        tariffSewer: tariffSewerInput.value,
        analysisYears: analysisYearsInput.value,
        discountRate: discountRateInput.value,
        quickPeak: quickInputs.peak.value || "1.3",
        quickBaseSupply: quickInputs.baseSupply.value || "",
      };

      if (window.Chart && Chart.defaults) {
        Chart.defaults.animation = false;
        Chart.defaults.transitions = Chart.defaults.transitions || {};
        Chart.defaults.transitions.active = Chart.defaults.transitions.active || {};
        Chart.defaults.transitions.active.animation = { duration: 0 };
        Chart.defaults.maintainAspectRatio = false;
      }

      const umsLogoPath = "UMS logo.png";
      let umsLogoDataUrl = "";
      let pptxLibPromise = null;

      let categoryChart = null;
      let shareChart = null;
      let cbaNpvChart = null;
      let cbaPaybackChart = null;

      let lastAltSources = [];
      let lastAltSummary = {
        totalPVBenefits: 0,
        totalPVCosts: 0,
        pvCapex: 0,
        pvOpex: 0,
        payback: NaN,
      };

      const STORAGE_KEY = "ums-water-calculator-v2";
      const LEGACY_KEY = "ums-water-calculator";
      const SCHEMA_VERSION = 2;
      let appState = {
        version: SCHEMA_VERSION,
        mode: "quick",
        demandMode: "quick",
        activeScenarioId: "A",
        scenarios: {},
      };
      let hasCalculated = false;
      let lastCalculatedAt = null;

      const WIZARD_STORAGE_KEY = "ums-water-wizard-seen";
      let wizardSeen = localStorage.getItem(WIZARD_STORAGE_KEY) === "1";
      let wizardStep = 0;
      const STEPPER_STATE_KEY = "ums-water-stepper-state";
      let stepperState = { expanded: false, seen: false };
      let stepperAutoCollapseTimer = null;
      let stepperAutoCollapseArmed = false;
      const WIZ_SELECTORS = {
        mode: ["#mode-selector .pill[data-mode]"],
        scenarioA: [".btn-load-scenario[data-id='A']", "#scenario-list .scenario-card", "text:Senario A", "text:Muat & kira"],
        duplicateScenario: ["#btn-duplicate-scenario"],
        peakFactor: ["#quick-peak", "input[id*='peak']", "input.cat-peak", "label:faktor puncak"],
        quickDemand: ["#quick-demand", "label:permintaan harian"],
        categoryTable: ["#category-input-table", ".category-row", "label:Kategori"],
        baseSupply: ["#quick-base-supply", "#supply-mld", "label:Bekalan asas"],
        jansSupply: ["#supply-mld", "label:Bekalan JANS"],
        tariffWater: ["#tariff-water", "label:Tarif air"],
        tariffSewer: ["#tariff-sewer", "label:Tarif pembetungan"],
        horizon: ["#analysis-years", "label:Tempoh analisis"],
        discount: ["#discount-rate", "label:Kadar diskaun"],
        alternatives: ["#alt-body", "#alt-results-table", "label:Sumber alternatif"],
        calcBtn: ["#btnKira", "text:Kira"],
        summary: ["#summary-table", "#summary-text"],
        exportExcel: ["#export-excel-btn", "text:Eksport"],
        exportPdf: ["#btn-generate-report", "text:Jana Laporan"],
      };

      function loadStepperState() {
        try {
          const raw = localStorage.getItem(STEPPER_STATE_KEY);
          if (raw) {
            const parsed = JSON.parse(raw);
            stepperState = {
              expanded: !!parsed.expanded,
              seen: !!parsed.seen,
            };
          }
        } catch (e) {
          stepperState = { expanded: false, seen: false };
        }
      }

      function saveStepperState() {
        try {
          localStorage.setItem(STEPPER_STATE_KEY, JSON.stringify(stepperState));
        } catch (e) {
          // ignore storage failures
        }
      }

      function cancelAutoCollapse() {
        if (stepperAutoCollapseTimer) {
          clearTimeout(stepperAutoCollapseTimer);
          stepperAutoCollapseTimer = null;
        }
        stepperAutoCollapseArmed = false;
      }

      function updateFloatingButton() {
        if (!stepperFloatingBtn) return;
        const shouldShow = !stepperState.expanded && window.scrollY > 300;
        stepperFloatingBtn.style.display = shouldShow ? "inline-flex" : "none";
      }

      function updateStepperUI() {
        if (!quickStepper || !stepperPanel || !stepperToggle) return;
        quickStepper.classList.toggle("expanded", stepperState.expanded);
        quickStepper.classList.toggle("collapsed", !stepperState.expanded);
        stepperPanel.classList.toggle("hidden", !stepperState.expanded);
        stepperToggle.setAttribute("aria-expanded", stepperState.expanded ? "true" : "false");
        if (stepperToggleText) {
          stepperToggleText.textContent = stepperState.expanded ? "Sembunyi" : "Papar";
        }
        if (stepperToggleIcon) {
          stepperToggleIcon.textContent = stepperState.expanded ? "â–¾" : "â–¸";
        }
        updateFloatingButton();
      }

      function setStepperExpanded(expanded, { source = "manual", scrollIntoView = false } = {}) {
        if (typeof expanded !== "boolean") return;
        stepperState.expanded = expanded;
        if (expanded) {
          stepperState.seen = true;
          cancelAutoCollapse();
          if (scrollIntoView && quickStepper) {
            quickStepper.scrollIntoView({ behavior: "smooth", block: "start" });
          }
        } else {
          cancelAutoCollapse();
        }
        saveStepperState();
        updateStepperUI();
      }

      function armAutoCollapse() {
        cancelAutoCollapse();
        stepperAutoCollapseArmed = true;
        stepperAutoCollapseTimer = setTimeout(() => autoCollapseNow("timer"), 5000);
      }

      function autoCollapseNow() {
        if (!stepperAutoCollapseArmed) return;
        stepperAutoCollapseArmed = false;
        cancelAutoCollapse();
        if (stepperState.expanded) {
          setStepperExpanded(false, { source: "auto" });
        }
      }

      const quickStepperConfig = [
        {
          id: "mode",
          title: "Pilih Mod (Quick / Operational / Full)",
          target: "section-mode",
          hint: "Apa perlu isi: pilih mod asas. Quick memaparkan input minimum.",
          example: "Contoh: pilih Quick untuk mula segera.",
          required: () => !!appState.mode,
          requiredMessage: "Sila pilih salah satu mod.",
        },
        {
          id: "scenario",
          title: "Pilih Senario (A Baseline, B alternatif, C kombinasi)",
          target: "section-scenario",
          hint: "Apa perlu isi: kekalkan A sebagai baseline, gandakan ke B/C jika perlu.",
          example: "Contoh: klik \"Gandakan\" untuk cipta B daripada A.",
          required: () => !!activeScenario(),
          requiredMessage: "Aktifkan sekurang-kurangnya Senario A.",
        },
        {
          id: "demand",
          title: "Masukkan Permintaan",
          target: "section-quick",
          hint: "Apa perlu isi: jumlah permintaan harian atau populasi + per kapita + faktor puncak.",
          example: "Contoh: 15,000 orang Ã— 160 L/orang/hari, faktor puncak 1.3.",
          required: () => {
            if (appState.demandMode === "quick") {
              const pop = normalizeNumber(quickInputs.pop.value);
              const percap = normalizeNumber(quickInputs.percap.value);
              const demand = normalizeNumber(quickInputs.demand.value);
              const peak = normalizeNumber(quickInputs.peak.value);
              return (demand > 0 || (pop > 0 && percap > 0)) && peak > 0;
            }
            const rows = Array.from(document.querySelectorAll(".category-row"));
            return rows.some(
              (r) =>
                normalizeNumber(r.querySelector(".cat-pop")?.value) > 0 &&
                normalizeNumber(r.querySelector(".cat-percap")?.value) > 0
            );
          },
          requiredMessage: "Isi permintaan (jumlah atau kategori) dan faktor puncak.",
        },
        {
          id: "supply",
          title: "Masukkan Bekalan Asas (JANS MLD)",
          target: "section-supply",
          hint: "Apa perlu isi: bekalan harian sedia ada (MLD).",
          example: "Contoh: 5 MLD.",
          required: () => normalizeNumber(supplyInput.value) > 0,
          requiredMessage: "Isi bekalan asas (tidak negatif).",
        },
        {
          id: "finance",
          title: "Parameter Kewangan (Tarif, Tempoh, Diskaun)",
          target: "section-finance",
          hint: "Apa perlu isi: tarif air, tarif pembetungan, tahun analisis, kadar diskaun.",
          example: "Contoh: Tarif air 1.20, pembetungan 0.80, 20 tahun, diskaun 5%.",
          required: () => normalizeNumber(analysisYearsInput.value) > 0,
          requiredMessage: "Lengkapkan tarif/parameter kewangan.",
        },
        {
          id: "alt",
          title: "(Pilihan) Sumber Alternatif + CAPEX/OPEX",
          target: "section-alt",
          hint: "Apa perlu isi: nama sumber, kapasiti, utiliti (% hari), CAPEX/OPEX.",
          example: "Contoh: Tangkapan air hujan 300 mÂ³/hari, utiliti 80%, CAPEX RM1.2j.",
          required: () => true,
          requiredMessage: "",
        },
        {
          id: "summary",
          title: "Kira & Semak Ringkasan",
          target: "section-results",
          hint: "Apa perlu isi: tekan Kira untuk lihat surplus/defisit.",
          example: "Contoh: Tekan \"Kira permintaan & banding dengan bekalan\".",
          required: () => summaryAvgMLDEl.textContent && summaryAvgMLDEl.textContent !== "â€“",
          requiredMessage: "Tekan butang kira untuk menjana ringkasan.",
        },
        {
          id: "export",
          title: "Eksport (Excel) & Jana Laporan (PDF)",
          target: "section-results",
          hint: "Apa perlu isi: pilih skop & tahap laporan, kemudian Jana Laporan/Excel.",
          example: "Contoh: Skop \"Senario terpilih\", Tahap \"Penuh\".",
          required: () => true,
          requiredMessage: "",
        },
      ];

      function moveSectionTo(el, target) {
        if (!el || !target) return;
        target.appendChild(el);
      }

      function buildInputSteps() {
        if (!inputStepsContainer) return;
        inputStepsContainer.innerHTML = "";
        const steps = [
          {
            title: "Langkah 1 â€” Permintaan Air (WAJIB)",
            meta: "Pilih Quick atau Kategori. Hanya satu kaedah aktif.",
            badge: "WAJIB",
            nodes: [quickStepper, sectionMap.quick, sectionMap.demand].filter(Boolean),
          },
          {
            title: "Langkah 2 â€” Bekalan Asas (WAJIB)",
            meta: "Isi bekalan JANS (MLD) dan faktor kebolehpercayaan jika ada.",
            badge: "WAJIB",
            nodes: [sectionMap.supply].filter(Boolean),
          },
          {
            title: "Langkah 3 â€” Parameter Kewangan (WAJIB untuk analisis kewangan)",
            meta: "Tarif air & pembetungan, tempoh analisis, kadar diskaun.",
            badge: "WAJIB",
            nodes: [sectionMap.finance].filter(Boolean),
          },
          {
            title: "Langkah 4 â€” Sumber Air Alternatif (Pilihan)",
            meta: "Tambah sumber alternatif dengan kapasiti, utiliti & kos.",
            badge: "Pilihan",
            nodes: [sectionMap.alt].filter(Boolean),
          },
          {
            title: "Langkah 5 â€” CAPEX & OPEX Terperinci (Pilihan / Full CBA)",
            meta: "Isi pecahan item kos jika mahu.",
            badge: "Pilihan",
            nodes: [sectionMap.capex].filter(Boolean),
          },
        ];

        // Kiraan kini diuruskan oleh bar melekat & butang lain, jadi tiada seksyen tersendiri di sini.
        steps.forEach((step, idx) => {
          const details = document.createElement("details");
          details.className = "input-step";
          details.open = false;
          details.innerHTML = `
            <summary>
              <div>
                <div class="step-label">${step.badge}</div>
                <div>${step.title}</div>
                <div class="step-meta">${step.meta}</div>
              </div>
              <span aria-hidden="true">â–¾</span>
            </summary>
          `;
          const body = document.createElement("div");
          body.className = "step-body";
          step.nodes.forEach((node) => body.appendChild(node));
          if (steps[idx + 1]) {
            const nextBtn = document.createElement("button");
            nextBtn.type = "button";
            nextBtn.className = "secondary step-next";
            nextBtn.textContent = "Seterusnya â†’";
            nextBtn.addEventListener("click", () => {
              details.open = false;
              const next = inputStepsContainer.querySelectorAll(".input-step")[idx + 1];
              if (next) {
                next.open = true;
                next.scrollIntoView({ behavior: "smooth", block: "start" });
                next.classList.add("section-highlight");
                setTimeout(() => next.classList.remove("section-highlight"), 1200);
              }
            });
            body.appendChild(nextBtn);
          }
          details.appendChild(body);
          inputStepsContainer.appendChild(details);
        });
      }

      function buildOutputLayout() {
        if (!outputBlock) return;
        outputBlock.innerHTML = "";
        const outputs = [
          { title: "Output 1 â€” Ringkasan Eksekutif", node: document.getElementById("section-balance") },
          { title: "Output 2 â€” Jadual Permintaan Mengikut Kategori", node: sectionMap.results },
          { title: "Output 3 â€” Analisis Kewangan", node: document.getElementById("section-alt-analysis") },
          { title: "Output 4 â€” Graf & Penerangan", node: document.getElementById("section-chart-category") },
          { title: "Output 5 â€” Perbandingan Senario", node: document.getElementById("section-compare") },
          { title: "Output 6 â€” Analisis Sensitiviti", node: document.getElementById("section-sensitivity") },
          { title: "Output 7 â€” Nota Metodologi", node: document.getElementById("section-method") },
        ];
        outputs.forEach((item) => {
          if (!item.node) return;
          const wrap = document.createElement("div");
          wrap.className = "output-section";
          const title = document.createElement("h3");
          title.textContent = item.title;
          wrap.appendChild(title);
          wrap.appendChild(item.node);
          outputBlock.appendChild(wrap);
        });
      }

      function attachHero() {
        moveSectionTo(sectionMap.mode, heroModeHolder);
        moveSectionTo(sectionMap.scenario, heroScenarioHolder);
      }

      function moveExportUI() {
        if (!exportSlot) return;
        exportSlot.innerHTML = "";
        const container = document.createElement("div");
        container.className = "stacked";
        const options = document.querySelector(".report-options");
        const btnRow = exportBtn?.closest(".btn-row");
        const conf = document.querySelector(".confidential-toggle");
        if (options) container.appendChild(options);
        if (btnRow) container.appendChild(btnRow);
        if (conf) container.appendChild(conf);
        exportSlot.appendChild(container);
      }

      function updateStickyOffsets() {
        const headerEl = document.querySelector("header");
        const stickyBar = document.getElementById("sticky-action-bar");
        const stepperBarEl = document.getElementById("stepper-bar");
        const barHeight = stickyBar?.offsetHeight || 0;
        const bottomPad = (barHeight || 0) + 16;
        const topOffset = (headerEl?.offsetHeight || 0) + (stepperBarEl?.offsetHeight || 0) + 12;
        document.documentElement.style.setProperty("--sticky-bottom-padding", `${bottomPad}px`);
        document.documentElement.style.setProperty("--sticky-top-offset", `${topOffset}px`);
      }

      function renderStickyActionBar() {
        if (document.getElementById("sticky-action-bar")) return;
        const bar = document.createElement("div");
        bar.id = "sticky-action-bar";
        bar.className = "sticky-action-bar";

        const helper = document.createElement("div");
        helper.className = "sticky-helper";
        helper.innerHTML = "<strong>Kiraan sentiasa tersedia.</strong><br />Gunakan bar ini untuk kira & simpan tanpa skrol.";

        const actions = document.createElement("div");
        actions.className = "sticky-actions";

        const stickyCalc = document.createElement("button");
        stickyCalc.type = "button";
        stickyCalc.className = "primary";
        stickyCalc.id = "sticky-calc-btn";
        stickyCalc.textContent = "ğŸš€ KIRA SEKARANG";
        stickyCalc.addEventListener("click", () => {
          handleKiraClick();
        });

        const stickySave = document.createElement("button");
        stickySave.type = "button";
        stickySave.className = "secondary";
        stickySave.id = "sticky-save-btn";
        stickySave.textContent = "ğŸ’¾ SIMPAN SENARIO";
        stickySave.addEventListener("click", () => {
          if (saveScenarioCtaBtn) {
            saveScenarioCtaBtn.click();
          } else if (saveScenarioBtn) {
            saveScenarioBtn.click();
          } else {
            saveActiveScenario();
            alert("Senario disimpan dalam pelayar.");
          }
        });

        actions.appendChild(stickySave);
        actions.appendChild(stickyCalc);

        bar.appendChild(helper);
        bar.appendChild(actions);
        document.body.appendChild(bar);
        document.body.classList.add("has-sticky-bar");
        mainEl?.classList.add("has-sticky-bar");
        updateStickyOffsets();
      }

      function updateStatusChip() {
        if (!calcStatusChip) return;
        if (!hasCalculated || !lastCalculatedAt) {
          calcStatusChip.textContent = "Belum dikira";
          return;
        }
        const ts = new Date(lastCalculatedAt).toLocaleString("ms-MY", { hour12: false });
        calcStatusChip.textContent = `Dikira pada ${ts}`;
      }

      function revealOutputs() {
        if (outputWrapper) outputWrapper.classList.remove("output-hidden");
        if (exportWrapper) exportWrapper.classList.toggle("output-hidden", !hasCalculated);
        if (outputEmpty) outputEmpty.style.display = hasCalculated ? "none" : "block";
        if (outputBlock) outputBlock.style.display = hasCalculated ? "grid" : "none";
      }

      function showOutputSectionAndScroll() {
        if (outputWrapper) {
          outputWrapper.classList.remove("output-hidden");
          outputWrapper.style.display = "";
        }
        if (exportWrapper) {
          exportWrapper.classList.remove("output-hidden");
        }
        if (outputEmpty) outputEmpty.style.display = hasCalculated ? "none" : "block";
        if (outputBlock) outputBlock.style.display = hasCalculated ? "grid" : "none";
        const target = outputWrapper || outputBlock;
        if (target) {
          target.scrollIntoView({ behavior: "smooth", block: "start" });
        }
      }

      function clearErrorBanner() {
        if (!errorBanner) return;
        errorBanner.textContent = "";
        errorBanner.style.display = "none";
      }

      function showErrorBanner(message) {
        if (!errorBanner) return;
        errorBanner.textContent = message || "Ralat tidak diketahui semasa kiraan.";
        errorBanner.style.display = "block";
      }

      function scrollToOutput() {
        const first = outputBlock?.querySelector(".output-section");
        if (first) {
          first.scrollIntoView({ behavior: "smooth", block: "start" });
        }
      }

      function scrollToFirstMissing(missing) {
        if (!missing?.length) return;
        const el = resolveTarget(missing[0]?.target);
        if (el) {
          el.scrollIntoView({ behavior: "smooth", block: "center" });
          if (typeof el.focus === "function") {
            el.focus({ preventScroll: true });
          }
        }
      }

      function runCalculation({ mode = appState.mode, scenarioId = appState.activeScenarioId, demandMethod = appState.demandMode, scroll = true } = {}) {
        if (scenarioId && appState.scenarios[scenarioId]) {
          appState.activeScenarioId = scenarioId;
        }
        clearMissingHighlights();
        const validation = validateInputs({ mode, demandMethod });
        showValidation(validation.warnings || []);
        if (!validation.ok) {
          applyMissingHighlights(validation.missing);
          showMissingPanel(validation.missing);
          scrollToFirstMissing(validation.missing);
          return false;
        }
        showMissingPanel([]);
        recalcCapexOpexItems();
        const ok = calculateCore({ mode, demandMethod });
        if (ok !== false) {
          hasCalculated = true;
          lastCalculatedAt = Date.now();
          updateStatusChip();
          revealOutputs();
          if (scroll) scrollToOutput();
        }
        return ok !== false;
      }

      // Pusatkan logik KIRA supaya semua butang rujuk handler yang sama.
      function handleKiraClick(e) {
        e?.preventDefault?.();
        clearErrorBanner();
        console.log("[KIRA] clicked", { mode: appState.mode, demandMode: appState.demandMode });
        console.log("inputs:", {
          quick: {
            pop: quickInputs.pop.value,
            percap: quickInputs.percap.value,
            demand: quickInputs.demand.value,
            peak: quickInputs.peak.value,
            baseSupply: quickInputs.baseSupply.value,
          },
          supply: supplyInput.value,
          tariffWater: tariffWaterInput.value,
          tariffSewer: tariffSewerInput.value,
          analysisYears: analysisYearsInput.value,
          discountRate: discountRateInput.value,
          demandMode: appState.demandMode,
        });
        try {
          const ok = runCalculation({ scroll: false });
          if (ok) {
            console.log("[KIRA] done", {
              summary: activeScenario()?.outputs?.summary,
              finance: activeScenario()?.outputs?.finance,
            });
            showOutputSectionAndScroll();
          } else {
            console.warn("[KIRA] validation failed");
            showErrorBanner("Input wajib belum lengkap. Sila lengkapkan medan ditanda untuk teruskan kiraan.");
            showOutputSectionAndScroll();
          }
        } catch (err) {
          console.error("[KIRA] failed", err);
          showErrorBanner(err?.message || "Ralat tidak diketahui semasa kiraan.");
          showOutputSectionAndScroll();
        }
      }

      function formatNumber(num) {
        if (!isFinite(num)) return "â€“";
        return num.toLocaleString("ms-MY", { maximumFractionDigits: 2 });
      }

      function parseNumberFromText(value) {
        const cleaned = String(value ?? "")
          .replace(/\s/g, "")
          .replace(/[^\d.-]/g, "");
        const num = parseFloat(cleaned);
        return isFinite(num) ? num : 0;
      }

      function getCanvasDataURL(canvasId) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return "";
        try {
          return canvas.toDataURL("image/jpeg", 0.78);
        } catch (err) {
          console.warn("Gagal eksport canvas", canvasId, err);
          return "";
        }
      }

      function chartToImage(chart, fallbackId) {
        if (chart && typeof chart.toBase64Image === "function") {
          try {
            return chart.toBase64Image("image/jpeg", 0.8);
          } catch (err) {
            console.warn("Gagal eksport chart melalui toBase64Image", err);
          }
        }
        return getCanvasDataURL(fallbackId);
      }

      function findElement(selectorArr) {
        for (const sel of selectorArr || []) {
          if (!sel) continue;
          if (sel.startsWith("label:")) {
            const candidate = findByLabelText(sel.replace("label:", ""));
            if (candidate) return candidate;
            continue;
          }
          if (sel.startsWith("text:")) {
            const candidate = findByButtonText(sel.replace("text:", ""));
            if (candidate) return candidate;
            continue;
          }
          try {
            const el = document.querySelector(sel);
            if (el) return el;
          } catch (e) {
            // ignore invalid selectors
          }
        }
        return null;
      }

      function addPointer(el) {
        if (!el) return () => {};
        el.classList.add("wizard-pointer");
        el.scrollIntoView({ behavior: "smooth", block: "center" });
        return () => el.classList.remove("wizard-pointer");
      }

      function highlightSection(targetId) {
        let el = document.getElementById(targetId);
        if (el && el.classList.contains("hidden")) {
          el = sectionMap.demand || sectionMap.quick || el;
        }
        if (!el) return;
        el.classList.add("section-highlight");
        el.scrollIntoView({ behavior: "smooth", block: "start" });
        setTimeout(() => el.classList.remove("section-highlight"), 1800);
      }

      function findByLabelText(text) {
        if (!text) return null;
        const labels = Array.from(document.querySelectorAll("label"));
        const target = labels.find((lbl) =>
          lbl.textContent.toLowerCase().includes(text.toLowerCase())
        );
        if (target) {
          if (target.htmlFor) {
            return document.getElementById(target.htmlFor);
          }
          const input = target.querySelector("input, select, textarea");
          if (input) return input;
        }
        return null;
      }

      function findByButtonText(text) {
        const candidates = Array.from(document.querySelectorAll("button, input[type='button'], input[type='submit']"));
        return candidates.find((btn) =>
          (btn.textContent || btn.value || "").toLowerCase().includes(text.toLowerCase())
        );
      }

      function renderOffscreenChart({ type, data, options, width = 780, height = 460, quality = 0.72 }) {
        if (typeof Chart === "undefined") return "";
        const canvas = document.createElement("canvas");
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext("2d");
        const chart = new Chart(ctx, {
          type,
          data,
          options: {
            responsive: false,
            animation: false,
            maintainAspectRatio: false,
            layout: { padding: 28 },
            plugins: {
              legend: { position: "top" },
              title: { display: !!options?.plugins?.title?.text, text: options?.plugins?.title?.text },
            },
            ...options,
          },
        });
        const url = canvas.toDataURL("image/jpeg", quality);
        chart.destroy();
        return url;
      }

      function buildBarChartImage({ title, labels, datasets }) {
        if (!labels.length || !datasets.length) {
          return "";
        }
        return renderOffscreenChart({
          type: "bar",
          data: { labels, datasets },
          options: {
            scales: {
              y: { beginAtZero: true, title: { display: true, text: "Nilai" } },
            },
            plugins: { title: { display: true, text: title } },
          },
        });
      }

      function buildPieChartImage({ title, labels, data }) {
        if (!labels.length || !data.length) return "";
        return renderOffscreenChart({
          type: "pie",
          width: 720,
          height: 720,
          data: {
            labels,
            datasets: [{ data, backgroundColor: [
              "rgba(13,110,253,0.85)",
              "rgba(0,188,212,0.85)",
              "rgba(3,169,244,0.85)",
              "rgba(0,150,136,0.85)",
              "rgba(63,81,181,0.85)",
              "rgba(33,150,243,0.85)",
              "rgba(0,200,83,0.85)",
              "rgba(255,193,7,0.85)",
            ] }],
          },
          options: {
            plugins: {
              legend: { position: "bottom" },
              title: { display: true, text: title },
            },
          },
        });
      }

      function buildSupplyDemandChartImage(summary) {
        const labels = ["Purata (MLD)", "Puncak (MLD)"];
        const demand = [summary.avgMLD, summary.peakMLD];
        const supply = [summary.effectiveMLD, summary.effectiveMLD];
        return buildBarChartImage({
          title: "Permintaan vs Bekalan Efektif",
          labels,
          datasets: [
            {
              label: "Permintaan",
              data: demand,
              backgroundColor: "rgba(255, 87, 34, 0.85)",
            },
            {
              label: "Bekalan Efektif",
              data: supply,
              backgroundColor: "rgba(13, 110, 253, 0.82)",
            },
          ],
        });
      }

      function buildAltCompositionChartImage(altSources) {
        if (!altSources || !altSources.length) return "";
        const labels = altSources.map((s) => s.name || "Sumber");
        const data = altSources.map((s) =>
          (parseFloat(s.capacity) || 0) *
          ((parseFloat(s.utilPercent) || 0) / 100) *
          ((parseFloat(s.reliabilityPercent) || 100) / 100)
        );
        return buildBarChartImage({
          title: "Komposisi Sumber Air Alternatif (mÂ³/hari berkesan)",
          labels,
          datasets: [
            {
              label: "Bekalan berkesan",
              data,
              backgroundColor: "rgba(0, 188, 212, 0.8)",
            },
          ],
        });
      }

      function wizardStepsConfig() {
        return [
          {
            title: "Langkah 1: Pilih mod",
            desc: "Pilih Quick/Operational/Full. Wizard akan set Quick secara automatik.",
            validator: () => ({
              valid: !!appState.mode,
              message: appState.mode ? "Mod telah dipilih." : "Sila pilih mod.",
            }),
            handler: () => {
              const quickBtn = Array.from(document.querySelectorAll("#mode-selector .pill"))
                .find((btn) => btn.dataset.mode === "quick");
              if (quickBtn) quickBtn.click();
              const cleanup = addPointer(quickBtn || findElement(WIZ_SELECTORS.mode));
              return {
                valid: !!quickBtn,
                message: quickBtn ? "Mod diset ke Quick." : "Butang mod tidak ditemui (boleh teruskan manual).",
                cleanup,
              };
            },
          },
          {
            title: "Langkah 2: Pilih Senario A (asas)",
            desc: "Aktifkan senario A sebagai baseline. Gandakan ke B jika perlu.",
            validator: () => ({
              valid: !!activeScenario(),
              message: activeScenario() ? `Senario aktif: ${activeScenario().name}` : "Tiada senario aktif.",
            }),
            handler: () => {
              const aBtn = findElement(WIZ_SELECTORS.scenarioA);
              if (aBtn) aBtn.click();
              const cleanA = addPointer(aBtn);
              const dupBtn = findElement(WIZ_SELECTORS.duplicateScenario);
              const cleanDup = addPointer(dupBtn);
              return {
                valid: true,
                message: aBtn ? "Senario A aktif." : "Senario A tidak ditemui, teruskan manual.",
                cleanup: () => { cleanA(); cleanDup(); },
              };
            },
          },
          {
            title: "Langkah 3: Permintaan minimum",
            desc: "Isi faktor puncak (1.2â€“1.5 disaran) dan masukkan permintaan: sama ada jumlah harian atau sekurang-kurangnya satu baris kategori.",
            validator: () => {
              const peakEl = findElement(WIZ_SELECTORS.peakFactor);
              if (!peakEl && !findElement(WIZ_SELECTORS.quickDemand)) {
                return { valid: true, message: "Input permintaan tidak ditemui (teruskan manual)." };
              }
              const peak = parseFloat(peakEl?.value || 0);
              const hasPeak = isFinite(peak) && peak > 0;
              const peakWarn = hasPeak && (peak < 1.2 || peak > 1.5);
              const quickDemand = parseFloat(findElement(WIZ_SELECTORS.quickDemand)?.value || 0);
              const hasQuick = isFinite(quickDemand) && quickDemand > 0;
              const hasCategory = Array.from(document.querySelectorAll(".category-row input"))
                .some((el) => (el.type === "text" && el.value.trim()) || parseFloat(el.value || 0) > 0);
              return {
                valid: hasPeak && (hasQuick || hasCategory),
                message: !hasPeak
                  ? "Isi faktor puncak"
                  : (hasQuick || hasCategory ? (peakWarn ? "Julat disaran 1.2â€“1.5 (boleh diteruskan)" : "OK") : "Isi demand (jumlah atau kategori)"),
              };
            },
            handler: () => {
              const peakEl = findElement(WIZ_SELECTORS.peakFactor);
              const cleanPeak = addPointer(peakEl);
              const demandEl = findElement(["#quick-demand", "#category-input-table"]);
              const cleanDemand = addPointer(demandEl);
              return {
                valid: true,
                message: "Pastikan nilai diisi.",
                cleanup: () => { cleanPeak(); cleanDemand(); },
              };
            },
          },
          {
            title: "Langkah 4: Bekalan asas (JANS)",
            desc: "Masukkan bekalan sedia ada (MLD).",
            validator: () => {
              const supplyEl = findElement(WIZ_SELECTORS.jansSupply);
              if (!supplyEl) return { valid: true, message: "Input bekalan tidak ditemui (teruskan manual)." };
              const val = parseFloat(supplyEl.value || 0);
              return { valid: val > 0, message: val > 0 ? "OK" : "Isi bekalan asas" };
            },
            handler: () => {
              const el = findElement(WIZ_SELECTORS.jansSupply) || findElement(WIZ_SELECTORS.baseSupply);
              const clean = addPointer(el);
              return { valid: !!el, message: el ? "Isi nilai bekalan." : "Input bekalan tidak ditemui.", cleanup: clean };
            },
          },
          {
            title: "Langkah 5: Parameter kewangan",
            desc: "Isi tarif air, tarif pembetungan, tempoh analisis, dan kadar diskaun.",
            validator: () => {
              const waterEl = findElement(WIZ_SELECTORS.tariffWater);
              const sewerEl = findElement(WIZ_SELECTORS.tariffSewer);
              const yearsEl = findElement(WIZ_SELECTORS.horizon);
              const discEl = findElement(WIZ_SELECTORS.discount);
              if (!waterEl && !sewerEl && !yearsEl && !discEl) {
                return { valid: true, message: "Input kewangan tidak ditemui (teruskan manual)." };
              }
              const water = parseFloat(waterEl?.value || 0);
              const sewer = parseFloat(sewerEl?.value || 0);
              const years = parseFloat(yearsEl?.value || 0);
              const disc = parseFloat(discEl?.value || 0);
              return { valid: water > 0 && sewer >= 0 && years > 0 && disc >= 0, message: "Pastikan semua parameter kewangan terisi." };
            },
            handler: () => {
              const candidates = [
                findElement(WIZ_SELECTORS.tariffWater),
                findElement(WIZ_SELECTORS.tariffSewer),
                findElement(WIZ_SELECTORS.horizon),
                findElement(WIZ_SELECTORS.discount),
              ].filter(Boolean);
              const cleanups = candidates.map(addPointer);
              return {
                valid: candidates.length > 0,
                message: candidates.length ? "Isi tarif & kadar." : "Input kewangan tidak ditemui.",
                cleanup: () => cleanups.forEach((fn) => fn && fn()),
              };
            },
          },
          {
            title: "Langkah 6: Sumber alternatif (opsyenal)",
            desc: "Tambah sumber alternatif jika ada. Anda boleh langkau.",
            optional: true,
            handler: () => {
              const altEl = findElement(WIZ_SELECTORS.alternatives);
              const clean = addPointer(altEl);
              altEl?.scrollIntoView({ behavior: "smooth", block: "center" });
              return { valid: true, message: "Tambah sekurang-kurangnya satu sumber jika perlu.", cleanup: clean };
            },
          },
          {
            title: "Langkah 7: Jalankan kiraan",
            desc: "Tekan butang Kira untuk kemas kini ringkasan.",
            handler: () => {
              const btn = findElement(WIZ_SELECTORS.calcBtn);
              const clean = addPointer(btn);
              btn?.click();
              const summaryEl = findElement(WIZ_SELECTORS.summary);
              summaryEl?.scrollIntoView({ behavior: "smooth", block: "center" });
              return { valid: !!btn, message: btn ? "Kiraan dijalankan." : "Butang kira tidak ditemui.", cleanup: clean };
            },
          },
          {
            title: "Langkah 8: Eksport",
            desc: "Pilih eksport Excel atau jana PDF selepas kiraan.",
            handler: () => {
              const excel = findElement(WIZ_SELECTORS.exportExcel);
              const pdf = findElement(WIZ_SELECTORS.exportPdf);
              const cleanExcel = addPointer(excel);
              const cleanPdf = addPointer(pdf);
              const summaryEl = findElement(WIZ_SELECTORS.summary);
              summaryEl?.scrollIntoView({ behavior: "smooth", block: "center" });
              return {
                valid: true,
                message: "Klik Eksport Excel atau Jana Laporan untuk muat turun.",
                cleanup: () => { cleanExcel(); cleanPdf(); },
              };
            },
          },
        ];
      }

      function formatStatusLabel(status, isPeak) {
        if (!status) return "â€“";
        if (status === "Surplus") {
          return isPeak ? "Lebihan (Puncak)" : "Lebihan (Purata)";
        }
        if (status === "Deficit" || status === "Defisit") {
          return isPeak ? "Defisit (Puncak)" : "Defisit (Purata)";
        }
        return status;
      }

      function renderWizardStepIndicators() {
        const steps = wizardStepsConfig();
        wizardStepList.innerHTML = steps
          .map(
            (s, idx) => `
              <li class="${idx === wizardStep ? "active" : ""}">
                <span class="idx">${idx + 1}</span>
                <span>${s.title}</span>
              </li>
            `
          )
          .join("");
      }

      function renderWizardContent() {
        const steps = wizardStepsConfig();
        const step = steps[wizardStep];
        if (!step) return;
        wizardContent.innerHTML = `
          <div class="wizard-panel">
            <h3>${step.title}</h3>
            <p>${step.desc}</p>
            ${step.optional ? '<p class="wizard-helper">Langkah ini opsyenal. Anda boleh langkau.</p>' : ""}
            <div class="wizard-step-actions">
              <button type="button" class="secondary" id="wizard-run-handler">Sorot & bantu</button>
            </div>
          </div>
          <div class="wizard-panel">
            <h3>Status</h3>
            <p id="wizard-validation-text">Semak keperluan sebelum meneruskan.</p>
          </div>
        `;

        const handlerBtn = document.getElementById("wizard-run-handler");
        let cleanup = () => {};
        handlerBtn?.addEventListener("click", () => {
          cleanup();
          try {
            const res = step.handler ? step.handler() : { valid: true, message: "OK" };
            cleanup = res.cleanup || (() => {});
            wizardStatus.textContent = res.message || "";
          } catch (e) {
            console.warn(e);
            wizardStatus.textContent = "Tidak dapat menjalankan langkah ini.";
          }
        });
      }

      function validateWizardStep() {
        const steps = wizardStepsConfig();
        const step = steps[wizardStep];
        if (!step) return;
        let valid = true;
        let message = "OK";
        try {
          if (typeof step.validator === "function") {
            const res = step.validator();
            valid = !!res.valid;
            message = res.message || message;
          }
        } catch (e) {
          console.warn("Wizard validator error", e);
        }
        wizardNextBtn.disabled = !valid && !step.optional;
        wizardStatus.textContent = message;
        if (!valid && step.title?.toLowerCase().includes("puncak")) {
          wizardStatus.innerHTML = `${message} <span class="wizard-warning">Disyorkan 1.2â€“1.5</span>`;
        }
      }

      function updateWizardNav() {
        const steps = wizardStepsConfig();
        wizardBackBtn.disabled = wizardStep === 0;
        wizardNextBtn.textContent = wizardStep === steps.length - 1 ? "Selesai" : "Seterusnya â¡ï¸";
        renderWizardStepIndicators();
        renderWizardContent();
        validateWizardStep();
      }

      function refreshStepperValidation() {
        quickStepperConfig.forEach((step) => validateStepCard(step));
        if (stepperStatusPill) {
          const stepStates = quickStepperConfig.map((s) => validateStepCard(s));
          const baseComplete = stepStates.slice(0, 6).every(Boolean);
          const calcComplete = quickStepperConfig.find((s) => s.id === "summary")?.required?.();
          if (calcComplete) {
            stepperStatusPill.textContent = "Sudah dikira";
            stepperStatusPill.className = "status-badge calculated";
          } else if (baseComplete) {
            stepperStatusPill.textContent = "Lengkap";
            stepperStatusPill.className = "status-badge done";
          } else {
            stepperStatusPill.textContent = "Belum lengkap";
            stepperStatusPill.className = "status-badge";
          }
        }
      }

      function setStepError(id, message) {
        const card = stepperGrid?.querySelector(`[data-step-id="${id}"]`);
        const msg = card?.querySelector(".step-error");
        if (msg) {
          msg.textContent = message || "";
          msg.classList.toggle("hidden", !message);
        }
      }

      function validateStepCard(step) {
        if (!step) return true;
        const ok = step.required ? !!step.required() : true;
        setStepError(step.id, ok ? "" : step.requiredMessage);
        return ok;
      }

      function buildStepper() {
        if (!stepperGrid) return;
        stepperGrid.innerHTML = quickStepperConfig
          .map(
            (step, idx) => `
              <div class="step-card" data-step-id="${step.id}">
                <h3><span class="step-number">${idx + 1}</span> ${step.title}</h3>
                <p class="step-text">${step.hint}</p>
                <p class="step-example"><strong>Contoh:</strong> ${step.example}</p>
                <p class="step-error hidden"></p>
                <div class="step-actions">
                  <button type="button" class="secondary" data-action="go" data-target="${step.target}">Pergi ke langkah ini</button>
                  <button type="button" class="primary" data-action="next" data-index="${idx}">Seterusnya</button>
                </div>
              </div>
            `
          )
          .join("");

        stepperGrid.addEventListener("click", (e) => {
          const btn = e.target.closest("button[data-action]");
          if (!btn) return;
          const action = btn.dataset.action;
          if (action === "go") {
            const targetId = btn.dataset.target;
            highlightSection(targetId);
            validateStepCard(quickStepperConfig.find((s) => s.target === targetId));
          }
          if (action === "next") {
            const idx = parseInt(btn.dataset.index, 10);
            const step = quickStepperConfig[idx];
            if (!validateStepCard(step)) return;
            const next = quickStepperConfig[idx + 1];
            if (next) {
              highlightSection(next.target);
            }
          }
        });
        addSectionNavButtons();
      }

      function addSectionNavButtons() {
        quickStepperConfig.forEach((step, idx) => {
          const section = document.getElementById(step.target);
          if (!section) return;
          if (section.querySelector(".section-next")) return;
          const next = quickStepperConfig[idx + 1];
          if (!next) return;
          const wrapper = document.createElement("div");
          wrapper.style.marginTop = "0.8rem";
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "primary section-next";
          btn.textContent = `Seterusnya: ${next.title.replace(/\\(.+\\)/, "").trim()}`;
          btn.addEventListener("click", () => {
            if (!validateStepCard(step)) return;
            highlightSection(next.target);
          });
          wrapper.appendChild(btn);
          section.appendChild(wrapper);
        });
      }

      function handleStepperScroll() {
        const y = window.scrollY || document.documentElement.scrollTop || 0;
        if (stepperAutoCollapseArmed && y > 0) {
          autoCollapseNow();
        }
        if (y > 120 && stepperState.expanded) {
          setStepperExpanded(false, { source: "scroll" });
        }
        if (quickStepper) {
          quickStepper.classList.toggle("near-top", y < 80);
        }
        updateFloatingButton();
      }

      function handleStepperFocusCollapse(event) {
        const target = event.target;
        if (!target || quickStepper?.contains(target)) return;
        if (mainEl && !mainEl.contains(target)) return;
        const tag = target.tagName;
        if (tag === "INPUT" || tag === "SELECT" || tag === "TEXTAREA") {
          setStepperExpanded(false, { source: "focus" });
          autoCollapseNow();
        }
      }

      function initStepperBehavior() {
        loadStepperState();
        updateStepperUI();
        if (!stepperState.seen) {
          setTimeout(() => {
            if (stepperState.seen || stepperState.expanded || window.scrollY > 150) return;
            setStepperExpanded(true, { source: "auto" });
            armAutoCollapse();
          }, 400);
        }
        stepperToggle?.addEventListener("click", () => {
          setStepperExpanded(!stepperState.expanded, { source: "toggle" });
          if (stepperState.expanded && quickStepper) {
            quickStepper.scrollIntoView({ behavior: "smooth", block: "start" });
          }
        });
        stepperCloseBtn?.addEventListener("click", () => setStepperExpanded(false, { source: "close" }));
        stepperFloatingBtn?.addEventListener("click", () => {
          const nextState = !stepperState.expanded;
          setStepperExpanded(nextState, { source: "floating", scrollIntoView: true });
        });
        window.addEventListener("scroll", handleStepperScroll, { passive: true });
        document.addEventListener("focusin", handleStepperFocusCollapse, true);
        handleStepperScroll();
      }

      function openWizard(auto) {
        wizardOverlay.classList.add("active");
        wizardOverlay.setAttribute("aria-hidden", "false");
        wizardStep = 0;
        updateWizardNav();
        if (auto) {
          const steps = wizardStepsConfig();
          steps[0]?.handler?.();
          steps[1]?.handler?.();
        }
      }

      function closeWizard() {
        wizardOverlay.classList.remove("active");
        wizardOverlay.setAttribute("aria-hidden", "true");
        localStorage.setItem(WIZARD_STORAGE_KEY, "1");
        wizardSeen = true;
      }

      function normalizeNumber(val, fallback = 0) {
        const num = parseFloat(val);
        return isFinite(num) ? num : fallback;
      }

      function createEmptyScenario(id = "A", name = `Senario ${id}`) {
        return {
          id,
          name,
          mode: "quick",
          demandMode: "quick",
          inputs: {},
          outputs: {},
          schemaVersion: SCHEMA_VERSION,
          lastSavedAt: null,
          savedAt: null,
          calculatedAt: null,
          updatedAt: Date.now(),
        };
      }

      function migrateLegacy(payload) {
        if (!payload || typeof payload !== "object") return null;
        // Legacy payload assumed flat; keep minimal fields.
        const scenario = createEmptyScenario("A", "Senario A (Legacy)");
        scenario.mode = payload.mode || "operational";
        scenario.inputs = {
          supply: payload.supply || "",
          tariffWater: payload.tariffWater || "",
          tariffSewer: payload.tariffSewer || "",
          analysisYears: payload.analysisYears || "",
          discount: payload.discount || "",
          categories: payload.categories || [],
          altRows: payload.altRows || [],
          capexRows: payload.capexRows || [],
          quick: payload.quick || {},
        };
        return {
          version: SCHEMA_VERSION,
          mode: scenario.mode,
          demandMode: "quick",
          activeScenarioId: "A",
          scenarios: { A: scenario },
        };
      }

      function loadState() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (raw) {
            const parsed = JSON.parse(raw);
            if (parsed.version === SCHEMA_VERSION) {
              appState = parsed;
              appState.demandMode = appState.demandMode || "quick";
              appState.schemaVersion = appState.schemaVersion || SCHEMA_VERSION;
              return;
            }
          }
          const legacyRaw = localStorage.getItem(LEGACY_KEY);
          if (legacyRaw) {
            const migrated = migrateLegacy(JSON.parse(legacyRaw));
            if (migrated) {
              appState = migrated;
              persistState();
              return;
            }
          }
        } catch (err) {
          console.warn("Gagal memuat state:", err);
        }
        appState = {
          version: SCHEMA_VERSION,
          schemaVersion: SCHEMA_VERSION,
          mode: "quick",
          demandMode: "quick",
          activeScenarioId: "A",
          scenarios: { A: createEmptyScenario("A", "Senario A") },
        };
      }

      function persistState() {
        try {
          appState.schemaVersion = SCHEMA_VERSION;
          localStorage.setItem(STORAGE_KEY, JSON.stringify(appState));
        } catch (err) {
          console.warn("Gagal simpan state:", err);
        }
      }

      function activeScenario() {
        return appState.scenarios[appState.activeScenarioId];
      }

      function toggleModeBlocks(mode) {
        document.querySelectorAll(".mode-block").forEach((section) => {
          const allowed = (section.dataset.modes || "").split(",").map((m) => m.trim());
          if (allowed.includes(mode)) {
            section.classList.remove("hidden");
          } else {
            section.classList.add("hidden");
          }
        });
      }

      function setQuickInputsDisabled(disabled) {
        Object.values(quickInputs).forEach((el) => {
          if (!el) return;
          el.disabled = disabled;
          el.classList.toggle("muted", disabled);
        });
        Object.values(quickAltInputs).forEach((el) => {
          if (!el) return;
          el.disabled = disabled;
          el.classList.toggle("muted", disabled);
        });
        document.getElementById("section-quick")?.classList.toggle("muted", disabled);
      }

      function setCategoryInputsDisabled(disabled) {
        document.querySelectorAll("#section-demand input").forEach((el) => {
          el.disabled = disabled;
          el.classList.toggle("muted", disabled);
        });
        document.getElementById("section-demand")?.classList.toggle("muted", disabled);
        if (categoryGuard) {
          categoryGuard.textContent = disabled
            ? "Pilih â€œGunakan Demand Mengikut Kategoriâ€ untuk mengaktifkan jadual ini. Input Quick akan dikunci."
            : "Mod kategori aktif. Input Quick dikunci supaya tidak bercampur.";
        }
      }

      function setDemandMode(mode, skipPersist = false) {
        appState.demandMode = mode;
        demandModeRadios.forEach((r) => {
          r.checked = r.value === mode;
        });
        const useQuick = mode === "quick";
        setQuickInputsDisabled(!useQuick);
        setCategoryInputsDisabled(useQuick);
        if (useQuick) {
          setCategoryInputMode("manual");
        }
        if (!useQuick) {
          document.body.classList.add("show-advanced");
        }
        if (!skipPersist) persistState();
        refreshStepperValidation();
      }

      function setMode(mode) {
        appState.mode = mode;
        modeSelector.querySelectorAll(".pill").forEach((pill) => {
          pill.classList.toggle("active", pill.dataset.mode === mode);
        });
        const noteText =
          mode === "quick"
            ? "Quick Estimate: isi populasi atau permintaan harian + faktor puncak & bekalan asas. Output: ringkasan permintaan-bekalan pantas dan NPV/BCR jika CAPEX/OPEX diisi."
            : mode === "operational"
            ? "Operational Planning: buka jadual kategori, sumber alternatif berganda dengan faktor utiliti & kebolehpercayaan. Gunakan untuk perancangan 10â€“15 minit."
            : "Full CBA (Advanced): kekalkan pecahan CAPEX/OPEX, kitaran penggantian, penjimatan terperinci dan sensitiviti +/-10%.";
        modeNote.textContent = noteText;
        if (calcLocationNote) {
          calcLocationNote.textContent =
            mode === "full"
              ? "Pastikan Langkah 1â€“5 diisi (Permintaan, Bekalan, Kewangan, Alt, CAPEX/OPEX) sebelum tekan KIRA."
              : "Pastikan Langkah 1â€“3 diisi (Permintaan, Bekalan, Kewangan) sebelum tekan KIRA.";
        }
        toggleModeBlocks(mode);
        persistState();
        refreshStepperValidation();
        buildInputSteps();
      }

      function clearElement(el) {
        while (el.firstChild) el.removeChild(el.firstChild);
      }

      function createCategoryRow(data = {}) {
        const tr = document.createElement("tr");
        tr.className = "category-row";
        tr.dataset.category = data.name || "";
        if (data.errorReason) {
          tr.classList.add("row-error");
        }
        const peakVal = data.peak ?? data.peakFactor ?? "1.3";
        tr.innerHTML = `
          <td>
            <input type="text" class="cat-name" data-field="category-name" value="${data.name || ""}" placeholder="Nama kategori" />
            ${data.errorReason ? `<span class="error-hint">${data.errorReason}</span>` : ""}
          </td>
          <td><input type="number" class="cat-pop" data-field="category-pop" value="${data.pop || ""}" min="0" /></td>
          <td><input type="number" class="cat-percap" data-field="category-percap" value="${data.percap || ""}" min="0" /></td>
          <td><input type="number" class="cat-peak" data-field="category-peak" value="${peakVal || "1.3"}" min="1" step="0.05" /></td>
        `;
        return tr;
      }

      function setCategoryRows(rows) {
        clearElement(categoryBody);
        const wrap = categoryBody?.closest(".demand-table-wrap");
        if (wrap) {
          wrap.style.minHeight = "0";
          wrap.style.height = "auto";
        }
        if (!rows || !rows.length) {
          ["Asrama", "Fakulti & Pentadbiran", "Masjid & Surau"].forEach((name) => {
            categoryBody.appendChild(
              createCategoryRow({ name, pop: "", percap: "", peak: 1.3 })
            );
          });
        } else {
          rows.forEach((r) => categoryBody.appendChild(createCategoryRow(r)));
        }
      }

      function setCategoryInputMode(mode) {
        if (!excelPanel) return;
        const useExcel = mode === "excel";
        excelPanel.classList.toggle("hidden", !useExcel);
        if (useExcel) {
          excelPanel.scrollIntoView({ behavior: "smooth", block: "start" });
        }
      }

      function downloadCategoryTemplate() {
        if (typeof XLSX === "undefined") {
          alert("Library Excel (SheetJS) tidak dimuatkan.");
          return;
        }
        const wb = XLSX.utils.book_new();
        const rows = [
          ["nama_bangunan", "populasi_orang", "per_kapita_L_org_hari", "faktor_puncak"],
          ["Asrama A", 800, 180, 1.3],
          ["Fakulti & Pentadbiran", 4000, 60, 1.25],
        ];
        const ws = XLSX.utils.aoa_to_sheet(rows);
        XLSX.utils.book_append_sheet(wb, ws, "PermintaanKategori");
        XLSX.writeFile(wb, "Template_Input_Permintaan_UMS.xlsx");
      }

      function importCategoryExcel(file) {
        if (!file) return;
        if (typeof XLSX === "undefined") {
          alert("Library Excel (SheetJS) tidak dimuatkan.");
          return;
        }
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            const wb = XLSX.read(data, { type: "array" });
            const sheet = wb.Sheets[wb.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(sheet, { defval: "" });
            const validRows = [];
            const errorRows = [];
            json.forEach((row, idx) => {
              const name = (row.nama_bangunan || "").toString().trim();
              const pop = parseFloat(row.populasi_orang);
              const percap = parseFloat(row.per_kapita_L_org_hari);
              const peak = parseFloat(row.faktor_puncak);
              const isEmpty = [name, pop, percap, peak].every((v) => !v);
              if (isEmpty) return;
              const reason = [];
              if (!isFinite(pop) || pop <= 0) reason.push("Populasi tidak sah");
              if (!isFinite(percap) || percap <= 0) reason.push("Per kapita tidak sah");
              if (!isFinite(peak) || peak <= 0) reason.push("Faktor puncak tidak sah");
              if (reason.length) {
                errorRows.push({
                  name: name || `Baris ${idx + 2}`,
                  pop: isFinite(pop) ? pop : "",
                  percap: isFinite(percap) ? percap : "",
                  peak: isFinite(peak) ? peak : "",
                  errorReason: reason.join("; "),
                });
              } else {
                validRows.push({
                  name: name || `Baris ${idx + 2}`,
                  pop,
                  percap,
                  peak: peak || 1.3,
                });
              }
            });
            clearMissingHighlights();
            const mergedRows = validRows.concat(errorRows);
            setCategoryRows(mergedRows.length ? mergedRows : validRows);
            if (excelSummary) {
              excelSummary.textContent = `Berjaya import ${validRows.length} baris; ${errorRows.length} baris ralat.`;
              excelSummary.style.color = errorRows.length ? "#b3261e" : "#12324a";
            }
          } catch (err) {
            console.error(err);
            alert("Gagal memproses fail Excel. Pastikan format lajur betul.");
          }
        };
        reader.readAsArrayBuffer(file);
      }

      function createAltRow(data = {}) {
        const tr = document.createElement("tr");
        tr.className = "alt-row";
        const reliabilityVal = data.reliability ?? data.reliabilityPercent ?? 90;
        tr.innerHTML = `
          <td><input type="text" class="alt-name" placeholder="Nama sumber" value="${data.name || ""}" /></td>
          <td><input type="number" class="alt-capacity" min="0" value="${data.capacity || ""}" /></td>
          <td><input type="number" class="alt-util" min="0" max="100" value="${data.util || ""}" /></td>
          <td><input type="number" class="alt-reliability" min="0" max="100" value="${reliabilityVal ?? ""}" /></td>
          <td><input type="number" class="alt-capex" min="0" value="${data.capex || ""}" /></td>
          <td><input type="text" class="alt-capex-note" placeholder="Butiran CAPEX (jika ada)" value="${data.capexNote || ""}" /></td>
          <td><input type="number" class="alt-opex-fixed" min="0" value="${data.opexFixed || ""}" /></td>
          <td><input type="number" class="alt-opex-var" min="0" step="0.01" value="${data.opexVar || ""}" /></td>
          <td><input type="text" class="alt-opex-note" placeholder="Butiran OPEX (jika ada)" value="${data.opexNote || ""}" /></td>
          <td><input type="number" class="alt-life" min="1" value="${data.life || ""}" /></td>
        `;
        return tr;
      }

      function setAltRows(rows) {
        clearElement(altBody);
        if (!rows || !rows.length) {
          ["Tangkapan air hujan", "Air tasik / tasik kampus"].forEach((name) => {
            altBody.appendChild(createAltRow({ name }));
          });
          altBody.appendChild(createAltRow());
        } else {
          rows.forEach((r) => altBody.appendChild(createAltRow(r)));
        }
      }

      function createCapexOpexRow(data = {}) {
        const tr = document.createElement("tr");
        tr.className = "capex-opex-row";
        tr.innerHTML = `
          <td>
            <select class="item-type">
              <option value="CAPEX" ${data.type === "OPEX" ? "" : "selected"}>CAPEX</option>
              <option value="OPEX" ${data.type === "OPEX" ? "selected" : ""}>OPEX</option>
            </select>
          </td>
          <td><input type="text" class="item-name" value="${data.name || ""}" placeholder="Nama item" /></td>
          <td><input type="number" class="item-qty" value="${data.qty || 1}" min="0" step="0.01" /></td>
          <td><input type="number" class="item-cost" value="${data.cost || 0}" min="0" step="0.01" /></td>
          <td class="item-total">0.00</td>
          <td><input type="text" class="item-note" value="${data.note || ""}" placeholder="Catatan (jika ada)" /></td>
        `;
        return tr;
      }

      function setCapexRows(rows) {
        clearElement(capexOpexBody);
        if (!rows || !rows.length) {
          capexOpexBody.appendChild(createCapexOpexRow());
        } else {
          rows.forEach((r) => capexOpexBody.appendChild(createCapexOpexRow(r)));
        }
        recalcCapexOpexItems();
      }

      function captureScenarioInputs() {
        const categories = Array.from(document.querySelectorAll(".category-row")).map(
          (row) => ({
            name: row.querySelector(".cat-name")?.value || "",
            pop: row.querySelector(".cat-pop")?.value || "",
            percap: row.querySelector(".cat-percap")?.value || "",
            peak: row.querySelector(".cat-peak")?.value || "",
          })
        );
        const altRows = Array.from(document.querySelectorAll(".alt-row")).map(
          (row) => ({
            name: row.querySelector(".alt-name")?.value || "",
            capacity: row.querySelector(".alt-capacity")?.value || "",
            util: row.querySelector(".alt-util")?.value || "",
            reliability: row.querySelector(".alt-reliability")?.value || "",
            capex: row.querySelector(".alt-capex")?.value || "",
            capexNote: row.querySelector(".alt-capex-note")?.value || "",
            opexFixed: row.querySelector(".alt-opex-fixed")?.value || "",
            opexVar: row.querySelector(".alt-opex-var")?.value || "",
            opexNote: row.querySelector(".alt-opex-note")?.value || "",
            life: row.querySelector(".alt-life")?.value || "",
          })
        );
        const capexRows = Array.from(document.querySelectorAll(".capex-opex-row")).map(
          (row) => ({
            type: row.querySelector(".item-type")?.value || "CAPEX",
            name: row.querySelector(".item-name")?.value || "",
            qty: row.querySelector(".item-qty")?.value || 1,
            cost: row.querySelector(".item-cost")?.value || 0,
            note: row.querySelector(".item-note")?.value || "",
          })
        );
        return {
          mode: appState.mode,
          demandMode: appState.demandMode,
          quick: {
            pop: quickInputs.pop.value,
            percap: quickInputs.percap.value,
            demand: quickInputs.demand.value,
            peak: quickInputs.peak.value,
            baseSupply: quickInputs.baseSupply.value,
            alt: {
              name: quickAltInputs.name.value,
              capacity: quickAltInputs.capacity.value,
              util: quickAltInputs.util.value,
              capex: quickAltInputs.capex.value,
              opex: quickAltInputs.opex.value,
            },
          },
          supply: supplyInput.value,
          tariffWater: tariffWaterInput.value,
          tariffSewer: tariffSewerInput.value,
          analysisYears: analysisYearsInput.value,
          discount: discountRateInput.value,
          categories,
          altRows,
          capexRows,
        };
      }

      function applyScenarioInputs(data) {
        if (!data) return;
        setMode(data.mode || "quick");
        setDemandMode(data.demandMode || "quick", true);
        quickInputs.pop.value = data.quick?.pop || "";
        quickInputs.percap.value = data.quick?.percap || "";
        quickInputs.demand.value = data.quick?.demand || "";
        quickInputs.peak.value = data.quick?.peak || "1.3";
        quickInputs.baseSupply.value = data.quick?.baseSupply || "";

        quickAltInputs.name.value = data.quick?.alt?.name || "";
        quickAltInputs.capacity.value = data.quick?.alt?.capacity || "";
        quickAltInputs.util.value = data.quick?.alt?.util || "";
        quickAltInputs.capex.value = data.quick?.alt?.capex || "";
        quickAltInputs.opex.value = data.quick?.alt?.opex || "";

        supplyInput.value = data.supply || supplyInput.value;
        tariffWaterInput.value = data.tariffWater || tariffWaterInput.value;
        tariffSewerInput.value = data.tariffSewer || tariffSewerInput.value;
        analysisYearsInput.value = data.analysisYears || analysisYearsInput.value;
        discountRateInput.value = data.discount || discountRateInput.value;

        setCategoryRows(data.categories || []);
        setAltRows(data.altRows || []);
        setCapexRows(data.capexRows || []);
      }

      function renderScenarioList() {
        clearElement(scenarioListEl);
        const labels = {
          A: "A: Baseline (JANS)",
          B: "B: + Alternatif 1",
          C: "C: + Alternatif 2/Kombinasi",
        };
        Object.values(appState.scenarios).forEach((sc) => {
          const card = document.createElement("div");
          card.className = "scenario-card" + (sc.id === appState.activeScenarioId ? " active" : "");
          card.dataset.id = sc.id;
          const label = labels[sc.id] || sc.name;
          const displayName = label && sc.name && label !== sc.name ? `${label} Â· ${sc.name}` : (label || sc.name);
          const savedText = sc.savedAt ? `Disimpan: ${formatDateTime(sc.savedAt)}` : "Belum disimpan";
          const calcText = sc.calculatedAt ? `Sudah dikira: ${formatDateTime(sc.calculatedAt)}` : "Belum dikira";
          card.innerHTML = `
            <p class="scenario-title">${displayName}</p>
            <p class="scenario-meta">Mod: ${sc.mode || "quick"} Â· ${savedText} Â· ${calcText}</p>
            <div class="scenario-actions">
              <button type="button" class="secondary btn-load-scenario" data-id="${sc.id}">Muat & kira</button>
            </div>
          `;
          scenarioListEl.appendChild(card);
        });
        updateActiveScenarioBanner();
      }

      function formatDateTime(ts) {
        if (!ts) return "";
        return new Date(ts).toLocaleString("ms-MY", { hour12: false });
      }

      function formatTimeHM(ts) {
        if (!ts) return "";
        return new Date(ts).toLocaleTimeString("ms-MY", {
          hour: "2-digit",
          minute: "2-digit",
          hour12: false,
        });
      }

      function updateScenarioSaveStatus() {
        if (!scenarioSaveStatus) return;
        const sc = activeScenario();
        if (!sc) return;
        scenarioSaveStatus.textContent = sc.savedAt
          ? `Disimpan pada ${formatTimeHM(sc.savedAt)}`
          : "Belum disimpan";
      }

      function updateActiveScenarioBanner() {
        const sc = activeScenario();
        if (!sc || !activeScenarioBanner) return;
        const calcStatus = sc.calculatedAt ? `Sudah dikira ${formatDateTime(sc.calculatedAt)}` : "Belum dikira";
        const saveStatus = sc.savedAt ? `Disimpan ${formatDateTime(sc.savedAt)}` : "Belum disimpan";
        activeScenarioBanner.textContent = `Senario aktif: ${sc.id} (${sc.name || "Baseline"}) Â· Status: ${saveStatus} Â· ${calcStatus}`;
        updateScenarioSaveStatus();
      }

      function updateScenarioOutputs(summary, finance) {
        const sc = activeScenario();
        if (!sc) return;
        sc.mode = appState.mode;
        sc.demandMode = appState.demandMode;
        sc.outputs = {
          summary,
          finance,
        };
        sc.calculatedAt = Date.now();
        sc.updatedAt = Date.now();
        sc.schemaVersion = SCHEMA_VERSION;
        updateActiveScenarioBanner();
      }

      function updateCompareTable() {
        const cells = {
          A: appState.scenarios.A,
          B: appState.scenarios.B,
          C: appState.scenarios.C,
        };
        ["avg", "peak", "supply", "surplus", "npv", "bcr", "irr", "payback"].forEach((k) => {
          ["A", "B", "C"].forEach((id) => {
            const cls = `sc-${id.toLowerCase()}-${k}`;
            const td = scenarioCompareTable.querySelector(`.${cls}`);
            const sc = cells[id];
            if (!td) return;
            if (sc?.outputs?.summary && sc?.outputs?.finance) {
              const sum = sc.outputs.summary;
              const fin = sc.outputs.finance;
              const mapping = {
                avg: sum.avgMLD,
                peak: sum.peakMLD,
                supply: sum.effectiveMLD,
                surplus: sum.surplusAvg,
                npv: fin.npv,
                bcr: fin.bcr,
                irr: fin.irr,
                payback: fin.payback,
              };
              td.textContent = isFinite(mapping[k]) ? formatNumber(mapping[k]) : mapping[k] || "â€“";
            } else {
              td.textContent = "â€“";
            }
          });
        });
      }

      function setActiveScenario(id) {
        if (!appState.scenarios[id]) return;
        appState.activeScenarioId = id;
        applyScenarioInputs(appState.scenarios[id].inputs || {});
        renderScenarioList();
        persistState();
        hasCalculated = !!appState.scenarios[id].outputs?.summary;
        if (hasCalculated) {
          runCalculation({ scenarioId: id, scroll: false });
        } else {
          clearMissingHighlights();
          showMissingPanel([]);
          revealOutputs();
          updateStatusChip();
          updateAdvancedVisibility();
        }
        refreshStepperValidation();
        updateActiveScenarioBanner();
      }

      function addScenario() {
        const letters = ["A", "B", "C"];
        const available = letters.find((l) => !appState.scenarios[l]);
        if (!available) {
          alert("Hanya tiga senario (A/B/C) disokong. Padam satu sebelum menambah.");
          return;
        }
        appState.scenarios[available] = createEmptyScenario(available, `Senario ${available}`);
        appState.activeScenarioId = available;
        renderScenarioList();
        persistState();
        applyScenarioInputs(appState.scenarios[available].inputs);
      }

      function duplicateScenario() {
        const letters = ["A", "B", "C"];
        const available = letters.find((l) => !appState.scenarios[l]);
        if (!available) {
          alert("Hanya tiga senario (A/B/C) disokong.");
          return;
        }
        const current = activeScenario();
        if (!current) return;
        appState.scenarios[available] = {
          ...JSON.parse(JSON.stringify(current)),
          id: available,
          name: `${current.name} (Salinan)`,
          updatedAt: Date.now(),
        };
        appState.activeScenarioId = available;
        renderScenarioList();
        persistState();
      }

      function renameScenario() {
        const sc = activeScenario();
        if (!sc) return;
        const name = prompt("Nama baharu senario:", sc.name);
        if (name) {
          sc.name = name;
          sc.updatedAt = Date.now();
          renderScenarioList();
          persistState();
        }
      }

      function deleteScenario() {
        if (Object.keys(appState.scenarios).length <= 1) {
          alert("Sekurang-kurangnya satu senario mesti wujud.");
          return;
        }
        const id = appState.activeScenarioId;
        delete appState.scenarios[id];
        appState.activeScenarioId = Object.keys(appState.scenarios)[0];
        renderScenarioList();
        persistState();
        applyScenarioInputs(activeScenario().inputs);
      }

      function clearChartInstance(chartRef, canvasId) {
        if (chartRef && typeof chartRef.destroy === "function") {
          chartRef.destroy();
        }
        if (canvasId) {
          const canvas = document.getElementById(canvasId);
          const ctx = canvas?.getContext("2d");
          if (canvas && ctx) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
          }
        }
      }

      function resetOutputsUI() {
        clearElement(resultsBody);
        clearElement(altResultsBody);
        summaryAvgMLDEl.textContent = "â€“";
        summaryPeakMLDEl.textContent = "â€“";
        supplyAvgMLDEl.textContent = "â€“";
        altSupplyMLDEl.textContent = "â€“";
        effectiveSupplyMLDEl.textContent = "â€“";
        surplusAvgMLDEl.textContent = "â€“";
        surplusPeakMLDEl.textContent = "â€“";
        statusAvgEl.textContent = "â€“";
        statusPeakEl.textContent = "â€“";
        rowAvg.classList.remove("summary-row-surplus", "summary-row-deficit");
        rowPeak.classList.remove("summary-row-surplus", "summary-row-deficit");

        totalPopEl.textContent = "â€“";
        totalAvgM3El.textContent = "â€“";
        totalPeakM3El.textContent = "â€“";
        totalAvgMLDEl.textContent = "â€“";
        totalPeakMLDEl.textContent = "â€“";

        altTotalCapacityEl.textContent = "â€“";
        altTotalVolumeEl.textContent = "â€“";
        altTotalCapexEl.textContent = "â€“";
        altTotalOpexEl.textContent = "â€“";
        altTotalSavingEl.textContent = "â€“";
        altTotalNetCFEl.textContent = "â€“";
        altTotalNPVEl.textContent = "â€“";
        altTotalBCREl.textContent = "â€“";

        sumCapexEl.textContent = "â€“";
        sumSavingEl.textContent = "â€“";
        sumOpexEl.textContent = "â€“";
        sumNetCFEl.textContent = "â€“";
        sumNPVEl.textContent = "â€“";
        sumBCREl.textContent = "â€“";
        sumIRREl.textContent = "â€“";
        capexItemsTotalEl.textContent = "0.00";
        opexItemsTotalEl.textContent = "0.00";

        Object.values(sensitivityLabels).forEach((el) => {
          if (el) el.textContent = "NPV: â€“, BCR: â€“";
        });

        summaryTextEl.innerHTML = defaultSummaryText;
        chartExplainCategory.innerHTML = defaultChartExplainers.category;
        chartExplainShare.innerHTML = defaultChartExplainers.share;
        chartExplainNPV.innerHTML = defaultChartExplainers.npv;
        chartExplainPayback.innerHTML = defaultChartExplainers.payback;

        calcStatusChip.textContent = "Belum dikira";
        if (calcAlertBox) {
          calcAlertBox.classList.add("hidden");
          calcAlertBox.innerHTML = "";
        }
        if (validationBox) {
          validationBox.classList.add("hidden");
          validationList.innerHTML = "";
        }

        clearChartInstance(categoryChart, "demand-by-category-chart");
        clearChartInstance(shareChart, "demand-share-chart");
        clearChartInstance(cbaNpvChart, "cba-npv-chart");
        clearChartInstance(cbaPaybackChart, "cba-payback-chart");
        categoryChart = null;
        shareChart = null;
        cbaNpvChart = null;
        cbaPaybackChart = null;
      }

      function resetAllInputs({ includeSavedScenarios = false } = {}) {
        const activeId = appState.activeScenarioId || "A";
        const preservedName = appState.scenarios[activeId]?.name || `Senario ${activeId}`;

        if (includeSavedScenarios) {
          localStorage.removeItem(STORAGE_KEY);
          localStorage.removeItem(LEGACY_KEY);
          appState = {
            version: SCHEMA_VERSION,
            schemaVersion: SCHEMA_VERSION,
            mode: "quick",
            demandMode: "quick",
            activeScenarioId: "A",
            scenarios: { A: createEmptyScenario("A", "Senario A") },
          };
        } else {
          appState.scenarios[activeId] = createEmptyScenario(activeId, preservedName);
        }

        const targetScenario = activeScenario();
        if (targetScenario) {
          targetScenario.inputs = {
            mode: appState.mode || "quick",
            demandMode: "quick",
            quick: {
              pop: "",
              percap: "",
              demand: "",
              peak: defaultInputValues.quickPeak || "1.3",
              baseSupply: defaultInputValues.quickBaseSupply || "",
              alt: {
                name: "",
                capacity: "",
                util: "",
                capex: "",
                opex: "",
              },
            },
            supply: defaultInputValues.supply,
            tariffWater: defaultInputValues.tariffWater,
            tariffSewer: defaultInputValues.tariffSewer,
            analysisYears: defaultInputValues.analysisYears,
            discount: defaultInputValues.discountRate,
            categories: [],
            altRows: [],
            capexRows: [],
          };
          targetScenario.savedAt = null;
          targetScenario.calculatedAt = null;
          targetScenario.updatedAt = Date.now();
        }

        setMode("quick");
        setDemandMode("quick", true);

        pdfScopeSelect.value = "active";
        pdfLevelSelect.value = "ringkas";
        preparedByInput.value = "";
        pdfChartsToggle.value = "yes";
        confidentialToggle.checked = false;

        const manualCatRadio = document.querySelector("input[name='category-input-mode'][value='manual']");
        if (manualCatRadio) {
          manualCatRadio.checked = true;
          setCategoryInputMode("manual");
        }

        applyScenarioInputs(activeScenario()?.inputs || {});
        resetOutputsUI();
        hasCalculated = false;
        lastCalculatedAt = null;
        lastAltSources = [];
        lastAltSummary = {
          totalPVBenefits: 0,
          totalPVCosts: 0,
          pvCapex: 0,
          pvOpex: 0,
          payback: NaN,
        };

        renderScenarioList();
        persistState();
        clearMissingHighlights();
        showMissingPanel([]);
        revealOutputs();
        updateStatusChip();
        updateActiveScenarioBanner();
        updateScenarioSaveStatus();
        updateCompareTable();
        updateAdvancedVisibility();
        refreshStepperValidation();
      }

      function resetScenario(options = {}) {
        resetAllInputs(options);
      }

      function loadPreset() {
        quickInputs.pop.value = 15000;
        quickInputs.percap.value = 150;
        quickInputs.demand.value = 0;
        quickInputs.peak.value = 1.3;
        quickInputs.baseSupply.value = 5;
        supplyInput.value = 5;
        tariffWaterInput.value = 1.2;
        tariffSewerInput.value = 0.8;
        analysisYearsInput.value = 20;
        discountRateInput.value = 5;
        quickAltInputs.name.value = "Tangkapan air hujan mini";
        quickAltInputs.capacity.value = 250;
        quickAltInputs.util.value = 80;
        quickAltInputs.capex.value = 900000;
        quickAltInputs.opex.value = 50000;
        runCalculation({ scroll: false });
      }

      function saveActiveScenario() {
        const sc = activeScenario();
        if (!sc) return;
        sc.inputs = captureScenarioInputs();
        sc.mode = appState.mode;
        sc.demandMode = appState.demandMode;
        const now = Date.now();
        sc.savedAt = now;
        sc.lastSavedAt = now;
        sc.schemaVersion = SCHEMA_VERSION;
        sc.updatedAt = now;
        persistState();
        renderScenarioList();
        updateActiveScenarioBanner();
      }

      function updateSensitivityUI() {
        const showSens =
          hasCalculated &&
          appState.mode === "full" &&
          lastAltSources.length > 0 &&
          normalizeNumber(tariffWaterInput.value) >= 0 &&
          normalizeNumber(analysisYearsInput.value) > 0;
        if (sensEmpty) {
          sensEmpty.style.display = showSens ? "none" : "block";
        }
        if (sensPlaceholder) {
          sensPlaceholder.style.display = showSens ? "none" : "block";
        }
        if (!showSens) {
          Object.values(sensitivityLabels).forEach((el) => {
            if (el) el.textContent = "NPV: â€“, BCR: â€“";
          });
          return;
        }
        const { totalPVBenefits, totalPVCosts, pvCapex, pvOpex } = lastAltSummary;
        const baseNPV = totalPVBenefits - totalPVCosts;
        const baseBCR = totalPVCosts > 0 ? totalPVBenefits / totalPVCosts : NaN;
        const scenarios = {
          base: { npv: baseNPV, bcr: baseBCR },
          capex: {
            npv: totalPVBenefits - (pvCapex * 1.1 + pvOpex),
            bcr: (totalPVBenefits) / (pvCapex * 1.1 + pvOpex || 1),
          },
          opex: {
            npv: totalPVBenefits - (pvCapex + pvOpex * 1.1),
            bcr: (totalPVBenefits) / (pvCapex + pvOpex * 1.1 || 1),
          },
          benefit: {
            npv: totalPVBenefits * 1.1 - totalPVCosts,
            bcr: totalPVCosts > 0 ? (totalPVBenefits * 1.1) / totalPVCosts : NaN,
          },
        };
        Object.entries(scenarios).forEach(([key, val]) => {
          const el = sensitivityLabels[key];
          if (!el) return;
          el.textContent = `NPV: ${formatNumber(val.npv)} | BCR: ${isFinite(val.bcr) ? formatNumber(val.bcr) : "â€“"}`;
        });
      }

      function updateAdvancedVisibility() {
        const compareCard = scenarioCompareTable.closest(".card");
        const computedCount = Object.values(appState.scenarios).filter(
          (sc) => sc.outputs?.summary
        ).length;
        const showCompare = hasCalculated && computedCount >= 2;
        if (compareEmpty) compareEmpty.style.display = showCompare ? "none" : "block";
        if (comparePlaceholder) comparePlaceholder.style.display = showCompare ? "none" : "block";
        if (compareCard) {
          compareCard.classList.toggle("muted", !showCompare);
          compareCard.style.display = "";
          scenarioCompareTable.style.display = showCompare ? "table" : "none";
          const wrap = compareCard.closest(".output-section");
          if (wrap) wrap.style.display = "";
        }
        const hasDemand = summaryAvgMLDEl.textContent && summaryAvgMLDEl.textContent !== "â€“";
        if (!hasDemand) {
          summaryTextEl.innerHTML = "Belum ada data. Lengkapkan Langkah 3â€“5 dan tekan Kira.";
        }
        const sensCard = document.getElementById("section-sensitivity");
        const hasFinanceInputs =
          normalizeNumber(tariffWaterInput.value) >= 0 &&
          normalizeNumber(tariffSewerInput.value) >= 0 &&
          normalizeNumber(analysisYearsInput.value) > 0 &&
          normalizeNumber(discountRateInput.value) >= 0;
        const showSens =
          hasCalculated &&
          appState.mode === "full" &&
          lastAltSources.length > 0 &&
          hasFinanceInputs;
        if (sensCard) {
          sensCard.style.display = "";
          sensCard.classList.toggle("muted", !showSens);
          const grid = sensCard.querySelector(".input-grid");
          const tagline = sensCard.querySelector(".tagline");
          if (grid) grid.style.display = showSens ? "grid" : "none";
          if (tagline) tagline.style.display = showSens ? "" : "none";
          const wrap = sensCard.closest(".output-section");
          if (wrap) wrap.style.display = "";
        }
        if (sensEmpty) {
          sensEmpty.style.display = showSens ? "none" : "block";
        }
        if (sensPlaceholder) {
          sensPlaceholder.style.display = showSens ? "none" : "block";
        }
      }

      function showValidation(messages) {
        if (!messages.length) {
          validationBox.classList.add("hidden");
          validationList.innerHTML = "";
          return;
        }
        validationList.innerHTML = messages.map((m) => `<li>${m}</li>`).join("");
        validationBox.classList.remove("hidden");
      }

      function clearMissingHighlights() {
        document.querySelectorAll(".field-missing").forEach((el) => el.classList.remove("field-missing"));
        document.querySelectorAll(".missing-hint").forEach((node) => node.remove());
        document.querySelectorAll(".row-error").forEach((row) => row.classList.remove("row-error"));
      }

      function attachHint(el, text) {
        if (!el) return;
        el.classList.add("field-missing");
        const container = el.parentElement;
        if (container && !container.querySelector(".missing-hint")) {
          const hint = document.createElement("div");
          hint.className = "missing-hint";
          hint.textContent = text || "WAJIB diisi untuk kiraan";
          container.appendChild(hint);
        }
      }

      function showMissingPanel(missing) {
        const targets = [calcAlertBox, calcInlineAlert].filter(Boolean);
        if (!targets.length) return;
        if (!missing || !missing.length) {
          targets.forEach((box) => {
            box.classList.add("hidden");
            box.innerHTML = "";
          });
          return;
        }
        const list = missing
          .map((item) => `<li><strong>${item.label}</strong> â€” ${item.reason || "WAJIB diisi untuk kiraan"}</li>`)
          .join("");
        const html = `
          Input wajib belum lengkap (${missing.length}). Sila lengkapkan item berikut:
          <ul>${list}</ul>
        `;
        targets.forEach((box) => {
          box.innerHTML = html;
          box.classList.remove("hidden");
        });
      }

      function resolveTarget(target) {
        if (!target) return null;
        if (target instanceof Element) return target;
        if (typeof target === "string") {
          try {
            return document.querySelector(target);
          } catch (e) {
            return null;
          }
        }
        return null;
      }

      function applyMissingHighlights(missing) {
        clearMissingHighlights();
        missing.forEach((item) => {
          const el = resolveTarget(item?.target);
          attachHint(el, item?.reason);
        });
      }

      function getCategoryRowData() {
        const tbody = categoryBody || document.querySelector("#category-input-table tbody");
        if (!tbody) throw new Error("Jadual permintaan kategori tidak ditemui atau belum dimuat.");
        const rows = Array.from(tbody.querySelectorAll("tr"));
        if (!rows.length) throw new Error("Tiada baris dalam jadual permintaan kategori untuk dikira.");
        return rows.map((row, idx) => {
          const nameInput = row.querySelector(".cat-name, [data-field='category-name']");
          const popInput = row.querySelector(".cat-pop, [data-field='category-pop']");
          const percapInput = row.querySelector(".cat-percap, [data-field='category-percap']");
          const peakInput = row.querySelector(".cat-peak, [data-field='category-peak']");
          if (!nameInput || !popInput || !percapInput || !peakInput) {
            throw new Error(
              `Baris ${idx + 1} jadual permintaan tidak lengkap. Sila semak semula lajur kategori/populasi/per kapita/peak.`
            );
          }
          const name =
            (row.dataset.category || nameInput.value || nameInput.textContent || `Baris ${idx + 1}`).trim();
          const pop = normalizeNumber(popInput.value);
          const percap = normalizeNumber(percapInput.value);
          const peak = normalizeNumber(peakInput.value);
          const hasAny = name || pop > 0 || percap > 0 || peak > 0;
          return { row, nameInput, popInput, percapInput, peakInput, name, pop, percap, peak, hasAny };
        });
      }

      function getAltRowData() {
        const rows = Array.from(document.querySelectorAll(".alt-row"));
        return rows.map((row, idx) => {
          const grab = (sel) => row.querySelector(sel);
          const nameInput = grab(".alt-name");
          const capacityInput = grab(".alt-capacity");
          const utilInput = grab(".alt-util");
          const reliabilityInput = grab(".alt-reliability");
          const capexInput = grab(".alt-capex");
          const capexNoteInput = grab(".alt-capex-note");
          const opexFixedInput = grab(".alt-opex-fixed");
          const opexVarInput = grab(".alt-opex-var");
          const opexNoteInput = grab(".alt-opex-note");
          const lifeInput = grab(".alt-life");
          if (!reliabilityInput) {
            throw new Error(`Lajur kebolehpercayaan hilang pada baris sumber alternatif ${idx + 1}.`);
          }
          if (!nameInput || !capacityInput || !utilInput) {
            throw new Error(`Baris ${idx + 1} sumber alternatif tidak lengkap (nama/kapasiti/util).`);
          }
          return {
            row,
            nameInput,
            capacityInput,
            utilInput,
            reliabilityInput,
            capexInput,
            capexNoteInput,
            opexFixedInput,
            opexVarInput,
            opexNoteInput,
            lifeInput,
          };
        });
      }

      function validateInputs({ mode = appState.mode, demandMethod = appState.demandMode } = {}) {
        const missing = [];
        const warnings = [];
        const addMissing = (target, label, reason) => {
          missing.push({ target, label, reason: reason || "WAJIB diisi untuk kiraan" });
        };

        if (demandMethod === "quick") {
          const pop = normalizeNumber(quickInputs.pop.value);
          const percap = normalizeNumber(quickInputs.percap.value);
          const demand = normalizeNumber(quickInputs.demand.value);
          const peak = normalizeNumber(quickInputs.peak.value);
          if (!(demand > 0 || (pop > 0 && percap > 0))) {
            addMissing("#quick-demand", "Permintaan harian / populasi", "Isi jumlah permintaan atau populasi & per kapita");
            addMissing("#quick-pop", "Populasi", "Isi jika tiada jumlah permintaan");
            addMissing("#quick-percap", "Per kapita", "Isi jika tiada jumlah permintaan");
          }
          if (!(peak > 0)) {
            addMissing("#quick-peak", "Faktor puncak", "Mesti lebih besar daripada 0");
          } else if (peak < 1.2 || peak > 1.5) {
            warnings.push("Amaran: faktor puncak biasa antara 1.2â€“1.5.");
          }
        } else {
          const rows = getCategoryRowData();
          let hasValidRow = false;
          rows.forEach((row, idx) => {
            const name = row.name || `Baris ${idx + 1}`;
            const popInput = row.popInput;
            const percapInput = row.percapInput;
            const peakInput = row.peakInput;
            const pop = row.pop;
            const percap = row.percap;
            const peak = row.peak;
            const hasAny = row.hasAny;
            if (pop > 0 && percap > 0) {
              hasValidRow = true;
            } else if (hasAny) {
              addMissing(popInput, `Kategori ${name}`, "Populasi dan per kapita wajib diisi");
              addMissing(percapInput, `Kategori ${name}`, "Populasi dan per kapita wajib diisi");
              row.row.classList.add("row-error");
            }
            if (!(peak > 0) && hasAny) {
              addMissing(peakInput, `Kategori ${name}`, "Faktor puncak wajib diisi");
            } else if (peak && (peak < 1.1 || peak > 1.6)) {
              warnings.push(`Amaran faktor puncak (${name}) luar julat biasa 1.2â€“1.5.`);
            }
          });
          if (!hasValidRow) {
            addMissing("#category-input-table", "Jadual kategori", "Isi sekurang-kurangnya satu baris lengkap");
          }
        }

        const supplyVal = normalizeNumber(supplyInput.value);
        if (!(supplyVal > 0)) {
          addMissing("#supply-mld", "Bekalan asas (JANS)", "Masukkan nilai MLD yang sah");
        }

        const tariffWaterVal = normalizeNumber(tariffWaterInput.value);
        const tariffSewerVal = normalizeNumber(tariffSewerInput.value);
        const analysisYearsVal = normalizeNumber(analysisYearsInput.value);
        const discountVal = normalizeNumber(discountRateInput.value);

        if (!(tariffWaterVal >= 0)) addMissing("#tariff-water", "Tarif air terawat", "Tidak boleh kosong");
        if (!(tariffSewerVal >= 0)) addMissing("#tariff-sewer", "Tarif pembetungan", "Tidak boleh kosong");
        if (!(analysisYearsVal > 0)) addMissing("#analysis-years", "Tempoh analisis", "Mesti lebih besar daripada 0");
        if (!(discountVal >= 0)) addMissing("#discount-rate", "Kadar diskaun", "Tidak boleh negatif");

        const ok = missing.length === 0;
        return { ok, missing, warnings };
      }

      function blobToDataURL(blob) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(blob);
        });
      }

      async function loadUmsLogoDataUrl() {
        if (umsLogoDataUrl) return umsLogoDataUrl;
        try {
          const res = await fetch(encodeURI(umsLogoPath));
          if (!res.ok) throw new Error(`Logo gagal dimuat (status ${res.status})`);
          const blob = await res.blob();
          umsLogoDataUrl = await blobToDataURL(blob);
        } catch (err) {
          console.warn("Gagal memuat logo UMS untuk laporan:", err);
          umsLogoDataUrl = "";
        }
        return umsLogoDataUrl;
      }

      function ensurePptxLoaded() {
        const existing = window.PptxGenJS || window.pptxgen;
        if (existing) {
          window.PptxGenJS = existing;
          return Promise.resolve(existing);
        }
        if (pptxLibPromise) return pptxLibPromise;
        const loadScript = (src, name) =>
          new Promise((resolve, reject) => {
            const script = document.createElement("script");
            script.src = src;
            script.async = true;
            script.onload = resolve;
            script.onerror = () => reject(new Error(`${name || "Skrip"} gagal dimuat`));
            document.head.appendChild(script);
          });
        pptxLibPromise = loadScript("https://cdn.jsdelivr.net/gh/gitbrent/pptxgenjs/dist/pptxgen.bundle.js", "PptxGenJS")
          .then(() => {
            const lib = window.PptxGenJS || window.pptxgen;
            if (lib) {
              window.PptxGenJS = lib;
              return lib;
            }
            throw new Error("PptxGenJS gagal dimuat");
          })
          .catch((err) => {
            pptxLibPromise = null;
            throw err;
          });
        return pptxLibPromise;
      }

      function waitForNextFrame() {
        return new Promise((resolve) => requestAnimationFrame(() => resolve()));
      }

      function wait(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }

      function waitForImages(container) {
        const imgs = Array.from(container.querySelectorAll("img"));
        const pending = imgs.filter((img) => !img.complete || img.naturalWidth === 0);
        if (!pending.length) return Promise.resolve();
        return Promise.allSettled(
          pending.map(
            (img) =>
              new Promise((resolve) => {
                img.addEventListener("load", resolve, { once: true });
                img.addEventListener("error", resolve, { once: true });
              })
          )
        );
      }

      function waitForFonts() {
        if (document.fonts && document.fonts.ready) {
          return document.fonts.ready.catch(() => undefined);
        }
        return Promise.resolve();
      }

      function calculateCore({ mode = appState.mode, demandMethod = appState.demandMode } = {}) {
        const demandRows = [];
        const categoryNames = [];
        const peakDemands = [];
        const avgDemands = [];
        let totalPop = 0;
        let totalAvgM3 = 0;
        let totalPeakM3 = 0;

        resultsBody.innerHTML = "";

        const useQuick = demandMethod === "quick";
        if (useQuick) {
          const pop = normalizeNumber(quickInputs.pop.value);
          const percap = normalizeNumber(quickInputs.percap.value);
          const demand = normalizeNumber(quickInputs.demand.value);
          const peak = normalizeNumber(quickInputs.peak.value) || 1.3;
          let avgM3 = demand > 0 ? demand : (pop * percap) / 1000;
          avgM3 = isFinite(avgM3) ? avgM3 : 0;
          const peakM3 = avgM3 * peak;
          totalPop = pop;
          totalAvgM3 = avgM3;
          totalPeakM3 = peakM3;
          demandRows.push({
            name: "Anggaran pantas",
            pop,
            percap,
            avgM3,
            peakFactor: peak,
            peakM3,
          });
          categoryNames.push("Anggaran pantas");
          avgDemands.push(avgM3);
          peakDemands.push(peakM3);
        } else {
          const rows = getCategoryRowData();
          rows.forEach((entry, idx) => {
            const name = entry.name || entry.row.dataset.category || `Kategori ${idx + 1}`;
            const pop = entry.pop;
            const percap = entry.percap;
            const peak = entry.peak;

            if (!entry.hasAny || !isFinite(pop) || pop <= 0 || !isFinite(percap)) {
              return;
            }

            const avgM3 = (pop * percap) / 1000;
            const peakM3 = avgM3 * (isFinite(peak) && peak > 0 ? peak : 1);

            totalPop += pop;
            totalAvgM3 += avgM3;
            totalPeakM3 += peakM3;

            categoryNames.push(name);
            avgDemands.push(avgM3);
            peakDemands.push(peakM3);

            demandRows.push({
              name,
              pop,
              percap,
              avgM3,
              peakFactor: peak,
              peakM3,
            });
          });
        }

        demandRows.forEach((row) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${row.name}</td>
            <td>${formatNumber(row.pop)}</td>
            <td>${formatNumber(row.percap)}</td>
            <td>${formatNumber(row.avgM3)}</td>
            <td>${isFinite(row.peakFactor) ? formatNumber(row.peakFactor) : "â€“"}</td>
            <td>${formatNumber(row.peakM3)}</td>
          `;
          resultsBody.appendChild(tr);
        });

        const totalAvgMLD = totalAvgM3 / 1000;
        const totalPeakMLD = totalPeakM3 / 1000;

        totalPopEl.textContent = totalPop ? formatNumber(totalPop) : "â€“";
        totalAvgM3El.textContent = formatNumber(totalAvgM3);
        totalPeakM3El.textContent = formatNumber(totalPeakM3);
        totalAvgMLDEl.textContent = formatNumber(totalAvgMLD);
        totalPeakMLDEl.textContent = formatNumber(totalPeakMLD);

        if (useQuick && quickInputs.baseSupply.value) {
          supplyInput.value = quickInputs.baseSupply.value;
        }

        // 2. Baseline supply (JANS)
        const supplyBaseMLD = parseFloat(supplyInput.value);
        const supplyValid = isFinite(supplyBaseMLD) && supplyBaseMLD >= 0;

        supplyAvgMLDEl.textContent = supplyValid
          ? formatNumber(supplyBaseMLD)
          : "â€“";

        // 3. Alternative supply + build altData for CBA
        const altData = [];
        let altAvgM3PerDayTotal = 0;
        if (useQuick) {
          const name = (quickAltInputs.name.value || "").trim();
          const cap = normalizeNumber(quickAltInputs.capacity.value);
          const util = normalizeNumber(quickAltInputs.util.value);
          if (name && cap > 0 && util > 0) {
            const capex = normalizeNumber(quickAltInputs.capex.value);
            const opex = normalizeNumber(quickAltInputs.opex.value);
            const avgM3PerDayEff = cap * (util / 100);
            altAvgM3PerDayTotal += avgM3PerDayEff;
            altData.push({
              name,
              capacity: cap,
              utilPercent: util,
              reliabilityPercent: 100,
              capex,
              capexNote: "",
              opexFixed: opex,
              opexVar: 0,
              opexNote: "",
              lifeYears: NaN,
            });
          }
        } else {
          const altRows = getAltRowData();
          altRows.forEach((entry, idx) => {
            const name = (entry.nameInput.value || "").trim() || `Sumber ${idx + 1}`;
            const cap = parseFloat(entry.capacityInput.value);
            const util = parseFloat(entry.utilInput.value);
            const reliabilityRaw = normalizeNumber(entry.reliabilityInput.value, NaN);
            const reliability = isFinite(reliabilityRaw) ? reliabilityRaw : 100;
            const capex = parseFloat(entry.capexInput?.value);
            const capexNote = (entry.capexNoteInput?.value || "").trim();
            const opexFixed = parseFloat(entry.opexFixedInput?.value);
            const opexVar = parseFloat(entry.opexVarInput?.value);
            const opexNote = (entry.opexNoteInput?.value || "").trim();
            const lifeYears = parseFloat(entry.lifeInput?.value);

            if (!name || !isFinite(cap) || cap <= 0 || !isFinite(util) || util <= 0) {
              return;
            }

            const avgM3PerDayEff = cap * (util / 100) * (reliability / 100);
            altAvgM3PerDayTotal += avgM3PerDayEff;

            altData.push({
              name,
              capacity: cap,
              utilPercent: util,
              reliabilityPercent: reliability,
              capex: isFinite(capex) ? capex : 0,
              capexNote,
              opexFixed: isFinite(opexFixed) ? opexFixed : 0,
              opexVar: isFinite(opexVar) ? opexVar : 0,
              opexNote,
              lifeYears: isFinite(lifeYears) ? lifeYears : NaN,
            });
          });
        }

        const altSupplyMLD = altAvgM3PerDayTotal / 1000;
        altSupplyMLDEl.textContent = altData.length
          ? formatNumber(altSupplyMLD)
          : "0.00";

        const effectiveSupplyMLD = (supplyValid ? supplyBaseMLD : 0) + altSupplyMLD;
        effectiveSupplyMLDEl.textContent = effectiveSupplyMLD
          ? formatNumber(effectiveSupplyMLD)
          : "â€“";

        // 4. Demand vs effective supply
        summaryAvgMLDEl.textContent = formatNumber(totalAvgMLD);
        summaryPeakMLDEl.textContent = formatNumber(totalPeakMLD);

        let surplusAvg = null;
        let surplusPeak = null;
        let statusAvg = "";
        let statusPeak = "";

        rowAvg.classList.remove("summary-row-surplus", "summary-row-deficit");
        rowPeak.classList.remove("summary-row-surplus", "summary-row-deficit");

        if (effectiveSupplyMLD > 0) {
          surplusAvg = effectiveSupplyMLD - totalAvgMLD;
          surplusPeak = effectiveSupplyMLD - totalPeakMLD;

          surplusAvgMLDEl.textContent = formatNumber(surplusAvg);
          surplusPeakMLDEl.textContent = formatNumber(surplusPeak);

          if (totalAvgMLD > 0) {
            statusAvg = surplusAvg >= 0 ? "Surplus" : "Deficit";
          }
          if (totalPeakMLD > 0) {
            statusPeak = surplusPeak >= 0 ? "Surplus" : "Deficit";
          }

          if (statusAvg === "Surplus") {
            rowAvg.classList.add("summary-row-surplus");
          } else if (statusAvg === "Deficit") {
            rowAvg.classList.add("summary-row-deficit");
          }

          if (statusPeak === "Surplus") {
            rowPeak.classList.add("summary-row-surplus");
          } else if (statusPeak === "Deficit") {
            rowPeak.classList.add("summary-row-deficit");
          }
        } else {
          surplusAvgMLDEl.textContent = "â€“";
          surplusPeakMLDEl.textContent = "â€“";
        }

        statusAvgEl.textContent = formatStatusLabel(statusAvg, false);
        statusPeakEl.textContent = formatStatusLabel(statusPeak, true);

        // 5. Ringkasan teks
        if (!categoryNames.length) {
          summaryTextEl.innerHTML =
            "Sila masukkan sekurang-kurangnya satu kategori dengan populasi dan kadar per kapita untuk menjana analisis.";
        } else if (!supplyValid && !altData.length) {
          summaryTextEl.innerHTML =
            "Permintaan purata dianggarkan sebanyak <strong>" +
            formatNumber(totalAvgMLD) +
            " MLD</strong>, manakala permintaan puncak sebanyak <strong>" +
            formatNumber(totalPeakMLD) +
            " MLD</strong>. Sila masukkan nilai bekalan JANS dan/atau sumber alternatif untuk menilai surplus atau defisit.";
        } else {
          const baseText = supplyValid
            ? "Bekalan sedia ada (JANS) dianggarkan <strong>" +
              formatNumber(supplyBaseMLD) +
              " MLD</strong>."
            : "Bekalan JANS tidak ditetapkan dengan jelas.";

          const altText = altData.length
            ? " Sumber alternatif menambah kira-kira <strong>" +
              formatNumber(altSupplyMLD) +
              " MLD</strong> kepada bekalan."
            : " Tiada sumber alternatif dimasukkan setakat ini.";

          const effText =
            " Bekalan efektif (JANS + alternatif) dianggarkan <strong>" +
            formatNumber(effectiveSupplyMLD) +
            " MLD</strong>.";

          const avgWord = surplusAvg >= 0 ? "lebihan" : "defisit";
          const peakWord = surplusPeak >= 0 ? "lebihan" : "defisit";

          summaryTextEl.innerHTML =
            baseText +
            altText +
            effText +
            " Jumlah permintaan purata kampus dianggarkan <strong>" +
            formatNumber(totalAvgMLD) +
            " MLD</strong> (" +
            avgWord +
            " " +
            formatNumber(Math.abs(surplusAvg)) +
            " MLD), manakala permintaan puncak dianggarkan <strong>" +
            formatNumber(totalPeakMLD) +
            " MLD</strong> (" +
            peakWord +
            " " +
            formatNumber(Math.abs(surplusPeak)) +
            " MLD).";
        }

        // 6. Update demand charts
        updateDemandCharts(categoryNames, avgDemands, peakDemands);

        // 7. CBA for alternative sources
        const finance = calculateAltCBA(altData) || {};

        // 8. Simpan ke senario & jadual perbandingan
        const summaryOut = {
          avgMLD: totalAvgMLD,
          peakMLD: totalPeakMLD,
          effectiveMLD: effectiveSupplyMLD,
          surplusAvg,
          surplusPeak,
        };
        updateChartNarratives(demandRows, summaryOut, finance);
        updateScenarioOutputs(summaryOut, finance);
        saveActiveScenario();
        updateCompareTable();
        updateSensitivityUI();
        updateAdvancedVisibility();
        refreshStepperValidation();
        return true;
      }

      function updateDemandCharts(labels, avgData, peakData) {
        if (categoryChart) categoryChart.destroy();
        if (shareChart) shareChart.destroy();

        if (!labels.length) return;

        categoryChart = new Chart(categoryChartCtx, {
          type: "bar",
          data: {
            labels,
            datasets: [
              {
                label: "Purata (mÂ³/hari)",
                data: avgData,
                backgroundColor: "rgba(13, 110, 253, 0.7)",
                borderRadius: 6,
              },
              {
                label: "Puncak (mÂ³/hari)",
                data: peakData,
                backgroundColor: "rgba(0, 188, 212, 0.7)",
                borderRadius: 6,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false,
            layout: { padding: 16 },
            plugins: {
              legend: { position: "bottom" },
              title: {
                display: true,
                text: "Permintaan Air Mengikut Kategori",
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                title: { display: true, text: "mÂ³/hari" },
              },
            },
          },
        });

        shareChart = new Chart(shareChartCtx, {
          type: "pie",
          data: {
            labels,
            datasets: [
              {
                data: avgData,
                backgroundColor: [
                  "rgba(13, 110, 253, 0.85)",
                  "rgba(0, 188, 212, 0.85)",
                  "rgba(3, 169, 244, 0.85)",
                  "rgba(0, 150, 136, 0.85)",
                  "rgba(63, 81, 181, 0.85)",
                  "rgba(33, 150, 243, 0.85)",
                ],
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false,
            layout: { padding: 18 },
            plugins: {
              legend: { position: "bottom" },
              title: {
                display: true,
                text: "Agihan Permintaan Purata Mengikut Kategori",
              },
            },
          },
        });
      }

      function updateChartNarratives(demandRows, summary, finance) {
        const top = (demandRows || []).reduce(
          (acc, row) => (row.avgM3 > (acc?.avgM3 || 0) ? row : acc),
          null
        );
        if (chartExplainCategory) {
          chartExplainCategory.innerHTML = `
            <strong>Apa yang ditunjukkan:</strong> Purata dan puncak setiap kategori (MLD).
            <br><strong>Maksud/Implikasi:</strong> ${top ? `${top.name} merupakan penyumbang tertinggi (${formatNumber(top.avgM3 / 1000)} MLD).` : "Isi data untuk melihat kategori dominan."}
            <br><strong>Tindakan dicadangkan:</strong> Fokuskan intervensi ke kategori tertinggi dan semak faktor puncak jika tinggi.
          `;
        }
        if (chartExplainShare) {
          const surplusText = summary?.surplusAvg >= 0 ? "bekalan mencukupi" : "terdapat defisit yang perlu ditutup";
          chartExplainShare.innerHTML = `
            <strong>Apa yang ditunjukkan:</strong> Peratus sumbangan permintaan mengikut kategori.
            <br><strong>Maksud/Implikasi:</strong> ${surplusText}. Kategori terbesar memberi impak besar kepada strategi penjimatan.
            <br><strong>Tindakan dicadangkan:</strong> Prioritikan program penjimatan di 2â€“3 kategori teratas dan semak peluang sumber alternatif.
          `;
        }
        if (chartExplainNPV) {
          const npvText = isFinite(finance?.npv) && finance.npv !== 0
            ? `NPV projek agregat ${finance.npv > 0 ? "positif" : "negatif"} (${formatNumber(finance.npv)}).`
            : "Isi CAPEX/OPEX untuk melihat NPV.";
          chartExplainNPV.innerHTML = `
            <strong>Apa yang ditunjukkan:</strong> Nilai NPV bagi setiap sumber alternatif.
            <br><strong>Maksud/Implikasi:</strong> ${npvText}
            <br><strong>Tindakan dicadangkan:</strong> Utamakan sumber dengan NPV positif/BCR tinggi; semak semula kos untuk sumber negatif.
          `;
        }
        if (chartExplainPayback) {
          const payText = isFinite(finance?.payback)
            ? `Anggaran pulangan modal ${formatNumber(finance.payback)} tahun.`
            : "Pulangan modal tidak dapat dikira tanpa aliran tunai positif.";
          chartExplainPayback.innerHTML = `
            <strong>Apa yang ditunjukkan:</strong> Tempoh pulangan modal setiap sumber.
            <br><strong>Maksud/Implikasi:</strong> ${payText}
            <br><strong>Tindakan dicadangkan:</strong> Pilih sumber dengan tempoh pulangan lebih pendek dahulu untuk fasa awal.
          `;
        }
      }

      function computeIRR(initialCapex, netCF, years) {
        if (!(isFinite(initialCapex) && isFinite(netCF) && initialCapex > 0 && netCF > 0 && years > 0)) {
          return NaN;
        }
        let low = 0.0;
        let high = 0.3; // 0%â€“30%
        function npv(rate) {
          let val = -initialCapex;
          for (let t = 1; t <= years; t++) {
            val += netCF / Math.pow(1 + rate, t);
          }
          return val;
        }
        let npvLow = npv(low);
        let npvHigh = npv(high);
        if (npvLow * npvHigh > 0) {
          return NaN;
        }
        for (let i = 0; i < 40; i++) {
          const mid = (low + high) / 2;
          const npvMid = npv(mid);
          if (Math.abs(npvMid) < 1e-3) {
            return mid;
          }
          if (npvLow * npvMid < 0) {
            high = mid;
            npvHigh = npvMid;
          } else {
            low = mid;
            npvLow = npvMid;
          }
        }
        return (low + high) / 2;
      }

      function calculateAltCBA(altData) {
        // Clear if no data
        altResultsBody.innerHTML = "";
        if (cbaNpvChart) cbaNpvChart.destroy();
        if (cbaPaybackChart) cbaPaybackChart.destroy();

        const tariffWater = parseFloat(tariffWaterInput.value) || 0;
        const tariffSewer = parseFloat(tariffSewerInput.value) || 0;
        const tariffTotal = tariffWater + tariffSewer;

        const analysisYears = parseInt(analysisYearsInput.value, 10) || 0;
        const discountRate = parseFloat(discountRateInput.value) || 0;
        const r = discountRate / 100;

        let totalCap = 0;
        let totalVol = 0;
        let totalCapex = 0;
        let totalOpex = 0;
        let totalSaving = 0;
        let totalNetCF = 0;

        let totalPVBenefits = 0;
        let totalPVCosts = 0;
        let pvCapexTotal = 0;
        let pvOpexTotal = 0;

        const labels = [];
        const npvData = [];
        const paybackData = [];

        if (!altData.length || analysisYears <= 0) {
          altTotalCapacityEl.textContent = "0.00";
          altTotalVolumeEl.textContent = "0.00";
          altTotalCapexEl.textContent = "0.00";
          altTotalOpexEl.textContent = "0.00";
          altTotalSavingEl.textContent = "0.00";
          altTotalNetCFEl.textContent = "0.00";
          altTotalNPVEl.textContent = "0.00";
          altTotalBCREl.textContent = "â€“";

          sumCapexEl.textContent = "0.00";
          sumSavingEl.textContent = "0.00";
          sumOpexEl.textContent = "0.00";
          sumNetCFEl.textContent = "0.00";
          sumNPVEl.textContent = "0.00";
          sumBCREl.textContent = "â€“";
          sumIRREl.textContent = "â€“";

          lastAltSources = [];
          lastAltSummary = {
            totalPVBenefits: 0,
            totalPVCosts: 0,
            pvCapex: 0,
            pvOpex: 0,
            payback: NaN,
          };
          return {
            capex: 0,
            saving: 0,
            opex: 0,
            netcf: 0,
            npv: 0,
            bcr: NaN,
            irr: NaN,
            payback: NaN,
          };
        }

        altData.forEach((s) => {
          const { name, capacity, utilPercent, reliabilityPercent = 100, capex, opexFixed, opexVar, lifeYears } = s;
          const volAnnual = capacity * (utilPercent / 100) * (reliabilityPercent / 100) * 365;

          const savingAnnual = volAnnual * tariffTotal;
          const opexAnnual = opexFixed + opexVar * volAnnual;
          const netCF = savingAnnual - opexAnnual;

          // Simple payback
          let payback = NaN;
          if (netCF > 0 && capex > 0) {
            payback = capex / netCF;
          }

          // NPV & BCR
          const horizon = isFinite(lifeYears) && lifeYears > 0
            ? Math.min(analysisYears, Math.round(lifeYears))
            : analysisYears;

          let pvBenefits = 0;
          let pvCosts = capex;
          let pvOpex = 0;

          for (let t = 1; t <= horizon; t++) {
            const df = Math.pow(1 + r, t);
            pvBenefits += savingAnnual / df;
            const opexPV = opexAnnual / df;
            pvCosts += opexPV;
            pvOpex += opexPV;
          }

          const npv = pvBenefits - pvCosts;
          const bcr = pvCosts > 0 ? pvBenefits / pvCosts : NaN;

          totalCap += capacity;
          totalVol += volAnnual;
          totalCapex += capex;
          totalOpex += opexAnnual;
          totalSaving += savingAnnual;
          totalNetCF += netCF;

          totalPVBenefits += pvBenefits;
          totalPVCosts += pvCosts;
          pvCapexTotal += capex;
          pvOpexTotal += pvOpex;

          labels.push(name);
          npvData.push(npv);
          paybackData.push(isFinite(payback) ? payback : null);

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${name}</td>
            <td>${formatNumber(capacity)}</td>
            <td>${formatNumber(utilPercent)}</td>
            <td>${formatNumber(reliabilityPercent)}</td>
            <td>${formatNumber(volAnnual)}</td>
            <td>${formatNumber(capex)}</td>
            <td>${formatNumber(opexAnnual)}</td>
            <td>${formatNumber(savingAnnual)}</td>
            <td>${formatNumber(netCF)}</td>
            <td>${isFinite(payback) ? formatNumber(payback) : "â€“"}</td>
            <td>${formatNumber(npv)}</td>
            <td>${isFinite(bcr) ? formatNumber(bcr) : "â€“"}</td>
          `;
          altResultsBody.appendChild(tr);
        });

        const totalNPV = totalPVBenefits - totalPVCosts;
        const totalBCR = totalPVCosts > 0 ? totalPVBenefits / totalPVCosts : NaN;
        const totalPayback = totalNetCF > 0 && totalCapex > 0 ? totalCapex / totalNetCF : NaN;

        altTotalCapacityEl.textContent = formatNumber(totalCap);
        altTotalVolumeEl.textContent = formatNumber(totalVol);
        altTotalCapexEl.textContent = formatNumber(totalCapex);
        altTotalOpexEl.textContent = formatNumber(totalOpex);
        altTotalSavingEl.textContent = formatNumber(totalSaving);
        altTotalNetCFEl.textContent = formatNumber(totalNetCF);
        altTotalNPVEl.textContent = formatNumber(totalNPV);
        altTotalBCREl.textContent = isFinite(totalBCR) ? formatNumber(totalBCR) : "â€“";

        sumCapexEl.textContent = formatNumber(totalCapex);
        sumSavingEl.textContent = formatNumber(totalSaving);
        sumOpexEl.textContent = formatNumber(totalOpex);
        sumNetCFEl.textContent = formatNumber(totalNetCF);
        sumNPVEl.textContent = formatNumber(totalNPV);
        sumBCREl.textContent = isFinite(totalBCR) ? formatNumber(totalBCR) : "â€“";

        // IRR anggaran untuk projek (menggunakan totalCapex & totalNetCF)
        const irr = computeIRR(totalCapex, totalNetCF, analysisYears);
        sumIRREl.textContent = isFinite(irr) ? (irr * 100).toFixed(2) + " %" : "â€“";

        // Simpan altData untuk laporan PDF (termasuk nota CAPEX/OPEX)
        lastAltSources = altData.slice();
        lastAltSummary = {
          totalPVBenefits,
          totalPVCosts,
          pvCapex: pvCapexTotal,
          pvOpex: pvOpexTotal,
          payback: totalPayback,
        };

        // Graf NPV & tempoh pulangan modal
        if (labels.length) {
          cbaNpvChart = new Chart(cbaNPVCtx, {
            type: "bar",
            data: {
              labels,
              datasets: [
                {
                  label: "NPV (RM)",
                  data: npvData,
                  backgroundColor: "rgba(3, 169, 244, 0.8)",
                  borderRadius: 6,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              animation: false,
              layout: { padding: 18 },
              plugins: {
                legend: { display: false },
                title: { display: true, text: "NPV Mengikut Sumber Air Alternatif" },
              },
              scales: {
                y: { beginAtZero: false, title: { display: true, text: "RM" } },
              },
            },
          });

          cbaPaybackChart = new Chart(cbaPaybackCtx, {
            type: "bar",
            data: {
              labels,
              datasets: [
                {
                  label: "Tempoh pulangan modal (tahun)",
                  data: paybackData,
                  backgroundColor: "rgba(255, 193, 7, 0.9)",
                  borderRadius: 6,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              animation: false,
              layout: { padding: 18 },
              plugins: {
                legend: { display: false },
                title: { display: true, text: "Tempoh Pulangan Modal Mengikut Sumber" },
              },
              scales: {
                y: {
                  beginAtZero: true,
                  title: { display: true, text: "Tahun" },
                },
              },
            },
          });
        }

        return {
          capex: totalCapex,
          saving: totalSaving,
          opex: totalOpex,
          netcf: totalNetCF,
          npv: totalNPV,
          bcr: totalBCR,
          irr: isFinite(irr) ? irr * 100 : NaN,
          payback: totalPayback,
        };
      }

      // CAPEX/OPEX itemised calculator
      function recalcCapexOpexItems() {
        const rows = Array.from(document.querySelectorAll(".capex-opex-row"));
        let capexTotal = 0;
        let opexTotal = 0;

        rows.forEach((row) => {
          const type = row.querySelector(".item-type").value;
          const qty = parseFloat(row.querySelector(".item-qty").value) || 0;
          const cost = parseFloat(row.querySelector(".item-cost").value) || 0;
          const total = qty * cost;
          row.querySelector(".item-total").textContent = formatNumber(total);
          if (type === "CAPEX") {
            capexTotal += total;
          } else {
            opexTotal += total;
          }
        });

        capexItemsTotalEl.textContent = formatNumber(capexTotal);
        opexItemsTotalEl.textContent = formatNumber(opexTotal);
      }

      async function collectReportData() {
        recalcCapexOpexItems();
        runCalculation({ scroll: false });
        await waitForNextFrame();
        await wait(80);

        const now = new Date();
        const generatedDate = now.toLocaleDateString("ms-MY");
        const fileDate = now.toISOString().slice(0, 10);
        const reportLevel = pdfLevelSelect?.value || "ringkas";
        const preparedBy = (preparedByInput?.value || "").trim();
        const includeCharts = (pdfChartsToggle?.value || "yes") === "yes";

        const summary = {
          avgMLD: parseNumberFromText(summaryAvgMLDEl.textContent),
          peakMLD: parseNumberFromText(summaryPeakMLDEl.textContent),
          supplyMLD: parseNumberFromText(supplyAvgMLDEl.textContent),
          altSupplyMLD: parseNumberFromText(altSupplyMLDEl.textContent),
          effectiveMLD: parseNumberFromText(effectiveSupplyMLDEl.textContent),
          surplusAvg: parseNumberFromText(surplusAvgMLDEl.textContent),
          surplusPeak: parseNumberFromText(surplusPeakMLDEl.textContent),
          text: {
            avg: summaryAvgMLDEl.textContent || "â€“",
            peak: summaryPeakMLDEl.textContent || "â€“",
            supply: supplyAvgMLDEl.textContent || "â€“",
            alt: altSupplyMLDEl.textContent || "â€“",
            effective: effectiveSupplyMLDEl.textContent || "â€“",
            surplusAvg: surplusAvgMLDEl.textContent || "â€“",
            surplusPeak: surplusPeakMLDEl.textContent || "â€“",
          },
          status: {
            avg: statusAvgEl.textContent || "â€“",
            peak: statusPeakEl.textContent || "â€“",
          },
        };

        const categoryInputs = Array.from(
          document.querySelectorAll(".category-row")
        )
          .map((row) => ({
            name: row.querySelector(".cat-name")?.value || "",
            pop: row.querySelector(".cat-pop")?.value || "",
            percap: row.querySelector(".cat-percap")?.value || "",
            peak: row.querySelector(".cat-peak")?.value || "",
          }))
          .filter(
            (r) =>
              r.name.trim() ||
              parseNumberFromText(r.pop) > 0 ||
              parseNumberFromText(r.percap) > 0
          );

        const demandByCategory = Array.from(
          document.querySelectorAll("#results-body tr")
        ).map((tr) => {
          const cells = tr.querySelectorAll("td");
          return {
            name: cells[0]?.textContent.trim() || "-",
            pop: cells[1]?.textContent.trim() || "â€“",
            percap: cells[2]?.textContent.trim() || "â€“",
            avg: cells[3]?.textContent.trim() || "â€“",
            peakFactor: cells[4]?.textContent.trim() || "â€“",
            peak: cells[5]?.textContent.trim() || "â€“",
          };
        });

        const altRows = Array.from(
          document.querySelectorAll("#alt-results-body tr")
        );
        const altSources = altRows.map((tr, idx) => {
          const cells = tr.querySelectorAll("td");
          return {
            name: cells[0]?.textContent.trim() || "-",
            capacity: cells[1]?.textContent.trim() || "â€“",
            util: cells[2]?.textContent.trim() || "â€“",
            volume: cells[3]?.textContent.trim() || "â€“",
            capex: cells[4]?.textContent.trim() || "â€“",
            opex: cells[5]?.textContent.trim() || "â€“",
            saving: cells[6]?.textContent.trim() || "â€“",
            netcf: cells[7]?.textContent.trim() || "â€“",
            payback: cells[8]?.textContent.trim() || "â€“",
            npv: cells[9]?.textContent.trim() || "â€“",
            bcr: cells[10]?.textContent.trim() || "â€“",
            capexNote: lastAltSources[idx]?.capexNote || "",
            opexNote: lastAltSources[idx]?.opexNote || "",
          };
        });

        const altTotals = {
          capacity: altTotalCapacityEl.textContent || "â€“",
          volume: altTotalVolumeEl.textContent || "â€“",
          capex: altTotalCapexEl.textContent || "â€“",
          opex: altTotalOpexEl.textContent || "â€“",
          saving: altTotalSavingEl.textContent || "â€“",
          netcf: altTotalNetCFEl.textContent || "â€“",
          npv: altTotalNPVEl.textContent || "â€“",
          bcr: altTotalBCREl.textContent || "â€“",
        };

        const financeSummary = {
          capex: sumCapexEl.textContent || "â€“",
          saving: sumSavingEl.textContent || "â€“",
          opex: sumOpexEl.textContent || "â€“",
          netcf: sumNetCFEl.textContent || "â€“",
          npv: sumNPVEl.textContent || "â€“",
          bcr: sumBCREl.textContent || "â€“",
          irr: sumIRREl.textContent || "â€“",
        };

        const capexOpexItems = Array.from(
          document.querySelectorAll("#capex-opex-body tr")
        )
          .map((tr) => ({
            type: tr.querySelector(".item-type")?.value || "",
            name: tr.querySelector(".item-name")?.value || "",
            qty: tr.querySelector(".item-qty")?.value || "",
            cost: tr.querySelector(".item-cost")?.value || "",
            total: tr.querySelector(".item-total")?.textContent || "",
            note: tr.querySelector(".item-note")?.value || "",
          }))
          .filter(
            (r) =>
              r.name.trim() ||
              parseNumberFromText(r.qty) > 0 ||
              parseNumberFromText(r.cost) > 0
          );

        const assumptions = {
          supply: supplyInput.value || "",
          tariffWater: tariffWaterInput.value || "",
          tariffSewer: tariffSewerInput.value || "",
          years: analysisYearsInput.value || "",
          discount: discountRateInput.value || "",
        };
        const quickInput = {
          pop: quickInputs.pop.value || "",
          percap: quickInputs.percap.value || "",
          demand: quickInputs.demand.value || "",
          peak: quickInputs.peak.value || "",
        };
        const financeComplete =
          normalizeNumber(tariffWaterInput.value) >= 0 &&
          normalizeNumber(tariffSewerInput.value) >= 0 &&
          normalizeNumber(analysisYearsInput.value) > 0 &&
          normalizeNumber(discountRateInput.value) >= 0;

        const scenariosForReport = Object.values(appState.scenarios || {}).map((s) => ({
          name: s.name,
          id: s.id,
          mode: s.mode,
          summary: s.outputs?.summary || {},
          finance: s.outputs?.finance || {},
        }));

        const sensitivity = {
          base: {
            npv: lastAltSummary.totalPVBenefits - lastAltSummary.totalPVCosts,
            bcr: lastAltSummary.totalPVCosts > 0 ? lastAltSummary.totalPVBenefits / lastAltSummary.totalPVCosts : NaN,
          },
          capex: {
            npv: lastAltSummary.totalPVBenefits - (lastAltSummary.pvCapex * 1.1 + lastAltSummary.pvOpex),
            bcr: lastAltSummary.pvCapex * 1.1 + lastAltSummary.pvOpex > 0
              ? lastAltSummary.totalPVBenefits / (lastAltSummary.pvCapex * 1.1 + lastAltSummary.pvOpex)
              : NaN,
          },
          opex: {
            npv: lastAltSummary.totalPVBenefits - (lastAltSummary.pvCapex + lastAltSummary.pvOpex * 1.1),
            bcr: lastAltSummary.pvCapex + lastAltSummary.pvOpex * 1.1 > 0
              ? lastAltSummary.totalPVBenefits / (lastAltSummary.pvCapex + lastAltSummary.pvOpex * 1.1)
              : NaN,
          },
          benefit: {
            npv: lastAltSummary.totalPVBenefits * 1.1 - lastAltSummary.totalPVCosts,
            bcr: lastAltSummary.totalPVCosts > 0
              ? (lastAltSummary.totalPVBenefits * 1.1) / lastAltSummary.totalPVCosts
              : NaN,
          },
        };

        const demandLabels = demandByCategory.map((d) => d.name);
        const demandAvgData = demandByCategory.map((d) => parseNumberFromText(d.avg));
        const demandPeakData = demandByCategory.map((d) => parseNumberFromText(d.peak));
        const charts = {};
        if (includeCharts) {
          charts.demandByCategory = buildBarChartImage({
            title: "Permintaan purata & puncak mengikut kategori",
            labels: demandLabels,
            datasets: [
              { label: "Purata (mÂ³/hari)", data: demandAvgData, backgroundColor: "rgba(13,110,253,0.8)" },
              { label: "Puncak (mÂ³/hari)", data: demandPeakData, backgroundColor: "rgba(0,188,212,0.8)" },
            ],
          });
          charts.demandShare = buildPieChartImage({
            title: "Agihan permintaan (%)",
            labels: demandLabels,
            data: demandAvgData,
          });
        }
        const cbaLabels = altSources.map((a) => a.name);
        const cbaNpvData = altSources.map((a) => parseNumberFromText(a.npv));
        const cbaPaybackData = altSources.map((a) => parseNumberFromText(a.payback));
        if (includeCharts) {
          charts.cbaNPV = buildBarChartImage({
            title: "NPV mengikut sumber alternatif",
            labels: cbaLabels,
            datasets: [
              { label: "NPV (RM)", data: cbaNpvData, backgroundColor: "rgba(3,169,244,0.8)" },
            ],
          });
          charts.cbaPayback = buildBarChartImage({
            title: "Tempoh pulangan modal mengikut sumber",
            labels: cbaLabels,
            datasets: [
              { label: "Payback (tahun)", data: cbaPaybackData, backgroundColor: "rgba(255,193,7,0.9)" },
            ],
          });
          charts.supplyDemand = buildSupplyDemandChartImage(summary);
          charts.altComposition = buildAltCompositionChartImage(lastAltSources);
        }

        const disclaimerText =
          "Laporan ini dijana secara automatik berdasarkan input semasa kalkulator. " +
          "Nilai kewangan dan teknikal adalah anggaran untuk tujuan perancangan awal " +
          "dan tertakluk kepada perubahan selepas audit data meter serta semakan " +
          "kejuruteraan terperinci.";

        return {
          generatedDate,
          fileDate,
          summary,
          categoryInputs,
          demandByCategory,
          altSources,
          altTotals,
          financeSummary,
          capexOpexItems,
          assumptions,
          mode: appState.mode,
          scenarioScope: pdfScopeSelect.value,
          reportLevel,
          preparedBy,
          activeScenarioName: activeScenario()?.name || "",
          activeScenarioId: activeScenario()?.id || appState.activeScenarioId || "A",
          scenariosForReport,
          sensitivity,
          charts,
          disclaimerText,
          logoDataUrl: umsLogoDataUrl,
          confidential: Boolean(confidentialToggle?.checked),
          includeCharts,
          financeComplete,
          demandMode: appState.demandMode,
          quickInput,
          mode: appState.mode,
        };
      }

      // BEGIN REPORT UPDATE
      function renderReportHTML(data) {
        const statusAvg = formatStatusLabel(data.summary.status.avg, false);
        const statusPeak = formatStatusLabel(data.summary.status.peak, true);
        const hasValue = (val) => {
          const cleaned = String(val || "").replace(/[^0-9.-]/g, "");
          if (!cleaned) return false;
          const num = parseFloat(cleaned);
          return isFinite(num);
        };

        const hasFinance =
          hasValue(data.financeSummary.npv) ||
          hasValue(data.financeSummary.bcr) ||
          hasValue(data.financeSummary.netcf);

        const demandRows = data.demandByCategory.length
          ? data.demandByCategory
              .map(
                (row) => `
                  <tr>
                    <td>${row.name}</td>
                    <td>${row.pop}</td>
                    <td>${row.percap}</td>
                    <td>${row.avg}</td>
                    <td>${row.peakFactor}</td>
                    <td>${row.peak}</td>
                  </tr>
                `
              )
              .join("")
          : `<tr><td colspan="6">Tiada data permintaan ditetapkan.</td></tr>`;

        const altRowsHtml = data.altSources.length
          ? data.altSources
              .map(
                (row) => `
                  <tr>
                    <td>${row.name}</td>
                    <td>${row.capacity}</td>
                    <td>${row.util}</td>
                    <td>${row.volume}</td>
                    <td>${row.capex}</td>
                    <td>${row.opex}</td>
                    <td>${row.saving}</td>
                    <td>${row.netcf}</td>
                    <td>${row.payback}</td>
                    <td>${row.npv}</td>
                    <td>${row.bcr}</td>
                  </tr>
                `
              )
              .join("")
          : `<tr><td colspan="11">Tiada sumber alternatif dimasukkan.</td></tr>`;

        const scenarioRows =
          data.scenarioScope === "all" && data.scenariosForReport.length
            ? data.scenariosForReport
                .map((s) => {
                  const sum = s.summary || {};
                  const fin = s.finance || {};
                  return `
                    <tr>
                      <td>${s.name} (${s.mode || "-"})</td>
                      <td>${formatNumber(sum.avgMLD)}</td>
                      <td>${formatNumber(sum.peakMLD)}</td>
                      <td>${formatNumber(sum.effectiveMLD)}</td>
                      <td>${formatNumber(sum.surplusAvg)}</td>
                      <td>${formatNumber(fin.npv)}</td>
                      <td>${isFinite(fin.bcr) ? formatNumber(fin.bcr) : "â€“"}</td>
                      <td>${isFinite(fin.irr) ? formatNumber(fin.irr) : "â€“"}</td>
                      <td>${isFinite(fin.payback) ? formatNumber(fin.payback) : "â€“"}</td>
                    </tr>
                  `;
                })
                .join("")
            : "";

        const capexOpexRows = data.capexOpexItems.length
          ? data.capexOpexItems
              .map(
                (item) => `
                  <tr>
                    <td>${item.type}</td>
                    <td>${item.name}</td>
                    <td>${item.qty}</td>
                    <td>${item.cost}</td>
                    <td>${item.total}</td>
                    <td>${item.note || "-"}</td>
                  </tr>
                `
              )
              .join("")
          : `<tr><td colspan="6">Belum ada pecahan CAPEX/OPEX item dimasukkan.</td></tr>`;

        const footerLabel = data.confidential
          ? "Sulit/Untuk Kegunaan Dalaman"
          : "&nbsp;";

        const cover = `
          <section class="report-page cover" id="cover">
            <div class="logo-box">
              ${
                data.logoDataUrl
                  ? `<img src="${data.logoDataUrl}" alt="Logo Universiti Malaysia Sabah" />`
                  : `<div>UMS</div>`
              }
            </div>
            <div>
              <div class="kicker" style="color:#0c2d57;">Kalkulator Permintaan &amp; Bekalan Air</div>
              <h1>LAPORAN ANALISIS PERMINTAAN &amp; BEKALAN AIR UMS</h1>
              <p class="meta">Senario: ${data.activeScenarioName || "Senario aktif"} (${data.activeScenarioId || "A"}) | Mod: ${data.mode}</p>
              <p class="meta">Tarikh & masa jana: ${data.generatedDate}</p>
              <p class="meta">Versi kalkulator: v${SCHEMA_VERSION}</p>
              <p class="meta">Tahap laporan: ${data.reportLevel === "penuh" ? "Penuh (Teknikal + Lampiran)" : "Ringkas (Top Mgmt)"}</p>
              <p class="meta">Disediakan oleh: ${data.preparedBy || "Auto-jana Kalkulator Permintaan & Bekalan Air UMS"}</p>
              <p class="tagline">Untuk semakan pengurusan, penentuan strategi bekalan & peruntukan bajet.</p>
            </div>
          </section>
        `;

        const pageShell = (id, title, subtitle, body) => `
          <section class="report-page" id="${id}">
            <div class="page-header">
              <span style="font-weight:700;">Laporan Permintaan &amp; Bekalan Air UMS</span>
              <span>Senario ${data.activeScenarioName || data.activeScenarioId || "Aktif"}</span>
              <span>${data.generatedDate}</span>
              <span class="page-number"></span>
            </div>
            <div class="section-block">
              <p class="section-tagline">${title}</p>
              ${subtitle ? `<h2 class="section-title">${subtitle}</h2>` : ""}
              ${body}
            </div>
            <div class="page-footer">
              <span>${footerLabel}</span>
              <span>Laporan Air UMS â€“ ${data.generatedDate}</span>
              <span class="page-number"></span>
            </div>
          </section>
        `;

        const tocPage = pageShell(
          "toc",
          "Kandungan",
          "Table of Contents",
          `
            <div class="toc-box">
              <p class="mini">Senarai kandungan (halaman)</p>
              <ul class="toc-list">
                <li><span class="label">Ringkasan Eksekutif</span><span class="page" data-page-ref="exec-summary"></span></li>
                <li><span class="label">Metodologi & Andaian</span><span class="page" data-page-ref="method"></span></li>
                <li><span class="label">Analisis Permintaan & Bekalan</span><span class="page" data-page-ref="results"></span></li>
                <li><span class="label">Analisis Kewangan</span><span class="page" data-page-ref="finance"></span></li>
                <li><span class="label">Perbandingan Senario</span><span class="page" data-page-ref="scenario-compare"></span></li>
                <li><span class="label">Graf & Visual</span><span class="page" data-page-ref="visuals"></span></li>
                <li><span class="label">Cadangan & Tindakan</span><span class="page" data-page-ref="recommendations"></span></li>
                <li><span class="label">Lampiran</span><span class="page" data-page-ref="appendix"></span></li>
              </ul>
            </div>
          `
        );

        const execSummary = pageShell(
          "exec-summary",
          "Ringkasan Eksekutif",
          "Sorotan 1 halaman",
          `
            <p class="justified">
              Objektif: menilai jurang permintaanâ€“bekalan air kampus dan pilihan alternatif untuk menutup defisit.
              Permintaan purata <strong>${data.summary.text.avg} MLD</strong>, puncak <strong>${data.summary.text.peak} MLD</strong>.
              Bekalan asas (JANS) <strong>${data.summary.text.supply} MLD</strong>; sumber alternatif <strong>${data.summary.text.alt} MLD</strong>; bekalan efektif <strong>${data.summary.text.effective} MLD</strong>.
              Status: <strong>${statusAvg}</strong> (purata) dan <strong>${statusPeak}</strong> (puncak).
              Skop laporan: ${data.scenarioScope === "all" ? "Semua senario (Aâ€“C)" : "Senario terpilih"} | Tahap: ${data.reportLevel === "penuh" ? "Penuh" : "Ringkas"}.
            </p>
            <div class="page-grid">
              <div class="page-card">
                <h4>Jurang bekalan</h4>
                <p class="justified">Surplus/defisit purata: ${data.summary.text.surplusAvg}; puncak: ${data.summary.text.surplusPeak}. Fokus segera pada hari puncak jika defisit.</p>
              </div>
              <div class="page-card">
                <h4>Sorotan kewangan</h4>
                <p class="justified">
                  ${hasFinance ? `CAPEX: ${data.financeSummary.capex}; OPEX: ${data.financeSummary.opex}; Penjimatan: ${data.financeSummary.saving}; NPV: ${data.financeSummary.npv}; BCR: ${data.financeSummary.bcr}; IRR: ${data.financeSummary.irr}.`
                  : "Analisis kewangan tidak dijana kerana CAPEX/OPEX/tarif tidak lengkap."}
                </p>
              </div>
            </div>
            <div class="page-card">
              <h4>Cadangan cepat</h4>
              <ul class="list-tight">
              <li>Pastikan faktor puncak dalam julat 1.2â€“1.5 dan kemas kini permintaan mengikut kategori utama.</li>
              <li>Utamakan sumber alternatif dengan payback terpendek dan BCR tertinggi.</li>
              <li>Benamkan keputusan ke dalam bajet tahunan dan pelan kesinambungan operasi.</li>
            </ul>
            </div>
            ${data.financeComplete ? "" : `<p class="wizard-warning">Analisis kewangan tidak dijana kerana input tarif/tempoh/diskaun/CAPEX/OPEX tidak lengkap.</p>`}
          `
        );

        const methodology = pageShell(
          "method",
          "INPUT & Andaian",
          "Langkah INPUT sebelum OUTPUT",
          `
            <p class="justified"><strong>Langkah 1 â€“ Permintaan:</strong> Kaedah digunakan: ${data.demandMode === "quick" ? "Permintaan Quick (ringkas)" : "Permintaan Mengikut Kategori (terperinci)"}.</p>
            ${
              data.demandMode === "quick"
                ? `
                  <div class="inline-table">
                    <div class="box"><div class="label">Populasi</div><div>${data.quickInput.pop || "â€“"} orang</div></div>
                    <div class="box"><div class="label">Per kapita</div><div>${data.quickInput.percap || "â€“"} L/org/hari</div></div>
                    <div class="box"><div class="label">Jumlah permintaan (override)</div><div>${data.quickInput.demand || "Tidak diisi"} mÂ³/hari</div></div>
                    <div class="box"><div class="label">Faktor puncak</div><div>${data.quickInput.peak || "â€“"}</div></div>
                  </div>
                `
                : `
                  <p class="justified">Ringkasan kategori digunakan:</p>
                  <table class="report-table zebra">
                    <thead><tr><th>Kategori</th><th>Populasi</th><th>Per kapita</th><th>Purata (mÂ³/hari)</th><th>Faktor puncak</th><th>Puncak (mÂ³/hari)</th></tr></thead>
                    <tbody>${demandRows}</tbody>
                  </table>
                `
            }
            <p class="justified"><strong>Langkah 2 â€“ Bekalan Asas (WAJIB):</strong> ${data.assumptions.supply || "â€“"} MLD.</p>
            <p class="justified"><strong>Langkah 3 â€“ Parameter Kewangan:</strong> Tarif air ${data.assumptions.tariffWater || "â€“"} RM/mÂ³; pembetungan ${data.assumptions.tariffSewer || "â€“"} RM/mÂ³; tempoh ${data.assumptions.years || "â€“"} tahun; diskaun ${data.assumptions.discount || "â€“"}%.</p>
            <p class="justified"><strong>Langkah 4 â€“ Sumber Alternatif (Pilihan):</strong> ${data.altSources.length ? "Sumber disenaraikan di bahagian OUTPUT." : "Tiada sumber alternatif dimasukkan."}</p>
            <p class="justified"><strong>Langkah 5 â€“ CAPEX/OPEX Terperinci (Pilihan):</strong> ${data.capexOpexItems.length ? "Pecahan item disertakan di Lampiran." : "Tiada pecahan item dimasukkan."}</p>
            <p class="justified">Unit: mÂ³/hari, MLD, RM. Permintaan puncak = purata Ã— faktor puncak. Bekalan alternatif = kapasiti Ã— utiliti (% hari) Ã— kebolehpercayaan (%).</p>
            <p class="justified">Kewangan: penjimatan = volum alternatif Ã— (tarif air + pembetungan). NPV/BCR menggunakan kadar diskaun dan tempoh analisis. Payback = CAPEX / aliran tunai bersih tahunan.</p>
            <div class="inline-table">
              <div class="box"><div class="label">Bekalan asas (JANS)</div><div><strong>${data.assumptions.supply || "â€“"} MLD</strong></div></div>
              <div class="box"><div class="label">Tarif air (RM/mÂ³)</div><div>${data.assumptions.tariffWater || "â€“"}</div></div>
              <div class="box"><div class="label">Tarif pembetungan (RM/mÂ³)</div><div>${data.assumptions.tariffSewer || "â€“"}</div></div>
              <div class="box"><div class="label">Tempoh analisis (tahun)</div><div>${data.assumptions.years || "â€“"}</div></div>
              <div class="box"><div class="label">Kadar diskaun (%)</div><div>${data.assumptions.discount || "â€“"}</div></div>
            </div>
            <p class="wizard-helper">Nota: Nilai di atas diambil terus daripada input kalkulator semasa laporan dijana.</p>
          `
        );

        const demandSupply = pageShell(
          "results",
          "Analisis Permintaan & Bekalan",
          "Permintaan purata/puncak, bekalan efektif",
          `
            <table class="report-table zebra wide-table">
              <thead><tr><th>Item</th><th>Nilai</th><th>Status</th></tr></thead>
              <tbody>
                <tr><td>Permintaan purata</td><td>${data.summary.text.avg}</td><td>${statusAvg}</td></tr>
                <tr><td>Permintaan puncak</td><td>${data.summary.text.peak}</td><td>${statusPeak}</td></tr>
                <tr><td>Bekalan sedia ada (JANS)</td><td>${data.summary.text.supply}</td><td>â€”</td></tr>
                <tr><td>Bekalan sumber alternatif</td><td>${data.summary.text.alt}</td><td>â€”</td></tr>
                <tr><td>Bekalan efektif</td><td>${data.summary.text.effective}</td><td>â€”</td></tr>
                <tr><td>Lebihan / Defisit purata</td><td>${data.summary.text.surplusAvg}</td><td>â€”</td></tr>
                <tr><td>Lebihan / Defisit puncak</td><td>${data.summary.text.surplusPeak}</td><td>â€”</td></tr>
              </tbody>
            </table>
            <p class="justified">Jadual permintaan mengikut kategori (jika dimasukkan):</p>
            <table class="report-table zebra wide-table">
              <thead>
                <tr>
                  <th>Kategori</th><th>Populasi</th><th>Per kapita (L/org/hari)</th><th>Purata (mÂ³/hari)</th><th>Faktor puncak</th><th>Permintaan puncak (mÂ³/hari)</th>
                </tr>
              </thead>
              <tbody>${demandRows}</tbody>
            </table>
            <p class="justified">Sumber alternatif:</p>
            <table class="report-table zebra wide-table">
              <thead>
                <tr><th>Sumber</th><th>Kapasiti (mÂ³/hari)</th><th>Utilisasi (% hari)</th><th>Vol. tahunan (mÂ³/tahun)</th><th>CAPEX (RM)</th><th>OPEX (RM/tahun)</th><th>Saving (RM/tahun)</th><th>CF bersih (RM/tahun)</th><th>Payback (tahun)</th><th>NPV (RM)</th><th>BCR</th></tr>
              </thead>
              <tbody>${altRowsHtml}</tbody>
              <tfoot>
                <tr>
                  <td>Jumlah / Agregat</td>
                  <td>${data.altTotals.capacity}</td>
                  <td>â€”</td>
                  <td>${data.altTotals.volume}</td>
                  <td>${data.altTotals.capex}</td>
                  <td>${data.altTotals.opex}</td>
                  <td>${data.altTotals.saving}</td>
                  <td>${data.altTotals.netcf}</td>
                  <td>â€”</td>
                  <td>${data.altTotals.npv}</td>
                  <td>${data.altTotals.bcr}</td>
                </tr>
              </tfoot>
            </table>
            <p class="page-note">Nota: Nilai payback/NPV/BCR hanya dipaparkan jika CAPEX/OPEX dan tarif diisi.</p>
          `
        );

        const financeSection = pageShell(
          "finance",
          "Analisis Kewangan",
          "Sorotan NPV/BCR/IRR/Payback",
          `
            ${
              hasFinance && data.financeComplete
                ? `
                  <div class="inline-table">
                    <div class="box"><div class="label">CAPEX</div><div>${data.financeSummary.capex}</div></div>
                    <div class="box"><div class="label">OPEX tahunan</div><div>${data.financeSummary.opex}</div></div>
                    <div class="box"><div class="label">Penjimatan tahunan</div><div>${data.financeSummary.saving}</div></div>
                    <div class="box"><div class="label">Aliran tunai bersih</div><div>${data.financeSummary.netcf}</div></div>
                    <div class="box"><div class="label">NPV</div><div>${data.financeSummary.npv}</div></div>
                    <div class="box"><div class="label">BCR</div><div>${data.financeSummary.bcr}</div></div>
                    <div class="box"><div class="label">IRR anggaran</div><div>${data.financeSummary.irr}</div></div>
                  </div>
                  <p class="justified"><strong>Interpretasi:</strong> NPV positif dan BCR > 1 menunjukkan projek wajar diteruskan. Payback pendek sesuai untuk keputusan pantas.</p>
                `
                : `<p class="wizard-warning">Analisis kewangan tidak dijana kerana CAPEX/OPEX/tarif tidak lengkap.</p>`
            }
            <p class="justified"><strong>Assumptions used:</strong> Faktor puncak, tarif air/pembetungan, kadar diskaun ${data.assumptions.discount || "-"}%, tempoh ${data.assumptions.years || "-"} tahun, serta faktor utiliti sumber alternatif semasa laporan dijana.</p>
            <p class="page-note">Data & Limitations: Keputusan bergantung pada ketepatan input (populasi, per kapita, tarif, CAPEX/OPEX, utiliti sumber alternatif). Sahkan dengan rekod meter, kontrak kos, dan audit teknikal sebelum keputusan akhir.</p>
          `
        );

        const scenarioCompare = data.scenarioScope === "all" && scenarioRows
          ? pageShell(
              "scenario-compare",
              "Perbandingan Senario Aâ€“C",
              "Bandingan KPI utama",
              `
                <p class="justified">Jadual berikut memaparkan permintaan, bekalan dan KPI kewangan bagi setiap senario yang disimpan.</p>
                <table class="report-table zebra wide-table">
                  <thead>
                    <tr>
                      <th>Senario</th><th>Permintaan purata (MLD)</th><th>Permintaan puncak (MLD)</th><th>Bekalan efektif (MLD)</th><th>Lebihan/Defisit purata</th><th>NPV (RM)</th><th>BCR</th><th>IRR (%)</th><th>Payback (tahun)</th>
                    </tr>
                  </thead>
                  <tbody>${scenarioRows}</tbody>
                </table>
                <p class="justified">Peraturan pantas: pilih senario yang memenuhi permintaan puncak dengan BCR tertinggi/NPV tertinggi. Jika tiada yang positif, pertimbangkan fasa pelaksanaan atau pelarasan kos.</p>
              `
            )
          : "";

        const visualsPage = data.includeCharts ? pageShell(
          "visuals",
          "Graf & Visual",
          "Paparan sokongan dengan interpretasi",
          `
            ${data.charts.supplyDemand ? `<div class="captioned-image"><img src="${data.charts.supplyDemand}" alt="Permintaan vs bekalan" /><div class="caption">Rajah 1: Permintaan purata & puncak berbanding bekalan efektif.</div><p class="justified"><strong>Apa yang ditunjukkan:</strong> Permintaan purata/puncak melawan bekalan JANS + alternatif. <strong>Implikasi keputusan:</strong> Jika bar permintaan puncak melebihi bekalan, fokuskan mitigasi puncak (stor/incremental supply). <strong>Tindakan dicadangkan:</strong> Semak bekalan asas, tambah sumber alternatif atau pelarasan faktor puncak.</p></div>` : ""}
            ${data.charts.altComposition ? `<div class="captioned-image"><img src="${data.charts.altComposition}" alt="Komposisi sumber alternatif" /><div class="caption">Rajah 2: Komposisi bekalan berkesan sumber alternatif.</div><p class="justified"><strong>Apa yang ditunjukkan:</strong> Sumbangan setiap sumber alternatif (mÂ³/hari berkesan). <strong>Implikasi keputusan:</strong> Sumber dominan perlu dijamin kebolehpercayaan utiliti. <strong>Tindakan dicadangkan:</strong> Laksanakan penyelenggaraan/penguatan sumber teratas dan rancang diversifikasi.</p></div>` : ""}
            ${data.charts.demandByCategory ? `<div class="captioned-image"><img src="${data.charts.demandByCategory}" alt="Permintaan mengikut kategori" /><div class="caption">Rajah 3: Permintaan purata dan puncak mengikut kategori.</div><p class="justified"><strong>Apa yang ditunjukkan:</strong> Keperluan air kategori utama (asrama, fakulti, dsb.). <strong>Implikasi keputusan:</strong> Kategori tertinggi memacu defisit; keutamaan audit kebocoran/kecekapan di sana. <strong>Tindakan dicadangkan:</strong> Meter sub-zon, kempen jimat air kategori tinggi.</p></div>` : ""}
            ${data.charts.demandShare ? `<div class="captioned-image"><img src="${data.charts.demandShare}" alt="Agihan permintaan" /><div class="caption">Rajah 4: Agihan permintaan (%) mengikut kategori.</div><p class="justified"><strong>Apa yang ditunjukkan:</strong> Peratusan sumbangan kategori kepada keseluruhan permintaan. <strong>Implikasi keputusan:</strong> Kecekapan pada kategori dominan memberi impak terbesar. <strong>Tindakan dicadangkan:</strong> Sasarkan program kecekapan/penukaran peralatan di kategori >20% sumbangan.</p></div>` : ""}
            ${data.charts.cbaNPV ? `<div class="captioned-image"><img src="${data.charts.cbaNPV}" alt="NPV sumber alternatif" /><div class="caption">Rajah 5: NPV mengikut sumber alternatif.</div><p class="justified"><strong>Apa yang ditunjukkan:</strong> Nilai kini bersih setiap pilihan. <strong>Implikasi keputusan:</strong> Pilihan NPV tertinggi patut didahulukan; NPV negatif perlukan penstrukturan semula kos/faedah. <strong>Tindakan dicadangkan:</strong> Semak andaian CAPEX/OPEX, laksana fasa untuk pilihan hampir neutral.</p></div>` : ""}
            ${data.charts.cbaPayback ? `<div class="captioned-image"><img src="${data.charts.cbaPayback}" alt="Pulangan modal sumber alternatif" /><div class="caption">Rajah 6: Tempoh pulangan modal mengikut sumber alternatif.</div><p class="justified"><strong>Apa yang ditunjukkan:</strong> Tahun pulangan modal bagi setiap sumber. <strong>Implikasi keputusan:</strong> Payback pendek sesuai untuk keputusan segera/pembiayaan dalaman. <strong>Tindakan dicadangkan:</strong> Pilih sumber payback &lt;5 tahun untuk fasa 1; simpan yang lebih panjang sebagai fasa kemudian.</p></div>` : ""}
            <p class="page-note">Graf diambil daripada kanvas luar skrin (900â€“1100px) dengan padding, memastikan tiada pie/bar terpotong dalam PDF.</p>
          `
        ) : "";

        const recommendations = pageShell(
          "recommendations",
          "Cadangan & Tindakan",
          "Untuk kelulusan pengurusan",
          `
            <div class="page-grid">
              <div class="page-card">
                <h4>Perlu lulus</h4>
                <ul class="list-tight">
                  <li>Peruntukan untuk sumber alternatif berpayback &lt; 5 tahun.</li>
                  <li>Pemasangan meter sub-zon bagi memantau faktor puncak sebenar.</li>
                  <li>Penyelarasan tarif/andaian kewangan setiap 12 bulan.</li>
                </ul>
              </div>
              <div class="page-card">
                <h4>Perlu kaji lanjut</h4>
                <ul class="list-tight">
                  <li>Analisis kesan variasi hujan terhadap bekalan alternatif.</li>
                <li>Pilihan reuse air kelabu/tasik jika defisit puncak kekal.</li>
                  <li>Strategi pembiayaan berfasa sekiranya NPV negatif.</li>
                </ul>
              </div>
              <div class="page-card">
                <h4>Data tambahan</h4>
                <ul class="list-tight">
                  <li>Data meter terkini mengikut blok/asrama.</li>
                  <li>Kos OPEX sebenar (penyelenggaraan, tenaga, kimia).</li>
                  <li>Profil beban harian untuk menala faktor puncak.</li>
                </ul>
              </div>
            </div>
            <p class="justified">Keutamaan: tutup defisit puncak, pastikan bekalan berdaya tahan dan aliran tunai positif. Gunakan lampiran untuk semakan teknikal terperinci.</p>
          `
        );

        const appendix =
          data.reportLevel === "penuh"
            ? pageShell(
                "appendix",
                "Lampiran & Had Data",
                "Butiran teknikal",
                `
                  ${
                    data.mode === "full" && data.financeComplete
                      ? `
                        <p class="justified"><strong>Analisis sensitiviti (+/âˆ’10%):</strong></p>
                        <table class="report-table zebra">
                          <thead><tr><th>Senario sensitiviti</th><th>NPV (RM)</th><th>BCR</th></tr></thead>
                          <tbody>
                            <tr><td>Asas</td><td>${formatNumber(data.sensitivity.base.npv)}</td><td>${isFinite(data.sensitivity.base.bcr) ? formatNumber(data.sensitivity.base.bcr) : "â€“"}</td></tr>
                            <tr><td>CAPEX +10%</td><td>${formatNumber(data.sensitivity.capex.npv)}</td><td>${isFinite(data.sensitivity.capex.bcr) ? formatNumber(data.sensitivity.capex.bcr) : "â€“"}</td></tr>
                            <tr><td>OPEX +10%</td><td>${formatNumber(data.sensitivity.opex.npv)}</td><td>${isFinite(data.sensitivity.opex.bcr) ? formatNumber(data.sensitivity.opex.bcr) : "â€“"}</td></tr>
                            <tr><td>Manfaat +10%</td><td>${formatNumber(data.sensitivity.benefit.npv)}</td><td>${isFinite(data.sensitivity.benefit.bcr) ? formatNumber(data.sensitivity.benefit.bcr) : "â€“"}</td></tr>
                          </tbody>
                        </table>
                      `
                      : `<p class="wizard-helper">Analisis sensitiviti hanya dipaparkan untuk Mod Full CBA dengan input kewangan lengkap.</p>`
                  }
                  <p class="justified">Pecahan CAPEX/OPEX item:</p>
                  <table class="report-table zebra">
                    <thead><tr><th>Jenis</th><th>Item / Komponen</th><th>Kuantiti</th><th>Kos seunit (RM)</th><th>Jumlah kos (RM)</th><th>Catatan</th></tr></thead>
                    <tbody>${capexOpexRows}</tbody>
                  </table>
                  <p class="justified"><strong>Had & Penafian:</strong> ${data.disclaimerText} Hasil bergantung pada faktor puncak, tarif, kadar diskaun, utiliti sumber alternatif, serta data CAPEX/OPEX yang dimasukkan.</p>
                  <p class="wizard-helper">Data & Limitations: nilai bergantung pada andaian semasa; kemas kini data meter, kos sebenar dan kadar penggunaan akan mengubah keputusan.</p>
                `
              )
            : "";

        return [
          cover,
          tocPage,
          execSummary,
          methodology,
          demandSupply,
          financeSection,
          scenarioCompare,
          visualsPage,
          recommendations,
          appendix,
        ].filter(Boolean).join("");
      }

      function applyPageNumbers(container) {
        const pages = Array.from(container.querySelectorAll(".report-page"));
        const total = pages.length;
        pages.forEach((page, idx) => {
          const numEl = page.querySelector(".page-number");
          if (numEl) {
            numEl.textContent = `Halaman ${idx + 1} daripada ${total}`;
          }
        });
        const tocRefs = container.querySelectorAll("[data-page-ref]");
        tocRefs.forEach((el) => {
          const target = el.getAttribute("data-page-ref");
          const pageIdx = pages.findIndex((p) => p.id === target);
          el.textContent = pageIdx >= 0 ? pageIdx + 1 : "â€“";
        });
      }

      async function generateReportPDF() {
        const { jsPDF } = window.jspdf || {};
        if (!jsPDF) {
          alert("Library jsPDF tidak dimuatkan.");
          return;
        }
        if (!hasCalculated) {
          const proceed = confirm("Sila tekan KIRA SEKARANG terlebih dahulu untuk jana laporan.\nPilih OK untuk Kira & Jana Laporan, atau Batal untuk kembali.");
          if (!proceed) return;
          const ok = runCalculation({ scroll: false });
          if (!ok) return;
        }

        await loadUmsLogoDataUrl();
        const data = await collectReportData();
        const doc = new jsPDF({
          unit: "mm",
          format: "a4",
          orientation: "portrait",
          compress: true,
        });

        const margin = 18;
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const usableWidth = pageWidth - margin * 2;
        const bottomLimit = pageHeight - margin;
        const scenarioLabel = data.activeScenarioName || `Senario ${data.activeScenarioId || "Aktif"}`;
        const headerText = `Laporan Permintaan & Bekalan Air UMS | ${scenarioLabel} | ${data.generatedDate}`;
        const tocEntries = [];
        let cursorY = margin;

        const addHeaderFooter = () => {
          const total = doc.getNumberOfPages();
          for (let i = 1; i <= total; i += 1) {
            doc.setPage(i);
            const isCover = i === 1;
            doc.setFontSize(9);
            doc.setTextColor(isCover ? 255 : 60);
            if (!isCover) {
              doc.text(headerText, margin, 12, { maxWidth: usableWidth });
            }
            doc.text(`Halaman ${i} daripada ${total}`, pageWidth - margin, pageHeight - 10, { align: "right" });
          }
        };

        const ensureSpace = (height = 12) => {
          if (cursorY + height > bottomLimit) {
            doc.addPage();
            cursorY = margin;
          }
        };

        const addTitle = (title, subtitle) => {
          ensureSpace(20);
          const pageNumber = doc.getNumberOfPages();
          tocEntries.push({ title, page: pageNumber });
          doc.setFontSize(16);
          doc.setTextColor(18, 78, 118);
          doc.text(title, margin, cursorY);
          cursorY += 7;
          if (subtitle) {
            doc.setFontSize(11);
            doc.setTextColor(60, 90, 110);
            doc.text(subtitle, margin, cursorY);
            cursorY += 7;
          }
          doc.setDrawColor(12, 142, 217);
          doc.setLineWidth(0.4);
          doc.line(margin, cursorY, margin + 36, cursorY);
          cursorY += 6;
          doc.setTextColor(30, 50, 70);
        };

        const addParagraphs = (
          paragraphs = [],
          { fontSize = 10.5, lineHeight = 5.2, color = [32, 50, 70], bullet = false } = {}
        ) => {
          doc.setFontSize(fontSize);
          doc.setTextColor(...color);
          paragraphs.forEach((p) => {
            if (!p) return;
            const text = bullet ? `â€¢ ${p}` : p;
            const lines = doc.splitTextToSize(text, usableWidth);
            const height = lines.length * lineHeight + 1.5;
            ensureSpace(height);
            doc.text(lines, margin, cursorY, { maxWidth: usableWidth });
            cursorY += height;
          });
          doc.setTextColor(30, 50, 70);
        };

        const addBand = () => {
          doc.setFillColor(12, 142, 217);
          doc.rect(0, 0, pageWidth, 32, "F");
          doc.setFillColor(230, 244, 255);
          doc.rect(0, 32, pageWidth, 14, "F");
        };

        const addChartImage = (title, img, caption, notes = []) => {
          if (!img) return;
          const props = doc.getImageProperties(img);
          const maxWidth = usableWidth;
          const maxHeight = bottomLimit - cursorY - 20;
          const safeMaxHeight = Math.max(maxHeight, 24);
          const scale = Math.min(maxWidth / props.width, safeMaxHeight / props.height, 1);
          const finalW = props.width * scale;
          const finalH = props.height * scale;
          ensureSpace(finalH + 18);
          doc.setFontSize(12);
          doc.setTextColor(25, 70, 110);
          doc.text(title, margin, cursorY);
          cursorY += 5;
          doc.addImage(img, "JPEG", margin, cursorY, finalW, finalH, undefined, "FAST");
          cursorY += finalH + 4;
          if (caption) addParagraphs([caption], { fontSize: 9.5, lineHeight: 4.8 });
          if (notes?.length) addParagraphs(notes, { fontSize: 9.5, lineHeight: 4.8 });
        };

        const renderTOC = (tocPage) => {
          doc.setPage(tocPage);
          doc.setFontSize(16);
          doc.setTextColor(18, 78, 118);
          doc.text("Kandungan", margin, margin);
          doc.setFontSize(10.5);
          doc.setTextColor(30, 50, 70);
          let y = margin + 10;
          tocEntries.forEach((entry, idx) => {
            const pageStr = String(entry.page);
            const label = `${idx + 1}. ${entry.title}`;
            const titleWidth = doc.getTextWidth(label);
            const pageWidthTxt = doc.getTextWidth(pageStr);
            const dotWidth = doc.getTextWidth(".");
            const maxDots = Math.max(2, Math.floor((usableWidth - titleWidth - pageWidthTxt - 6) / dotWidth));
            const dotStr = ".".repeat(maxDots);
            doc.text(label, margin, y, { maxWidth: usableWidth - 24 });
            doc.text(dotStr, margin + Math.min(titleWidth, usableWidth - 28) + 2, y);
            doc.text(pageStr, pageWidth - margin, y, { align: "right" });
            y += 7;
            if (y > bottomLimit) {
              doc.addPage();
              doc.setPage(doc.getNumberOfPages());
              y = margin + 4;
            }
          });
        };

        const financeValue = (val) => {
          const num = parseNumberFromText(val);
          if (!data.financeComplete) return "N/A (input belum diisi)";
          if (!isFinite(num)) return val || "N/A (input belum diisi)";
          if (Math.abs(num) < 0.000001) return "N/A (input belum diisi)";
          return val || "â€“";
        };

        // COVER
        addBand();
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(22);
        doc.text("Laporan Permintaan & Bekalan Air UMS", margin, 18);
        doc.setFontSize(13);
        doc.text(`Senario: ${scenarioLabel}`, margin, 26);
        doc.text(`Tarikh: ${data.generatedDate}`, margin, 32);
        if (umsLogoDataUrl) {
          doc.addImage(umsLogoDataUrl, "PNG", pageWidth - margin - 26, 10, 22, 22, undefined, "FAST");
        }
        doc.setTextColor(18, 50, 80);
        doc.setFontSize(12);
        cursorY = 50;
        const coverBullets = [
          `Permintaan purata: ${data.summary.text.avg || "â€“"} | Bekalan efektif: ${data.summary.text.effective || "â€“"}`,
          `Lebihan/Defisit purata: ${data.summary.text.surplusAvg || "â€“"} | Puncak: ${data.summary.text.surplusPeak || "â€“"}`,
          `Sorotan kewangan: BCR ${data.financeSummary?.bcr || "â€“"}, NPV ${data.financeSummary?.npv || "â€“"}, Payback ${data.financeSummary?.payback || "N/A"}`,
        ];
        addParagraphs([
          "Laporan rasmi ini diringkaskan untuk pengurusan tertinggi dengan fokus pada keseimbangan permintaanâ€“bekalan, kesan sumber alternatif dan kebolehlaksanaan kewangan.",
          `Skop: ${data.scenarioScope === "all" ? "Semua senario Aâ€“C" : "Senario terpilih"} Â· Tahap: ${data.reportLevel} Â· Disediakan oleh: ${data.preparedBy || "Auto-jana Kalkulator UMS"}.`,
        ]);
        addParagraphs(coverBullets, { bullet: true, fontSize: 11, lineHeight: 5.4, color: [26, 62, 98] });

        // TOC placeholder
        doc.addPage();
        const tocPage = doc.getNumberOfPages();
        cursorY = margin;

        // EXEC SUMMARY
        doc.addPage();
        cursorY = margin;
        addTitle("Ringkasan Eksekutif", "Status permintaan, bekalan & risiko");
        addParagraphs([
          "Bahagian ini merumuskan kedudukan permintaan purata dan puncak berbanding bekalan efektif (JANS + sumber alternatif). Nilai dibentangkan dalam KPI yang boleh terus digunakan sebagai bahan mesyuarat pengurusan.",
          "Penilaian dibuat terhadap margin keselamatan operasi harian, keupayaan menghadapi puncak semester dan kesan segera kepada perkhidmatan. Gabungan bekalan alternatif yang tidak stabil akan ditandakan supaya tindakan mitigasi boleh dirancang.",
          "Sekiranya defisit muncul, risiko operasi termasuk gangguan bekalan, penurunan tekanan dan peningkatan aduan pelanggan. Defisit puncak juga menandakan keperluan storan atau penjadualan beban untuk mengelak kejutan permintaan.",
          "Bagi kes yang menunjukkan lebihan, analisis ini tetap menekankan penjajaran dengan sasaran kebolehpercayaan dan penyenggaraan sumber alternatif supaya lebihan kekal konsisten sepanjang tahun.",
          "Cadangan tindakan segera dinyatakan dalam seksyen cadangan; pengurus boleh menggunakan KPI di bawah sebagai senarai semak pantas sebelum meluluskan intervensi atau pembiayaan tambahan.",
        ]);
        doc.autoTable({
          startY: cursorY,
          margin: { left: margin, right: margin },
          tableWidth: usableWidth,
          theme: "grid",
          styles: { fontSize: 9.5, overflow: "linebreak", cellPadding: 2.2 },
          headStyles: { fillColor: [12, 142, 217], textColor: 255 },
          bodyStyles: { cellWidth: "wrap" },
          head: [["Item", "Nilai", "Status / Catatan"]],
          body: [
            ["Permintaan purata (MLD)", data.summary.text.avg, data.summary.status.avg || "â€“"],
            ["Permintaan puncak (MLD)", data.summary.text.peak, data.summary.status.peak || "â€“"],
            ["Bekalan efektif (MLD)", data.summary.text.effective, "Termasuk sumber alternatif"],
            ["Lebihan/Defisit purata", data.summary.text.surplusAvg, "\u2265 0 bermakna margin harian memadai"],
            ["Lebihan/Defisit puncak", data.summary.text.surplusPeak, "\u2265 0 bermakna mampu tampung puncak"],
          ],
        });
        cursorY = doc.lastAutoTable.finalY + 6;

        // INPUT & ANDAIAN
        addTitle("Input & Andaian Utama", "Ringkasan Langkah 1â€“3");
        addParagraphs([
          "Permintaan dibina daripada mod Quick atau Kategori. Populasi, kadar per kapita dan faktor puncak diterjemahkan terus kepada permintaan purata dan puncak yang digunakan dalam semua graf dan jadual.",
          "Bekalan asas JANS dan utiliti sumber alternatif menentukan bekalan efektif. Parameter ini penting untuk menguji margin keselamatan, terutama apabila puncak semester atau acara besar berlaku serentak.",
          "Tarif air/pembetungan, tempoh analisis dan kadar diskaun menentukan kepekaan NPV/BCR. Jika mana-mana input kewangan kosong, nilai kewangan dalam jadual akan dipaparkan sebagai N/A supaya pembaca tidak tersalah tafsir angka kosong sebagai sifar.",
        ]);
        doc.autoTable({
          startY: cursorY,
          margin: { left: margin, right: margin },
          tableWidth: usableWidth,
          theme: "plain",
          styles: { fontSize: 9.5, overflow: "linebreak", cellPadding: 2 },
          columnStyles: {
            0: { cellWidth: 55 },
            1: { cellWidth: usableWidth - 55 },
          },
          body: [
            ["Mod permintaan", data.demandMode === "quick" ? "Quick Estimate" : "Kategori terperinci"],
            ["Populasi", `${data.quickInput.pop || "-"} orang`],
            ["Per kapita", `${data.quickInput.percap || "-"} L/org/hari`],
            ["Permintaan override", `${data.quickInput.demand || "-"} mÂ³/hari`],
            ["Faktor puncak", data.quickInput.peak || "â€“"],
            ["Bekalan asas (JANS)", `${data.assumptions.supply || "-"} MLD`],
            ["Tarif air/pembetungan", `${data.assumptions.tariffWater || "-"} / ${data.assumptions.tariffSewer || "-"} RM/mÂ³`],
            ["Tempoh & diskaun", `${data.assumptions.years || "-"} tahun; ${data.assumptions.discount || "-"}% diskaun`],
          ],
        });
        cursorY = doc.lastAutoTable.finalY + 6;

        // DEMAND & SUPPLY
        addTitle("Analisis Permintaan & Bekalan", "Kapasiti semasa & sumber alternatif");
        addParagraphs([
          "Jadual pertama memaparkan permintaan mengikut kategori yang pengguna isi. Nilai purata dan puncak dikira secara automatik supaya jurang dapat dilihat tanpa perlu membuka semula kalkulator.",
          "Kedua-dua permintaan dan bekalan dipaparkan dalam unit yang sama (mÂ³/hari) untuk mengelakkan salah tafsir. Kategori dengan populasinya tinggi menunjukkan ruang intervensi penjimatan.",
          "Bahagian sumber alternatif menekankan kapasiti, utiliti, kos operasi dan indikator kewangan ringkas. Baris kosong tidak ditunjukkan; ini mengelakkan pembaca menganggap kosong sebagai sifar yang sah.",
          "Interpretasi jurang: jika permintaan puncak melebihi bekalan efektif, tindakan segera ialah penjadualan beban, peningkatan storan atau menambah sumber alternatif dengan payback pantas.",
        ]);
        const demandRows = data.demandByCategory.length
          ? data.demandByCategory.map((r) => [r.name, r.pop, r.percap, r.avg, r.peak])
          : [["Tiada data kategori", "â€“", "â€“", "â€“", "â€“"]];
        const categoryTableBody = demandRows;
        console.log("[PDF] categories count:", categoryTableBody.length);
        if (categoryTableBody.length) {
          console.log("[PDF] first/last:", categoryTableBody[0], categoryTableBody[categoryTableBody.length - 1]);
        }
        doc.autoTable({
          startY: cursorY,
          margin: { left: margin, right: margin },
          tableWidth: usableWidth,
          theme: "grid",
          styles: { fontSize: 8, overflow: "linebreak", cellPadding: 1.5 },
          headStyles: { fillColor: [230, 244, 255], textColor: 18 },
          columnStyles: {
            0: { cellWidth: usableWidth * 0.44 },
            1: { halign: "right", cellWidth: usableWidth * 0.14 },
            2: { halign: "right", cellWidth: usableWidth * 0.14 },
            3: { halign: "right", cellWidth: usableWidth * 0.14 },
            4: { halign: "right", cellWidth: usableWidth * 0.14 },
          },
          head: [["Kategori", "Populasi", "Per kapita", "Purata (mÂ³/hari)", "Puncak (mÂ³/hari)"]],
          body: categoryTableBody,
          rowPageBreak: "auto",
          pageBreak: "auto",
        });
        cursorY = doc.lastAutoTable.finalY + 6;
        const altRows = data.altSources.length
          ? data.altSources.map((r) => [r.name, r.capacity, r.util, r.opex, r.npv, r.bcr])
          : [["Tiada sumber alternatif", "â€“", "â€“", "â€“", "â€“", "â€“"]];
        doc.autoTable({
          startY: cursorY,
          margin: { left: margin, right: margin },
          tableWidth: usableWidth,
          theme: "grid",
          styles: { fontSize: 9, overflow: "linebreak", cellPadding: 2 },
          headStyles: { fillColor: [12, 142, 217], textColor: 255 },
          head: [["Sumber alternatif", "Kapasiti (mÂ³/hari)", "Utilisasi (% hari)", "OPEX (RM/tahun)", "NPV (RM)", "BCR"]],
          body: altRows,
          rowPageBreak: "auto",
        });
        cursorY = doc.lastAutoTable.finalY + 6;

        // FINANCIALS
        addTitle("Analisis Kewangan", "NPV, BCR, Payback & Sensitiviti");
        addParagraphs([
          "Ringkasan kewangan menumpukan kepada CAPEX, OPEX, penjimatan tahunan dan indikator kelayakan (NPV, BCR, IRR, payback). Semua nilai dikira terus daripada input semasa.",
          "Jika mana-mana input kewangan belum lengkap, jadual akan memaparkan \"N/A (input belum diisi)\" untuk mengelakkan kekeliruan. Ini mengingatkan pembaca bahawa angka sifar bukanlah hasil kiraan sebenar.",
          "Keputusan utama: BCR < 1 atau NPV negatif menunjukkan projek perlu dipakej semula, dikurangkan skop atau ditambah nilai faedah. Payback panjang meningkatkan risiko aliran tunai dan memerlukan strategi fasa.",
          "Sensitiviti Â±10% kos/faedah membantu menilai daya tahan projek terhadap ketidakpastian harga, kos operasi atau volum air. Jadual di bawah boleh digunakan sebagai rujukan pantas sebelum pembentangan bajet.",
        ]);
        const sensVal = (val) => financeValue(isFinite(val) ? formatNumber(val) : val);
        doc.autoTable({
          startY: cursorY,
          margin: { left: margin, right: margin },
          tableWidth: usableWidth,
          theme: "grid",
          styles: { fontSize: 9, overflow: "linebreak", cellPadding: 2 },
          headStyles: { fillColor: [230, 244, 255], textColor: 18 },
          head: [["Metrik", "Nilai"]],
          body: [
            ["Jumlah CAPEX (RM)", financeValue(data.financeSummary.capex)],
            ["Jumlah OPEX (RM/tahun)", financeValue(data.financeSummary.opex)],
            ["Penjimatan (RM/tahun)", financeValue(data.financeSummary.saving)],
            ["Aliran tunai bersih (RM/tahun)", financeValue(data.financeSummary.netcf)],
            ["NPV (RM)", financeValue(data.financeSummary.npv)],
            ["BCR", financeValue(data.financeSummary.bcr)],
            ["IRR anggaran (%)", financeValue(data.financeSummary.irr)],
          ],
          rowPageBreak: "auto",
        });
        cursorY = doc.lastAutoTable.finalY + 6;
        doc.autoTable({
          startY: cursorY,
          margin: { left: margin, right: margin },
          tableWidth: usableWidth,
          theme: "grid",
          styles: { fontSize: 9, overflow: "linebreak", cellPadding: 2 },
          headStyles: { fillColor: [12, 142, 217], textColor: 255 },
          head: [["Sensitiviti", "NPV (RM)", "BCR"]],
          body: [
            ["Asas", sensVal(data.sensitivity.base?.npv ?? NaN), sensVal(data.sensitivity.base?.bcr)],
            ["CAPEX +10%", sensVal(data.sensitivity.capex?.npv ?? NaN), sensVal(data.sensitivity.capex?.bcr)],
            ["OPEX +10%", sensVal(data.sensitivity.opex?.npv ?? NaN), sensVal(data.sensitivity.opex?.bcr)],
            ["Manfaat +10%", sensVal(data.sensitivity.benefit?.npv ?? NaN), sensVal(data.sensitivity.benefit?.bcr)],
          ],
          rowPageBreak: "auto",
        });
        cursorY = doc.lastAutoTable.finalY + 8;

        // SCENARIO COMPARISON
        if (data.scenarioScope === "all" && (data.scenariosForReport || []).length) {
          addTitle("Perbandingan Senario Aâ€“C", "KPI permintaan & kewangan");
          addParagraphs([
            "Setiap senario disimpan terus daripada kalkulator dan dibandingkan pada jadual berikut. Nilai yang kosong akan kekal \"â€“\" supaya perbezaan jelas kelihatan.",
            "Gunakan perbandingan ini untuk memilih kombinasi sumber atau permintaan yang paling seimbang sebelum difailkan sebagai cadangan rasmi.",
          ]);
          const compareBody = data.scenariosForReport.map((s) => [
            s.name || s.id,
            formatNumber(s.summary?.avgMLD ?? NaN),
            formatNumber(s.summary?.peakMLD ?? NaN),
            formatNumber(s.summary?.effectiveMLD ?? NaN),
            formatNumber(s.summary?.surplusAvg ?? NaN),
            formatNumber(s.finance?.npv ?? NaN),
            isFinite(s.finance?.bcr) ? formatNumber(s.finance.bcr) : "â€“",
            isFinite(s.finance?.payback) ? formatNumber(s.finance.payback) : "â€“",
          ]);
          doc.autoTable({
            startY: cursorY,
            margin: { left: margin, right: margin },
            tableWidth: usableWidth,
            theme: "grid",
            styles: { fontSize: 9, overflow: "linebreak", cellPadding: 2 },
            headStyles: { fillColor: [12, 142, 217], textColor: 255 },
            head: [["Senario", "Avg (MLD)", "Peak (MLD)", "Bekalan efektif (MLD)", "Lebihan/Defisit", "NPV (RM)", "BCR", "Payback (tahun)"]],
            body: compareBody,
            rowPageBreak: "auto",
          });
          cursorY = doc.lastAutoTable.finalY + 8;
        }

        // VISUALS
        if (data.includeCharts) {
          addTitle("Graf & Visual", "Interpretasi visual permintaan, bekalan dan kewangan");
          addParagraphs([
            "Setiap rajah dikompres dalam format JPEG berkualiti 0.72 untuk mengekalkan saiz fail kecil tanpa menjejaskan keterbacaan. Lebar imej dihadkan kepada ruang kandungan A4 supaya tiada elemen terkeluar margin.",
            "Gunakan catatan di bawah setiap rajah untuk memahami maksud data dan tindakan pantas yang disyorkan. Rajah menggunakan data semasa; kemas kini input akan menukar grafik secara automatik.",
          ]);
          addChartImage(
            "Rajah 1: Permintaan vs Bekalan Efektif",
            data.charts.supplyDemand,
            "Permintaan purata/puncak dibandingkan terus dengan bekalan efektif.",
            [
              "Implikasi: jika bar permintaan puncak melebihi bekalan, risiko gangguan meningkat semasa pendaftaran pelajar atau acara besar.",
              "Tindakan: optimakan storan, jadualkan penggunaan tinggi di luar puncak dan tambah sumber alternatif berpayback pantas.",
            ]
          );
          addChartImage(
            "Rajah 2: Komposisi Sumber Alternatif",
            data.charts.altComposition,
            "Sumbangan setiap sumber alternatif (mÂ³/hari berkesan).",
            [
              "Implikasi: sumber dengan bar terbesar ialah penentu kebolehpercayaan; jadualkan penyelenggaraan dan pemantauan untuk sumber ini terlebih dahulu.",
              "Tindakan: wujudkan redundansi dan stok alat ganti bagi dua sumber teratas, dan semak utiliti jika prestasi tidak konsisten.",
            ]
          );
          addChartImage(
            "Rajah 3: Permintaan Mengikut Kategori",
            data.charts.demandByCategory,
            "Purata dan puncak bagi kategori utama.",
            [
              "Implikasi: kategori dengan permintaan tertinggi memacu keperluan infrastruktur dan menjadi calon utama audit kebocoran/kecekapan.",
              "Tindakan: sasarkan kategori yang menyumbang >20% permintaan untuk program penggantian peralatan dan kempen kesedaran.",
            ]
          );
          addChartImage(
            "Rajah 4: Agihan Permintaan (%)",
            data.charts.demandShare,
            "Peratusan sumbangan permintaan.",
            [
              "Implikasi: kategori dominan memberikan pulangan tertinggi bagi setiap inisiatif penjimatan air.",
              "Tindakan: rancang intervensi fasa mengikut ranking peratus sumbangan supaya pelaburan lebih fokus.",
            ]
          );
          addChartImage(
            "Rajah 5: NPV Mengikut Sumber Alternatif",
            data.charts.cbaNPV,
            "Nilai kini bersih setiap sumber.",
            [
              "Implikasi: NPV negatif menunjukkan kos melebihi faedah; semak semula kos CAPEX/OPEX atau manfaat yang diandaikan.",
              "Tindakan: fasa pelaksanaan bermula dengan sumber bernilai tertinggi sambil menegosiasi kos untuk sumber hampir neutral.",
            ]
          );
          addChartImage(
            "Rajah 6: Payback Mengikut Sumber Alternatif",
            data.charts.cbaPayback,
            "Tempoh pulangan modal.",
            [
              "Implikasi: payback panjang meningkatkan risiko aliran tunai dan kebolehbiayaan projek.",
              "Tindakan: utamakan sumber dengan payback <5 tahun untuk fasa awal dan jadualkan semakan tarif secara berkala.",
            ]
          );
        }

        // RECOMMENDATIONS
        addTitle("Cadangan & Tindakan", "Prioriti pengurusan");
        addParagraphs([
          "Tindakan segera: tutup defisit puncak melalui penjadualan beban, penguatan storan dan pemeriksaan kebolehpercayaan sumber alternatif.",
          "Keutamaan pelaburan: fokus kepada sumber alternatif dengan BCR tertinggi dan payback terpantas; semak tarif dan kos operasi sebenar setiap 12 bulan.",
          "Pengurusan risiko: sediakan pelan kontingensi untuk kegagalan sumber dominan; laksanakan audit NRW dan pemasangan meter sub-zon bagi menala faktor puncak.",
        ]);

        // APPENDIX TABLES (AUTOTABLE â€“ kecil)
        addTitle("Lampiran Jadual", "Butiran sumber & CAPEX/OPEX");
        const appendixStartY = cursorY;
        const altBody = data.altSources.length
          ? data.altSources.map((r) => [r.name, r.capacity, r.util, r.capex, r.opex, r.npv, r.bcr])
          : [["Tiada sumber alternatif", "â€“", "â€“", "â€“", "â€“", "â€“", "â€“"]];
        doc.autoTable({
          startY: appendixStartY,
          margin: { left: margin, right: margin },
          tableWidth: usableWidth,
          theme: "grid",
          styles: { fontSize: 8.5, overflow: "linebreak", cellPadding: 1.6 },
          headStyles: { fillColor: [230, 244, 255], textColor: 18 },
          head: [["Sumber", "Kapasiti", "Utilisasi (% hari)", "CAPEX (RM)", "OPEX (RM/tahun)", "NPV (RM)", "BCR"]],
          body: altBody,
          rowPageBreak: "auto",
        });
        cursorY = doc.lastAutoTable.finalY + 6;
        const capexOpexBody = data.capexOpexItems.length
          ? data.capexOpexItems.map((r) => [r.type, r.name, r.qty, r.cost, r.total, r.note || "-"])
          : [["Tiada pecahan CAPEX/OPEX", "â€“", "â€“", "â€“", "â€“", "â€“"]];
        doc.autoTable({
          startY: cursorY,
          margin: { left: margin, right: margin },
          tableWidth: usableWidth,
          theme: "grid",
          styles: { fontSize: 8.5, overflow: "linebreak", cellPadding: 1.6 },
          headStyles: { fillColor: [12, 142, 217], textColor: 255 },
          head: [["Jenis", "Item / Komponen", "Kuantiti", "Kos seunit (RM)", "Jumlah (RM)", "Catatan"]],
          body: capexOpexBody,
          rowPageBreak: "auto",
        });
        cursorY = doc.lastAutoTable.finalY + 6;
        addParagraphs([
          "Data diperlukan untuk analisis kewangan: tarif air & pembetungan, tempoh analisis, kadar diskaun, CAPEX, OPEX dan penjimatan tahunan. Masukkan nilai sebenar untuk menggantikan paparan N/A dalam jadual kewangan.",
          data.disclaimerText,
          data.confidential ? "Status: Sulit â€“ untuk kegunaan dalaman pengurusan UMS sahaja." : "",
        ]);

        // RENDER TOC & HEADER/FOOTER
        renderTOC(tocPage);
        addHeaderFooter();

        const safeScenario = (data.activeScenarioId || "Aktif").replace(/\W+/g, "_");
        doc.save(`Laporan_UMS_Water_${safeScenario}_${data.fileDate}.pdf`);
      }

      async function downloadTopMgmtPptx() {
        console.log("[PPTX] click");
        let PptxGenJS = window.PptxGenJS || window.pptxgen;
        const defaultPptxLabel = "ğŸ“‘ Muat turun PowerPoint (Top Mgmt)";
        const setPptxBtnState = (isLoading, label) => {
          if (!pptxBtn) return;
          pptxBtn.disabled = !!isLoading;
          pptxBtn.textContent = label || defaultPptxLabel;
        };
        try {
          setPptxBtnState(true, "â³ Menjana PPTXâ€¦");
          PptxGenJS = await ensurePptxLoaded();
          if (!PptxGenJS) {
            alert("Library PowerPoint (PptxGenJS) tidak dimuatkan. Sila cuba lagi selepas semak sambungan internet.");
            setPptxBtnState(false);
            return;
          }
          window.PptxGenJS = PptxGenJS;
          if (!hasCalculated) {
            const proceed = confirm("Sila tekan KIRA SEKARANG terlebih dahulu untuk jana PowerPoint.\nPilih OK untuk Kira & Jana PPTX, atau Batal untuk kembali.");
            if (!proceed) {
              setPptxBtnState(false);
              return;
            }
            const ok = runCalculation({ scroll: false });
            if (!ok) {
              setPptxBtnState(false);
              return;
            }
          }
        } catch (err) {
          console.error("[PPTX] gagal memuat library atau mengira sebelum eksport", err);
          const msg = err?.message || "Ralat semasa memuat library / pengiraan sebelum jana PPTX. Sila semak sambungan dan cuba lagi.";
          showErrorBanner(msg);
          alert(msg);
          setPptxBtnState(false);
          return;
        }

        try {
          await loadUmsLogoDataUrl();
          const data = await collectReportData();
          const pptx = new PptxGenJS();
          pptx.layout = "16x9";

          const primary = "0c8ed9";
          const dark = "12324a";
          const soft = "e6f4ff";
          const scenarioLabel = data.activeScenarioName || `Senario ${data.activeScenarioId || "Aktif"}`;
          const today = data.fileDate || new Date().toISOString().slice(0, 10);
          const safeScenario = (data.activeScenarioId || "Aktif").replace(/\W+/g, "_");
          const headerOpts = { bold: true, color: dark, fill: soft, fontSize: 12 };
          const safeNumber = (val) =>
            isFinite(val) ? formatNumber(val) : val || "â€“";

          const summary = data.summary || {};
          const financeSummary = data.financeSummary || {};
          const demandByCategory = data.demandByCategory || [];
          const altSources = data.altSources?.length ? data.altSources : [];
          const altTotals = data.altTotals || {};
          const assumptions = data.assumptions || {};
          const surplusAvg = summary.surplusAvg;
          const surplusPeak = summary.surplusPeak;
          const statusAvg = summary.status?.avg || "â€“";
          const statusPeak = summary.status?.peak || "â€“";
          const paybackText = isFinite(lastAltSummary.payback)
            ? formatNumber(lastAltSummary.payback)
            : financeSummary.payback || "â€“";
          const fileName = `UMS_Water_TopMgmt_${safeScenario}_${today}.pptx`;
          const titleSlide = pptx.addSlide();
          titleSlide.background = { color: "f7fbff" };
          titleSlide.addShape(pptx.ShapeType.rect, { x: 0, y: 5.6, w: "100%", h: 1.4, fill: { color: soft } });
          titleSlide.addText("UMS Water Demandâ€“Supply Analysis", {
            x: 0.5,
            y: 0.7,
            w: 9,
            h: 1.2,
            fontSize: 28,
            bold: true,
            color: dark,
          });
          titleSlide.addText(`Senario: ${scenarioLabel}`, { x: 0.5, y: 2.0, fontSize: 16, color: primary, bold: true });
          titleSlide.addText(`Tarikh: ${today}`, { x: 0.5, y: 2.55, fontSize: 14, color: dark });
          titleSlide.addText("Fokus: keseimbangan permintaanâ€“bekalan, kesan sumber alternatif dan KPI kewangan.", {
            x: 0.5,
            y: 3.05,
            w: 9,
            fontSize: 13,
            color: "#245070",
          });
          if (data.preparedBy) {
            titleSlide.addText(`Disediakan oleh: ${data.preparedBy}`, { x: 0.5, y: 3.55, fontSize: 12, color: "#245070" });
          }
          if (umsLogoDataUrl) {
            titleSlide.addImage({ data: umsLogoDataUrl, x: 8.4, y: 0.45, w: 1.5, h: 1.5 });
          }

          const execSlide = pptx.addSlide();
          execSlide.background = { color: "#ffffff" };
          execSlide.addText("Executive Summary", { x: 0.5, y: 0.3, fontSize: 20, bold: true, color: dark });
          const execTable = [
            [{ text: "Metrik Utama", options: headerOpts }, { text: "Nilai", options: headerOpts }],
            ["Permintaan purata (MLD)", safeNumber(summary.avgMLD)],
            ["Permintaan puncak (MLD)", safeNumber(summary.peakMLD)],
            ["Bekalan efektif (MLD)", safeNumber(summary.effectiveMLD)],
            ["Lebihan/Defisit purata (MLD)", safeNumber(surplusAvg)],
            ["Lebihan/Defisit puncak (MLD)", safeNumber(surplusPeak)],
            ["Status (purata / puncak)", `${statusAvg} / ${statusPeak}`],
          ];
          execSlide.addTable(execTable, {
            x: 0.5,
            y: 0.9,
            w: 5,
            colW: [3.1, 1.9],
            border: { color: primary, pt: 0.9 },
            fontSize: 12,
          });
          const insights = [];
          if (isFinite(surplusAvg)) {
            insights.push(
              surplusAvg >= 0
                ? "Surplus purata boleh menampung variasi operasi; optimakan storan & agihan."
                : "Defisit purata perlu mitigasi segera (pengurangan NRW atau tambah sumber)."
            );
          }
          if (isFinite(surplusPeak)) {
            insights.push(
              surplusPeak >= 0
                ? "Semasa puncak masih ada ruang keselamatan; semak kebolehpercayaan sumber alternatif."
                : "Puncak defisit: rancang penjadualan beban, perkuat storan & sumber alternatif."
            );
          }
          if (financeSummary.bcr && financeSummary.bcr !== "â€“") {
            insights.push(`Kelayakan kewangan (BCR): ${financeSummary.bcr}. Utamakan sumber dengan BCR tertinggi.`);
          }
          execSlide.addText(insights, {
            x: 5.7,
            y: 1.0,
            w: 3.6,
            fontSize: 12.5,
            color: dark,
            bullet: true,
            lineSpacing: 20,
          });

          const kpiSlide = pptx.addSlide();
          kpiSlide.background = { color: "ffffff" };
          kpiSlide.addText("KPI & Visual", { x: 0.5, y: 0.3, fontSize: 20, bold: true, color: dark });
          const kpiTable = [
            [{ text: "KPI", options: headerOpts }, { text: "Nilai", options: headerOpts }],
            ["BCR projek alternatif", financeSummary.bcr || "â€“"],
            ["NPV projek alternatif (RM)", financeSummary.npv || "â€“"],
            ["Payback anggaran (tahun)", paybackText],
            ["Jumlah CAPEX (RM)", financeSummary.capex || "â€“"],
            ["Jumlah OPEX (RM/tahun)", financeSummary.opex || "â€“"],
          ];
          kpiSlide.addTable(kpiTable, {
            x: 0.5,
            y: 1.0,
            w: 4.6,
            colW: [2.8, 1.8],
            border: { color: primary, pt: 0.75 },
            fontSize: 12,
          });
          const shareChartImg =
            chartToImage(shareChart, "demand-share-chart") ||
            chartToImage(categoryChart, "demand-by-category-chart");
          const supplyDemandImg = buildSupplyDemandChartImage(summary);
          const chartImg = shareChartImg || supplyDemandImg || data.charts?.supplyDemand;
          if (chartImg) {
            kpiSlide.addImage({
              data: chartImg,
              x: 5.4,
              y: 1.0,
              w: 4.4,
              h: 3.2,
            });
            kpiSlide.addText("Graf diambil terus daripada kalkulator (Chart.js).", {
              x: 5.4,
              y: 4.25,
              w: 4.4,
              fontSize: 10,
              color: "#4b6885",
            });
          }
          kpiSlide.addText(
            [
              "Senario A/B/C kekal untuk perbandingan pantas.",
              "Eksport terus: Excel, PDF & PPTX untuk mesyuarat pengurusan.",
              "Kira semula bila input dikemas kini â€“ tiada muat semula halaman.",
            ],
            { x: 0.5, y: 4.9, w: 9.2, fontSize: 12, color: dark, bullet: true, lineSpacing: 20 }
          );

          const demandSlide = pptx.addSlide();
          demandSlide.background = { color: "ffffff" };
          demandSlide.addText("Agihan Permintaan Mengikut Kategori", { x: 0.5, y: 0.3, fontSize: 20, bold: true, color: dark });
          const topDemand = demandByCategory.slice(0, 6);
          const demandTable = [
            [
              { text: "Kategori", options: headerOpts },
              { text: "Populasi", options: headerOpts },
              { text: "Per kapita", options: headerOpts },
              { text: "Purata (mÂ³/hari)", options: headerOpts },
              { text: "Puncak (mÂ³/hari)", options: headerOpts },
            ],
          ];
          if (topDemand.length) {
            topDemand.forEach((row) => {
              demandTable.push([row.name, row.pop, row.percap, row.avg, row.peak]);
            });
          } else {
            demandTable.push(["Tiada data kategori", "â€“", "â€“", "â€“", "â€“"]);
          }
          demandSlide.addTable(demandTable, {
            x: 0.5,
            y: 1.0,
            w: 9.2,
            colW: [2.6, 1.4, 1.4, 1.9, 1.9],
            fontSize: 11,
            border: { color: "#c9deef", pt: 0.75 },
          });
          demandSlide.addText("Kategori tambahan boleh dimuat naik melalui Excel; jadual membaca terus struktur jadual semasa.", {
            x: 0.5,
            y: 5.9,
            w: 9.2,
            fontSize: 11,
            color: "#3e5875",
          });

        const supplySlide = pptx.addSlide();
        supplySlide.background = { color: "#ffffff" };
        supplySlide.addText("Bekalan Sedia Ada & Sumber Alternatif", { x: 0.5, y: 0.3, fontSize: 20, bold: true, color: dark });
        supplySlide.addTable(
          [
            [{ text: "Komponen", options: headerOpts }, { text: "Nilai", options: headerOpts }],
            ["Bekalan asas (MLD)", safeNumber(summary.supplyMLD)],
            ["Bekalan alternatif (MLD)", safeNumber(summary.altSupplyMLD)],
            ["Bekalan efektif (MLD)", safeNumber(summary.effectiveMLD)],
            ["Status purata / puncak", `${statusAvg} / ${statusPeak}`],
          ],
          { x: 0.5, y: 1.0, w: 4.6, colW: [2.7, 1.9], fontSize: 12, border: { color: primary, pt: 0.75 } }
        );
        const altTableRows = [
          [
            { text: "Sumber", options: headerOpts },
            { text: "Vol. tahunan (mÂ³/tahun)", options: headerOpts },
            { text: "CAPEX (RM)", options: headerOpts },
            { text: "OPEX (RM/tahun)", options: headerOpts },
            { text: "Payback (tahun)", options: headerOpts },
          ],
        ];
        (altSources.slice(0, 5)).forEach((r) => {
          altTableRows.push([r.name || "-", r.volume || "â€“", r.capex || "â€“", r.opex || "â€“", r.payback || "â€“"]);
        });
        if (altTableRows.length === 1) {
          altTableRows.push(["Tiada data sumber alternatif", "â€“", "â€“", "â€“", "â€“"]);
        }
        supplySlide.addTable(altTableRows, {
          x: 5.3,
          y: 1.0,
          w: 4.4,
          colW: [1.9, 1.0, 0.9, 0.85, 0.75],
          fontSize: 11,
          border: { color: "#c9deef", pt: 0.75 },
        });
        supplySlide.addText(
          `Jumlah volum alternatif: ${altTotals.volume || "â€“"} | Jumlah CAPEX: ${altTotals.capex || "â€“"} | BCR: ${financeSummary.bcr || "â€“"}`,
          { x: 0.5, y: 5.9, w: 9.2, fontSize: 11, color: "#3e5875" }
        );

        const gapSlide = pptx.addSlide();
        gapSlide.background = { color: "#ffffff" };
        gapSlide.addText("Jurang & Cadangan", { x: 0.5, y: 0.3, fontSize: 20, bold: true, color: dark });
        const gapBullets = [
          surplusAvg >= 0
            ? "Surplus purata: kekalkan pemantauan kebolehpercayaan, optimakan tangki/storan."
            : "Defisit purata: keutamaan kepada pengurangan NRW dan sumber alternatif dengan utiliti tinggi.",
          surplusPeak >= 0
            ? "Puncak terkawal: semak SOP operasi puncak dan redundansi pam."
            : "Defisit puncak: jadualkan permintaan puncak, sediakan storan tambahan / by-pass kecemasan.",
        ];
        gapBullets.push(
          financeSummary.bcr && financeSummary.bcr !== "â€“"
            ? `BCR portfolio: ${financeSummary.bcr}. Fokus sumber dengan payback ${paybackText} tahun atau lebih pantas.`
            : "Lengkapkan parameter kewangan untuk melihat BCR/NPV."
        );
        gapSlide.addText(gapBullets, {
          x: 0.5,
          y: 1.0,
          w: 9.2,
          fontSize: 12.5,
          color: dark,
          bullet: true,
          lineSpacing: 22,
        });

        const financeSlide = pptx.addSlide();
        financeSlide.background = { color: "#ffffff" };
        financeSlide.addText("Sorotan Kewangan & Sensitiviti", { x: 0.5, y: 0.3, fontSize: 20, bold: true, color: dark });
        financeSlide.addTable(
          [
            [{ text: "Metrik", options: headerOpts }, { text: "Nilai", options: headerOpts }],
            ["NPV (RM)", financeSummary.npv || "â€“"],
            ["BCR", financeSummary.bcr || "â€“"],
            ["Payback (tahun)", paybackText],
            ["Jumlah CAPEX (RM)", financeSummary.capex || "â€“"],
            ["Jumlah OPEX (RM/tahun)", financeSummary.opex || "â€“"],
            ["Penjimatan (RM/tahun)", financeSummary.saving || "â€“"],
          ],
          { x: 0.5, y: 1.0, w: 4.6, colW: [2.8, 1.8], fontSize: 12, border: { color: primary, pt: 0.75 } }
        );
        const sensitivity = data.sensitivity || {};
        const sensitivityTable = [
          [{ text: "Sensitiviti", options: headerOpts }, { text: "NPV", options: headerOpts }, { text: "BCR", options: headerOpts }],
          ["Asas", formatNumber(sensitivity.base?.npv ?? NaN), isFinite(sensitivity.base?.bcr) ? formatNumber(sensitivity.base.bcr) : "â€“"],
          ["CAPEX +10%", formatNumber(sensitivity.capex?.npv ?? NaN), isFinite(sensitivity.capex?.bcr) ? formatNumber(sensitivity.capex.bcr) : "â€“"],
          ["OPEX +10%", formatNumber(sensitivity.opex?.npv ?? NaN), isFinite(sensitivity.opex?.bcr) ? formatNumber(sensitivity.opex.bcr) : "â€“"],
          ["Benefit +10%", formatNumber(sensitivity.benefit?.npv ?? NaN), isFinite(sensitivity.benefit?.bcr) ? formatNumber(sensitivity.benefit.bcr) : "â€“"],
        ];
        financeSlide.addTable(sensitivityTable, {
          x: 5.3,
          y: 1.0,
          w: 4.2,
          colW: [1.7, 1.2, 1.1],
          fontSize: 11,
          border: { color: "#c9deef", pt: 0.75 },
        });
        financeSlide.addText("Nota: NPV/BCR dikira terus daripada input semasa; semak tarif & tempoh analisis jika angka kelihatan luar biasa.", {
          x: 0.5,
          y: 5.9,
          w: 9.2,
          fontSize: 11,
          color: "#3e5875",
        });

        const appendixSlide = pptx.addSlide();
        appendixSlide.background = { color: "#ffffff" };
        appendixSlide.addText("Lampiran Ringkas (Andaian Utama)", { x: 0.5, y: 0.3, fontSize: 20, bold: true, color: dark });
        const assumptionList = [
          `Bekalan asas diisi: ${assumptions.supply || "â€“"} MLD; Tarif air RM${assumptions.tariffWater || "â€“"} /mÂ³, pembetungan RM${assumptions.tariffSewer || "â€“"} /mÂ³.`,
          `Tempoh analisis: ${assumptions.years || "â€“"} tahun; kadar diskaun ${assumptions.discount || "â€“"}%.`,
          `Mod permintaan: ${data.demandMode || "quick"}; input Excel disokong tanpa mengubah struktur jadual kategori.`,
          "Graf & jadual diambil terus daripada kalkulator untuk kekal selari dengan PDF/Excel.",
        ];
        appendixSlide.addText(assumptionList, {
          x: 0.5,
          y: 1.0,
          w: 9.2,
          fontSize: 12,
          color: dark,
          bullet: true,
          lineSpacing: 22,
        });
        if (umsLogoDataUrl) {
          appendixSlide.addImage({ data: umsLogoDataUrl, x: 8.6, y: 5.8, w: 1.2, h: 1.2, transparency: 10 });
        }

          const runFallbackDownload = async (reason) => {
            console.warn(`[PPTX] menggunakan fallback download (${reason})`);
            const blob = await pptx.write({ outputType: "blob", compression: true });
            if (window.saveAs) {
              window.saveAs(blob, fileName);
              return;
            }
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
          };

          let wrote = false;
          try {
            await pptx.writeFile({ fileName, compression: true });
            wrote = true;
          } catch (err) {
            console.warn("[PPTX] writeFile gagal, cuba fallback", err);
          }
          if (!wrote) {
            await runFallbackDownload("writeFile gagal atau tidak memulakan muat turun");
          }
        } catch (err) {
          console.error("[PPTX] gagal menjana fail PPTX", err);
          const msg = err?.message || "Ralat semasa menjana PPTX. Sila cuba lagi selepas semak sambungan internet.";
          showErrorBanner(msg);
          alert(msg);
        } finally {
          setPptxBtnState(false);
        }
      }
      // END REPORT UPDATE

      addItemBtn.addEventListener("click", () => {
        const tr = createCapexOpexRow();
        capexOpexBody.appendChild(tr);
        recalcCapexOpexItems();
      });

      capexOpexBody.addEventListener("input", (e) => {
        if (
          e.target.classList.contains("item-qty") ||
          e.target.classList.contains("item-cost") ||
          e.target.classList.contains("item-type")
        ) {
          recalcCapexOpexItems();
        }
      });

      // Add rows for demand categories
      addRowBtn.addEventListener("click", () => {
        const tr = createCategoryRow();
        categoryBody.appendChild(tr);
      });

      // Add rows for alternative sources
      addAltRowBtn.addEventListener("click", () => {
        const tr = createAltRow();
        altBody.appendChild(tr);
      });

      // Lindungi pemilih KIRA jika seksyen CTA disembunyikan.
      calcBtn?.addEventListener("click", handleKiraClick);
      document.addEventListener("click", (e) => {
        if (e.target.closest("#sticky-calc-btn") || e.target.closest("#btnKira")) {
          handleKiraClick();
        }
      });

      // Export Excel
      exportBtn.addEventListener("click", () => {
        try {
          if (typeof XLSX === "undefined") {
            alert("Library Excel (SheetJS) tidak dimuatkan.");
            return;
          }

          // Ensure latest calculations
          runCalculation({ scroll: false });

          const wb = XLSX.utils.book_new();

          // Sheet 0: Mod & Senario
          const metaRows = [
            ["Mod dipilih", appState.mode],
            ["Senario aktif", activeScenario()?.name || ""],
            ["Skop laporan PDF", pdfScopeSelect.value === "all" ? "Semua senario" : "Senario aktif"],
            ["Bekalan asas (MLD)", supplyInput.value],
            ["Tarif air (RM/mÂ³)", tariffWaterInput.value],
            ["Tarif pembetungan (RM/mÂ³)", tariffSewerInput.value],
            ["Tempoh analisis (tahun)", analysisYearsInput.value],
            ["Kadar diskaun (%)", discountRateInput.value],
          ];
          const scenarioRows = [
            ["Senario", "Mod", "Permintaan purata (MLD)", "Permintaan puncak (MLD)", "Bekalan efektif (MLD)", "Lebihan/Defisit purata", "NPV", "BCR", "IRR (%)", "Payback (tahun)"],
          ];
          Object.values(appState.scenarios).forEach((sc) => {
            const sum = sc.outputs?.summary || {};
            const fin = sc.outputs?.finance || {};
            scenarioRows.push([
              sc.name,
              sc.mode,
              formatNumber(sum.avgMLD),
              formatNumber(sum.peakMLD),
              formatNumber(sum.effectiveMLD),
              formatNumber(sum.surplusAvg),
              formatNumber(fin.npv),
              isFinite(fin.bcr) ? formatNumber(fin.bcr) : "â€“",
              isFinite(fin.irr) ? formatNumber(fin.irr) : "â€“",
              isFinite(fin.payback) ? formatNumber(fin.payback) : "â€“",
            ]);
          });
          const wsMeta = XLSX.utils.aoa_to_sheet(metaRows.concat([[]], scenarioRows));
          XLSX.utils.book_append_sheet(wb, wsMeta, "Mod_Senario");

          // Sheet 1: Kategori demand
          const catRows = [["Kategori", "Populasi", "Per kapita (L/org/hari)", "Purata (mÂ³/hari)", "Faktor puncak", "Permintaan puncak (mÂ³/hari)"]];
          document.querySelectorAll("#results-body tr").forEach((tr) => {
            const cells = Array.from(tr.querySelectorAll("td")).map((td) =>
              td.textContent.trim()
            );
            if (cells.length) catRows.push(cells);
          });
          const totalsRow1 = [
            "Jumlah",
            document.getElementById("total-pop").textContent,
            "",
            document.getElementById("total-avg-m3").textContent,
            "",
            document.getElementById("total-peak-m3").textContent,
          ];
          const totalsRow2 = [
            "Jumlah dalam MLD",
            "",
            "",
            document.getElementById("total-avg-mld").textContent,
            "",
            document.getElementById("total-peak-mld").textContent,
          ];
          catRows.push(totalsRow1, totalsRow2);
          const wsCat = XLSX.utils.aoa_to_sheet(catRows);
          XLSX.utils.book_append_sheet(wb, wsCat, "Kategori");

          // Sheet 2: Ringkasan demandâ€“supply
          const summaryRows = [
            ["Item", "Nilai (MLD)"],
            ["Jumlah permintaan purata", document.getElementById("summary-avg-mld").textContent],
            ["Jumlah permintaan puncak", document.getElementById("summary-peak-mld").textContent],
            ["Bekalan sedia ada (JANS)", document.getElementById("supply-avg-mld").textContent],
            ["Extra supply (alt sources)", document.getElementById("alt-supply-mld").textContent],
            ["Bekalan efektif", document.getElementById("effective-supply-mld").textContent],
            ["Lebihan / Defisit purata", document.getElementById("surplus-avg-mld").textContent],
            ["Lebihan / Defisit puncak", document.getElementById("surplus-peak-mld").textContent],
          ];
          const wsSum = XLSX.utils.aoa_to_sheet(summaryRows);
          XLSX.utils.book_append_sheet(wb, wsSum, "Ringkasan");

          // Sheet 3: CBA alternatif
          const cbaRows = [[
            "Sumber",
            "Kapasiti (mÂ³/hari)",
            "Utilisasi (% hari)",
            "Kebolehpercayaan (%)",
            "Vol. tahunan (mÂ³/tahun)",
            "CAPEX (RM)",
            "OPEX tahunan (RM/tahun)",
            "Saving air + pembetungan (RM/tahun)",
            "CF bersih (RM/tahun)",
            "Tempoh pulangan modal (tahun)",
            "NPV (RM)",
            "BCR"
          ]];
          document.querySelectorAll("#alt-results-body tr").forEach((tr) => {
            const cells = Array.from(tr.querySelectorAll("td")).map((td) =>
              td.textContent.trim()
            );
            if (cells.length) cbaRows.push(cells);
          });
          const cbaTotalsRow = [
            "Jumlah / Agregat",
            document.getElementById("alt-total-capacity").textContent,
            "",
            "",
            document.getElementById("alt-total-volume").textContent,
            document.getElementById("alt-total-capex").textContent,
            document.getElementById("alt-total-opex").textContent,
            document.getElementById("alt-total-saving").textContent,
            document.getElementById("alt-total-netcf").textContent,
            "",
            document.getElementById("alt-total-npv").textContent,
            document.getElementById("alt-total-bcr").textContent,
          ];
          cbaRows.push(cbaTotalsRow);
          const wsCBA = XLSX.utils.aoa_to_sheet(cbaRows);
          XLSX.utils.book_append_sheet(wb, wsCBA, "CBA_Alt_Sources");

          // Sheet 4: Itemised CAPEX & OPEX
          const itemRows = [[
            "Jenis",
            "Item / Komponen",
            "Kuantiti",
            "Kos seunit (RM)",
            "Jumlah kos (RM)",
            "Catatan"
          ]];
          document.querySelectorAll("#capex-opex-body tr").forEach((tr) => {
            const type = tr.querySelector(".item-type").value || "";
            const name = tr.querySelector(".item-name").value || "";
            const qty = tr.querySelector(".item-qty").value || "";
            const cost = tr.querySelector(".item-cost").value || "";
            const total = tr.querySelector(".item-total").textContent || "";
            const note = tr.querySelector(".item-note").value || "";
            if (name.trim() || parseFloat(qty) > 0 || parseFloat(cost) > 0) {
              itemRows.push([type, name, qty, cost, total, note]);
            }
          });
          itemRows.push(
            ["Jumlah CAPEX", "", "", "", document.getElementById("capex-items-total").textContent, ""],
            ["Jumlah OPEX", "", "", "", document.getElementById("opex-items-total").textContent, ""]
          );
          const wsItems = XLSX.utils.aoa_to_sheet(itemRows);
          XLSX.utils.book_append_sheet(wb, wsItems, "CAPEX_OPEX_Itemised");

          XLSX.writeFile(wb, "UMS_Water_Demand_Supply_CBA.xlsx");
        } catch (e) {
          console.error(e);
          alert("Ralat semasa export Excel. Sila cuba lagi.");
        }
      });

      pptxBtn?.addEventListener("click", downloadTopMgmtPptx);

      generateReportBtn.addEventListener("click", () => {
        generateReportPDF();
      });

      function goWizard(delta) {
        const steps = wizardStepsConfig();
        wizardStep = Math.min(Math.max(wizardStep + delta, 0), steps.length - 1);
        updateWizardNav();
      }

      if (wizardOpenBtn) wizardOpenBtn.addEventListener("click", () => openWizard(false));
      if (wizardCloseBtn) wizardCloseBtn.addEventListener("click", closeWizard);
      if (wizardBackBtn) wizardBackBtn.addEventListener("click", () => goWizard(-1));
      if (wizardNextBtn) wizardNextBtn.addEventListener("click", () => {
        const steps = wizardStepsConfig();
        if (wizardStep >= steps.length - 1) {
          closeWizard();
        } else {
          goWizard(1);
        }
      });
      if (wizardSkipBtn) wizardSkipBtn.addEventListener("click", () => goWizard(1));
      document.addEventListener("input", (e) => {
        if (e.target?.classList?.contains("field-missing")) {
          e.target.classList.remove("field-missing");
          const hint = e.target.parentElement?.querySelector(".missing-hint");
          if (hint) hint.remove();
        }
        if (!calcAlertBox?.classList.contains("hidden")) {
          const check = validateInputs({ mode: appState.mode, demandMethod: appState.demandMode });
          if (check.ok) {
            showMissingPanel([]);
          }
        }
        validateWizardStep();
        refreshStepperValidation();
      });
      document.addEventListener("change", (e) => {
        if (e.target?.classList?.contains("field-missing")) {
          e.target.classList.remove("field-missing");
          const hint = e.target.parentElement?.querySelector(".missing-hint");
          if (hint) hint.remove();
        }
        validateWizardStep();
        refreshStepperValidation();
      });

      modeSelector.addEventListener("click", (e) => {
        const pill = e.target.closest(".pill");
        if (!pill) return;
        setMode(pill.dataset.mode);
        if (hasCalculated) {
          runCalculation({ scroll: false });
        } else {
          clearMissingHighlights();
          showMissingPanel([]);
          updateAdvancedVisibility();
        }
      });

      autofillBtn.addEventListener("click", () => {
        quickInputs.pop.value = 15000;
        quickInputs.percap.value = 160;
        quickInputs.demand.value = "";
        quickInputs.peak.value = 1.3;
        quickInputs.baseSupply.value = 5;
        quickAltInputs.name.value = "Tangkapan air hujan mini";
        quickAltInputs.capacity.value = 250;
        quickAltInputs.util.value = 80;
        quickAltInputs.capex.value = 900000;
        quickAltInputs.opex.value = 50000;
        supplyInput.value = 5;
        tariffWaterInput.value = 1.2;
        tariffSewerInput.value = 0.8;
        analysisYearsInput.value = 20;
        discountRateInput.value = 5;
        runCalculation({ scroll: false });
      });

      toggleAdvancedBtn?.addEventListener("click", () => {
        document.body.classList.toggle("show-advanced");
        toggleAdvancedBtn.textContent = document.body.classList.contains("show-advanced")
          ? "Sembunyi input terperinci"
          : "ğŸ‘€ Papar input terperinci";
      });
      demandModeRadios.forEach((radio) => {
        radio.addEventListener("change", (e) => {
          setDemandMode(e.target.value);
        });
      });
      categoryInputToggle?.addEventListener("change", (e) => {
        if (e.target.name !== "category-input-mode") return;
        setCategoryInputMode(e.target.value);
      });
      downloadTemplateBtn?.addEventListener("click", downloadCategoryTemplate);
      excelUpload?.addEventListener("change", (e) => {
        const file = e.target.files?.[0];
        importCategoryExcel(file);
        e.target.value = "";
      });

      fixInputBtn.addEventListener("click", () => {
        const invalid = document.querySelector(".field-missing") || document.querySelector(".invalid");
        if (invalid) {
          invalid.scrollIntoView({ behavior: "smooth", block: "center" });
          invalid.focus({ preventScroll: true });
        } else {
          alert("Tiada input rosak dikesan. Anda boleh terus mengira.");
        }
      });

      scenarioListEl.addEventListener("click", (e) => {
        const btn = e.target.closest(".btn-load-scenario");
        if (btn) {
          setActiveScenario(btn.dataset.id);
        }
      });

      addScenarioBtn.addEventListener("click", addScenario);
      duplicateScenarioBtn.addEventListener("click", duplicateScenario);
      renameScenarioBtn.addEventListener("click", renameScenario);
      deleteScenarioBtn.addEventListener("click", deleteScenario);
      const handleSaveScenario = () => {
        saveActiveScenario();
        alert("Senario disimpan dalam pelayar.");
      };
      const handleResetAction = () => {
        const includeSaved = confirm(
          "Reset termasuk senario tersimpan dalam pelayar?\nOK: Padam semua senario tersimpan & kosongkan input.\nCancel: Hanya reset input senario aktif."
        );
        resetAllInputs({ includeSavedScenarios: includeSaved });
      };
      saveScenarioBtn.addEventListener("click", handleSaveScenario);
      saveScenarioCtaBtn?.addEventListener("click", handleSaveScenario);
      resetScenarioBtn?.addEventListener("click", handleResetAction);
      presetBtn?.addEventListener("click", loadPreset);

      jumpCalcBtn?.addEventListener("click", () => {
        const stickyBar = document.getElementById("sticky-action-bar");
        if (stickyBar) {
          stickyBar.scrollIntoView({ behavior: "smooth", block: "center" });
          stickyBar.classList.add("section-highlight");
          setTimeout(() => stickyBar.classList.remove("section-highlight"), 900);
          return;
        }
        if (calcActionsSection) {
          calcActionsSection.scrollIntoView({ behavior: "smooth", block: "start" });
        }
      });
      presetHeroBtn?.addEventListener("click", () => {
        loadPreset();
        runCalculation({ scroll: true });
      });
      resetInputsBtn?.addEventListener("click", handleResetAction);
      backToInputBtn?.addEventListener("click", () => {
        const target = document.getElementById("input-wrapper") || inputStepsContainer || document.body;
        if (target) {
          target.scrollIntoView({ behavior: "smooth", block: "start" });
        }
        setStepperExpanded(true, { source: "back-to-input", scrollIntoView: false });
        const firstStep = inputStepsContainer?.querySelector(".input-step");
        if (firstStep) firstStep.open = true;
      });

      attachHero();
      buildInputSteps();
      buildOutputLayout();
      moveExportUI();
      renderStickyActionBar();
      revealOutputs();
      buildStepper();
      initStepperBehavior();
      refreshStepperValidation();
      loadState();
      renderScenarioList();
      setMode(appState.mode);
      setDemandMode(appState.demandMode || "quick", true);
      applyScenarioInputs(activeScenario().inputs);
      const initialCatMode = document.querySelector("input[name='category-input-mode']:checked")?.value || "manual";
      setCategoryInputMode(initialCatMode);
      if (activeScenario()?.outputs?.summary) {
        hasCalculated = true;
        lastCalculatedAt = activeScenario().calculatedAt || Date.now();
        revealOutputs();
        updateStatusChip();
        updateAdvancedVisibility();
      }
      updateAdvancedVisibility();
      updateActiveScenarioBanner();
      loadUmsLogoDataUrl();
      recalcCapexOpexItems();
      updateStatusChip();
      updateStickyOffsets();
      window.addEventListener("resize", updateStickyOffsets);
    });
  </script>
</body>
</html>
