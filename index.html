<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <title>Kalkulator Permintaan & Bekalan Air UMS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Chart.js (graf) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- SheetJS (Export Excel) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- jsPDF & AutoTable (Export PDF) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root {
      --primary: #0d6efd;
      --primary-light: #e0f4ff;
      --primary-dark: #054a91;
      --accent: #00bcd4;
      --danger: #ff1744;
      --success: #00c853;
      --bg: #f5fbff;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        Roboto, sans-serif;
      color: #12324a;
      background:
        radial-gradient(circle at top, #cbe9ff 0, #f5fbff 45%, #ffffff 100%);
      position: relative;
      overflow-x: hidden;
    }

    /* background ‚Äúair‚Äù halus */
    body::before {
      content: "";
      position: fixed;
      inset: -20vh -10vw auto;
      height: 60vh;
      background:
        radial-gradient(circle at 20% 20%, rgba(255,255,255,0.7) 0, transparent 55%),
        radial-gradient(circle at 80% 10%, rgba(255,255,255,0.6) 0, transparent 55%),
        linear-gradient(135deg, rgba(13,110,253,0.25), rgba(0,188,212,0.15));
      opacity: 0.7;
      z-index: -2;
      pointer-events: none;
    }

    header {
      background: linear-gradient(135deg, var(--primary-dark), var(--accent));
      color: #fff;
      padding: 1.4rem 1rem;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.18);
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(6px);
    }

    .header-inner {
      max-width: 1100px;
      margin: 0 auto;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }

    header h1 {
      margin: 0;
      font-size: 1.45rem;
      letter-spacing: 0.02em;
    }

    header p {
      margin: 0.15rem 0 0;
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.35rem 0.8rem;
      border-radius: 999px;
      background-color: rgba(255, 255, 255, 0.15);
      font-size: 0.8rem;
      align-self: flex-start;
    }

    .badge span { font-size: 1.1rem; }

    main {
      max-width: 1100px;
      margin: 1.5rem auto 2.5rem;
      padding: 0 1rem;
    }

    .card {
      background: #ffffff;
      border-radius: 1rem;
      padding: 1.3rem 1.5rem;
      margin-bottom: 1.3rem;
      box-shadow: 0 8px 25px rgba(13, 110, 253, 0.08);
      border: 1px solid rgba(13, 110, 253, 0.09);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: auto -30% -40%;
      height: 120px;
      background:
        radial-gradient(circle at 10% 0%, rgba(13,110,253,0.06) 0, transparent 55%),
        radial-gradient(circle at 90% 40%, rgba(0,188,212,0.06) 0, transparent 55%);
      z-index: -1;
    }

    .card h2 {
      margin-top: 0;
      font-size: 1.15rem;
      color: var(--primary-dark);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .card h2 span.icon { font-size: 1.25rem; }

    .card p.lead {
      margin-top: 0;
      font-size: 0.9rem;
      color: #476582;
    }

    label {
      font-size: 0.85rem;
      font-weight: 600;
      color: #23405b;
      display: block;
      margin-bottom: 0.2rem;
    }

    input[type="number"],
    input[type="text"] {
      width: 100%;
      padding: 0.4rem 0.55rem;
      border-radius: 0.5rem;
      border: 1px solid #c5d9ec;
      font-size: 0.9rem;
      outline: none;
      background-color: #fafdff;
    }

    input[type="number"]:focus,
    input[type="text"]:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.15);
      background-color: #ffffff;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
      margin-top: 0.5rem;
      background-color: #fdfefe;
    }

    th,
    td {
      padding: 0.4rem 0.5rem;
      border-bottom: 1px solid #dde7f3;
      text-align: right;
      white-space: nowrap;
    }

    th:first-child,
    td:first-child { text-align: left; }

    thead {
      background: linear-gradient(
        90deg,
        rgba(13, 110, 253, 0.1),
        rgba(0, 188, 212, 0.06)
      );
    }

    tfoot td {
      font-weight: 700;
      background-color: #f3f8ff;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      margin-top: 0.6rem;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 0.45rem 0.9rem;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      transition: transform 0.05s ease, box-shadow 0.12s ease,
        background-color 0.12s ease;
    }

    button.primary {
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color: #fff;
      box-shadow: 0 4px 12px rgba(13, 110, 253, 0.35);
    }

    button.secondary {
      background-color: var(--primary-light);
      color: var(--primary-dark);
    }

    button.export {
      background: linear-gradient(135deg, #00c853, #00e676);
      color: #fff;
      box-shadow: 0 4px 12px rgba(0, 200, 83, 0.4);
    }

    button:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }

    .two-column {
      display: grid;
      grid-template-columns: minmax(0, 1.5fr) minmax(0, 1.2fr);
      gap: 1.2rem;
    }

    .status-pill {
      display: inline-flex;
      border-radius: 999px;
      padding: 0.18rem 0.6rem;
      font-size: 0.8rem;
      font-weight: 600;
      align-items: center;
      gap: 0.35rem;
    }

    .status-surplus {
      background-color: #e0ffe9;
      color: #008a2f;
      border: 1px solid #00c853;
    }

    .status-deficit {
      background-color: #ffebee;
      color: #c62828;
      border: 1px solid #ff1744;
    }

    .summary-text {
      font-size: 0.88rem;
      margin-top: 0.5rem;
      color: #36526f;
    }

    .note {
      font-size: 0.78rem;
      color: #627d96;
      margin-top: 0.2rem;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.75rem;
      padding: 0.2rem 0.5rem;
      border-radius: 999px;
      background-color: rgba(13, 110, 253, 0.05);
      color: #2d4c69;
      margin-right: 0.4rem;
      margin-top: 0.2rem;
    }

    canvas {
      background: radial-gradient(circle at top, #f2fbff, #ffffff);
      border-radius: 0.8rem;
      padding: 0.5rem;
    }

    .summary-row-surplus td:nth-child(2),
    .summary-row-surplus td:nth-child(4) {
      background-color: #e0ffe9;
      color: #006622;
      font-weight: 700;
    }

    .summary-row-deficit td:nth-child(2),
    .summary-row-deficit td:nth-child(4) {
      background-color: #ffebee;
      color: #b71c1c;
      font-weight: 700;
    }

    .disclaimer {
      font-size: 0.8rem;
      color: #455a64;
      line-height: 1.5;
    }

    footer {
      text-align: center;
      padding: 0.8rem 1rem 1.2rem;
      font-size: 0.78rem;
      color: #607d8b;
      background: #f1f7fd;
      border-top: 1px solid #d3e1f2;
    }

    .input-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 0.8rem 1rem;
      margin-top: 0.6rem;
    }

    @media (max-width: 768px) {
      header { padding: 1.15rem 1rem; }
      header h1 { font-size: 1.25rem; }
      .two-column { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div>
        <h1>Kalkulator Permintaan & Bekalan Air UMS</h1>
        <p>
          Anggaran demand‚Äìsupply air kampus termasuk sumber alternatif
          (tangkapan air hujan, reuse, air tasik, kondensasi penghawa dingin)
          dan analisis kos‚Äìfaedah kewangan, ekonomi & alam sekitar.
        </p>
      </div>
      <div class="badge">
        <span>üíß</span> Planning-level water & CBA tool
      </div>
    </div>
  </header>

  <main>
    <!-- INPUT KATEGORI DEMAND -->
    <section class="card">
      <h2><span class="icon">üì•</span> Input Permintaan Air Mengikut Kategori</h2>
      <p class="lead">
        Tetapkan kategori (contoh: Asrama, Fakulti & Pentadbiran, Masjid, Sukan)
        bersama bilangan pengguna, kadar penggunaan per kapita, dan faktor
        permintaan puncak (peak factor).
      </p>

      <div class="note">
        Tip: 1 m¬≥/hari = 1,000 L/hari. Peak factor biasa 1.2‚Äì1.5 untuk asrama
        & kawasan tumpuan pelajar.
      </div>

      <div style="overflow-x: auto; margin-top: 0.6rem;">
        <table id="category-input-table">
          <thead>
            <tr>
              <th>Kategori</th>
              <th>Populasi (orang)</th>
              <th>Per kapita (L/org/hari)</th>
              <th>Faktor puncak</th>
            </tr>
          </thead>
          <tbody id="category-body">
            <tr class="category-row">
              <td><input type="text" class="cat-name" value="Asrama" /></td>
              <td><input type="number" class="cat-pop" value="6621" min="0" /></td>
              <td><input type="number" class="cat-percap" value="200" min="0" /></td>
              <td><input type="number" class="cat-peak" value="1.3" min="1" step="0.05" /></td>
            </tr>
            <tr class="category-row">
              <td>
                <input type="text" class="cat-name" value="Fakulti & Pentadbiran" />
              </td>
              <td><input type="number" class="cat-pop" value="8000" min="0" /></td>
              <td><input type="number" class="cat-percap" value="50" min="0" /></td>
              <td><input type="number" class="cat-peak" value="1.2" min="1" step="0.05" /></td>
            </tr>
            <tr class="category-row">
              <td><input type="text" class="cat-name" value="Masjid & Surau" /></td>
              <td><input type="number" class="cat-pop" value="3000" min="0" /></td>
              <td><input type="number" class="cat-percap" value="15" min="0" /></td>
              <td><input type="number" class="cat-peak" value="1.5" min="1" step="0.05" /></td>
            </tr>
            <tr class="category-row">
              <td><input type="text" class="cat-name" value="Sukan & Rekreasi" /></td>
              <td><input type="number" class="cat-pop" value="1500" min="0" /></td>
              <td><input type="number" class="cat-percap" value="60" min="0" /></td>
              <td><input type="number" class="cat-peak" value="1.4" min="1" step="0.05" /></td>
            </tr>
            <tr class="category-row">
              <td>
                <input type="text" class="cat-name"
                       placeholder="Kategori tambahan (jika ada)" />
              </td>
              <td><input type="number" class="cat-pop" min="0" /></td>
              <td><input type="number" class="cat-percap" min="0" /></td>
              <td><input type="number" class="cat-peak" value="1.3" min="1" step="0.05" /></td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="btn-row">
        <button id="add-row-btn" type="button" class="secondary">
          ‚ûï Tambah baris kategori
        </button>
        <button id="calculate-btn" type="button" class="primary">
          üîç Kira permintaan & banding dengan bekalan
        </button>
      </div>
    </section>

    <!-- INPUT SUPPLY (JANS) -->
    <section class="card">
      <h2><span class="icon">üö∞</span> Input Bekalan Air (Supply Sedia Ada)</h2>
      <p class="lead">
        Masukkan anggaran kapasiti bekalan air harian yang diterima kampus
        (daripada JANS dan sumber utama lain). Nilai dalam juta liter sehari (MLD).
      </p>

      <label for="supply-mld">Kapasiti bekalan harian sedia ada (MLD)</label>
      <input type="number" id="supply-mld" value="5" min="0" step="0.1" />
      <div class="note">
        Contoh: jika UMS menerima sekitar 4.5‚Äì5.0 MLD daripada loji rawatan.
      </div>
    </section>

    <!-- PARAMETER TARIF & KEWANGAN -->
    <section class="card">
      <h2><span class="icon">üíπ</span> Parameter Tarif & Kewangan</h2>
      <p class="lead">
        Parameter ini digunakan untuk mengira penjimatan bil air & pembetungan
        serta NPV, BCR, payback dan IRR bagi sumber air alternatif.
      </p>

      <div class="input-grid">
        <div>
          <label for="tariff-water">Tarif air terawat (RM/m¬≥)</label>
          <input type="number" id="tariff-water" value="1.20" min="0" step="0.01" />
        </div>
        <div>
          <label for="tariff-sewer">Kadar pembetungan (RM/m¬≥)</label>
          <input type="number" id="tariff-sewer" value="0.80" min="0" step="0.01" />
        </div>
        <div>
          <label for="analysis-years">Tempoh analisis kewangan (tahun)</label>
          <input type="number" id="analysis-years" value="20" min="1" step="1" />
        </div>
        <div>
          <label for="discount-rate">Kadar diskaun (% setahun)</label>
          <input type="number" id="discount-rate" value="5" min="0" step="0.1" />
        </div>
      </div>

      <div class="note">
        Kebiasaannya kadar diskaun 3‚Äì7% digunakan untuk projek infrastruktur
        awam, bergantung kepada garis panduan agensi.
      </div>
    </section>

    <!-- INPUT SUMBER AIR ALTERNATIF + PERINCIAN CAPEX/OPEX -->
    <section class="card">
      <h2><span class="icon">üíß</span> Sumber Air Alternatif (Extra Supply & CBA)</h2>
      <p class="lead">
        Masukkan kapasiti teknikal, faktor penggunaan, CAPEX dan OPEX bagi
        setiap sumber air alternatif. Gunakan ruangan perincian CAPEX/OPEX
        untuk merekod komponen kos utama (tangki, pam, paip, elektrik, operator dan lain-lain).
      </p>

      <div style="overflow-x: auto; margin-top: 0.6rem;">
        <table id="alt-input-table">
          <thead>
            <tr>
              <th>Sumber</th>
              <th>Kapasiti (m¬≥/hari)</th>
              <th>Faktor penggunaan (% hari/tahun)</th>
              <th>CAPEX (RM)</th>
              <th>Butiran CAPEX (ringkas)</th>
              <th>OPEX tetap (RM/tahun)</th>
              <th>OPEX berubah (RM/m¬≥)</th>
              <th>Butiran OPEX (ringkas)</th>
              <th>Jangka hayat (tahun)</th>
            </tr>
          </thead>
          <tbody id="alt-body">
            <tr class="alt-row">
              <td><input type="text" class="alt-name" value="Tangkapan air hujan" /></td>
              <td><input type="number" class="alt-capacity" value="300" min="0" /></td>
              <td><input type="number" class="alt-util" value="80" min="0" max="100" /></td>
              <td><input type="number" class="alt-capex" value="1200000" min="0" /></td>
              <td><input type="text" class="alt-capex-note"
                         value="Struktur tangki, gutter, paip agihan, pam dan panel kawalan" /></td>
              <td><input type="number" class="alt-opex-fixed" value="60000" min="0" /></td>
              <td><input type="number" class="alt-opex-var" value="0.10" min="0" step="0.01" /></td>
              <td><input type="text" class="alt-opex-note"
                         value="Elektrik pam, penyelenggaraan berkala dan pembersihan tangki" /></td>
              <td><input type="number" class="alt-life" value="25" min="1" /></td>
            </tr>
            <tr class="alt-row">
              <td><input type="text" class="alt-name" value="Air tasik / tasik kampus" /></td>
              <td><input type="number" class="alt-capacity" value="200" min="0" /></td>
              <td><input type="number" class="alt-util" value="70" min="0" max="100" /></td>
              <td><input type="number" class="alt-capex" value="900000" min="0" /></td>
              <td><input type="text" class="alt-capex-note"
                         value="Pam pengambilan, paip penghantaran, sistem rawatan asas" /></td>
              <td><input type="number" class="alt-opex-fixed" value="45000" min="0" /></td>
              <td><input type="number" class="alt-opex-var" value="0.15" min="0" step="0.01" /></td>
              <td><input type="text" class="alt-opex-note"
                         value="Elektrik, bahan kimia rawatan, operator dan penyelenggaraan" /></td>
              <td><input type="number" class="alt-life" value="20" min="1" /></td>
            </tr>
            <tr class="alt-row">
              <td><input type="text" class="alt-name" value="Reuse (greywater / RO)" /></td>
              <td><input type="number" class="alt-capacity" value="250" min="0" /></td>
              <td><input type="number" class="alt-util" value="80" min="0" max="100" /></td>
              <td><input type="number" class="alt-capex" value="1500000" min="0" /></td>
              <td><input type="text" class="alt-capex-note"
                         value="Sistem rawatan, tangki imbangan, rangkaian paip dua paip" /></td>
              <td><input type="number" class="alt-opex-fixed" value="90000" min="0" /></td>
              <td><input type="number" class="alt-opex-var" value="0.25" min="0" step="0.01" /></td>
              <td><input type="text" class="alt-opex-note"
                         value="Elektrik loji, bahan kimia, alat ganti, operator" /></td>
              <td><input type="number" class="alt-life" value="20" min="1" /></td>
            </tr>
            <tr class="alt-row">
              <td><input type="text" class="alt-name" value="Kondensasi penghawa dingin" /></td>
              <td><input type="number" class="alt-capacity" value="50" min="0" /></td>
              <td><input type="number" class="alt-util" value="90" min="0" max="100" /></td>
              <td><input type="number" class="alt-capex" value="200000" min="0" /></td>
              <td><input type="text" class="alt-capex-note"
                         value="Pengumpulan kondensat, tangki kecil, pam edaran" /></td>
              <td><input type="number" class="alt-opex-fixed" value="15000" min="0" /></td>
              <td><input type="number" class="alt-opex-var" value="0.05" min="0" step="0.01" /></td>
              <td><input type="text" class="alt-opex-note"
                         value="Elektrik pam dan penyelenggaraan ringan" /></td>
              <td><input type="number" class="alt-life" value="15" min="1" /></td>
            </tr>
            <tr class="alt-row">
              <td><input type="text" class="alt-name" placeholder="Sumber tambahan" /></td>
              <td><input type="number" class="alt-capacity" min="0" /></td>
              <td><input type="number" class="alt-util" min="0" max="100" /></td>
              <td><input type="number" class="alt-capex" min="0" /></td>
              <td><input type="text" class="alt-capex-note" placeholder="Butiran CAPEX (jika perlu)" /></td>
              <td><input type="number" class="alt-opex-fixed" min="0" /></td>
              <td><input type="number" class="alt-opex-var" min="0" step="0.01" /></td>
              <td><input type="text" class="alt-opex-note" placeholder="Butiran OPEX (jika perlu)" /></td>
              <td><input type="number" class="alt-life" min="1" /></td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="btn-row">
        <button id="add-alt-row-btn" type="button" class="secondary">
          ‚ûï Tambah baris sumber alternatif
        </button>
      </div>
    </section>

    <!-- ANALISIS KATEGORI DEMAND -->
    <section class="card">
      <h2><span class="icon">üìä</span> Analisis Permintaan Air Mengikut Kategori</h2>
      <p class="lead">
        Jadual ini menunjukkan permintaan purata dan puncak (peak) bagi setiap
        kategori berdasarkan input yang dimasukkan.
      </p>

      <div style="overflow-x: auto;">
        <table id="results-table">
          <thead>
            <tr>
              <th>Kategori</th>
              <th>Populasi</th>
              <th>Per kapita (L/org/hari)</th>
              <th>Purata (m¬≥/hari)</th>
              <th>Faktor puncak</th>
              <th>Permintaan puncak (m¬≥/hari)</th>
            </tr>
          </thead>
          <tbody id="results-body">
            <!-- JS akan isi -->
          </tbody>
          <tfoot>
            <tr>
              <td>Jumlah</td>
              <td id="total-pop">‚Äì</td>
              <td>‚Äì</td>
              <td id="total-avg-m3">‚Äì</td>
              <td>‚Äì</td>
              <td id="total-peak-m3">‚Äì</td>
            </tr>
            <tr>
              <td>Jumlah dalam MLD</td>
              <td colspan="2"></td>
              <td id="total-avg-mld">‚Äì</td>
              <td></td>
              <td id="total-peak-mld">‚Äì</td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="chip">üîπ Purata = Populasi √ó Per kapita / 1,000</div>
      <div class="chip">üîπ Puncak = Purata √ó Faktor puncak</div>
    </section>

    <!-- DEMAND VS SUPPLY + EXPORT -->
    <section class="card">
      <h2><span class="icon">‚öñÔ∏è</span> Ringkasan Demand‚ÄìSupply (MLD)</h2>
      <div class="two-column">
        <div>
          <table id="summary-table">
            <thead>
              <tr>
                <th>Item</th>
                <th>Nilai (MLD)</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <tr id="row-avg">
                <td>Jumlah permintaan purata</td>
                <td id="summary-avg-mld">‚Äì</td>
                <td id="status-avg">‚Äì</td>
              </tr>
              <tr id="row-peak">
                <td>Jumlah permintaan puncak</td>
                <td id="summary-peak-mld">‚Äì</td>
                <td id="status-peak">‚Äì</td>
              </tr>
              <tr>
                <td>Bekalan sedia ada (JANS)</td>
                <td id="supply-avg-mld">‚Äì</td>
                <td></td>
              </tr>
              <tr>
                <td>Extra supply (air hujan / reuse / tasik / AC)</td>
                <td id="alt-supply-mld">‚Äì</td>
                <td></td>
              </tr>
              <tr>
                <td><strong>Bekalan efektif (JANS + sumber alternatif)</strong></td>
                <td id="effective-supply-mld">‚Äì</td>
                <td></td>
              </tr>
              <tr>
                <td>Surplus / Defisit purata</td>
                <td id="surplus-avg-mld">‚Äì</td>
                <td></td>
              </tr>
              <tr>
                <td>Surplus / Defisit semasa puncak</td>
                <td id="surplus-peak-mld">‚Äì</td>
                <td></td>
              </tr>
            </tbody>
          </table>

          <div class="btn-row" style="margin-top: 0.8rem;">
            <button id="export-excel-btn" type="button" class="export">
              üì§ Export Excel (.xlsx)
            </button>
            <button id="export-pdf-btn" type="button" class="secondary">
              üìÑ Jana Laporan PDF
            </button>
          </div>

          <div class="summary-text" id="summary-text">
            Tekan butang <strong>‚ÄúKira permintaan & banding dengan bekalan‚Äù</strong>
            untuk melihat ringkasan analisis termasuk kesan sumber alternatif.
          </div>
        </div>

        <div>
          <canvas id="demand-by-category-chart" height="200"></canvas>
        </div>
      </div>
    </section>

    <!-- PIE CHART DEMAND SHARE -->
    <section class="card">
      <h2><span class="icon">üìà</span> Agihan Permintaan Mengikut Kategori</h2>
      <p class="lead">
        Rajah menunjukkan sumbangan (%) setiap kategori kepada permintaan purata
        keseluruhan kampus.
      </p>
      <canvas id="demand-share-chart" height="200"></canvas>
    </section>

    <!-- ANALISIS CBA SUMBER ALTERNATIF -->
    <section class="card">
      <h2><span class="icon">üíº</span> Analisis Kewangan Sumber Air Alternatif</h2>
      <p class="lead">
        Jadual di bawah merumuskan volum, penjimatan, CAPEX, OPEX, aliran tunai
        bersih, payback period, NPV dan BCR bagi setiap sumber air alternatif.
      </p>

      <div style="overflow-x: auto;">
        <table id="alt-results-table">
          <thead>
            <tr>
              <th>Sumber</th>
              <th>Kapasiti (m¬≥/hari)</th>
              <th>Utilisasi (% hari)</th>
              <th>Vol. tahunan (m¬≥/tahun)</th>
              <th>CAPEX (RM)</th>
              <th>OPEX tahunan (RM/tahun)</th>
              <th>Saving air + pembetungan (RM/tahun)</th>
              <th>CF bersih (RM/tahun)</th>
              <th>Payback (tahun)</th>
              <th>NPV (RM)</th>
              <th>BCR</th>
            </tr>
          </thead>
          <tbody id="alt-results-body">
            <!-- JS akan isi -->
          </tbody>
          <tfoot>
            <tr>
              <td>Jumlah / Agregat</td>
              <td id="alt-total-capacity">‚Äì</td>
              <td>‚Äì</td>
              <td id="alt-total-volume">‚Äì</td>
              <td id="alt-total-capex">‚Äì</td>
              <td id="alt-total-opex">‚Äì</td>
              <td id="alt-total-saving">‚Äì</td>
              <td id="alt-total-netcf">‚Äì</td>
              <td>‚Äì</td>
              <td id="alt-total-npv">‚Äì</td>
              <td id="alt-total-bcr">‚Äì</td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="two-column" style="margin-top: 1rem;">
        <div>
          <h3 style="font-size:0.96rem; margin-top:0;">Ringkasan Kewangan Projek</h3>
          <table id="alt-summary-table">
            <tbody>
              <tr>
                <td>Jumlah CAPEX semua sumber</td>
                <td id="sum-capex">‚Äì</td>
              </tr>
              <tr>
                <td>Jumlah penjimatan air + pembetungan / tahun</td>
                <td id="sum-saving">‚Äì</td>
              </tr>
              <tr>
                <td>Jumlah OPEX / tahun</td>
                <td id="sum-opex">‚Äì</td>
              </tr>
              <tr>
                <td>Aliran tunai bersih tahunan</td>
                <td id="sum-netcf">‚Äì</td>
              </tr>
              <tr>
                <td>NPV projek (semua sumber)</td>
                <td id="sum-npv">‚Äì</td>
              </tr>
              <tr>
                <td>BCR projek (semua sumber)</td>
                <td id="sum-bcr">‚Äì</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div>
          <canvas id="cba-npv-chart" height="200" style="margin-bottom:0.8rem;"></canvas>
          <canvas id="cba-payback-chart" height="200"></canvas>
        </div>
      </div>
    </section>

    <!-- ANALISIS EKONOMI (SHADOW PRICE) & ALAM SEKITAR -->
    <section class="card">
      <h2><span class="icon">üåè</span> Analisis Ekonomi (Harga Bayangan) & Manfaat Alam Sekitar</h2>
      <p class="lead">
        Analisis ini mengaplikasi harga bayangan air dan anggaran manfaat
        alam sekitar (pengurangan CO‚ÇÇ dan NRW) selari dengan amalan penilaian
        projek awam.
      </p>

      <div class="input-grid">
        <div>
          <label for="shadow-multiplier">Faktor harga bayangan air</label>
          <input type="number" id="shadow-multiplier" value="1.20" step="0.05" min="1" />
          <div class="note">
            Contoh: 1.2 bermaksud harga bayangan 20% lebih tinggi daripada tarif
            kewangan (air + pembetungan).
          </div>
        </div>
        <div>
          <label for="co2-factor">Faktor pelepasan CO‚ÇÇ air terawat (kg CO‚ÇÇ/m¬≥)</label>
          <input type="number" id="co2-factor" value="0.40" step="0.01" min="0" />
          <div class="note">
            Digunakan untuk anggaran pengurangan pelepasan CO‚ÇÇ apabila sebahagian
            permintaan dipenuhi oleh sumber alternatif.
          </div>
        </div>
        <div>
          <label for="carbon-price">Harga karbon (RM/tan CO‚ÇÇ)</label>
          <input type="number" id="carbon-price" value="150" step="10" min="0" />
        </div>
        <div>
          <label for="nrw-avoid">NRW dielakkan oleh sumber alternatif (%)</label>
          <input type="number" id="nrw-avoid" value="10" step="1" min="0" max="100" />
          <div class="note">
            Anggaran peratus kehilangan bukan hasil (NRW) yang dapat dielakkan
            apabila sebahagian bekalan diganti dengan sumber setempat.
          </div>
        </div>
      </div>

      <table id="econ-env-table" style="margin-top:1rem;">
        <tbody>
          <tr>
            <td>Harga bayangan air (RM/m¬≥)</td>
            <td id="shadow-price-val">‚Äì</td>
          </tr>
          <tr>
            <td>Faedah ekonomi tahunan (RM/tahun)</td>
            <td id="eco-annual-benefit">‚Äì</td>
          </tr>
          <tr>
            <td>NPV ekonomi projek (RM)</td>
            <td id="eco-npv">‚Äì</td>
          </tr>
          <tr>
            <td>BCR ekonomi projek</td>
            <td id="eco-bcr">‚Äì</td>
          </tr>
          <tr>
            <td>CO‚ÇÇ dielakkan (tan/tahun)</td>
            <td id="co2-saved">‚Äì</td>
          </tr>
          <tr>
            <td>Nilai ekonomi karbon (RM/tahun)</td>
            <td id="carbon-value">‚Äì</td>
          </tr>
          <tr>
            <td>NRW dielakkan (m¬≥/tahun)</td>
            <td id="nrw-saved">‚Äì</td>
          </tr>
        </tbody>
      </table>
    </section>

    <!-- SENARIO FASA & IRR -->
    <section class="card">
      <h2><span class="icon">üìÜ</span> Senario Fasa (Tahun 1‚Äì5) & IRR Projek</h2>
      <p class="lead">
        Senario ini membenarkan projek dilaksanakan secara berfasa dalam tempoh
        lima tahun pertama. IRR dikira berdasarkan aliran tunai bersih agregat
        dengan sensitiviti ¬±20% tarif air.
      </p>

      <div class="input-grid">
        <div>
          <label for="phase-year1">Fasa Tahun 1 (0‚Äì1)</label>
          <input type="number" id="phase-year1" class="phase-factor" value="0.40" step="0.1" min="0" max="1" />
        </div>
        <div>
          <label for="phase-year2">Fasa Tahun 2 (0‚Äì1)</label>
          <input type="number" id="phase-year2" class="phase-factor" value="0.60" step="0.1" min="0" max="1" />
        </div>
        <div>
          <label for="phase-year3">Fasa Tahun 3 (0‚Äì1)</label>
          <input type="number" id="phase-year3" class="phase-factor" value="0.80" step="0.1" min="0" max="1" />
        </div>
        <div>
          <label for="phase-year4">Fasa Tahun 4 (0‚Äì1)</label>
          <input type="number" id="phase-year4" class="phase-factor" value="1.00" step="0.1" min="0" max="1" />
        </div>
        <div>
          <label for="phase-year5">Fasa Tahun 5 (0‚Äì1)</label>
          <input type="number" id="phase-year5" class="phase-factor" value="1.00" step="0.1" min="0" max="1" />
        </div>
      </div>

      <table id="irr-table" style="margin-top:1rem;">
        <tbody>
          <tr>
            <td>IRR asas projek (%)</td>
            <td id="irr-base">‚Äì</td>
          </tr>
          <tr>
            <td>IRR sensitiviti tarif ‚àí20% (%)</td>
            <td id="irr-low">‚Äì</td>
          </tr>
          <tr>
            <td>IRR sensitiviti tarif +20% (%)</td>
            <td id="irr-high">‚Äì</td>
          </tr>
        </tbody>
      </table>
      <div class="note" style="margin-top:0.4rem;">
        Nota: CAPEX diandaikan ditanggung pada tahun 0, manakala faedah dan OPEX
        ditingkatkan secara berperingkat berdasarkan faktor fasa Tahun 1‚Äì5.
      </div>
    </section>

    <!-- METODOLOGI + DISCLAIMER -->
    <section class="card">
      <h2><span class="icon">üßÆ</span> Nota Metodologi (Ringkas) & Penafian</h2>
      <div class="disclaimer">
        <p><strong>Metodologi ringkas:</strong></p>
        <ul style="margin-top: 0.2rem; padding-left: 1.1rem;">
          <li>
            <strong>Langkah 1 ‚Äì Per kapita:</strong> Untuk setiap kategori demand,
            permintaan purata dikira berdasarkan bilangan pengguna dikali kadar
            penggunaan per kapita (L/org/hari), ditukar kepada m¬≥/hari.
          </li>
          <li>
            <strong>Langkah 2 ‚Äì Permintaan puncak:</strong> Nilai purata
            digandakan dengan faktor puncak (contoh 1.3) bagi menggambarkan hari
            atau masa penggunaan tertinggi.
          </li>
          <li>
            <strong>Langkah 3 ‚Äì Extra supply:</strong> Kapasiti sumber air
            alternatif ditukar kepada bekalan efektif (m¬≥/hari) menggunakan
            faktor penggunaan (% hari/tahun) dan ditambah kepada bekalan JANS.
          </li>
          <li>
            <strong>Langkah 4 ‚Äì Penjimatan & CBA:</strong> Volum air alternatif
            dikalikan dengan tarif air + pembetungan untuk mendapatkan penjimatan
            tahunan, ditolak OPEX untuk mendapatkan aliran tunai bersih.
            NPV, BCR, payback dan IRR dikira menggunakan tempoh analisis dan
            kadar diskaun yang ditetapkan.
          </li>
          <li>
            <strong>Langkah 5 ‚Äì Analisis ekonomi & alam sekitar:</strong> Harga
            bayangan air diaplikasi bagi mencerminkan nilai sosial air yang
            lebih tinggi berbanding tarif kewangan. Manfaat alam sekitar
            dianggarkan melalui pengurangan CO‚ÇÇ dan NRW.
          </li>
          <li>
            <strong>Langkah 6 ‚Äì Fasa pelaksanaan:</strong> Fasa tahun 1‚Äì5
            digunakan untuk menskalakan aliran faedah dan kos operasi mengikut
            jadual penyerapan projek.
          </li>
        </ul>

        <p style="margin-top: 0.7rem;"><strong>Penafian:</strong></p>
        <p>
          Kalkulator ini disediakan untuk tujuan perancangan dan analisis awal
          (planning-level estimate) berdasarkan andaian input pengguna. Nilai
          yang dijana bukanlah rekod rasmi penggunaan atau bekalan air
          Universiti Malaysia Sabah dan tidak menggantikan data meter/bil air
          yang disahkan oleh pihak berkuasa berkaitan. Sebarang keputusan
          kejuruteraan atau pelaburan sebenar hendaklah dirujuk dan disahkan
          dengan data teknikal terperinci serta pihak berkepentingan rasmi.
        </p>
      </div>
    </section>
  </main>

  <footer>
    ¬© 2025 Assis, Fera, Sarimah, Sani RuWaS UMS. All rights reserved.
  </footer>

  <script>
    // Simpan sumber alternatif terakhir (untuk PDF naratif perincian CAPEX/OPEX)
    let lastAltSources = [];

    window.addEventListener("DOMContentLoaded", () => {
      const addRowBtn = document.getElementById("add-row-btn");
      const calcBtn = document.getElementById("calculate-btn");
      const exportBtn = document.getElementById("export-excel-btn");
      const pdfBtn = document.getElementById("export-pdf-btn");
      const categoryBody = document.getElementById("category-body");

      const addAltRowBtn = document.getElementById("add-alt-row-btn");
      const altBody = document.getElementById("alt-body");

      const resultsBody = document.getElementById("results-body");
      const totalPopEl = document.getElementById("total-pop");
      const totalAvgM3El = document.getElementById("total-avg-m3");
      const totalPeakM3El = document.getElementById("total-peak-m3");
      const totalAvgMLDEl = document.getElementById("total-avg-mld");
      const totalPeakMLDEl = document.getElementById("total-peak-mld");

      const supplyInput = document.getElementById("supply-mld");
      const summaryAvgMLDEl = document.getElementById("summary-avg-mld");
      const summaryPeakMLDEl = document.getElementById("summary-peak-mld");
      const supplyAvgMLDEl = document.getElementById("supply-avg-mld");
      const altSupplyMLDEl = document.getElementById("alt-supply-mld");
      const effectiveSupplyMLDEl = document.getElementById("effective-supply-mld");
      const surplusAvgMLDEl = document.getElementById("surplus-avg-mld");
      const surplusPeakMLDEl = document.getElementById("surplus-peak-mld");
      const statusAvgEl = document.getElementById("status-avg");
      const statusPeakEl = document.getElementById("status-peak");
      const summaryTextEl = document.getElementById("summary-text");

      const rowAvg = document.getElementById("row-avg");
      const rowPeak = document.getElementById("row-peak");

      // CBA elements
      const altResultsBody = document.getElementById("alt-results-body");
      const altTotalCapacityEl = document.getElementById("alt-total-capacity");
      const altTotalVolumeEl = document.getElementById("alt-total-volume");
      const altTotalCapexEl = document.getElementById("alt-total-capex");
      const altTotalOpexEl = document.getElementById("alt-total-opex");
      const altTotalSavingEl = document.getElementById("alt-total-saving");
      const altTotalNetCFEl = document.getElementById("alt-total-netcf");
      const altTotalNPVEl = document.getElementById("alt-total-npv");
      const altTotalBCREl = document.getElementById("alt-total-bcr");

      const sumCapexEl = document.getElementById("sum-capex");
      const sumSavingEl = document.getElementById("sum-saving");
      const sumOpexEl = document.getElementById("sum-opex");
      const sumNetCFEl = document.getElementById("sum-netcf");
      const sumNPVEl = document.getElementById("sum-npv");
      const sumBCREl = document.getElementById("sum-bcr");

      // Ekonomi & alam sekitar
      const shadowMultiplierInput = document.getElementById("shadow-multiplier");
      const co2FactorInput = document.getElementById("co2-factor");
      const carbonPriceInput = document.getElementById("carbon-price");
      const nrwAvoidInput = document.getElementById("nrw-avoid");

      const shadowPriceEl = document.getElementById("shadow-price-val");
      const ecoAnnualBenefitEl = document.getElementById("eco-annual-benefit");
      const ecoNPVEl = document.getElementById("eco-npv");
      const ecoBCREl = document.getElementById("eco-bcr");
      const co2SavedEl = document.getElementById("co2-saved");
      const carbonValueEl = document.getElementById("carbon-value");
      const nrwSavedVolEl = document.getElementById("nrw-saved");

      // IRR & fasa
      const phaseInputs = [
        document.getElementById("phase-year1"),
        document.getElementById("phase-year2"),
        document.getElementById("phase-year3"),
        document.getElementById("phase-year4"),
        document.getElementById("phase-year5"),
      ];
      const irrBaseEl = document.getElementById("irr-base");
      const irrLowEl = document.getElementById("irr-low");
      const irrHighEl = document.getElementById("irr-high");

      // Parameter kewangan
      const tariffWaterInput = document.getElementById("tariff-water");
      const tariffSewerInput = document.getElementById("tariff-sewer");
      const analysisYearsInput = document.getElementById("analysis-years");
      const discountRateInput = document.getElementById("discount-rate");

      const categoryChartCtx = document
        .getElementById("demand-by-category-chart")
        .getContext("2d");
      const shareChartCtx = document
        .getElementById("demand-share-chart")
        .getContext("2d");
      const cbaNPVCtx = document
        .getElementById("cba-npv-chart")
        .getContext("2d");
      const cbaPaybackCtx = document
        .getElementById("cba-payback-chart")
        .getContext("2d");

      let categoryChart = null;
      let shareChart = null;
      let cbaNpvChart = null;
      let cbaPaybackChart = null;

      function formatNumber(num) {
        if (!isFinite(num)) return "‚Äì";
        return num.toLocaleString("ms-MY", { maximumFractionDigits: 2 });
      }

      function formatPercent(num) {
        if (!isFinite(num)) return "‚Äì";
        return num.toLocaleString("ms-MY", {
          maximumFractionDigits: 2,
        }) + " %";
      }

      function createStatusPill(status, isPeak) {
        if (!status) return "";
        const cls =
          status === "Surplus" ? "status-surplus" : "status-deficit";
        const label =
          status === "Surplus"
            ? isPeak
              ? "Surplus (puncak)"
              : "Surplus"
            : isPeak
            ? "Defisit (puncak)"
            : "Defisit";
        return `<span class="status-pill ${cls}">${
          status === "Surplus" ? "‚úîÔ∏è" : "‚ö†Ô∏è"
        } ${label}</span>`;
      }

      function computeIRR(cashflows, guess = 0.08) {
        // Bisection method between -0.9 and 1.0
        const npv = (rate) => {
          let total = cashflows[0];
          for (let t = 1; t < cashflows.length; t++) {
            total += cashflows[t] / Math.pow(1 + rate, t);
          }
          return total;
        };

        let low = -0.9;
        let high = 1.0;
        let npvLow = npv(low);
        let npvHigh = npv(high);

        if (npvLow * npvHigh > 0) {
          return NaN; // tiada akar jelas
        }

        for (let i = 0; i < 60; i++) {
          const mid = (low + high) / 2;
          const npvMid = npv(mid);
          if (Math.abs(npvMid) < 1e-6) {
            return mid * 100;
          }
          if (npvLow * npvMid < 0) {
            high = mid;
            npvHigh = npvMid;
          } else {
            low = mid;
            npvLow = npvMid;
          }
        }
        return ((low + high) / 2) * 100;
      }

      function calculate() {
        // 1. Demand by category
        const rows = Array.from(document.querySelectorAll(".category-row"));
        const categoryNames = [];
        const peakDemands = [];
        const avgDemands = [];

        let totalPop = 0;
        let totalAvgM3 = 0;
        let totalPeakM3 = 0;

        resultsBody.innerHTML = "";

        rows.forEach((row) => {
          const nameInput = row.querySelector(".cat-name");
          const popInput = row.querySelector(".cat-pop");
          const perCapInput = row.querySelector(".cat-percap");
          const peakInput = row.querySelector(".cat-peak");

          const name = (nameInput.value || "").trim();
          const pop = parseFloat(popInput.value);
          const perCap = parseFloat(perCapInput.value);
          const peak = parseFloat(peakInput.value);

          if (!name || !isFinite(pop) || pop <= 0 || !isFinite(perCap)) {
            return;
          }

          const avgM3 = (pop * perCap) / 1000;
          const peakM3 = avgM3 * (isFinite(peak) && peak > 0 ? peak : 1);

          totalPop += pop;
          totalAvgM3 += avgM3;
          totalPeakM3 += peakM3;

          categoryNames.push(name);
          avgDemands.push(avgM3);
          peakDemands.push(peakM3);

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${name}</td>
            <td>${formatNumber(pop)}</td>
            <td>${formatNumber(perCap)}</td>
            <td>${formatNumber(avgM3)}</td>
            <td>${isFinite(peak) ? formatNumber(peak) : "‚Äì"}</td>
            <td>${formatNumber(peakM3)}</td>
          `;
          resultsBody.appendChild(tr);
        });

        const totalAvgMLD = totalAvgM3 / 1000;
        const totalPeakMLD = totalPeakM3 / 1000;

        totalPopEl.textContent = totalPop ? formatNumber(totalPop) : "‚Äì";
        totalAvgM3El.textContent = formatNumber(totalAvgM3);
        totalPeakM3El.textContent = formatNumber(totalPeakM3);
        totalAvgMLDEl.textContent = formatNumber(totalAvgMLD);
        totalPeakMLDEl.textContent = formatNumber(totalPeakMLD);

        // 2. Baseline supply (JANS)
        const supplyBaseMLD = parseFloat(supplyInput.value);
        const supplyValid = isFinite(supplyBaseMLD) && supplyBaseMLD >= 0;

        supplyAvgMLDEl.textContent = supplyValid
          ? formatNumber(supplyBaseMLD)
          : "‚Äì";

        // 3. Alternative supply + build altData for CBA
        const altRows = Array.from(document.querySelectorAll(".alt-row"));
        let altAvgM3PerDayTotal = 0;
        const altData = [];

        altRows.forEach((row) => {
          const name = (row.querySelector(".alt-name").value || "").trim();
          const cap = parseFloat(row.querySelector(".alt-capacity").value);
          const util = parseFloat(row.querySelector(".alt-util").value);
          const capex = parseFloat(row.querySelector(".alt-capex").value);
          const capexNote = (row.querySelector(".alt-capex-note")?.value || "").trim();
          const opexFixed = parseFloat(
            row.querySelector(".alt-opex-fixed").value
          );
          const opexVar = parseFloat(
            row.querySelector(".alt-opex-var").value
          );
          const opexNote = (row.querySelector(".alt-opex-note")?.value || "").trim();
          const lifeYears = parseFloat(row.querySelector(".alt-life").value);

          if (!name || !isFinite(cap) || cap <= 0 || !isFinite(util) || util <= 0) {
            return;
          }

          const avgM3PerDayEff = cap * (util / 100);
          altAvgM3PerDayTotal += avgM3PerDayEff;

          altData.push({
            name,
            capacity: cap,
            utilPercent: util,
            capex: isFinite(capex) ? capex : 0,
            capexNote,
            opexFixed: isFinite(opexFixed) ? opexFixed : 0,
            opexVar: isFinite(opexVar) ? opexVar : 0,
            opexNote,
            lifeYears: isFinite(lifeYears) ? lifeYears : NaN,
          });
        });

        const altSupplyMLD = altAvgM3PerDayTotal / 1000;
        altSupplyMLDEl.textContent = altData.length
          ? formatNumber(altSupplyMLD)
          : "0.00";

        const effectiveSupplyMLD = (supplyValid ? supplyBaseMLD : 0) + altSupplyMLD;
        effectiveSupplyMLDEl.textContent = effectiveSupplyMLD
          ? formatNumber(effectiveSupplyMLD)
          : "‚Äì";

        // 4. Demand vs effective supply
        summaryAvgMLDEl.textContent = formatNumber(totalAvgMLD);
        summaryPeakMLDEl.textContent = formatNumber(totalPeakMLD);

        let surplusAvg = null;
        let surplusPeak = null;
        let statusAvg = "";
        let statusPeak = "";

        rowAvg.classList.remove("summary-row-surplus", "summary-row-deficit");
        rowPeak.classList.remove("summary-row-surplus", "summary-row-deficit");

        if (effectiveSupplyMLD > 0) {
          surplusAvg = effectiveSupplyMLD - totalAvgMLD;
          surplusPeak = effectiveSupplyMLD - totalPeakMLD;

          surplusAvgMLDEl.textContent = formatNumber(surplusAvg);
          surplusPeakMLDEl.textContent = formatNumber(surplusPeak);

          if (totalAvgMLD > 0) {
            statusAvg = surplusAvg >= 0 ? "Surplus" : "Deficit";
          }
          if (totalPeakMLD > 0) {
            statusPeak = surplusPeak >= 0 ? "Surplus" : "Deficit";
          }

          if (statusAvg === "Surplus") {
            rowAvg.classList.add("summary-row-surplus");
          } else if (statusAvg === "Deficit") {
            rowAvg.classList.add("summary-row-deficit");
          }

          if (statusPeak === "Surplus") {
            rowPeak.classList.add("summary-row-surplus");
          } else if (statusPeak === "Deficit") {
            rowPeak.classList.add("summary-row-deficit");
          }
        } else {
          surplusAvgMLDEl.textContent = "‚Äì";
          surplusPeakMLDEl.textContent = "‚Äì";
        }

        statusAvgEl.innerHTML = createStatusPill(statusAvg, false);
        statusPeakEl.innerHTML = createStatusPill(statusPeak, true);

        // 5. Ringkasan teks
        if (!categoryNames.length) {
          summaryTextEl.innerHTML =
            "Sila masukkan sekurang-kurangnya satu kategori dengan populasi dan kadar per kapita untuk menjana analisis.";
        } else if (!supplyValid && !altData.length) {
          summaryTextEl.innerHTML =
            "Permintaan purata dianggarkan sebanyak <strong>" +
            formatNumber(totalAvgMLD) +
            " MLD</strong>, manakala permintaan puncak sebanyak <strong>" +
            formatNumber(totalPeakMLD) +
            " MLD</strong>. Sila masukkan nilai bekalan JANS dan/atau sumber alternatif untuk menilai surplus atau defisit.";
        } else {
          const baseText = supplyValid
            ? "Bekalan sedia ada (JANS) dianggarkan <strong>" +
              formatNumber(supplyBaseMLD) +
              " MLD</strong>."
            : "Bekalan JANS tidak ditetapkan dengan jelas.";

          const altText = altData.length
            ? " Sumber alternatif menambah kira-kira <strong>" +
              formatNumber(altSupplyMLD) +
              " MLD</strong> kepada bekalan."
            : " Tiada sumber alternatif dimasukkan setakat ini.";

          const effText =
            " Bekalan efektif (JANS + alternatif) dianggarkan <strong>" +
            formatNumber(effectiveSupplyMLD) +
            " MLD</strong>.";

          const avgWord = surplusAvg >= 0 ? "surplus" : "defisit";
          const peakWord = surplusPeak >= 0 ? "surplus" : "defisit";

          summaryTextEl.innerHTML =
            baseText +
            altText +
            effText +
            " Jumlah permintaan purata kampus dianggarkan <strong>" +
            formatNumber(totalAvgMLD) +
            " MLD</strong> (" +
            avgWord +
            " " +
            formatNumber(Math.abs(surplusAvg)) +
            " MLD), manakala permintaan puncak dianggarkan <strong>" +
            formatNumber(totalPeakMLD) +
            " MLD</strong> (" +
            peakWord +
            " " +
            formatNumber(Math.abs(surplusPeak)) +
            " MLD).";
        }

        // 6. Update demand charts
        updateDemandCharts(categoryNames, avgDemands, peakDemands);

        // 7. CBA for alternative sources + ekonomi & alam sekitar + IRR
        calculateAltCBA(altData);
      }

      function updateDemandCharts(labels, avgData, peakData) {
        if (categoryChart) categoryChart.destroy();
        if (shareChart) shareChart.destroy();

        if (!labels.length) return;

        categoryChart = new Chart(categoryChartCtx, {
          type: "bar",
          data: {
            labels,
            datasets: [
              {
                label: "Purata (m¬≥/hari)",
                data: avgData,
                backgroundColor: "rgba(13, 110, 253, 0.7)",
                borderRadius: 6,
              },
              {
                label: "Puncak (m¬≥/hari)",
                data: peakData,
                backgroundColor: "rgba(0, 188, 212, 0.7)",
                borderRadius: 6,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: "top" },
              title: {
                display: true,
                text: "Permintaan Air Mengikut Kategori",
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                title: { display: true, text: "m¬≥/hari" },
              },
            },
          },
        });

        shareChart = new Chart(shareChartCtx, {
          type: "pie",
          data: {
            labels,
            datasets: [
              {
                data: avgData,
                backgroundColor: [
                  "rgba(13, 110, 253, 0.85)",
                  "rgba(0, 188, 212, 0.85)",
                  "rgba(3, 169, 244, 0.85)",
                  "rgba(0, 150, 136, 0.85)",
                  "rgba(63, 81, 181, 0.85)",
                  "rgba(33, 150, 243, 0.85)",
                ],
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: "right" },
              title: {
                display: true,
                text: "Agihan Permintaan Purata Mengikut Kategori",
              },
            },
          },
        });
      }

      function calculateAltCBA(altData) {
        // Clear jika tiada data
        altResultsBody.innerHTML = "";
        if (cbaNpvChart) cbaNpvChart.destroy();
        if (cbaPaybackChart) cbaPaybackChart.destroy();

        const tariffWater = parseFloat(tariffWaterInput.value) || 0;
        const tariffSewer = parseFloat(tariffSewerInput.value) || 0;
        const tariffTotal = tariffWater + tariffSewer;

        const analysisYears = parseInt(analysisYearsInput.value, 10) || 0;
        const discountRate = parseFloat(discountRateInput.value) || 0;
        const r = discountRate / 100;

        let totalCap = 0;
        let totalVol = 0;
        let totalCapex = 0;
        let totalOpex = 0;
        let totalSaving = 0;
        let totalNetCF = 0;

        let totalPVBenefits = 0;
        let totalPVCosts = 0;

        const labels = [];
        const npvData = [];
        const paybackData = [];

        if (!altData.length || analysisYears <= 0) {
          altTotalCapacityEl.textContent = "0.00";
          altTotalVolumeEl.textContent = "0.00";
          altTotalCapexEl.textContent = "0.00";
          altTotalOpexEl.textContent = "0.00";
          altTotalSavingEl.textContent = "0.00";
          altTotalNetCFEl.textContent = "0.00";
          altTotalNPVEl.textContent = "0.00";
          altTotalBCREl.textContent = "‚Äì";

          sumCapexEl.textContent = "0.00";
          sumSavingEl.textContent = "0.00";
          sumOpexEl.textContent = "0.00";
          sumNetCFEl.textContent = "0.00";
          sumNPVEl.textContent = "0.00";
          sumBCREl.textContent = "‚Äì";

          // Kosongkan ekonomi & IRR juga
          shadowPriceEl.textContent = "‚Äì";
          ecoAnnualBenefitEl.textContent = "‚Äì";
          ecoNPVEl.textContent = "‚Äì";
          ecoBCREl.textContent = "‚Äì";
          co2SavedEl.textContent = "‚Äì";
          carbonValueEl.textContent = "‚Äì";
          nrwSavedVolEl.textContent = "‚Äì";
          irrBaseEl.textContent = "‚Äì";
          irrLowEl.textContent = "‚Äì";
          irrHighEl.textContent = "‚Äì";

          lastAltSources = [];
          return;
        }

        altData.forEach((s) => {
          const {
            name,
            capacity,
            utilPercent,
            capex,
            opexFixed,
            opexVar,
            lifeYears,
          } = s;
          const volAnnual = capacity * (utilPercent / 100) * 365;

          const savingAnnual = volAnnual * tariffTotal;
          const opexAnnual = opexFixed + opexVar * volAnnual;
          const netCF = savingAnnual - opexAnnual;

          // Simple payback
          let payback = NaN;
          if (netCF > 0 && capex > 0) {
            payback = capex / netCF;
          }

          // NPV & BCR
          const horizon =
            isFinite(lifeYears) && lifeYears > 0
              ? Math.min(analysisYears, Math.round(lifeYears))
              : analysisYears;

          let pvBenefits = 0;
          let pvCosts = capex;

          for (let t = 1; t <= horizon; t++) {
            const df = Math.pow(1 + r, t);
            pvBenefits += savingAnnual / df;
            pvCosts += opexAnnual / df;
          }

          const npv = pvBenefits - pvCosts;
          const bcr = pvCosts > 0 ? pvBenefits / pvCosts : NaN;

          totalCap += capacity;
          totalVol += volAnnual;
          totalCapex += capex;
          totalOpex += opexAnnual;
          totalSaving += savingAnnual;
          totalNetCF += netCF;

          totalPVBenefits += pvBenefits;
          totalPVCosts += pvCosts;

          labels.push(name);
          npvData.push(npv);
          paybackData.push(isFinite(payback) ? payback : null);

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${name}</td>
            <td>${formatNumber(capacity)}</td>
            <td>${formatNumber(utilPercent)}</td>
            <td>${formatNumber(volAnnual)}</td>
            <td>${formatNumber(capex)}</td>
            <td>${formatNumber(opexAnnual)}</td>
            <td>${formatNumber(savingAnnual)}</td>
            <td>${formatNumber(netCF)}</td>
            <td>${isFinite(payback) ? formatNumber(payback) : "‚Äì"}</td>
            <td>${formatNumber(npv)}</td>
            <td>${isFinite(bcr) ? formatNumber(bcr) : "‚Äì"}</td>
          `;
          altResultsBody.appendChild(tr);
        });

        const totalNPV = totalPVBenefits - totalPVCosts;
        const totalBCR = totalPVCosts > 0 ? totalPVBenefits / totalPVCosts : NaN;

        altTotalCapacityEl.textContent = formatNumber(totalCap);
        altTotalVolumeEl.textContent = formatNumber(totalVol);
        altTotalCapexEl.textContent = formatNumber(totalCapex);
        altTotalOpexEl.textContent = formatNumber(totalOpex);
        altTotalSavingEl.textContent = formatNumber(totalSaving);
        altTotalNetCFEl.textContent = formatNumber(totalNetCF);
        altTotalNPVEl.textContent = formatNumber(totalNPV);
        altTotalBCREl.textContent = isFinite(totalBCR) ? formatNumber(totalBCR) : "‚Äì";

        sumCapexEl.textContent = formatNumber(totalCapex);
        sumSavingEl.textContent = formatNumber(totalSaving);
        sumOpexEl.textContent = formatNumber(totalOpex);
        sumNetCFEl.textContent = formatNumber(totalNetCF);
        sumNPVEl.textContent = formatNumber(totalNPV);
        sumBCREl.textContent = isFinite(totalBCR) ? formatNumber(totalBCR) : "‚Äì";

        // Charts NPV & Payback
        if (labels.length) {
          cbaNpvChart = new Chart(cbaNPVCtx, {
            type: "bar",
            data: {
              labels,
              datasets: [
                {
                  label: "NPV (RM)",
                  data: npvData,
                  backgroundColor: "rgba(3, 169, 244, 0.8)",
                  borderRadius: 6,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: { display: false },
                title: { display: true, text: "NPV Mengikut Sumber Air Alternatif" },
              },
              scales: {
                y: { beginAtZero: false, title: { display: true, text: "RM" } },
              },
            },
          });

          cbaPaybackChart = new Chart(cbaPaybackCtx, {
            type: "bar",
            data: {
              labels,
              datasets: [
                {
                  label: "Payback (tahun)",
                  data: paybackData,
                  backgroundColor: "rgba(255, 193, 7, 0.9)",
                  borderRadius: 6,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: { display: false },
                title: { display: true, text: "Payback Period Mengikut Sumber" },
              },
              scales: {
                y: {
                  beginAtZero: true,
                  title: { display: true, text: "Tahun" },
                },
              },
            },
          });
        }

        // 8. Analisis ekonomi (shadow price) & alam sekitar (CO2 + NRW)
        const shadowMult = parseFloat(shadowMultiplierInput.value) || 1;
        const co2Factor = parseFloat(co2FactorInput.value) || 0;
        const carbonPrice = parseFloat(carbonPriceInput.value) || 0;
        const nrwAvoid = parseFloat(nrwAvoidInput.value) || 0;

        const shadowTariff = tariffTotal * shadowMult;
        const econAnnualBenefit = totalVol * shadowTariff;

        // Faktor anuiti untuk analisisYears
        let annFactor = 0;
        for (let t = 1; t <= analysisYears; t++) {
          annFactor += 1 / Math.pow(1 + r, t);
        }

        const econPVBenefits = econAnnualBenefit * annFactor;
        const econPVCosts = totalCapex + totalOpex * annFactor;
        const econNPV = econPVBenefits - econPVCosts;
        const econBCR = econPVCosts > 0 ? econPVBenefits / econPVCosts : NaN;

        const co2SavedTon = (totalVol * co2Factor) / 1000;
        const carbonValue = co2SavedTon * carbonPrice;
        const nrwSavedVol = totalVol * (nrwAvoid / 100);

        shadowPriceEl.textContent = formatNumber(shadowTariff);
        ecoAnnualBenefitEl.textContent = formatNumber(econAnnualBenefit);
        ecoNPVEl.textContent = formatNumber(econNPV);
        ecoBCREl.textContent = isFinite(econBCR) ? formatNumber(econBCR) : "‚Äì";
        co2SavedEl.textContent = formatNumber(co2SavedTon);
        carbonValueEl.textContent = formatNumber(carbonValue);
        nrwSavedVolEl.textContent = formatNumber(nrwSavedVol);

        // 9. IRR & sensitiviti ¬±20% tarif air (projek agregat) dengan fasa 1‚Äì5
        const phaseFactors = phaseInputs.map((inp) => {
          const v = parseFloat(inp.value);
          return isFinite(v) && v >= 0 ? v : 1;
        });

        function buildFlows(fullNetPerYear) {
          const flows = [-totalCapex];
          for (let t = 1; t <= analysisYears; t++) {
            const f = t <= phaseFactors.length ? phaseFactors[t - 1] : 1;
            flows.push(fullNetPerYear * f);
          }
          return flows;
        }

        const fullNetBase = totalSaving - totalOpex;
        const fullNetLow = totalSaving * 0.8 - totalOpex;
        const fullNetHigh = totalSaving * 1.2 - totalOpex;

        const irrBase = computeIRR(buildFlows(fullNetBase));
        const irrLow = computeIRR(buildFlows(fullNetLow));
        const irrHigh = computeIRR(buildFlows(fullNetHigh));

        irrBaseEl.textContent = isFinite(irrBase) ? formatPercent(irrBase) : "‚Äì";
        irrLowEl.textContent = isFinite(irrLow) ? formatPercent(irrLow) : "‚Äì";
        irrHighEl.textContent = isFinite(irrHigh) ? formatPercent(irrHigh) : "‚Äì";

        // Simpan sumber alternatif (termasuk catatan CAPEX/OPEX) untuk laporan PDF
        lastAltSources = altData.slice();
      }

      // Add rows for demand categories
      addRowBtn.addEventListener("click", () => {
        const tr = document.createElement("tr");
        tr.className = "category-row";
        tr.innerHTML = `
          <td><input type="text" class="cat-name" placeholder="Nama kategori" /></td>
          <td><input type="number" class="cat-pop" min="0" /></td>
          <td><input type="number" class="cat-percap" min="0" /></td>
          <td><input type="number" class="cat-peak" value="1.3" min="1" step="0.05" /></td>
        `;
        categoryBody.appendChild(tr);
      });

      // Add rows for alternative sources
      addAltRowBtn.addEventListener("click", () => {
        const tr = document.createElement("tr");
        tr.className = "alt-row";
        tr.innerHTML = `
          <td><input type="text" class="alt-name" placeholder="Nama sumber" /></td>
          <td><input type="number" class="alt-capacity" min="0" /></td>
          <td><input type="number" class="alt-util" min="0" max="100" /></td>
          <td><input type="number" class="alt-capex" min="0" /></td>
          <td><input type="text" class="alt-capex-note" placeholder="Butiran CAPEX (jika perlu)" /></td>
          <td><input type="number" class="alt-opex-fixed" min="0" /></td>
          <td><input type="number" class="alt-opex-var" min="0" step="0.01" /></td>
          <td><input type="text" class="alt-opex-note" placeholder="Butiran OPEX (jika perlu)" /></td>
          <td><input type="number" class="alt-life" min="1" /></td>
        `;
        altBody.appendChild(tr);
      });

      calcBtn.addEventListener("click", calculate);

      // Export Excel
      exportBtn.addEventListener("click", () => {
        try {
          if (typeof XLSX === "undefined") {
            alert("Library Excel (SheetJS) tidak dimuatkan.");
            return;
          }

          // Pastikan kiraan terkini
          calculate();

          const wb = XLSX.utils.book_new();

          // Sheet 1: Kategori demand
          const catRows = [["Kategori", "Populasi", "Per kapita (L/org/hari)", "Purata (m¬≥/hari)", "Faktor puncak", "Permintaan puncak (m¬≥/hari)"]];
          document.querySelectorAll("#results-body tr").forEach((tr) => {
            const cells = Array.from(tr.querySelectorAll("td")).map((td) =>
              td.textContent.trim()
            );
            if (cells.length) catRows.push(cells);
          });
          const totalsRow1 = [
            "Jumlah",
            document.getElementById("total-pop").textContent,
            "",
            document.getElementById("total-avg-m3").textContent,
            "",
            document.getElementById("total-peak-m3").textContent,
          ];
          const totalsRow2 = [
            "Jumlah dalam MLD",
            "",
            "",
            document.getElementById("total-avg-mld").textContent,
            "",
            document.getElementById("total-peak-mld").textContent,
          ];
          catRows.push(totalsRow1, totalsRow2);
          const wsCat = XLSX.utils.aoa_to_sheet(catRows);
          XLSX.utils.book_append_sheet(wb, wsCat, "Kategori");

          // Sheet 2: Ringkasan demand‚Äìsupply
          const summaryRows = [
            ["Item", "Nilai (MLD)"],
            ["Jumlah permintaan purata", document.getElementById("summary-avg-mld").textContent],
            ["Jumlah permintaan puncak", document.getElementById("summary-peak-mld").textContent],
            ["Bekalan sedia ada (JANS)", document.getElementById("supply-avg-mld").textContent],
            ["Extra supply (alt sources)", document.getElementById("alt-supply-mld").textContent],
            ["Bekalan efektif", document.getElementById("effective-supply-mld").textContent],
            ["Surplus / Defisit purata", document.getElementById("surplus-avg-mld").textContent],
            ["Surplus / Defisit puncak", document.getElementById("surplus-peak-mld").textContent],
          ];
          const wsSum = XLSX.utils.aoa_to_sheet(summaryRows);
          XLSX.utils.book_append_sheet(wb, wsSum, "Ringkasan");

          // Sheet 3: CBA alternatif
          const cbaRows = [[
            "Sumber",
            "Kapasiti (m¬≥/hari)",
            "Utilisasi (% hari)",
            "Vol. tahunan (m¬≥/tahun)",
            "CAPEX (RM)",
            "OPEX tahunan (RM/tahun)",
            "Saving air + pembetungan (RM/tahun)",
            "CF bersih (RM/tahun)",
            "Payback (tahun)",
            "NPV (RM)",
            "BCR"
          ]];
          document.querySelectorAll("#alt-results-body tr").forEach((tr) => {
            const cells = Array.from(tr.querySelectorAll("td")).map((td) =>
              td.textContent.trim()
            );
            if (cells.length) cbaRows.push(cells);
          });
          const cbaTotalsRow = [
            "Jumlah / Agregat",
            document.getElementById("alt-total-capacity").textContent,
            "",
            document.getElementById("alt-total-volume").textContent,
            document.getElementById("alt-total-capex").textContent,
            document.getElementById("alt-total-opex").textContent,
            document.getElementById("alt-total-saving").textContent,
            document.getElementById("alt-total-netcf").textContent,
            "",
            document.getElementById("alt-total-npv").textContent,
            document.getElementById("alt-total-bcr").textContent,
          ];
          cbaRows.push(cbaTotalsRow);
          const wsCBA = XLSX.utils.aoa_to_sheet(cbaRows);
          XLSX.utils.book_append_sheet(wb, wsCBA, "CBA_Alt_Sources");

          XLSX.writeFile(wb, "UMS_Water_Demand_Supply_CBA.xlsx");
        } catch (e) {
          console.error(e);
          alert("Ralat semasa export Excel. Sila cuba lagi.");
        }
      });

      // Export PDF (Laporan EPU-style ringkas)
      pdfBtn.addEventListener("click", () => {
        try {
          if (!window.jspdf || !window.jspdf.jsPDF) {
            alert("Library PDF (jsPDF) tidak dimuatkan.");
            return;
          }

          // Pastikan angka terkini
          calculate();

          const { jsPDF } = window.jspdf;
          const doc = new jsPDF("p", "mm", "a4");

          const marginLeft = 14;
          let y = 18;

          doc.setFont("helvetica", "bold");
          doc.setFontSize(14);
          doc.text("LAPORAN PENILAIAN PROJEK SUMBER AIR ALTERNATIF", marginLeft, y);
          doc.setFontSize(11);
          doc.text("Universiti Malaysia Sabah (UMS)", marginLeft, y + 7);

          doc.setFont("helvetica", "normal");
          doc.setFontSize(9);
          y += 16;

          // 1. Latar Belakang
          doc.setFont("helvetica", "bold");
          doc.text("1. LATAR BELAKANG", marginLeft, y);
          doc.setFont("helvetica", "normal");

          const latar =
            "UMS bergantung kepada bekalan air terawat daripada pembekal utiliti luar kampus " +
            "untuk menampung keperluan pelajar, staf, kemudahan akademik, asrama dan premis sokongan. " +
            "Pertumbuhan bilangan pengguna dan pembangunan infrastruktur baharu meningkatkan tekanan " +
            "ke atas sistem bekalan sedia ada, khususnya semasa tempoh permintaan puncak. " +
            "Sejajar dengan agenda kecekapan sumber, kelestarian dan daya tahan kampus, " +
            "projek ini menilai potensi sumber air alternatif seperti tangkapan air hujan, reuse, " +
            "air tasik kampus dan kondensasi penghawa dingin untuk mengurangkan kebergantungan " +
            "kepada bekalan konvensional.";

          y += 6;
          doc.text(latar, marginLeft, y, { maxWidth: 180 });
          y += 30;

          // 2. Objektif Projek
          if (y > 260) { doc.addPage(); y = 20; }
          doc.setFont("helvetica", "bold");
          doc.text("2. OBJEKTIF PROJEK", marginLeft, y);
          doc.setFont("helvetica", "normal");

          const obj1 =
            "i.   Menganggarkan profil permintaan air harian kampus mengikut kategori utama seperti asrama, " +
            "fakulti/pentadbiran, kemudahan ibadah dan sukan.";
          const obj2 =
            "ii.  Menilai kecukupan bekalan sedia ada berbanding permintaan purata dan permintaan puncak.";
          const obj3 =
            "iii. Menilai potensi sumber air alternatif daripada segi volum, penjimatan bil air/pembetungan " +
            "dan daya maju kewangan (NPV, BCR, payback dan IRR).";
          const obj4 =
            "iv.  Menjalankan penilaian ekonomi menggunakan harga bayangan air serta menganggarkan manfaat " +
            "alam sekitar melalui pengurangan CO‚ÇÇ dan kehilangan bukan hasil (NRW).";
          const obj5 =
            "v.   Menyediakan cadangan pelaksanaan berfasa bagi tempoh lima tahun pertama selaras dengan " +
            "keutamaan pembangunan kampus.";

          y += 6;
          doc.text(obj1, marginLeft, y, { maxWidth: 180 }); y += 6;
          doc.text(obj2, marginLeft, y, { maxWidth: 180 }); y += 6;
          doc.text(obj3, marginLeft, y, { maxWidth: 180 }); y += 6;
          doc.text(obj4, marginLeft, y, { maxWidth: 180 }); y += 6;
          doc.text(obj5, marginLeft, y, { maxWidth: 180 }); y += 10;

          // 3. Kaedah Penilaian
          if (y > 260) { doc.addPage(); y = 20; }
          doc.setFont("helvetica", "bold");
          doc.text("3. KAEDAH PENILAIAN", marginLeft, y);
          doc.setFont("helvetica", "normal");

          const kaedah1 =
            "a) Analisis permintaan air: Permintaan purata dikira menggunakan bilangan pengguna " +
            "dan kadar penggunaan per kapita (L/org/hari) mengikut kategori. Permintaan puncak " +
            "dianggarkan dengan mendarab permintaan purata dengan faktor puncak.";
          const kaedah2 =
            "b) Analisis bekalan dan sumber alternatif: Bekalan asas (JANS) digabungkan dengan kapasiti " +
            "teknikal sumber alternatif (air hujan, tasik, reuse, kondensasi) dengan mengambil kira faktor " +
            "penggunaan (% hari/tahun) untuk mendapatkan bekalan efektif.";
          const kaedah3 =
            "c) Analisis kewangan: Volum air alternatif didarab dengan tarif air dan pembetungan untuk " +
            "mengira penjimatan tahunan. Setelah ditolak OPEX, aliran tunai bersih digunakan untuk " +
            "mengira NPV, BCR, payback dan IRR bagi tempoh analisis.";
          const kaedah4 =
            "d) Analisis ekonomi & alam sekitar: Harga bayangan air diaplikasi ke atas volum air alternatif " +
            "untuk mendapatkan faedah ekonomi. Pengurangan CO‚ÇÇ dan NRW dianggarkan menggunakan faktor " +
            "pelepasan dan parameter NRW dielakkan, seterusnya ditukarkan kepada nilai monetari.";
          const kaedah5 =
            "e) Senario fasa: Faktor fasa Tahun 1‚Äì5 digunakan untuk menskalakan aliran faedah dan " +
            "kos operasi, bagi menggambarkan penyerapan projek secara berperingkat.";

          y += 6;
          doc.text(kaedah1, marginLeft, y, { maxWidth: 180 }); y += 10;
          doc.text(kaedah2, marginLeft, y, { maxWidth: 180 }); y += 10;
          doc.text(kaedah3, marginLeft, y, { maxWidth: 180 }); y += 10;
          doc.text(kaedah4, marginLeft, y, { maxWidth: 180 }); y += 10;
          doc.text(kaedah5, marginLeft, y, { maxWidth: 180 }); y += 8;

          // 4. Hasil Analisis (jadual ringkasan)
          if (y > 240) { doc.addPage(); y = 20; }
          doc.setFont("helvetica", "bold");
          doc.text("4. HASIL ANALISIS", marginLeft, y);
          y += 6;

          // 4.1 Ringkasan demand‚Äìsupply
          doc.setFont("helvetica", "bold");
          doc.text("4.1 Ringkasan Permintaan‚ÄìBekalan Air", marginLeft, y);
          doc.setFont("helvetica", "normal");

          const summaryRows = [
            ["Jumlah permintaan purata (MLD)", document.getElementById("summary-avg-mld").textContent],
            ["Jumlah permintaan puncak (MLD)", document.getElementById("summary-peak-mld").textContent],
            ["Bekalan sedia ada (JANS) (MLD)", document.getElementById("supply-avg-mld").textContent],
            ["Extra supply (sumber alternatif) (MLD)", document.getElementById("alt-supply-mld").textContent],
            ["Bekalan efektif (MLD)", document.getElementById("effective-supply-mld").textContent],
            ["Surplus / Defisit purata (MLD)", document.getElementById("surplus-avg-mld").textContent],
            ["Surplus / Defisit puncak (MLD)", document.getElementById("surplus-peak-mld").textContent],
          ];

          doc.autoTable({
            startY: y + 4,
            head: [["Item", "Nilai"]],
            body: summaryRows,
            styles: { fontSize: 8 },
            headStyles: { fillColor: [13, 110, 253] },
          });

          y = doc.lastAutoTable.finalY + 8;

          // 4.2 Ringkasan kewangan & IRR
          if (y > 240) { doc.addPage(); y = 20; }
          doc.setFont("helvetica", "bold");
          doc.text("4.2 Ringkasan Analisis Kewangan", marginLeft, y);
          doc.setFont("helvetica", "normal");

          const finanRows = [
            ["Jumlah CAPEX semua sumber (RM)", document.getElementById("sum-capex").textContent],
            ["Jumlah penjimatan air + pembetungan/tahun (RM)", document.getElementById("sum-saving").textContent],
            ["Jumlah OPEX/tahun (RM)", document.getElementById("sum-opex").textContent],
            ["Aliran tunai bersih tahunan (RM)", document.getElementById("sum-netcf").textContent],
            ["NPV kewangan projek (RM)", document.getElementById("sum-npv").textContent],
            ["BCR kewangan projek", document.getElementById("sum-bcr").textContent],
            ["IRR asas projek (%)", document.getElementById("irr-base").textContent],
            ["IRR sensitiviti tarif ‚àí20
