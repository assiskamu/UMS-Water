<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <title>Kalkulator Permintaan & Bekalan Air UMS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Chart.js (graf) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- SheetJS (Export Excel) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- jsPDF (Penjanaan PDF profesional) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root {
      --primary: #0d6efd;
      --primary-light: #e0f4ff;
      --primary-dark: #054a91;
      --accent: #00bcd4;
      --danger: #ff1744;
      --success: #00c853;
      --bg: #f5fbff;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        Roboto, sans-serif;
      color: #12324a;
      background:
        radial-gradient(circle at top, #cbe9ff 0, #f5fbff 45%, #ffffff 100%);
      position: relative;
      overflow-x: hidden;
    }

    /* background ‚Äúair‚Äù halus */
    body::before {
      content: "";
      position: fixed;
      inset: -20vh -10vw auto;
      height: 60vh;
      background:
        radial-gradient(circle at 20% 20%, rgba(255,255,255,0.7) 0, transparent 55%),
        radial-gradient(circle at 80% 10%, rgba(255,255,255,0.6) 0, transparent 55%),
        linear-gradient(135deg, rgba(13,110,253,0.25), rgba(0,188,212,0.15));
      opacity: 0.7;
      z-index: -2;
      pointer-events: none;
    }

    header {
      background: linear-gradient(135deg, var(--primary-dark), var(--accent));
      color: #fff;
      padding: 1.4rem 1rem;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.18);
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(6px);
    }

    .header-inner {
      max-width: 1100px;
      margin: 0 auto;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }

    header h1 {
      margin: 0;
      font-size: 1.45rem;
      letter-spacing: 0.02em;
    }

    header p {
      margin: 0.15rem 0 0;
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.35rem 0.8rem;
      border-radius: 999px;
      background-color: rgba(255, 255, 255, 0.15);
      font-size: 0.8rem;
      align-self: flex-start;
    }

    .badge span { font-size: 1.1rem; }

    main {
      max-width: 1100px;
      margin: 1.5rem auto 2.5rem;
      padding: 0 1rem;
    }

    .card {
      background: #ffffff;
      border-radius: 1rem;
      padding: 1.3rem 1.5rem;
      margin-bottom: 1.3rem;
      box-shadow: 0 8px 25px rgba(13, 110, 253, 0.08);
      border: 1px solid rgba(13, 110, 253, 0.09);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: auto -30% -40%;
      height: 120px;
      background:
        radial-gradient(circle at 10% 0%, rgba(13,110,253,0.06) 0, transparent 55%),
        radial-gradient(circle at 90% 40%, rgba(0,188,212,0.06) 0, transparent 55%);
      z-index: -1;
    }

    .card h2 {
      margin-top: 0;
      font-size: 1.15rem;
      color: var(--primary-dark);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .card h2 span.icon { font-size: 1.25rem; }

    .card p.lead {
      margin-top: 0;
      font-size: 0.9rem;
      color: #476582;
    }

    label {
      font-size: 0.85rem;
      font-weight: 600;
      color: #23405b;
      display: block;
      margin-bottom: 0.2rem;
    }

    input[type="number"],
    input[type="text"],
    select {
      width: 100%;
      padding: 0.4rem 0.55rem;
      border-radius: 0.5rem;
      border: 1px solid #c5d9ec;
      font-size: 0.9rem;
      outline: none;
      background-color: #fafdff;
    }

    input[type="number"]:focus,
    input[type="text"]:focus,
    select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.15);
      background-color: #ffffff;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
      margin-top: 0.5rem;
      background-color: #fdfefe;
    }

    th,
    td {
      padding: 0.4rem 0.5rem;
      border-bottom: 1px solid #dde7f3;
      text-align: right;
      white-space: nowrap;
    }

    th:first-child,
    td:first-child { text-align: left; }

    thead {
      background: linear-gradient(
        90deg,
        rgba(13, 110, 253, 0.1),
        rgba(0, 188, 212, 0.06)
      );
    }

    tfoot td {
      font-weight: 700;
      background-color: #f3f8ff;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      margin-top: 0.6rem;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 0.45rem 0.9rem;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      transition: transform 0.05s ease, box-shadow 0.12s ease,
        background-color 0.12s ease;
    }

    button.primary {
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color: #fff;
      box-shadow: 0 4px 12px rgba(13, 110, 253, 0.35);
    }

    button.secondary {
      background-color: var(--primary-light);
      color: var(--primary-dark);
    }

    button.export {
      background: linear-gradient(135deg, #00c853, #00e676);
      color: #fff;
      box-shadow: 0 4px 12px rgba(0, 200, 83, 0.4);
    }

    button:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }

    .two-column {
      display: grid;
      grid-template-columns: minmax(0, 1.5fr) minmax(0, 1.2fr);
      gap: 1.2rem;
    }

    .status-pill {
      display: inline-flex;
      border-radius: 999px;
      padding: 0.18rem 0.6rem;
      font-size: 0.8rem;
      font-weight: 600;
      align-items: center;
      gap: 0.35rem;
    }

    .status-surplus {
      background-color: #e0ffe9;
      color: #008a2f;
      border: 1px solid #00c853;
    }

    .status-deficit {
      background-color: #ffebee;
      color: #c62828;
      border: 1px solid #ff1744;
    }

    .summary-text {
      font-size: 0.88rem;
      margin-top: 0.5rem;
      color: #36526f;
    }

    .note {
      font-size: 0.78rem;
      color: #627d96;
      margin-top: 0.2rem;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.75rem;
      padding: 0.2rem 0.5rem;
      border-radius: 999px;
      background-color: rgba(13, 110, 253, 0.05);
      color: #2d4c69;
      margin-right: 0.4rem;
      margin-top: 0.2rem;
    }

    canvas {
      background: radial-gradient(circle at top, #f2fbff, #ffffff);
      border-radius: 0.8rem;
      padding: 0.5rem;
    }

    .summary-row-surplus td:nth-child(2),
    .summary-row-surplus td:nth-child(4) {
      background-color: #e0ffe9;
      color: #006622;
      font-weight: 700;
    }

    .summary-row-deficit td:nth-child(2),
    .summary-row-deficit td:nth-child(4) {
      background-color: #ffebee;
      color: #b71c1c;
      font-weight: 700;
    }

    .disclaimer {
      font-size: 0.8rem;
      color: #455a64;
      line-height: 1.5;
    }

    footer {
      text-align: center;
      padding: 0.8rem 1rem 1.2rem;
      font-size: 0.78rem;
      color: #607d8b;
      background: #f1f7fd;
      border-top: 1px solid #d3e1f2;
    }

    .input-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 0.8rem 1rem;
      margin-top: 0.6rem;
    }

    .mini {
      font-size: 0.78rem;
      color: #607d8b;
    }

    .hidden { display: none !important; }

    /* Kontena laporan HTML legacy (tidak lagi digunakan untuk penjanaan jsPDF) */
    #reportRoot.rendering {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      margin: 0 auto;
      /* Kekalkan keterlihatan jika diperlukan semasa debug paparan HTML */
      opacity: 1;
      pointer-events: none;
      overflow: visible;
      background: #ffffff;
      z-index: 999;
    }

    #reportRoot .logo-box img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      display: block;
    }

    /* Laporan Profesional (PDF) */
    @page {
      size: A4;
      margin: 25mm;
    }

    #reportRoot {
      width: 210mm;
      margin: 0 auto;
      background: #ffffff;
      color: #1b2744;
      font-family: "Georgia", "Times New Roman", serif;
      box-shadow: 0 8px 24px rgba(13, 46, 79, 0.12);
    }

    #reportRoot.offscreen {
      position: absolute;
      left: -9999px;
      top: 0;
      pointer-events: none;
    }

    #reportRoot .report-page {
      padding: 25mm;
    }

    #reportRoot h1,
    #reportRoot h2,
    #reportRoot h3,
    #reportRoot h4 {
      font-family: "Georgia", "Times New Roman", serif;
      color: #0c2d57;
      margin-top: 0;
    }

    #reportRoot p,
    #reportRoot li {
      font-size: 11.5pt;
      line-height: 1.45;
      text-align: justify;
      text-justify: inter-word;
    }

    #reportRoot .report-table {
      width: 100%;
      border-collapse: collapse;
      margin: 0.4rem 0 0.9rem;
      font-size: 10pt;
    }

    #reportRoot .report-table th,
    #reportRoot .report-table td {
      border: 1px solid #0f3057;
      padding: 6px 8px;
      text-align: left;
      background: #fff;
    }

    #reportRoot .report-table thead th {
      background: linear-gradient(135deg, rgba(13, 110, 253, 0.18), rgba(0, 188, 212, 0.2));
    }

    #reportRoot .zebra tbody tr:nth-child(even) td {
      background: #f5f8ff;
    }

    #reportRoot .page-break { page-break-before: always; }

    #reportRoot .cover {
      min-height: 297mm;
      padding: 30mm;
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 1.8rem;
    }

    #reportRoot .cover-water {
      overflow: hidden;
      background: linear-gradient(180deg, #e6f7ff 0%, #ffffff 55%, #e6f7ff 100%);
    }

    #reportRoot .cover-water::before {
      content: "";
      position: absolute;
      inset: 0;
      background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='1200' height='800' viewBox='0 0 1200 800'><path d='M0,520 C200,480 300,600 520,560 C760,510 900,610 1200,560 L1200,800 L0,800 Z' fill='%2300a3d9' fill-opacity='0.08'/><path d='M0,600 C240,560 320,680 560,640 C780,605 940,685 1200,640 L1200,800 L0,800 Z' fill='%2300a3d9' fill-opacity='0.06'/></svg>");
      background-size: cover;
      background-repeat: no-repeat;
      background-position: bottom;
      pointer-events: none;
    }

    #reportRoot .cover-water::after {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 20% 20%, rgba(13, 110, 253, 0.12), transparent 40%),
        radial-gradient(circle at 80% 0%, rgba(0, 188, 212, 0.14), transparent 38%);
      pointer-events: none;
    }

    #reportRoot .cover .watermark {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      font-size: 120px;
      color: rgba(12, 45, 87, 0.06);
      letter-spacing: 0.12em;
      pointer-events: none;
      z-index: 0;
    }

    #reportRoot .cover .logo-box {
      width: 120px;
      height: 140px;
      border: 2px dashed #0d2e55;
      display: grid;
      place-items: center;
      font-size: 0.9rem;
      color: #0d2e55;
      background: rgba(255, 255, 255, 0.65);
    }

    #reportRoot .cover > * {
      position: relative;
      z-index: 1;
    }

    #reportRoot .toc {
      padding: 25mm;
      background: #ffffff;
    }

    #reportRoot .toc ol {
      counter-reset: item;
      padding-left: 1rem;
    }

    #reportRoot .toc li {
      margin: 0.25rem 0;
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      font-size: 11pt;
    }

    #reportRoot .toc li::before {
      counter-increment: item;
      content: counters(item, ".") " ";
      font-weight: bold;
      margin-right: 0.35rem;
      color: #0c2d57;
    }

    #reportRoot .toc .page-num {
      color: #0c2d57;
      font-variant-numeric: tabular-nums;
    }

    #reportRoot .section-tag {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.16rem 0.55rem;
      background: rgba(13, 110, 253, 0.12);
      color: #0d2e55;
      border-radius: 999px;
      font-size: 0.78rem;
      letter-spacing: 0.02em;
    }

    #reportRoot .figure {
      text-align: center;
      margin: 0.3rem 0 0.9rem;
    }

    #reportRoot .figure img {
      max-width: 100%;
      border: 1px solid #cdd9eb;
      border-radius: 8px;
      background: #fff;
    }

    #reportRoot .figure .caption {
      font-size: 9.5pt;
      margin-top: 0.35rem;
      color: #425c7a;
    }

    #reportRoot .kicker {
      font-size: 0.9rem;
      letter-spacing: 0.08em;
      color: #0d2e55;
      text-transform: uppercase;
    }

    #reportRoot .meta {
      color: #244a75;
      font-size: 0.95rem;
    }

    #reportRoot .highlight-box {
      border: 1px solid rgba(13, 110, 253, 0.3);
      background: rgba(13, 110, 253, 0.04);
      padding: 0.8rem 1rem;
      border-radius: 10px;
      margin: 0.7rem 0 1rem;
    }

    #reportRoot .risk-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
      gap: 0.7rem;
    }

    #reportRoot .risk-card {
      border: 1px solid #c8d7ec;
      border-radius: 10px;
      padding: 0.7rem 0.9rem;
      background: #fbfdff;
    }

    #reportRoot .tagline {
      color: #244a75;
      font-style: italic;
      margin-top: 0.4rem;
    }

    #reportRoot .footer-note {
      text-align: center;
      font-size: 9.5pt;
      margin-top: 0.9rem;
      color: #3e5674;
    }

    #reportRoot .page-note {
      font-size: 9.5pt;
      color: #4c6079;
    }

    #reportRoot .watermark-underline {
      height: 5px;
      background: linear-gradient(90deg, rgba(13, 110, 253, 0.3), rgba(0, 188, 212, 0.4));
      border-radius: 12px;
      margin: 0.4rem 0 0.8rem;
    }

    #reportRoot .list-tight li { margin: 0.12rem 0; }

    #reportRoot .phase-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 0.8rem;
    }

    #reportRoot .phase-card {
      border: 1px solid #d1e2f5;
      border-radius: 10px;
      padding: 0.8rem 0.95rem;
      background: linear-gradient(135deg, #f8fbff, #fdfefe);
    }

    #reportRoot .phase-card h4 {
      margin: 0 0 0.25rem;
      font-size: 1rem;
    }

    #reportRoot .phase-card ul { padding-left: 1rem; margin: 0; }

    #reportRoot .inline-table {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 0.7rem;
    }

    #reportRoot .inline-table .box {
      border: 1px solid #cfdff0;
      border-radius: 10px;
      padding: 0.7rem 0.85rem;
      background: #fbfdff;
    }

    #reportRoot .inline-table .label {
      font-size: 0.82rem;
      color: #36526f;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-bottom: 0.2rem;
    }

    @media (max-width: 768px) {
      header { padding: 1.15rem 1rem; }
      header h1 { font-size: 1.25rem; }
      .two-column { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div>
        <h1>Kalkulator Permintaan & Bekalan Air UMS</h1>
        <p>
          Anggaran demand‚Äìsupply air kampus termasuk sumber alternatif
          (tangkapan air hujan, reuse, air tasik, kondensasi penghawa dingin)
          dan analisis kos‚Äìfaedah asas.
        </p>
      </div>
      <div class="badge">
        <span>üíß</span> Planning-level water & CBA tool
      </div>
    </div>
  </header>

  <main>
    <!-- INPUT KATEGORI DEMAND -->
    <section class="card">
      <h2><span class="icon">üì•</span> Input Permintaan Air Mengikut Kategori</h2>
      <p class="lead">
        Tetapkan kategori (contoh: Asrama, Fakulti & Pentadbiran, Masjid, Sukan)
        bersama bilangan pengguna, kadar penggunaan per kapita, dan faktor
        permintaan puncak (peak factor).
      </p>

      <div class="note">
        Tip: 1 m¬≥/hari = 1,000 L/hari. Peak factor biasa 1.2‚Äì1.5 untuk asrama
        & kawasan tumpuan pelajar.
      </div>

      <div style="overflow-x: auto; margin-top: 0.6rem;">
        <table id="category-input-table">
          <thead>
            <tr>
              <th>Kategori</th>
              <th>Populasi (orang)</th>
              <th>Per kapita (L/org/hari)</th>
              <th>Faktor puncak</th>
            </tr>
          </thead>
          <tbody id="category-body">
            <tr class="category-row">
              <td><input type="text" class="cat-name" value="Asrama" /></td>
              <td><input type="number" class="cat-pop" value="6621" min="0" /></td>
              <td><input type="number" class="cat-percap" value="200" min="0" /></td>
              <td><input type="number" class="cat-peak" value="1.3" min="1" step="0.05" /></td>
            </tr>
            <tr class="category-row">
              <td>
                <input type="text" class="cat-name" value="Fakulti & Pentadbiran" />
              </td>
              <td><input type="number" class="cat-pop" value="8000" min="0" /></td>
              <td><input type="number" class="cat-percap" value="50" min="0" /></td>
              <td><input type="number" class="cat-peak" value="1.2" min="1" step="0.05" /></td>
            </tr>
            <tr class="category-row">
              <td><input type="text" class="cat-name" value="Masjid & Surau" /></td>
              <td><input type="number" class="cat-pop" value="3000" min="0" /></td>
              <td><input type="number" class="cat-percap" value="15" min="0" /></td>
              <td><input type="number" class="cat-peak" value="1.5" min="1" step="0.05" /></td>
            </tr>
            <tr class="category-row">
              <td><input type="text" class="cat-name" value="Sukan & Rekreasi" /></td>
              <td><input type="number" class="cat-pop" value="1500" min="0" /></td>
              <td><input type="number" class="cat-percap" value="60" min="0" /></td>
              <td><input type="number" class="cat-peak" value="1.4" min="1" step="0.05" /></td>
            </tr>
            <tr class="category-row">
              <td>
                <input type="text" class="cat-name"
                       placeholder="Kategori tambahan (jika ada)" />
              </td>
              <td><input type="number" class="cat-pop" min="0" /></td>
              <td><input type="number" class="cat-percap" min="0" /></td>
              <td><input type="number" class="cat-peak" value="1.3" min="1" step="0.05" /></td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="btn-row">
        <button id="add-row-btn" type="button" class="secondary">
          ‚ûï Tambah baris kategori
        </button>
        <button id="calculate-btn" type="button" class="primary">
          üîç Kira permintaan & banding dengan bekalan
        </button>
      </div>
    </section>

    <!-- INPUT SUPPLY (JANS) -->
    <section class="card">
      <h2><span class="icon">üö∞</span> Input Bekalan Air (Supply Sedia Ada)</h2>
      <p class="lead">
        Masukkan anggaran kapasiti bekalan air harian yang diterima kampus
        (daripada JANS dan sumber utama lain). Nilai dalam juta liter sehari (MLD).
      </p>

      <label for="supply-mld">Kapasiti bekalan harian sedia ada (MLD)</label>
      <input type="number" id="supply-mld" value="5" min="0" step="0.1" />
      <div class="note">
        Contoh: jika UMS menerima sekitar 4.5‚Äì5.0 MLD daripada loji rawatan.
      </div>
    </section>

    <!-- PARAMETER TARIF & KEWANGAN -->
    <section class="card">
      <h2><span class="icon">üíπ</span> Parameter Tarif & Kewangan</h2>
      <p class="lead">
        Parameter ini digunakan untuk mengira penjimatan bil air & pembetungan
        serta NPV, BCR dan anggaran payback bagi setiap sumber air alternatif.
      </p>

      <div class="input-grid">
        <div>
          <label for="tariff-water">Tarif air terawat (RM/m¬≥)</label>
          <input type="number" id="tariff-water" value="1.20" min="0" step="0.01" />
        </div>
        <div>
          <label for="tariff-sewer">Kadar pembetungan (RM/m¬≥)</label>
          <input type="number" id="tariff-sewer" value="0.80" min="0" step="0.01" />
        </div>
        <div>
          <label for="analysis-years">Tempoh analisis kewangan (tahun)</label>
          <input type="number" id="analysis-years" value="20" min="1" step="1" />
        </div>
        <div>
          <label for="discount-rate">Kadar diskaun (% setahun)</label>
          <input type="number" id="discount-rate" value="5" min="0" step="0.1" />
        </div>
      </div>

      <div class="note">
        Kebiasaannya kadar diskaun 3‚Äì7% digunakan untuk projek infrastruktur
        awam, bergantung kepada garis panduan agensi.
      </div>
    </section>

    <!-- INPUT SUMBER AIR ALTERNATIF -->
    <section class="card">
      <h2><span class="icon">üíß</span> Sumber Air Alternatif (Extra Supply & CBA)</h2>
      <p class="lead">
        Masukkan kapasiti teknikal, faktor penggunaan, CAPEX, OPEX dan nota
        perincian kos bagi setiap sumber air alternatif. Sumber ini akan menambah
        bekalan efektif dan digunakan dalam analisis kos‚Äìfaedah.
      </p>

      <div style="overflow-x: auto; margin-top: 0.6rem;">
        <table id="alt-input-table">
          <thead>
            <tr>
              <th>Sumber</th>
              <th>Kapasiti (m¬≥/hari)</th>
              <th>Faktor penggunaan (% hari/tahun)</th>
              <th>CAPEX (RM)</th>
              <th>Butiran CAPEX (ringkas)</th>
              <th>OPEX tetap (RM/tahun)</th>
              <th>OPEX berubah (RM/m¬≥)</th>
              <th>Butiran OPEX (ringkas)</th>
              <th>Jangka hayat (tahun)</th>
            </tr>
          </thead>
          <tbody id="alt-body">
            <tr class="alt-row">
              <td><input type="text" class="alt-name" value="Tangkapan air hujan" /></td>
              <td><input type="number" class="alt-capacity" value="300" min="0" /></td>
              <td><input type="number" class="alt-util" value="80" min="0" max="100" /></td>
              <td><input type="number" class="alt-capex" value="1200000" min="0" /></td>
              <td><input type="text" class="alt-capex-note"
                     value="Struktur tangki, gutter, paip agihan, pam dan panel kawalan" /></td>
              <td><input type="number" class="alt-opex-fixed" value="60000" min="0" /></td>
              <td><input type="number" class="alt-opex-var" value="0.10" min="0" step="0.01" /></td>
              <td><input type="text" class="alt-opex-note"
                     value="Elektrik pam, penyelenggaraan berkala dan pembersihan tangki" /></td>
              <td><input type="number" class="alt-life" value="25" min="1" /></td>
            </tr>
            <tr class="alt-row">
              <td><input type="text" class="alt-name" value="Air tasik / tasik kampus" /></td>
              <td><input type="number" class="alt-capacity" value="200" min="0" /></td>
              <td><input type="number" class="alt-util" value="70" min="0" max="100" /></td>
              <td><input type="number" class="alt-capex" value="900000" min="0" /></td>
              <td><input type="text" class="alt-capex-note"
                     value="Pam pengabstrakan, paip penghantaran, sistem penapisan" /></td>
              <td><input type="number" class="alt-opex-fixed" value="45000" min="0" /></td>
              <td><input type="number" class="alt-opex-var" value="0.15" min="0" step="0.01" /></td>
              <td><input type="text" class="alt-opex-note"
                     value="Elektrik pam, bahan kimia dan penyelenggaraan penapis" /></td>
              <td><input type="number" class="alt-life" value="20" min="1" /></td>
            </tr>
            <tr class="alt-row">
              <td><input type="text" class="alt-name" value="Reuse (greywater / RO)" /></td>
              <td><input type="number" class="alt-capacity" value="250" min="0" /></td>
              <td><input type="number" class="alt-util" value="80" min="0" max="100" /></td>
              <td><input type="number" class="alt-capex" value="1500000" min="0" /></td>
              <td><input type="text" class="alt-capex-note"
                     value="Unit rawatan, tangki imbangan, sistem paip dwi-saluran" /></td>
              <td><input type="number" class="alt-opex-fixed" value="90000" min="0" /></td>
              <td><input type="number" class="alt-opex-var" value="0.25" min="0" step="0.01" /></td>
              <td><input type="text" class="alt-opex-note"
                     value="Bahan kimia, tenaga elektrik dan operator" /></td>
              <td><input type="number" class="alt-life" value="20" min="1" /></td>
            </tr>
            <tr class="alt-row">
              <td><input type="text" class="alt-name" value="Kondensasi penghawa dingin" /></td>
              <td><input type="number" class="alt-capacity" value="50" min="0" /></td>
              <td><input type="number" class="alt-util" value="90" min="0" max="100" /></td>
              <td><input type="number" class="alt-capex" value="200000" min="0" /></td>
              <td><input type="text" class="alt-capex-note"
                     value="Pengumpulan kondensat, tangki kecil dan pam pemindahan" /></td>
              <td><input type="number" class="alt-opex-fixed" value="15000" min="0" /></td>
              <td><input type="number" class="alt-opex-var" value="0.05" min="0" step="0.01" /></td>
              <td><input type="text" class="alt-opex-note"
                     value="Elektrik tambahan dan penyelenggaraan" /></td>
              <td><input type="number" class="alt-life" value="15" min="1" /></td>
            </tr>
            <tr class="alt-row">
              <td><input type="text" class="alt-name" placeholder="Sumber tambahan" /></td>
              <td><input type="number" class="alt-capacity" min="0" /></td>
              <td><input type="number" class="alt-util" min="0" max="100" /></td>
              <td><input type="number" class="alt-capex" min="0" /></td>
              <td><input type="text" class="alt-capex-note"
                     placeholder="Butiran CAPEX (jika ada)" /></td>
              <td><input type="number" class="alt-opex-fixed" min="0" /></td>
              <td><input type="number" class="alt-opex-var" min="0" step="0.01" /></td>
              <td><input type="text" class="alt-opex-note"
                     placeholder="Butiran OPEX (jika ada)" /></td>
              <td><input type="number" class="alt-life" min="1" /></td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="btn-row">
        <button id="add-alt-row-btn" type="button" class="secondary">
          ‚ûï Tambah baris sumber alternatif
        </button>
      </div>
      <p class="mini">
        Nota: Butiran CAPEX dan OPEX membantu penjajaran dengan garis panduan EPU/MOF
        (contoh pecahan kepada infrastruktur, peralatan, tenaga kerja, O&M).
      </p>
    </section>

    <!-- PENGIRAAN TERPERINCI CAPEX & OPEX MENGIKUT ITEM -->
    <section class="card">
      <h2><span class="icon">üßæ</span> Pengiraan Terperinci CAPEX & OPEX Mengikut Item</h2>
      <p class="lead">
        Jadual mini ini membolehkan pecahan CAPEX dan OPEX mengikut item
        (contoh: tangki, pam, paip, operator, elektrik). Jumlah CAPEX dan OPEX
        boleh dirujuk semula apabila mengisi jadual sumber air alternatif.
      </p>

      <div style="overflow-x:auto;">
        <table id="capex-opex-items-table">
          <thead>
            <tr>
              <th>Jenis</th>
              <th>Item / Komponen</th>
              <th>Kuantiti</th>
              <th>Kos seunit (RM)</th>
              <th>Jumlah kos (RM)</th>
              <th>Catatan</th>
            </tr>
          </thead>
          <tbody id="capex-opex-body">
            <tr class="capex-opex-row">
              <td>
                <select class="item-type">
                  <option value="CAPEX">CAPEX</option>
                  <option value="OPEX">OPEX</option>
                </select>
              </td>
              <td><input type="text" class="item-name" value="Tangki simpanan air hujan" /></td>
              <td><input type="number" class="item-qty" value="2" min="0" step="0.01" /></td>
              <td><input type="number" class="item-cost" value="150000" min="0" step="0.01" /></td>
              <td class="item-total">0.00</td>
              <td><input type="text" class="item-note" value="Termasuk asas konkrit dan pemasangan" /></td>
            </tr>
            <tr class="capex-opex-row">
              <td>
                <select class="item-type">
                  <option value="CAPEX">CAPEX</option>
                  <option value="OPEX">OPEX</option>
                </select>
              </td>
              <td><input type="text" class="item-name" value="Pam dan paip agihan utama" /></td>
              <td><input type="number" class="item-qty" value="1" min="0" step="0.01" /></td>
              <td><input type="number" class="item-cost" value="250000" min="0" step="0.01" /></td>
              <td class="item-total">0.00</td>
              <td><input type="text" class="item-note" value="Termasuk panel kawalan" /></td>
            </tr>
            <tr class="capex-opex-row">
              <td>
                <select class="item-type">
                  <option value="OPEX" selected>OPEX</option>
                  <option value="CAPEX">CAPEX</option>
                </select>
              </td>
              <td><input type="text" class="item-name" value="Elektrik pam air hujan" /></td>
              <td><input type="number" class="item-qty" value="12" min="0" step="1" /></td>
              <td><input type="number" class="item-cost" value="4000" min="0" step="0.01" /></td>
              <td class="item-total">0.00</td>
              <td><input type="text" class="item-note" value="Anggaran bil elektrik setahun" /></td>
            </tr>
          </tbody>
          <tfoot>
            <tr>
              <td colspan="4"><strong>Jumlah CAPEX (daripada jadual item)</strong></td>
              <td id="capex-items-total">0.00</td>
              <td></td>
            </tr>
            <tr>
              <td colspan="4"><strong>Jumlah OPEX (daripada jadual item)</strong></td>
              <td id="opex-items-total">0.00</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="btn-row">
        <button id="add-capex-opex-item-btn" type="button" class="secondary">
          ‚ûï Tambah baris item
        </button>
      </div>
      <p class="mini">
        Nota: Jumlah CAPEX dan OPEX di sini boleh dijadikan rujukan dan dipadankan
        secara manual dengan CAPEX/OPEX mengikut sumber air alternatif di atas.
      </p>
    </section>

    <!-- ANALISIS KATEGORI DEMAND -->
    <section class="card">
      <h2><span class="icon">üìä</span> Analisis Permintaan Air Mengikut Kategori</h2>
      <p class="lead">
        Jadual ini menunjukkan permintaan purata dan puncak (peak) bagi setiap
        kategori berdasarkan input yang dimasukkan.
      </p>

      <div style="overflow-x: auto;">
        <table id="results-table">
          <thead>
            <tr>
              <th>Kategori</th>
              <th>Populasi</th>
              <th>Per kapita (L/org/hari)</th>
              <th>Purata (m¬≥/hari)</th>
              <th>Faktor puncak</th>
              <th>Permintaan puncak (m¬≥/hari)</th>
            </tr>
          </thead>
          <tbody id="results-body">
            <!-- JS akan isi -->
          </tbody>
          <tfoot>
            <tr>
              <td>Jumlah</td>
              <td id="total-pop">‚Äì</td>
              <td>‚Äì</td>
              <td id="total-avg-m3">‚Äì</td>
              <td>‚Äì</td>
              <td id="total-peak-m3">‚Äì</td>
            </tr>
            <tr>
              <td>Jumlah dalam MLD</td>
              <td colspan="2"></td>
              <td id="total-avg-mld">‚Äì</td>
              <td></td>
              <td id="total-peak-mld">‚Äì</td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="chip">üîπ Purata = Populasi √ó Per kapita / 1,000</div>
      <div class="chip">üîπ Puncak = Purata √ó Faktor puncak</div>
    </section>

    <!-- DEMAND VS SUPPLY + EXPORT -->
    <section class="card">
      <h2><span class="icon">‚öñÔ∏è</span> Ringkasan Demand‚ÄìSupply (MLD)</h2>
      <div class="two-column">
        <div>
          <table id="summary-table">
            <thead>
              <tr>
                <th>Item</th>
                <th>Nilai (MLD)</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <tr id="row-avg">
                <td>Jumlah permintaan purata</td>
                <td id="summary-avg-mld">‚Äì</td>
                <td id="status-avg">‚Äì</td>
              </tr>
              <tr id="row-peak">
                <td>Jumlah permintaan puncak</td>
                <td id="summary-peak-mld">‚Äì</td>
                <td id="status-peak">‚Äì</td>
              </tr>
              <tr>
                <td>Bekalan sedia ada (JANS)</td>
                <td id="supply-avg-mld">‚Äì</td>
                <td></td>
              </tr>
              <tr>
                <td>Extra supply (air hujan / reuse / tasik / AC)</td>
                <td id="alt-supply-mld">‚Äì</td>
                <td></td>
              </tr>
              <tr>
                <td><strong>Bekalan efektif (JANS + sumber alternatif)</strong></td>
                <td id="effective-supply-mld">‚Äì</td>
                <td></td>
              </tr>
              <tr>
                <td>Surplus / Defisit purata</td>
                <td id="surplus-avg-mld">‚Äì</td>
                <td></td>
              </tr>
              <tr>
                <td>Surplus / Defisit semasa puncak</td>
                <td id="surplus-peak-mld">‚Äì</td>
                <td></td>
              </tr>
            </tbody>
          </table>

          <div class="btn-row" style="margin-top: 0.8rem;">
            <button id="export-excel-btn" type="button" class="export">
              üì§ Export Excel (.xlsx)
            </button>
            <button id="download-report-btn" type="button" class="primary">
              üìÑ Jana Laporan
            </button>
          </div>

          <div class="summary-text" id="summary-text">
            Tekan butang <strong>‚ÄúKira permintaan & banding dengan bekalan‚Äù</strong>
            untuk melihat ringkasan analisis termasuk kesan sumber alternatif.
          </div>
        </div>

        <div>
          <canvas id="demand-by-category-chart" height="200"></canvas>
        </div>
      </div>
    </section>

    <!-- PIE CHART DEMAND SHARE -->
    <section class="card">
      <h2><span class="icon">üìà</span> Agihan Permintaan Mengikut Kategori</h2>
      <p class="lead">
        Rajah menunjukkan sumbangan (%) setiap kategori kepada permintaan purata
        keseluruhan kampus.
      </p>
      <canvas id="demand-share-chart" height="200"></canvas>
    </section>

    <!-- ANALISIS CBA SUMBER ALTERNATIF -->
    <section class="card">
      <h2><span class="icon">üíº</span> Analisis Kewangan Sumber Air Alternatif</h2>
      <p class="lead">
        Jadual di bawah merumuskan volum, penjimatan, CAPEX, OPEX, aliran tunai
        bersih, payback period, NPV dan BCR bagi setiap sumber air alternatif.
      </p>

      <div style="overflow-x: auto;">
        <table id="alt-results-table">
          <thead>
            <tr>
              <th>Sumber</th>
              <th>Kapasiti (m¬≥/hari)</th>
              <th>Utilisasi (% hari)</th>
              <th>Vol. tahunan (m¬≥/tahun)</th>
              <th>CAPEX (RM)</th>
              <th>OPEX tahunan (RM/tahun)</th>
              <th>Saving air + pembetungan (RM/tahun)</th>
              <th>CF bersih (RM/tahun)</th>
              <th>Payback (tahun)</th>
              <th>NPV (RM)</th>
              <th>BCR</th>
            </tr>
          </thead>
          <tbody id="alt-results-body">
            <!-- JS akan isi -->
          </tbody>
          <tfoot>
            <tr>
              <td>Jumlah / Agregat</td>
              <td id="alt-total-capacity">‚Äì</td>
              <td>‚Äì</td>
              <td id="alt-total-volume">‚Äì</td>
              <td id="alt-total-capex">‚Äì</td>
              <td id="alt-total-opex">‚Äì</td>
              <td id="alt-total-saving">‚Äì</td>
              <td id="alt-total-netcf">‚Äì</td>
              <td>‚Äì</td>
              <td id="alt-total-npv">‚Äì</td>
              <td id="alt-total-bcr">‚Äì</td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="two-column" style="margin-top: 1rem;">
        <div>
          <h3 style="font-size:0.96rem; margin-top:0;">Ringkasan Kewangan Projek</h3>
          <table id="alt-summary-table">
            <tbody>
              <tr>
                <td>Jumlah CAPEX semua sumber</td>
                <td id="sum-capex">‚Äì</td>
              </tr>
              <tr>
                <td>Jumlah penjimatan air + pembetungan / tahun</td>
                <td id="sum-saving">‚Äì</td>
              </tr>
              <tr>
                <td>Jumlah OPEX / tahun</td>
                <td id="sum-opex">‚Äì</td>
              </tr>
              <tr>
                <td>Aliran tunai bersih tahunan</td>
                <td id="sum-netcf">‚Äì</td>
              </tr>
              <tr>
                <td>NPV projek (semua sumber)</td>
                <td id="sum-npv">‚Äì</td>
              </tr>
              <tr>
                <td>BCR projek (semua sumber)</td>
                <td id="sum-bcr">‚Äì</td>
              </tr>
              <tr>
                <td>Anggaran IRR projek (mengikut aliran tunai bersih)</td>
                <td id="sum-irr">‚Äì</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div>
          <canvas id="cba-npv-chart" height="200" style="margin-bottom:0.8rem;"></canvas>
          <canvas id="cba-payback-chart" height="200"></canvas>
        </div>
      </div>
    </section>

    <!-- METODOLOGI + DISCLAIMER -->
    <section class="card">
      <h2><span class="icon">üßÆ</span> Nota Metodologi (Ringkas) & Penafian</h2>
      <div class="disclaimer">
        <p><strong>Metodologi ringkas:</strong></p>
        <ul style="margin-top: 0.2rem; padding-left: 1.1rem;">
          <li>
            <strong>Langkah 1 ‚Äì Per kapita:</strong> Untuk setiap kategori demand,
            permintaan purata dikira berdasarkan bilangan pengguna dikali kadar
            penggunaan per kapita (L/org/hari), ditukar kepada m¬≥/hari.
          </li>
          <li>
            <strong>Langkah 2 ‚Äì Permintaan puncak:</strong> Nilai purata
            digandakan dengan faktor puncak (contoh 1.3) bagi menggambarkan hari
            atau masa penggunaan tertinggi.
          </li>
          <li>
            <strong>Langkah 3 ‚Äì Extra supply:</strong> Kapasiti sumber air
            alternatif ditukar kepada bekalan efektif (m¬≥/hari) menggunakan
            faktor penggunaan (% hari/tahun) dan ditambah kepada bekalan JANS.
          </li>
          <li>
            <strong>Langkah 4 ‚Äì Penjimatan & CBA:</strong> Volum air alternatif
            dikalikan dengan tarif air + pembetungan untuk mendapatkan penjimatan
            tahunan, ditolak OPEX untuk mendapatkan aliran tunai bersih.
            NPV dan BCR dikira menggunakan tempoh analisis dan kadar diskaun
            yang ditetapkan.
          </li>
        </ul>

        <p style="margin-top: 0.7rem;"><strong>Penafian:</strong></p>
        <p>
          Kalkulator ini disediakan untuk tujuan perancangan dan analisis awal
          (planning-level estimate) berdasarkan andaian input pengguna. Nilai
          yang dijana bukanlah rekod rasmi penggunaan atau bekalan air
          Universiti Malaysia Sabah dan tidak menggantikan data meter/bil air
          yang disahkan oleh pihak berkuasa berkaitan. Sebarang keputusan
          kejuruteraan atau pelaburan sebenar hendaklah dirujuk dan disahkan
          dengan data teknikal terperinci serta pihak berkepentingan rasmi.
        </p>
      </div>
    </section>
  </main>

  <div id="reportRoot" class="report hidden offscreen" aria-hidden="true"></div>

  <footer>
    ¬© 2025 Assis, Fera, Sarimah & Sani @ RuWaS UMS. All rights reserved.
  </footer>

  <script>
    window.addEventListener("DOMContentLoaded", () => {
      const addRowBtn = document.getElementById("add-row-btn");
      const calcBtn = document.getElementById("calculate-btn");
      const exportBtn = document.getElementById("export-excel-btn");
      const downloadReportBtn = document.getElementById("download-report-btn");
      const reportRoot = document.getElementById("reportRoot");
      const categoryBody = document.getElementById("category-body");

      const addAltRowBtn = document.getElementById("add-alt-row-btn");
      const altBody = document.getElementById("alt-body");

      const resultsBody = document.getElementById("results-body");
      const totalPopEl = document.getElementById("total-pop");
      const totalAvgM3El = document.getElementById("total-avg-m3");
      const totalPeakM3El = document.getElementById("total-peak-m3");
      const totalAvgMLDEl = document.getElementById("total-avg-mld");
      const totalPeakMLDEl = document.getElementById("total-peak-mld");

      const supplyInput = document.getElementById("supply-mld");
      const summaryAvgMLDEl = document.getElementById("summary-avg-mld");
      const summaryPeakMLDEl = document.getElementById("summary-peak-mld");
      const supplyAvgMLDEl = document.getElementById("supply-avg-mld");
      const altSupplyMLDEl = document.getElementById("alt-supply-mld");
      const effectiveSupplyMLDEl = document.getElementById("effective-supply-mld");
      const surplusAvgMLDEl = document.getElementById("surplus-avg-mld");
      const surplusPeakMLDEl = document.getElementById("surplus-peak-mld");
      const statusAvgEl = document.getElementById("status-avg");
      const statusPeakEl = document.getElementById("status-peak");
      const summaryTextEl = document.getElementById("summary-text");

      const rowAvg = document.getElementById("row-avg");
      const rowPeak = document.getElementById("row-peak");

      // CBA elements
      const altResultsBody = document.getElementById("alt-results-body");
      const altTotalCapacityEl = document.getElementById("alt-total-capacity");
      const altTotalVolumeEl = document.getElementById("alt-total-volume");
      const altTotalCapexEl = document.getElementById("alt-total-capex");
      const altTotalOpexEl = document.getElementById("alt-total-opex");
      const altTotalSavingEl = document.getElementById("alt-total-saving");
      const altTotalNetCFEl = document.getElementById("alt-total-netcf");
      const altTotalNPVEl = document.getElementById("alt-total-npv");
      const altTotalBCREl = document.getElementById("alt-total-bcr");

      const sumCapexEl = document.getElementById("sum-capex");
      const sumSavingEl = document.getElementById("sum-saving");
      const sumOpexEl = document.getElementById("sum-opex");
      const sumNetCFEl = document.getElementById("sum-netcf");
      const sumNPVEl = document.getElementById("sum-npv");
      const sumBCREl = document.getElementById("sum-bcr");
      const sumIRREl = document.getElementById("sum-irr");

      const tariffWaterInput = document.getElementById("tariff-water");
      const tariffSewerInput = document.getElementById("tariff-sewer");
      const analysisYearsInput = document.getElementById("analysis-years");
      const discountRateInput = document.getElementById("discount-rate");

      // CAPEX/OPEX itemised
      const capexOpexBody = document.getElementById("capex-opex-body");
      const capexItemsTotalEl = document.getElementById("capex-items-total");
      const opexItemsTotalEl = document.getElementById("opex-items-total");
      const addItemBtn = document.getElementById("add-capex-opex-item-btn");

      const categoryChartCtx = document
        .getElementById("demand-by-category-chart")
        .getContext("2d");
      const shareChartCtx = document
        .getElementById("demand-share-chart")
        .getContext("2d");
      const cbaNPVCtx = document
        .getElementById("cba-npv-chart")
        .getContext("2d");
      const cbaPaybackCtx = document
        .getElementById("cba-payback-chart")
        .getContext("2d");
      const umsLogoPath = "ums-logo.png";
      let umsLogoDataUrl = "";

      let categoryChart = null;
      let shareChart = null;
      let cbaNpvChart = null;
      let cbaPaybackChart = null;

      let lastAltSources = [];

      function formatNumber(num) {
        if (!isFinite(num)) return "‚Äì";
        return num.toLocaleString("ms-MY", { maximumFractionDigits: 2 });
      }

      function parseNumberFromText(value) {
        const cleaned = String(value ?? "")
          .replace(/\s/g, "")
          .replace(/[^\d.-]/g, "");
        const num = parseFloat(cleaned);
        return isFinite(num) ? num : 0;
      }

      function getCanvasDataURL(canvasId) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return "";
        try {
          return canvas.toDataURL("image/png", 1);
        } catch (err) {
          console.warn("Gagal eksport canvas", canvasId, err);
          return "";
        }
      }

      function buildBarChartImage({ title, labels, datasets }) {
        if (typeof Chart === "undefined" || !labels.length || !datasets.length) {
          return "";
        }
        const canvas = document.createElement("canvas");
        canvas.width = 1100;
        canvas.height = 620;
        const ctx = canvas.getContext("2d");
        const chart = new Chart(ctx, {
          type: "bar",
          data: { labels, datasets },
          options: {
            responsive: false,
            plugins: {
              legend: { position: "top" },
              title: { display: true, text: title },
            },
            scales: {
              y: { beginAtZero: true, title: { display: true, text: "Nilai" } },
            },
          },
        });
        const url = canvas.toDataURL("image/png", 1);
        chart.destroy();
        return url;
      }

      function buildSupplyDemandChartImage(summary) {
        const labels = ["Purata (MLD)", "Puncak (MLD)"];
        const demand = [summary.avgMLD, summary.peakMLD];
        const supply = [summary.effectiveMLD, summary.effectiveMLD];
        return buildBarChartImage({
          title: "Permintaan vs Bekalan Efektif",
          labels,
          datasets: [
            {
              label: "Permintaan",
              data: demand,
              backgroundColor: "rgba(255, 87, 34, 0.85)",
            },
            {
              label: "Bekalan Efektif",
              data: supply,
              backgroundColor: "rgba(13, 110, 253, 0.82)",
            },
          ],
        });
      }

      function buildAltCompositionChartImage(altSources) {
        if (!altSources || !altSources.length) return "";
        const labels = altSources.map((s) => s.name || "Sumber");
        const data = altSources.map((s) =>
          (parseFloat(s.capacity) || 0) * ((parseFloat(s.utilPercent) || 0) / 100)
        );
        return buildBarChartImage({
          title: "Komposisi Sumber Air Alternatif (m¬≥/hari berkesan)",
          labels,
          datasets: [
            {
              label: "Bekalan berkesan",
              data,
              backgroundColor: "rgba(0, 188, 212, 0.8)",
            },
          ],
        });
      }

      function createStatusPill(status, isPeak) {
        if (!status) return "";
        const cls =
          status === "Surplus" ? "status-surplus" : "status-deficit";
        const label =
          status === "Surplus"
            ? isPeak
              ? "Surplus (puncak)"
              : "Surplus"
            : isPeak
            ? "Defisit (puncak)"
            : "Defisit";
        return `<span class="status-pill ${cls}">${
          status === "Surplus" ? "‚úîÔ∏è" : "‚ö†Ô∏è"
        } ${label}</span>`;
      }

      function blobToDataURL(blob) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(blob);
        });
      }

      async function loadUmsLogoDataUrl() {
        if (umsLogoDataUrl) return umsLogoDataUrl;
        try {
          const res = await fetch(encodeURI(umsLogoPath));
          if (!res.ok) throw new Error(`Logo gagal dimuat (status ${res.status})`);
          const blob = await res.blob();
          umsLogoDataUrl = await blobToDataURL(blob);
        } catch (err) {
          console.warn("Gagal memuat logo UMS untuk laporan:", err);
          umsLogoDataUrl = "";
        }
        return umsLogoDataUrl;
      }

      function waitForNextFrame() {
        return new Promise((resolve) => requestAnimationFrame(() => resolve()));
      }

      function wait(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }

      function waitForImages(container) {
        const imgs = Array.from(container.querySelectorAll("img"));
        const pending = imgs.filter((img) => !img.complete || img.naturalWidth === 0);
        if (!pending.length) return Promise.resolve();
        return Promise.allSettled(
          pending.map(
            (img) =>
              new Promise((resolve) => {
                img.addEventListener("load", resolve, { once: true });
                img.addEventListener("error", resolve, { once: true });
              })
          )
        );
      }

      function waitForFonts() {
        if (document.fonts && document.fonts.ready) {
          return document.fonts.ready.catch(() => undefined);
        }
        return Promise.resolve();
      }

      function calculate() {
        // 1. Demand by category
        const rows = Array.from(document.querySelectorAll(".category-row"));
        const categoryNames = [];
        const peakDemands = [];
        const avgDemands = [];

        let totalPop = 0;
        let totalAvgM3 = 0;
        let totalPeakM3 = 0;

        resultsBody.innerHTML = "";

        rows.forEach((row) => {
          const nameInput = row.querySelector(".cat-name");
          const popInput = row.querySelector(".cat-pop");
          const perCapInput = row.querySelector(".cat-percap");
          const peakInput = row.querySelector(".cat-peak");

          const name = (nameInput.value || "").trim();
          const pop = parseFloat(popInput.value);
          const perCap = parseFloat(perCapInput.value);
          const peak = parseFloat(peakInput.value);

          if (!name || !isFinite(pop) || pop <= 0 || !isFinite(perCap)) {
            return;
          }

          const avgM3 = (pop * perCap) / 1000;
          const peakM3 = avgM3 * (isFinite(peak) && peak > 0 ? peak : 1);

          totalPop += pop;
          totalAvgM3 += avgM3;
          totalPeakM3 += peakM3;

          categoryNames.push(name);
          avgDemands.push(avgM3);
          peakDemands.push(peakM3);

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${name}</td>
            <td>${formatNumber(pop)}</td>
            <td>${formatNumber(perCap)}</td>
            <td>${formatNumber(avgM3)}</td>
            <td>${isFinite(peak) ? formatNumber(peak) : "‚Äì"}</td>
            <td>${formatNumber(peakM3)}</td>
          `;
          resultsBody.appendChild(tr);
        });

        const totalAvgMLD = totalAvgM3 / 1000;
        const totalPeakMLD = totalPeakM3 / 1000;

        totalPopEl.textContent = totalPop ? formatNumber(totalPop) : "‚Äì";
        totalAvgM3El.textContent = formatNumber(totalAvgM3);
        totalPeakM3El.textContent = formatNumber(totalPeakM3);
        totalAvgMLDEl.textContent = formatNumber(totalAvgMLD);
        totalPeakMLDEl.textContent = formatNumber(totalPeakMLD);

        // 2. Baseline supply (JANS)
        const supplyBaseMLD = parseFloat(supplyInput.value);
        const supplyValid = isFinite(supplyBaseMLD) && supplyBaseMLD >= 0;

        supplyAvgMLDEl.textContent = supplyValid
          ? formatNumber(supplyBaseMLD)
          : "‚Äì";

        // 3. Alternative supply + build altData for CBA
        const altRows = Array.from(document.querySelectorAll(".alt-row"));
        let altAvgM3PerDayTotal = 0;
        const altData = [];

        altRows.forEach((row) => {
          const name = (row.querySelector(".alt-name").value || "").trim();
          const cap = parseFloat(row.querySelector(".alt-capacity").value);
          const util = parseFloat(row.querySelector(".alt-util").value);
          const capex = parseFloat(row.querySelector(".alt-capex").value);
          const capexNote = (row.querySelector(".alt-capex-note")?.value || "").trim();
          const opexFixed = parseFloat(
            row.querySelector(".alt-opex-fixed").value
          );
          const opexVar = parseFloat(
            row.querySelector(".alt-opex-var").value
          );
          const opexNote = (row.querySelector(".alt-opex-note")?.value || "").trim();
          const lifeYears = parseFloat(row.querySelector(".alt-life").value);

          if (!name || !isFinite(cap) || cap <= 0 || !isFinite(util) || util <= 0) {
            return;
          }

          const avgM3PerDayEff = cap * (util / 100);
          altAvgM3PerDayTotal += avgM3PerDayEff;

          altData.push({
            name,
            capacity: cap,
            utilPercent: util,
            capex: isFinite(capex) ? capex : 0,
            capexNote,
            opexFixed: isFinite(opexFixed) ? opexFixed : 0,
            opexVar: isFinite(opexVar) ? opexVar : 0,
            opexNote,
            lifeYears: isFinite(lifeYears) ? lifeYears : NaN,
          });
        });

        const altSupplyMLD = altAvgM3PerDayTotal / 1000;
        altSupplyMLDEl.textContent = altData.length
          ? formatNumber(altSupplyMLD)
          : "0.00";

        const effectiveSupplyMLD = (supplyValid ? supplyBaseMLD : 0) + altSupplyMLD;
        effectiveSupplyMLDEl.textContent = effectiveSupplyMLD
          ? formatNumber(effectiveSupplyMLD)
          : "‚Äì";

        // 4. Demand vs effective supply
        summaryAvgMLDEl.textContent = formatNumber(totalAvgMLD);
        summaryPeakMLDEl.textContent = formatNumber(totalPeakMLD);

        let surplusAvg = null;
        let surplusPeak = null;
        let statusAvg = "";
        let statusPeak = "";

        rowAvg.classList.remove("summary-row-surplus", "summary-row-deficit");
        rowPeak.classList.remove("summary-row-surplus", "summary-row-deficit");

        if (effectiveSupplyMLD > 0) {
          surplusAvg = effectiveSupplyMLD - totalAvgMLD;
          surplusPeak = effectiveSupplyMLD - totalPeakMLD;

          surplusAvgMLDEl.textContent = formatNumber(surplusAvg);
          surplusPeakMLDEl.textContent = formatNumber(surplusPeak);

          if (totalAvgMLD > 0) {
            statusAvg = surplusAvg >= 0 ? "Surplus" : "Deficit";
          }
          if (totalPeakMLD > 0) {
            statusPeak = surplusPeak >= 0 ? "Surplus" : "Deficit";
          }

          if (statusAvg === "Surplus") {
            rowAvg.classList.add("summary-row-surplus");
          } else if (statusAvg === "Deficit") {
            rowAvg.classList.add("summary-row-deficit");
          }

          if (statusPeak === "Surplus") {
            rowPeak.classList.add("summary-row-surplus");
          } else if (statusPeak === "Deficit") {
            rowPeak.classList.add("summary-row-deficit");
          }
        } else {
          surplusAvgMLDEl.textContent = "‚Äì";
          surplusPeakMLDEl.textContent = "‚Äì";
        }

        statusAvgEl.innerHTML = createStatusPill(statusAvg, false);
        statusPeakEl.innerHTML = createStatusPill(statusPeak, true);

        // 5. Ringkasan teks
        if (!categoryNames.length) {
          summaryTextEl.innerHTML =
            "Sila masukkan sekurang-kurangnya satu kategori dengan populasi dan kadar per kapita untuk menjana analisis.";
        } else if (!supplyValid && !altData.length) {
          summaryTextEl.innerHTML =
            "Permintaan purata dianggarkan sebanyak <strong>" +
            formatNumber(totalAvgMLD) +
            " MLD</strong>, manakala permintaan puncak sebanyak <strong>" +
            formatNumber(totalPeakMLD) +
            " MLD</strong>. Sila masukkan nilai bekalan JANS dan/atau sumber alternatif untuk menilai surplus atau defisit.";
        } else {
          const baseText = supplyValid
            ? "Bekalan sedia ada (JANS) dianggarkan <strong>" +
              formatNumber(supplyBaseMLD) +
              " MLD</strong>."
            : "Bekalan JANS tidak ditetapkan dengan jelas.";

          const altText = altData.length
            ? " Sumber alternatif menambah kira-kira <strong>" +
              formatNumber(altSupplyMLD) +
              " MLD</strong> kepada bekalan."
            : " Tiada sumber alternatif dimasukkan setakat ini.";

          const effText =
            " Bekalan efektif (JANS + alternatif) dianggarkan <strong>" +
            formatNumber(effectiveSupplyMLD) +
            " MLD</strong>.";

          const avgWord = surplusAvg >= 0 ? "surplus" : "defisit";
          const peakWord = surplusPeak >= 0 ? "surplus" : "defisit";

          summaryTextEl.innerHTML =
            baseText +
            altText +
            effText +
            " Jumlah permintaan purata kampus dianggarkan <strong>" +
            formatNumber(totalAvgMLD) +
            " MLD</strong> (" +
            avgWord +
            " " +
            formatNumber(Math.abs(surplusAvg)) +
            " MLD), manakala permintaan puncak dianggarkan <strong>" +
            formatNumber(totalPeakMLD) +
            " MLD</strong> (" +
            peakWord +
            " " +
            formatNumber(Math.abs(surplusPeak)) +
            " MLD).";
        }

        // 6. Update demand charts
        updateDemandCharts(categoryNames, avgDemands, peakDemands);

        // 7. CBA for alternative sources
        calculateAltCBA(altData);
      }

      function updateDemandCharts(labels, avgData, peakData) {
        if (categoryChart) categoryChart.destroy();
        if (shareChart) shareChart.destroy();

        if (!labels.length) return;

        categoryChart = new Chart(categoryChartCtx, {
          type: "bar",
          data: {
            labels,
            datasets: [
              {
                label: "Purata (m¬≥/hari)",
                data: avgData,
                backgroundColor: "rgba(13, 110, 253, 0.7)",
                borderRadius: 6,
              },
              {
                label: "Puncak (m¬≥/hari)",
                data: peakData,
                backgroundColor: "rgba(0, 188, 212, 0.7)",
                borderRadius: 6,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: "top" },
              title: {
                display: true,
                text: "Permintaan Air Mengikut Kategori",
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                title: { display: true, text: "m¬≥/hari" },
              },
            },
          },
        });

        shareChart = new Chart(shareChartCtx, {
          type: "pie",
          data: {
            labels,
            datasets: [
              {
                data: avgData,
                backgroundColor: [
                  "rgba(13, 110, 253, 0.85)",
                  "rgba(0, 188, 212, 0.85)",
                  "rgba(3, 169, 244, 0.85)",
                  "rgba(0, 150, 136, 0.85)",
                  "rgba(63, 81, 181, 0.85)",
                  "rgba(33, 150, 243, 0.85)",
                ],
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: "right" },
              title: {
                display: true,
                text: "Agihan Permintaan Purata Mengikut Kategori",
              },
            },
          },
        });
      }

      function computeIRR(initialCapex, netCF, years) {
        if (!(isFinite(initialCapex) && isFinite(netCF) && initialCapex > 0 && netCF > 0 && years > 0)) {
          return NaN;
        }
        let low = 0.0;
        let high = 0.3; // 0%‚Äì30%
        function npv(rate) {
          let val = -initialCapex;
          for (let t = 1; t <= years; t++) {
            val += netCF / Math.pow(1 + rate, t);
          }
          return val;
        }
        let npvLow = npv(low);
        let npvHigh = npv(high);
        if (npvLow * npvHigh > 0) {
          return NaN;
        }
        for (let i = 0; i < 40; i++) {
          const mid = (low + high) / 2;
          const npvMid = npv(mid);
          if (Math.abs(npvMid) < 1e-3) {
            return mid;
          }
          if (npvLow * npvMid < 0) {
            high = mid;
            npvHigh = npvMid;
          } else {
            low = mid;
            npvLow = npvMid;
          }
        }
        return (low + high) / 2;
      }

      function calculateAltCBA(altData) {
        // Clear if no data
        altResultsBody.innerHTML = "";
        if (cbaNpvChart) cbaNpvChart.destroy();
        if (cbaPaybackChart) cbaPaybackChart.destroy();

        const tariffWater = parseFloat(tariffWaterInput.value) || 0;
        const tariffSewer = parseFloat(tariffSewerInput.value) || 0;
        const tariffTotal = tariffWater + tariffSewer;

        const analysisYears = parseInt(analysisYearsInput.value, 10) || 0;
        const discountRate = parseFloat(discountRateInput.value) || 0;
        const r = discountRate / 100;

        let totalCap = 0;
        let totalVol = 0;
        let totalCapex = 0;
        let totalOpex = 0;
        let totalSaving = 0;
        let totalNetCF = 0;

        let totalPVBenefits = 0;
        let totalPVCosts = 0;

        const labels = [];
        const npvData = [];
        const paybackData = [];

        if (!altData.length || analysisYears <= 0) {
          altTotalCapacityEl.textContent = "0.00";
          altTotalVolumeEl.textContent = "0.00";
          altTotalCapexEl.textContent = "0.00";
          altTotalOpexEl.textContent = "0.00";
          altTotalSavingEl.textContent = "0.00";
          altTotalNetCFEl.textContent = "0.00";
          altTotalNPVEl.textContent = "0.00";
          altTotalBCREl.textContent = "‚Äì";

          sumCapexEl.textContent = "0.00";
          sumSavingEl.textContent = "0.00";
          sumOpexEl.textContent = "0.00";
          sumNetCFEl.textContent = "0.00";
          sumNPVEl.textContent = "0.00";
          sumBCREl.textContent = "‚Äì";
          sumIRREl.textContent = "‚Äì";

          lastAltSources = [];
          return;
        }

        altData.forEach((s) => {
          const { name, capacity, utilPercent, capex, opexFixed, opexVar, lifeYears } = s;
          const volAnnual = capacity * (utilPercent / 100) * 365;

          const savingAnnual = volAnnual * tariffTotal;
          const opexAnnual = opexFixed + opexVar * volAnnual;
          const netCF = savingAnnual - opexAnnual;

          // Simple payback
          let payback = NaN;
          if (netCF > 0 && capex > 0) {
            payback = capex / netCF;
          }

          // NPV & BCR
          const horizon = isFinite(lifeYears) && lifeYears > 0
            ? Math.min(analysisYears, Math.round(lifeYears))
            : analysisYears;

          let pvBenefits = 0;
          let pvCosts = capex;

          for (let t = 1; t <= horizon; t++) {
            const df = Math.pow(1 + r, t);
            pvBenefits += savingAnnual / df;
            pvCosts += opexAnnual / df;
          }

          const npv = pvBenefits - pvCosts;
          const bcr = pvCosts > 0 ? pvBenefits / pvCosts : NaN;

          totalCap += capacity;
          totalVol += volAnnual;
          totalCapex += capex;
          totalOpex += opexAnnual;
          totalSaving += savingAnnual;
          totalNetCF += netCF;

          totalPVBenefits += pvBenefits;
          totalPVCosts += pvCosts;

          labels.push(name);
          npvData.push(npv);
          paybackData.push(isFinite(payback) ? payback : null);

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${name}</td>
            <td>${formatNumber(capacity)}</td>
            <td>${formatNumber(utilPercent)}</td>
            <td>${formatNumber(volAnnual)}</td>
            <td>${formatNumber(capex)}</td>
            <td>${formatNumber(opexAnnual)}</td>
            <td>${formatNumber(savingAnnual)}</td>
            <td>${formatNumber(netCF)}</td>
            <td>${isFinite(payback) ? formatNumber(payback) : "‚Äì"}</td>
            <td>${formatNumber(npv)}</td>
            <td>${isFinite(bcr) ? formatNumber(bcr) : "‚Äì"}</td>
          `;
          altResultsBody.appendChild(tr);
        });

        const totalNPV = totalPVBenefits - totalPVCosts;
        const totalBCR = totalPVCosts > 0 ? totalPVBenefits / totalPVCosts : NaN;

        altTotalCapacityEl.textContent = formatNumber(totalCap);
        altTotalVolumeEl.textContent = formatNumber(totalVol);
        altTotalCapexEl.textContent = formatNumber(totalCapex);
        altTotalOpexEl.textContent = formatNumber(totalOpex);
        altTotalSavingEl.textContent = formatNumber(totalSaving);
        altTotalNetCFEl.textContent = formatNumber(totalNetCF);
        altTotalNPVEl.textContent = formatNumber(totalNPV);
        altTotalBCREl.textContent = isFinite(totalBCR) ? formatNumber(totalBCR) : "‚Äì";

        sumCapexEl.textContent = formatNumber(totalCapex);
        sumSavingEl.textContent = formatNumber(totalSaving);
        sumOpexEl.textContent = formatNumber(totalOpex);
        sumNetCFEl.textContent = formatNumber(totalNetCF);
        sumNPVEl.textContent = formatNumber(totalNPV);
        sumBCREl.textContent = isFinite(totalBCR) ? formatNumber(totalBCR) : "‚Äì";

        // IRR anggaran untuk projek (menggunakan totalCapex & totalNetCF)
        const irr = computeIRR(totalCapex, totalNetCF, analysisYears);
        sumIRREl.textContent = isFinite(irr) ? (irr * 100).toFixed(2) + " %" : "‚Äì";

        // Simpan altData untuk laporan PDF (termasuk nota CAPEX/OPEX)
        lastAltSources = altData.slice();

        // Charts NPV & Payback
        if (labels.length) {
          cbaNpvChart = new Chart(cbaNPVCtx, {
            type: "bar",
            data: {
              labels,
              datasets: [
                {
                  label: "NPV (RM)",
                  data: npvData,
                  backgroundColor: "rgba(3, 169, 244, 0.8)",
                  borderRadius: 6,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: { display: false },
                title: { display: true, text: "NPV Mengikut Sumber Air Alternatif" },
              },
              scales: {
                y: { beginAtZero: false, title: { display: true, text: "RM" } },
              },
            },
          });

          cbaPaybackChart = new Chart(cbaPaybackCtx, {
            type: "bar",
            data: {
              labels,
              datasets: [
                {
                  label: "Payback (tahun)",
                  data: paybackData,
                  backgroundColor: "rgba(255, 193, 7, 0.9)",
                  borderRadius: 6,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: { display: false },
                title: { display: true, text: "Payback Period Mengikut Sumber" },
              },
              scales: {
                y: {
                  beginAtZero: true,
                  title: { display: true, text: "Tahun" },
                },
              },
            },
          });
        }
      }

      // CAPEX/OPEX itemised calculator
      function recalcCapexOpexItems() {
        const rows = Array.from(document.querySelectorAll(".capex-opex-row"));
        let capexTotal = 0;
        let opexTotal = 0;

        rows.forEach((row) => {
          const type = row.querySelector(".item-type").value;
          const qty = parseFloat(row.querySelector(".item-qty").value) || 0;
          const cost = parseFloat(row.querySelector(".item-cost").value) || 0;
          const total = qty * cost;
          row.querySelector(".item-total").textContent = formatNumber(total);
          if (type === "CAPEX") {
            capexTotal += total;
          } else {
            opexTotal += total;
          }
        });

        capexItemsTotalEl.textContent = formatNumber(capexTotal);
        opexItemsTotalEl.textContent = formatNumber(opexTotal);
      }

      function collectReportData() {
        recalcCapexOpexItems();
        calculate();

        const now = new Date();
        const generatedDate = now.toLocaleDateString("ms-MY");
        const fileDate = now.toISOString().slice(0, 10);

        const summary = {
          avgMLD: parseNumberFromText(summaryAvgMLDEl.textContent),
          peakMLD: parseNumberFromText(summaryPeakMLDEl.textContent),
          supplyMLD: parseNumberFromText(supplyAvgMLDEl.textContent),
          altSupplyMLD: parseNumberFromText(altSupplyMLDEl.textContent),
          effectiveMLD: parseNumberFromText(effectiveSupplyMLDEl.textContent),
          surplusAvg: parseNumberFromText(surplusAvgMLDEl.textContent),
          surplusPeak: parseNumberFromText(surplusPeakMLDEl.textContent),
          text: {
            avg: summaryAvgMLDEl.textContent || "‚Äì",
            peak: summaryPeakMLDEl.textContent || "‚Äì",
            supply: supplyAvgMLDEl.textContent || "‚Äì",
            alt: altSupplyMLDEl.textContent || "‚Äì",
            effective: effectiveSupplyMLDEl.textContent || "‚Äì",
            surplusAvg: surplusAvgMLDEl.textContent || "‚Äì",
            surplusPeak: surplusPeakMLDEl.textContent || "‚Äì",
          },
          status: {
            avg: statusAvgEl.textContent || "‚Äì",
            peak: statusPeakEl.textContent || "‚Äì",
          },
        };

        const categoryInputs = Array.from(
          document.querySelectorAll(".category-row")
        )
          .map((row) => ({
            name: row.querySelector(".cat-name")?.value || "",
            pop: row.querySelector(".cat-pop")?.value || "",
            percap: row.querySelector(".cat-percap")?.value || "",
            peak: row.querySelector(".cat-peak")?.value || "",
          }))
          .filter(
            (r) =>
              r.name.trim() ||
              parseNumberFromText(r.pop) > 0 ||
              parseNumberFromText(r.percap) > 0
          );

        const demandByCategory = Array.from(
          document.querySelectorAll("#results-body tr")
        ).map((tr) => {
          const cells = tr.querySelectorAll("td");
          return {
            name: cells[0]?.textContent.trim() || "-",
            pop: cells[1]?.textContent.trim() || "‚Äì",
            percap: cells[2]?.textContent.trim() || "‚Äì",
            avg: cells[3]?.textContent.trim() || "‚Äì",
            peakFactor: cells[4]?.textContent.trim() || "‚Äì",
            peak: cells[5]?.textContent.trim() || "‚Äì",
          };
        });

        const altRows = Array.from(
          document.querySelectorAll("#alt-results-body tr")
        );
        const altSources = altRows.map((tr, idx) => {
          const cells = tr.querySelectorAll("td");
          return {
            name: cells[0]?.textContent.trim() || "-",
            capacity: cells[1]?.textContent.trim() || "‚Äì",
            util: cells[2]?.textContent.trim() || "‚Äì",
            volume: cells[3]?.textContent.trim() || "‚Äì",
            capex: cells[4]?.textContent.trim() || "‚Äì",
            opex: cells[5]?.textContent.trim() || "‚Äì",
            saving: cells[6]?.textContent.trim() || "‚Äì",
            netcf: cells[7]?.textContent.trim() || "‚Äì",
            payback: cells[8]?.textContent.trim() || "‚Äì",
            npv: cells[9]?.textContent.trim() || "‚Äì",
            bcr: cells[10]?.textContent.trim() || "‚Äì",
            capexNote: lastAltSources[idx]?.capexNote || "",
            opexNote: lastAltSources[idx]?.opexNote || "",
          };
        });

        const altTotals = {
          capacity: altTotalCapacityEl.textContent || "‚Äì",
          volume: altTotalVolumeEl.textContent || "‚Äì",
          capex: altTotalCapexEl.textContent || "‚Äì",
          opex: altTotalOpexEl.textContent || "‚Äì",
          saving: altTotalSavingEl.textContent || "‚Äì",
          netcf: altTotalNetCFEl.textContent || "‚Äì",
          npv: altTotalNPVEl.textContent || "‚Äì",
          bcr: altTotalBCREl.textContent || "‚Äì",
        };

        const financeSummary = {
          capex: sumCapexEl.textContent || "‚Äì",
          saving: sumSavingEl.textContent || "‚Äì",
          opex: sumOpexEl.textContent || "‚Äì",
          netcf: sumNetCFEl.textContent || "‚Äì",
          npv: sumNPVEl.textContent || "‚Äì",
          bcr: sumBCREl.textContent || "‚Äì",
          irr: sumIRREl.textContent || "‚Äì",
        };

        const capexOpexItems = Array.from(
          document.querySelectorAll("#capex-opex-body tr")
        )
          .map((tr) => ({
            type: tr.querySelector(".item-type")?.value || "",
            name: tr.querySelector(".item-name")?.value || "",
            qty: tr.querySelector(".item-qty")?.value || "",
            cost: tr.querySelector(".item-cost")?.value || "",
            total: tr.querySelector(".item-total")?.textContent || "",
            note: tr.querySelector(".item-note")?.value || "",
          }))
          .filter(
            (r) =>
              r.name.trim() ||
              parseNumberFromText(r.qty) > 0 ||
              parseNumberFromText(r.cost) > 0
          );

        const assumptions = {
          supply: supplyInput.value || "",
          tariffWater: tariffWaterInput.value || "",
          tariffSewer: tariffSewerInput.value || "",
          years: analysisYearsInput.value || "",
          discount: discountRateInput.value || "",
        };

        const charts = {
          demandByCategory: getCanvasDataURL("demand-by-category-chart"),
          demandShare: getCanvasDataURL("demand-share-chart"),
          cbaNPV: getCanvasDataURL("cba-npv-chart"),
          cbaPayback: getCanvasDataURL("cba-payback-chart"),
        };
        const supplyDemandImg = buildSupplyDemandChartImage(summary);
        const altMixImg = buildAltCompositionChartImage(lastAltSources);
        if (supplyDemandImg) charts.supplyDemand = supplyDemandImg;
        if (altMixImg) charts.altComposition = altMixImg;

        const disclaimerText =
          "Laporan ini dijana secara automatik berdasarkan input semasa kalkulator. " +
          "Nilai kewangan dan teknikal adalah anggaran untuk tujuan perancangan awal " +
          "dan tertakluk kepada perubahan selepas audit data meter serta semakan " +
          "kejuruteraan terperinci.";

        return {
          generatedDate,
          fileDate,
          summary,
          categoryInputs,
          demandByCategory,
          altSources,
          altTotals,
          financeSummary,
          capexOpexItems,
          assumptions,
          charts,
          disclaimerText,
          logoDataUrl: umsLogoDataUrl,
        };
      }

      function renderReportHTML(data) {
        const tocEntries = [
          { anchor: "ringkasan", title: "A. Ringkasan Eksekutif", page: "3" },
          { anchor: "latar-objektif", title: "B. Latar Belakang & C. Objektif", page: "4" },
          { anchor: "kaedah", title: "D. Kaedah Penilaian", page: "5" },
          { anchor: "input", title: "E. Input & Andaian", page: "6" },
          { anchor: "hasil", title: "F. Hasil Analisis", page: "7-8" },
          { anchor: "perbincangan", title: "G. Perbincangan & Implikasi", page: "9" },
          { anchor: "cadangan", title: "H. Cadangan & Pelan Pelaksanaan", page: "9" },
          { anchor: "risiko", title: "I. Risiko, Had & Keperluan Data", page: "10" },
          { anchor: "penafian", title: "J. Penafian", page: "10-11" },
          { anchor: "lampiran", title: "K. Lampiran", page: "11" },
        ];

        const tocHtml = tocEntries
          .map(
            (item) =>
              `<li><a href="#${item.anchor}">${item.title}</a><span class="page-num">${item.page}</span></li>`
          )
          .join("");

        const demandRows = data.demandByCategory.length
          ? data.demandByCategory
              .map(
                (row) => `
                  <tr>
                    <td>${row.name}</td>
                    <td>${row.pop}</td>
                    <td>${row.percap}</td>
                    <td>${row.avg}</td>
                    <td>${row.peakFactor}</td>
                    <td>${row.peak}</td>
                  </tr>
                `
              )
              .join("")
          : `<tr><td colspan="6">Tiada data permintaan ditetapkan.</td></tr>`;

        const inputCategoryRows = data.categoryInputs.length
          ? data.categoryInputs
              .map(
                (row, idx) => `
                  <tr>
                    <td>${idx + 1}</td>
                    <td>${row.name || "-"}</td>
                    <td>${row.pop || "-"}</td>
                    <td>${row.percap || "-"}</td>
                    <td>${row.peak || "-"}</td>
                  </tr>
                `
              )
              .join("")
          : `<tr><td colspan="5">Tiada input kategori tambahan dimasukkan.</td></tr>`;

        const altRowsHtml = data.altSources.length
          ? data.altSources
              .map(
                (row) => `
                  <tr>
                    <td>${row.name}</td>
                    <td>${row.capacity}</td>
                    <td>${row.util}</td>
                    <td>${row.volume}</td>
                    <td>${row.capex}</td>
                    <td>${row.opex}</td>
                    <td>${row.saving}</td>
                    <td>${row.netcf}</td>
                    <td>${row.payback}</td>
                    <td>${row.npv}</td>
                    <td>${row.bcr}</td>
                  </tr>
                `
              )
              .join("")
          : `<tr><td colspan="11">Tiada sumber alternatif dimasukkan.</td></tr>`;

        const capexOpexRows = data.capexOpexItems.length
          ? data.capexOpexItems
              .map(
                (item) => `
                  <tr>
                    <td>${item.type}</td>
                    <td>${item.name}</td>
                    <td>${item.qty}</td>
                    <td>${item.cost}</td>
                    <td>${item.total}</td>
                    <td>${item.note || "-"}</td>
                  </tr>
                `
              )
              .join("")
          : `<tr><td colspan="6">Belum ada pecahan CAPEX/OPEX item dimasukkan.</td></tr>`;

        const chartsHtml = `
          ${data.charts.supplyDemand ? `<div class="figure"><img src="${data.charts.supplyDemand}" alt="Graf permintaan vs bekalan" /><div class="caption">Rajah F1: Permintaan purata dan puncak berbanding bekalan efektif.</div></div>` : ""}
          ${data.charts.altComposition ? `<div class="figure"><img src="${data.charts.altComposition}" alt="Graf komposisi sumber alternatif" /><div class="caption">Rajah F2: Komposisi bekalan berkesan sumber air alternatif.</div></div>` : ""}
          ${data.charts.demandByCategory ? `<div class="figure"><img src="${data.charts.demandByCategory}" alt="Graf permintaan mengikut kategori" /><div class="caption">Rajah F3: Permintaan purata dan puncak mengikut kategori pengguna.</div></div>` : ""}
          ${data.charts.demandShare ? `<div class="figure"><img src="${data.charts.demandShare}" alt="Graf agihan permintaan" /><div class="caption">Rajah F4: Agihan permintaan (%) mengikut kategori.</div></div>` : ""}
          ${data.charts.cbaNPV ? `<div class="figure"><img src="${data.charts.cbaNPV}" alt="Graf NPV" /><div class="caption">Rajah F5: NPV projek mengikut sumber alternatif.</div></div>` : ""}
          ${data.charts.cbaPayback ? `<div class="figure"><img src="${data.charts.cbaPayback}" alt="Graf payback" /><div class="caption">Rajah F6: Payback period mengikut sumber alternatif.</div></div>` : ""}
        `;

        return `
          <div class="report-document">
            <section class="cover cover-water" id="cover">
              <div class="watermark">UMS</div>
              <div class="logo-box">
                ${
                  data.logoDataUrl
                    ? `<img src="${data.logoDataUrl}" alt="Logo Universiti Malaysia Sabah" />`
                    : `<div>Logo UMS</div>`
                }
              </div>
              <div>
                <div class="kicker">Laporan Profesional (PDF)</div>
                <h1>LAPORAN PERMINTAAN, BEKALAN DAN SUMBER AIR ALTERNATIF UNIVERSITI MALAYSIA SABAH (UMS)</h1>
                <div class="watermark-underline"></div>
                <h3>Dijana melalui Kalkulator Permintaan‚ÄìBekalan Air UMS (Versi Web)</h3>
                <p class="meta">Tarikh jana: ${data.generatedDate}</p>
                <p class="meta">Disediakan oleh: Prof. Madya Dr. Assis Kamu (Ketua); Dr. Fera @ Nony Cleophas; Dr. Sarimah Surianshah; Prof. Madya Ts. Dr. Mohd Sani Sarjadi</p>
                <p class="tagline">Semua perenggan diratakan (justify) dengan margin A4 25mm.</p>
              </div>
            </section>

            <div class="page-break"></div>

            <section class="toc report-page" id="toc">
              <div class="section-tag">Isi Kandungan</div>
              <h2>Isi Kandungan (Table of Contents)</h2>
              <p class="page-note">Nombor muka surat adalah anggaran automatik berdasarkan susun atur digital.</p>
              <ol>
                ${tocHtml}
              </ol>
              <div class="footer-note">Laporan UMS Water ¬∑ Tarikh jana: ${data.generatedDate}</div>
            </section>

            <div class="page-break"></div>

            <section class="report-page" id="ringkasan">
              <div class="section-tag">A. Ringkasan Eksekutif</div>
              <h2>Ringkasan Eksekutif</h2>
              <p>
                Analisis kalkulator menunjukkan permintaan purata kampus UMS adalah sekitar <strong>${data.summary.text.avg} MLD</strong> manakala permintaan puncak dianggarkan <strong>${data.summary.text.peak} MLD</strong>.
                Bekalan sedia ada (JANS) direkodkan <strong>${data.summary.text.supply} MLD</strong> dan sumber alternatif menambah <strong>${data.summary.text.alt} MLD</strong>, menghasilkan bekalan efektif <strong>${data.summary.text.effective} MLD</strong>.
                Status purata ialah <strong>${data.summary.status.avg}</strong> dan status puncak ialah <strong>${data.summary.status.peak}</strong>.
              </p>
              <div class="highlight-box">
                <ul class="list-tight">
                  <li>Surplus / defisit purata: ${data.summary.text.surplusAvg} MLD.</li>
                  <li>Surplus / defisit puncak: ${data.summary.text.surplusPeak} MLD.</li>
                  <li>Jumlah CAPEX alternatif (indikatif): ${data.financeSummary.capex}; OPEX tahunan: ${data.financeSummary.opex}; penjimatan tahunan: ${data.financeSummary.saving}; NPV projek: ${data.financeSummary.npv}; BCR: ${data.financeSummary.bcr}; IRR anggaran: ${data.financeSummary.irr}.</li>
                </ul>
              </div>
              <p>
                Laporan ini mengekalkan fokus kepada kebolehpercayaan bekalan, kesan kewangan dan keutamaan fasa pelaksanaan.
                Kandungan seterusnya menghuraikan latar belakang, metodologi, input pengguna, hasil analisis, implikasi pengurusan, cadangan pelaksanaan serta risiko dan had kajian.
              </p>
              <div class="footer-note">Sulit/Untuk Kegunaan Dalaman (Jika perlu) ¬∑ Laporan UMS Water</div>
            </section>

            <div class="page-break"></div>

            <section class="report-page" id="latar-objektif">
              <div class="section-tag">B. Latar Belakang</div>
              <h2>Latar Belakang</h2>
              <p>
                Universiti Malaysia Sabah bergantung kepada bekalan air terawat bagi menyokong operasi akademik, asrama, kemudahan ibadah dan sukan.
                Pertumbuhan populasi pelajar dan aktiviti kampus menuntut perancangan kapasiti bekalan yang lebih rapi, termasuk penerokaan sumber alternatif seperti tangkapan air hujan, reuse air terawat, air tasik dan kondensasi penghawa dingin.
              </p>
              <p>
                Laporan ini memanfaatkan kalkulator permintaan‚Äìbekalan air UMS untuk menukar input pengguna kepada indikator permintaan purata, permintaan puncak, keupayaan sumber alternatif dan prestasi kewangan asas projek.
                Semua angka adalah untuk tujuan perancangan dan perlu disemak dengan data meter sebenar.
              </p>

              <div class="section-tag" style="margin-top:1.1rem;">C. Objektif Projek</div>
              <h3>Objektif Projek</h3>
              <ul>
                <li>Menganggarkan permintaan air kampus mengikut kategori pengguna dan faktor puncak.</li>
                <li>Membandingkan permintaan purata dan puncak dengan bekalan sedia ada dan bekalan alternatif.</li>
                <li>Menilai sumbangan sumber air alternatif terhadap keselamatan bekalan dan penjimatan bil.</li>
                <li>Menjana indikator kewangan (CAPEX, OPEX, penjimatan, NPV, BCR, IRR, payback) secara automatik.</li>
                <li>Menyusun cadangan pelaksanaan fasa 1‚Äì3 serta keutamaan tindakan ‚Äúquick wins‚Äù.</li>
              </ul>
              <div class="footer-note">Sulit/Untuk Kegunaan Dalaman (Jika perlu) ¬∑ Laporan UMS Water</div>
            </section>

            <div class="page-break"></div>

            <section class="report-page" id="kaedah">
              <div class="section-tag">D. Kaedah Penilaian</div>
              <h2>Kaedah Penilaian</h2>
              <p>
                Penilaian ini menggabungkan pengiraan permintaan per kapita, faktor puncak, bekalan asas (JANS) dan model sumber air alternatif, berserta analisis kewangan projek.
              </p>
              <ul class="list-tight">
                <li><strong>Permintaan per kapita:</strong> setiap kategori dikira menggunakan populasi √ó kadar per kapita (L/org/hari) dan ditukar kepada m¬≥/hari.</li>
                <li><strong>Faktor puncak:</strong> permintaan purata didarab faktor puncak untuk menangkap variasi harian puncak.</li>
                <li><strong>Bekalan asas (JANS):</strong> input pengguna untuk bekalan terawat semasa (MLD) dijadikan asas rujukan.</li>
                <li><strong>Model sumber alternatif:</strong> kapasiti teknikal (m¬≥/hari), faktor penggunaan (% hari), CAPEX, OPEX tetap/berubah dan jangka hayat dimodelkan untuk mendapatkan bekalan berkesan dan penjimatan.</li>
                <li><strong>Andaian kewangan:</strong> tarif air + pembetungan, tempoh analisis dan kadar diskaun digunakan bagi mengira penjimatan tahunan, aliran tunai bersih, NPV, BCR, IRR dan payback.</li>
              </ul>
              <div class="highlight-box">
                <p class="page-note">
                  Semua perenggan diratakan (justify) dengan jarak perenggan konsisten untuk paparan cetakan A4 margin 25mm.
                </p>
              </div>
              <div class="footer-note">Sulit/Untuk Kegunaan Dalaman (Jika perlu) ¬∑ Laporan UMS Water</div>
            </section>

            <div class="page-break"></div>

            <section class="report-page" id="input">
              <div class="section-tag">E. Input & Andaian</div>
              <h2>Input &amp; Andaian Pengiraan</h2>
              <p>Jadual berikut merangkumkan input utama yang dimasukkan pengguna.</p>
              <div class="inline-table">
                <div class="box">
                  <div class="label">Bekalan asas (JANS)</div>
                  <div><strong>${data.assumptions.supply || "‚Äì"} MLD</strong></div>
                </div>
                <div class="box">
                  <div class="label">Tarif air (RM/m¬≥)</div>
                  <div>${data.assumptions.tariffWater || "‚Äì"}</div>
                </div>
                <div class="box">
                  <div class="label">Tarif pembetungan (RM/m¬≥)</div>
                  <div>${data.assumptions.tariffSewer || "‚Äì"}</div>
                </div>
                <div class="box">
                  <div class="label">Tempoh analisis (tahun)</div>
                  <div>${data.assumptions.years || "‚Äì"}</div>
                </div>
                <div class="box">
                  <div class="label">Kadar diskaun (%)</div>
                  <div>${data.assumptions.discount || "‚Äì"}</div>
                </div>
              </div>

              <h3>Input Permintaan Mengikut Kategori</h3>
              <table class="report-table zebra">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Kategori</th>
                    <th>Populasi</th>
                    <th>Per kapita (L/org/hari)</th>
                    <th>Faktor puncak</th>
                  </tr>
                </thead>
                <tbody>${inputCategoryRows}</tbody>
              </table>
              <div class="footer-note">Sulit/Untuk Kegunaan Dalaman (Jika perlu) ¬∑ Laporan UMS Water</div>
            </section>

            <div class="page-break"></div>

            <section class="report-page" id="hasil">
              <div class="section-tag">F. Hasil Analisis</div>
              <h2>Hasil Analisis Utama</h2>
              <h3>Ringkasan Permintaan & Bekalan (MLD)</h3>
              <table class="report-table zebra">
                <thead>
                  <tr>
                    <th>Item</th>
                    <th>Nilai</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td>Permintaan purata</td><td>${data.summary.text.avg}</td><td>${data.summary.status.avg}</td></tr>
                  <tr><td>Permintaan puncak</td><td>${data.summary.text.peak}</td><td>${data.summary.status.peak}</td></tr>
                  <tr><td>Bekalan sedia ada (JANS)</td><td>${data.summary.text.supply}</td><td>‚Äî</td></tr>
                  <tr><td>Bekalan sumber alternatif</td><td>${data.summary.text.alt}</td><td>‚Äî</td></tr>
                  <tr><td>Bekalan efektif (JANS + alternatif)</td><td>${data.summary.text.effective}</td><td>‚Äî</td></tr>
                  <tr><td>Surplus / Defisit purata</td><td>${data.summary.text.surplusAvg}</td><td>‚Äî</td></tr>
                  <tr><td>Surplus / Defisit puncak</td><td>${data.summary.text.surplusPeak}</td><td>‚Äî</td></tr>
                </tbody>
              </table>

              <h3>Permintaan Mengikut Kategori</h3>
              <table class="report-table zebra">
                <thead>
                  <tr>
                    <th>Kategori</th>
                    <th>Populasi</th>
                    <th>Per kapita (L/org/hari)</th>
                    <th>Purata (m¬≥/hari)</th>
                    <th>Faktor puncak</th>
                    <th>Permintaan puncak (m¬≥/hari)</th>
                  </tr>
                </thead>
                <tbody>${demandRows}</tbody>
              </table>

              <h3>Sumber Air Alternatif</h3>
              <table class="report-table zebra">
                <thead>
                  <tr>
                    <th>Sumber</th>
                    <th>Kapasiti (m¬≥/hari)</th>
                    <th>Utilisasi (% hari)</th>
                    <th>Vol. tahunan (m¬≥/tahun)</th>
                    <th>CAPEX (RM)</th>
                    <th>OPEX (RM/tahun)</th>
                    <th>Saving (RM/tahun)</th>
                    <th>CF bersih (RM/tahun)</th>
                    <th>Payback (tahun)</th>
                    <th>NPV (RM)</th>
                    <th>BCR</th>
                  </tr>
                </thead>
                <tbody>${altRowsHtml}</tbody>
                <tfoot>
                  <tr>
                    <td>Jumlah / Agregat</td>
                    <td>${data.altTotals.capacity}</td>
                    <td>‚Äî</td>
                    <td>${data.altTotals.volume}</td>
                    <td>${data.altTotals.capex}</td>
                    <td>${data.altTotals.opex}</td>
                    <td>${data.altTotals.saving}</td>
                    <td>${data.altTotals.netcf}</td>
                    <td>‚Äî</td>
                    <td>${data.altTotals.npv}</td>
                    <td>${data.altTotals.bcr}</td>
                  </tr>
                </tfoot>
              </table>

              <h3>Analisis Kewangan</h3>
              <div class="inline-table">
                <div class="box"><div class="label">Jumlah CAPEX</div><div>${data.financeSummary.capex}</div></div>
                <div class="box"><div class="label">Jumlah OPEX (tahun)</div><div>${data.financeSummary.opex}</div></div>
                <div class="box"><div class="label">Penjimatan (tahun)</div><div>${data.financeSummary.saving}</div></div>
                <div class="box"><div class="label">Aliran tunai bersih</div><div>${data.financeSummary.netcf}</div></div>
                <div class="box"><div class="label">NPV projek</div><div>${data.financeSummary.npv}</div></div>
                <div class="box"><div class="label">BCR</div><div>${data.financeSummary.bcr}</div></div>
                <div class="box"><div class="label">IRR anggaran</div><div>${data.financeSummary.irr}</div></div>
              </div>
              <div class="footer-note">Sulit/Untuk Kegunaan Dalaman (Jika perlu) ¬∑ Laporan UMS Water</div>
            </section>

            <div class="page-break"></div>

            <section class="report-page" id="hasil-visual">
              <div class="section-tag">F. Visual & Graf Sokongan</div>
              <h2>Graf Permintaan, Bekalan & Kewangan</h2>
              ${chartsHtml}
              <p class="page-note">Graf diekstrak terus daripada kanvas kalkulator (resolusi tinggi) supaya tidak pecah apabila dicetak.</p>
              <div class="footer-note">Sulit/Untuk Kegunaan Dalaman (Jika perlu) ¬∑ Laporan UMS Water</div>
            </section>

            <div class="page-break"></div>

            <section class="report-page" id="perbincangan">
              <div class="section-tag">G. Perbincangan & Implikasi Pengurusan</div>
              <h2>Implikasi Pengurusan</h2>
              <p>
                Surplus/defisit yang ditunjukkan memberikan gambaran awal kebergantungan kampus kepada bekalan JANS.
                Sumber alternatif yang konsisten mampu mengecilkan jurang permintaan‚Äìbekalan dan mengurangkan risiko gangguan operasi.
                Sekiranya defisit puncak kekal, intervensi pengurusan permintaan (audit kebocoran, retrofit peralatan, kempen kesedaran) perlu dilaksanakan selari dengan projek alternatif.
              </p>
              <p>
                Dari sudut kewangan, nilai NPV, BCR dan IRR menjadi indikator kesesuaian pelaburan. Projek dengan payback lebih singkat serta CAPEX sederhana wajar diprioritikan pada fasa awal.
                Penjimatan bil air dan pembetungan perlu dipantau secara berkala bagi mengesahkan jangkaan aliran tunai bersih.
              </p>
            </section>

            <section class="report-page" id="cadangan">
              <div class="section-tag">H. Cadangan & Pelan Pelaksanaan</div>
              <h2>Pelan Tindakan</h2>
              <div class="phase-grid">
                <div class="phase-card">
                  <h4>Fasa 1: Quick Wins (0‚Äì6 bulan)</h4>
                  <ul>
                    <li>Tangkapan air hujan berskala kecil pada bangunan tumpuan.</li>
                    <li>Pengumpulan kondensasi penghawa dingin untuk kegunaan landskap.</li>
                    <li>Audit kebocoran dalaman dan pemasangan meter sub-zon.</li>
                  </ul>
                </div>
                <div class="phase-card">
                  <h4>Fasa 2: Pengukuhan (6‚Äì18 bulan)</h4>
                  <ul>
                    <li>Sistem reuse (greywater/RO) untuk tandas dan pembersihan.</li>
                    <li>Penyambungan ke tangki penimbal zon utama kampus.</li>
                    <li>Kemas kini tarif & OPEX berdasarkan kontrak sebenar.</li>
                  </ul>
                </div>
                <div class="phase-card">
                  <h4>Fasa 3: Skala Penuh (18‚Äì36 bulan)</h4>
                  <ul>
                    <li>Pembangunan sumber air tasik/kewujudan kolam rawatan awal.</li>
                    <li>Integrasi SCADA/IoT untuk pemantauan penggunaan masa nyata.</li>
                    <li>Pengoptimuman campuran sumber untuk memaksimumkan BCR/NPV.</li>
                  </ul>
                </div>
              </div>
              <p class="page-note">Keutamaan boleh dilaras mengikut bajet dan keperluan operasi semasa kampus.</p>
              <div class="footer-note">Sulit/Untuk Kegunaan Dalaman (Jika perlu) ¬∑ Laporan UMS Water</div>
            </section>

            <div class="page-break"></div>

            <section class="report-page" id="risiko">
              <div class="section-tag">I. Risiko, Had Kajian & Keperluan Data</div>
              <h2>Risiko & Had</h2>
              <div class="risk-grid">
                <div class="risk-card">
                  <strong>Ketidakpastian data input</strong>
                  <p>Populasi, kadar per kapita dan faktor puncak mungkin berbeza mengikut musim akademik.</p>
                </div>
                <div class="risk-card">
                  <strong>Variasi ketersediaan hujan</strong>
                  <p>Kapasiti air hujan bergantung kepada pola hujan; perlu data sejarah tempatan.</p>
                </div>
                <div class="risk-card">
                  <strong>Andaian tarif</strong>
                  <p>Penjimatan kewangan sensitif kepada tarif air/pembetungan semasa dan semakan tarif akan datang.</p>
                </div>
                <div class="risk-card">
                  <strong>Teknikal & integrasi</strong>
                  <p>Infrastruktur sedia ada (paip, tangki, pam) perlu disahkan sebelum sambungan sumber alternatif.</p>
                </div>
              </div>
              <h3>Keperluan Data Lanjutan</h3>
              <ul class="list-tight">
                <li>Data meter utama & sub-zon beresolusi harian/mingguan.</li>
                <li>Profil beban puncak mengikut blok bangunan.</li>
                <li>Log operasi sistem sedia ada serta rekod OPEX sebenar.</li>
                <li>Data hujan setempat dan potensi kawasan tangkapan.</li>
              </ul>
              <div class="footer-note">Sulit/Untuk Kegunaan Dalaman (Jika perlu) ¬∑ Laporan UMS Water</div>
            </section>

            <section class="report-page" id="penafian">
              <div class="section-tag">J. Penafian</div>
              <h2>Penafian Laporan</h2>
              <p>${data.disclaimerText}</p>
              <p>
                Sebarang keputusan pelaburan, reka bentuk kejuruteraan atau kontrak hendaklah dirujuk kepada data meter rasmi dan pengesahan pihak berkuasa berkaitan.
                Laporan ini disediakan untuk kegunaan dalaman dan boleh dikemas kini apabila data baharu tersedia.
              </p>
              <div class="footer-note">Sulit/Untuk Kegunaan Dalaman (Jika perlu) ¬∑ Laporan UMS Water</div>
            </section>

            <section class="report-page" id="lampiran">
              <div class="section-tag">K. Lampiran</div>
              <h2>Lampiran ‚Äì Jadual Terperinci CAPEX/OPEX</h2>
              <table class="report-table zebra">
                <thead>
                  <tr>
                    <th>Jenis</th>
                    <th>Item / Komponen</th>
                    <th>Kuantiti</th>
                    <th>Kos seunit (RM)</th>
                    <th>Jumlah kos (RM)</th>
                    <th>Catatan</th>
                  </tr>
                </thead>
                <tbody>${capexOpexRows}</tbody>
              </table>
              <p class="page-note">Jumlah CAPEX: ${data.financeSummary.capex} | Jumlah OPEX: ${data.financeSummary.opex}</p>
              <div class="highlight-box">
                <strong>Penafian (rujukan semula):</strong> ${data.disclaimerText}
              </div>
              <div class="footer-note">Sulit/Untuk Kegunaan Dalaman (Jika perlu) ¬∑ Laporan UMS Water</div>
            </section>
          </div>
        `;
      }

      addItemBtn.addEventListener("click", () => {
        const tr = document.createElement("tr");
        tr.className = "capex-opex-row";
        tr.innerHTML = `
          <td>
            <select class="item-type">
              <option value="CAPEX">CAPEX</option>
              <option value="OPEX">OPEX</option>
            </select>
          </td>
          <td><input type="text" class="item-name" placeholder="Nama item" /></td>
          <td><input type="number" class="item-qty" value="1" min="0" step="0.01" /></td>
          <td><input type="number" class="item-cost" value="0" min="0" step="0.01" /></td>
          <td class="item-total">0.00</td>
          <td><input type="text" class="item-note" placeholder="Catatan (jika ada)" /></td>
        `;
        capexOpexBody.appendChild(tr);
        recalcCapexOpexItems();
      });

      capexOpexBody.addEventListener("input", (e) => {
        if (
          e.target.classList.contains("item-qty") ||
          e.target.classList.contains("item-cost") ||
          e.target.classList.contains("item-type")
        ) {
          recalcCapexOpexItems();
        }
      });

      // Add rows for demand categories
      addRowBtn.addEventListener("click", () => {
        const tr = document.createElement("tr");
        tr.className = "category-row";
        tr.innerHTML = `
          <td><input type="text" class="cat-name" placeholder="Nama kategori" /></td>
          <td><input type="number" class="cat-pop" min="0" /></td>
          <td><input type="number" class="cat-percap" min="0" /></td>
          <td><input type="number" class="cat-peak" value="1.3" min="1" step="0.05" /></td>
        `;
        categoryBody.appendChild(tr);
      });

      // Add rows for alternative sources
      addAltRowBtn.addEventListener("click", () => {
        const tr = document.createElement("tr");
        tr.className = "alt-row";
        tr.innerHTML = `
          <td><input type="text" class="alt-name" placeholder="Nama sumber" /></td>
          <td><input type="number" class="alt-capacity" min="0" /></td>
          <td><input type="number" class="alt-util" min="0" max="100" /></td>
          <td><input type="number" class="alt-capex" min="0" /></td>
          <td><input type="text" class="alt-capex-note" placeholder="Butiran CAPEX (jika ada)" /></td>
          <td><input type="number" class="alt-opex-fixed" min="0" /></td>
          <td><input type="number" class="alt-opex-var" min="0" step="0.01" /></td>
          <td><input type="text" class="alt-opex-note" placeholder="Butiran OPEX (jika ada)" /></td>
          <td><input type="number" class="alt-life" min="1" /></td>
        `;
        altBody.appendChild(tr);
      });

      calcBtn.addEventListener("click", () => {
        recalcCapexOpexItems();
        calculate();
      });

      // Export Excel
      exportBtn.addEventListener("click", () => {
        try {
          if (typeof XLSX === "undefined") {
            alert("Library Excel (SheetJS) tidak dimuatkan.");
            return;
          }

          // Ensure latest calculations
          recalcCapexOpexItems();
          calculate();

          const wb = XLSX.utils.book_new();

          // Sheet 1: Kategori demand
          const catRows = [["Kategori", "Populasi", "Per kapita (L/org/hari)", "Purata (m¬≥/hari)", "Faktor puncak", "Permintaan puncak (m¬≥/hari)"]];
          document.querySelectorAll("#results-body tr").forEach((tr) => {
            const cells = Array.from(tr.querySelectorAll("td")).map((td) =>
              td.textContent.trim()
            );
            if (cells.length) catRows.push(cells);
          });
          const totalsRow1 = [
            "Jumlah",
            document.getElementById("total-pop").textContent,
            "",
            document.getElementById("total-avg-m3").textContent,
            "",
            document.getElementById("total-peak-m3").textContent,
          ];
          const totalsRow2 = [
            "Jumlah dalam MLD",
            "",
            "",
            document.getElementById("total-avg-mld").textContent,
            "",
            document.getElementById("total-peak-mld").textContent,
          ];
          catRows.push(totalsRow1, totalsRow2);
          const wsCat = XLSX.utils.aoa_to_sheet(catRows);
          XLSX.utils.book_append_sheet(wb, wsCat, "Kategori");

          // Sheet 2: Ringkasan demand‚Äìsupply
          const summaryRows = [
            ["Item", "Nilai (MLD)"],
            ["Jumlah permintaan purata", document.getElementById("summary-avg-mld").textContent],
            ["Jumlah permintaan puncak", document.getElementById("summary-peak-mld").textContent],
            ["Bekalan sedia ada (JANS)", document.getElementById("supply-avg-mld").textContent],
            ["Extra supply (alt sources)", document.getElementById("alt-supply-mld").textContent],
            ["Bekalan efektif", document.getElementById("effective-supply-mld").textContent],
            ["Surplus / Defisit purata", document.getElementById("surplus-avg-mld").textContent],
            ["Surplus / Defisit puncak", document.getElementById("surplus-peak-mld").textContent],
          ];
          const wsSum = XLSX.utils.aoa_to_sheet(summaryRows);
          XLSX.utils.book_append_sheet(wb, wsSum, "Ringkasan");

          // Sheet 3: CBA alternatif
          const cbaRows = [[
            "Sumber",
            "Kapasiti (m¬≥/hari)",
            "Utilisasi (% hari)",
            "Vol. tahunan (m¬≥/tahun)",
            "CAPEX (RM)",
            "OPEX tahunan (RM/tahun)",
            "Saving air + pembetungan (RM/tahun)",
            "CF bersih (RM/tahun)",
            "Payback (tahun)",
            "NPV (RM)",
            "BCR"
          ]];
          document.querySelectorAll("#alt-results-body tr").forEach((tr) => {
            const cells = Array.from(tr.querySelectorAll("td")).map((td) =>
              td.textContent.trim()
            );
            if (cells.length) cbaRows.push(cells);
          });
          const cbaTotalsRow = [
            "Jumlah / Agregat",
            document.getElementById("alt-total-capacity").textContent,
            "",
            document.getElementById("alt-total-volume").textContent,
            document.getElementById("alt-total-capex").textContent,
            document.getElementById("alt-total-opex").textContent,
            document.getElementById("alt-total-saving").textContent,
            document.getElementById("alt-total-netcf").textContent,
            "",
            document.getElementById("alt-total-npv").textContent,
            document.getElementById("alt-total-bcr").textContent,
          ];
          cbaRows.push(cbaTotalsRow);
          const wsCBA = XLSX.utils.aoa_to_sheet(cbaRows);
          XLSX.utils.book_append_sheet(wb, wsCBA, "CBA_Alt_Sources");

          // Sheet 4: Itemised CAPEX & OPEX
          const itemRows = [[
            "Jenis",
            "Item / Komponen",
            "Kuantiti",
            "Kos seunit (RM)",
            "Jumlah kos (RM)",
            "Catatan"
          ]];
          document.querySelectorAll("#capex-opex-body tr").forEach((tr) => {
            const type = tr.querySelector(".item-type").value || "";
            const name = tr.querySelector(".item-name").value || "";
            const qty = tr.querySelector(".item-qty").value || "";
            const cost = tr.querySelector(".item-cost").value || "";
            const total = tr.querySelector(".item-total").textContent || "";
            const note = tr.querySelector(".item-note").value || "";
            if (name.trim() || parseFloat(qty) > 0 || parseFloat(cost) > 0) {
              itemRows.push([type, name, qty, cost, total, note]);
            }
          });
          itemRows.push(
            ["Jumlah CAPEX", "", "", "", document.getElementById("capex-items-total").textContent, ""],
            ["Jumlah OPEX", "", "", "", document.getElementById("opex-items-total").textContent, ""]
          );
          const wsItems = XLSX.utils.aoa_to_sheet(itemRows);
          XLSX.utils.book_append_sheet(wb, wsItems, "CAPEX_OPEX_Itemised");

          XLSX.writeFile(wb, "UMS_Water_Demand_Supply_CBA.xlsx");
        } catch (e) {
          console.error(e);
          alert("Ralat semasa export Excel. Sila cuba lagi.");
        }
      });

      async function generateProfessionalReport() {
        const { jsPDF } = window.jspdf || {};
        if (!jsPDF) {
          alert("Library jsPDF tidak dimuatkan.");
          return;
        }

        await loadUmsLogoDataUrl();
        const data = collectReportData();

        const doc = new jsPDF({ unit: "mm", format: "a4", orientation: "portrait" });
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const margins = { top: 24, right: 18, bottom: 16, left: 18 };
        const contentWidth = pageWidth - margins.left - margins.right;
        const lineHeight = 6.2;
        let y = margins.top;
        const tocEntries = [];

        const ensureSpace = (height = lineHeight) => {
          if (y + height > pageHeight - margins.bottom) {
            doc.addPage();
            y = margins.top;
          }
        };

        const splitLines = (text) => {
          const normalized = (text || "").replace(/\s+/g, " ").trim();
          if (!normalized) return [];
          const words = normalized.split(" ");
          const lines = [];
          let current = [];
          let width = 0;
          const spaceWidth = doc.getTextWidth(" ");
          words.forEach((word) => {
            const w = doc.getTextWidth(word);
            if (!current.length) {
              current.push(word);
              width = w;
              return;
            }
            if (width + spaceWidth + w <= contentWidth) {
              current.push(word);
              width += spaceWidth + w;
            } else {
              lines.push({ words: current, width });
              current = [word];
              width = w;
            }
          });
          if (current.length) lines.push({ words: current, width });
          return lines;
        };

        const addParagraph = (text) => {
          doc.setFontSize(11);
          doc.setTextColor(33, 33, 33);
          const lines = splitLines(text);
          lines.forEach((line, idx) => {
            ensureSpace(lineHeight);
            if (line.words.length === 1 || idx === lines.length - 1) {
              doc.text(line.words.join(" "), margins.left, y, { maxWidth: contentWidth });
            } else {
              const gaps = line.words.length - 1;
              const extra = contentWidth - line.width;
              const extraPerGap = extra / gaps;
              let cursorX = margins.left;
              line.words.forEach((word, wIdx) => {
                doc.text(word, cursorX, y);
                if (wIdx < gaps) {
                  const step = doc.getTextWidth(word) + doc.getTextWidth(" ") + extraPerGap;
                  cursorX += step;
                }
              });
            }
            y += lineHeight;
          });
          y += 1.8;
        };

        const addBullets = (items) => {
          doc.setFontSize(11);
          doc.setTextColor(30, 52, 73);
          items.forEach((item) => {
            const lines = splitLines(item);
            lines.forEach((line, idx) => {
              ensureSpace(lineHeight);
              const prefix = idx === 0 ? "‚Ä¢ " : "  ";
              doc.text(prefix + line.words.join(" "), margins.left, y, { maxWidth: contentWidth });
              y += lineHeight;
            });
          });
          y += 1.5;
        };

        const addKeyValueList = (title, rows) => {
          ensureSpace(10);
          doc.setFontSize(12);
          doc.setTextColor(15, 76, 117);
          doc.text(title, margins.left, y);
          y += 5.5;
          doc.setFontSize(10.5);
          rows.forEach((row, idx) => {
            ensureSpace(7);
            const fill = idx % 2 === 0 ? [236, 245, 253] : [246, 250, 254];
            doc.setFillColor(...fill);
            doc.rect(margins.left, y - 4.8, contentWidth, 7, "F");
            doc.setTextColor(40, 40, 40);
            doc.text(row[0], margins.left + 2, y);
            doc.text(row[1], pageWidth - margins.right, y, { align: "right" });
            y += 7;
          });
          y += 2;
        };

        const addChart = (img, caption) => {
          if (!img) return;
          const props = doc.getImageProperties(img);
          const imgWidth = Math.min(contentWidth, 165);
          const imgHeight = (props.height * imgWidth) / props.width;
          ensureSpace(imgHeight + 10);
          doc.addImage(img, props.fileType || "PNG", margins.left, y, imgWidth, imgHeight);
          y += imgHeight + 4;
          doc.setFontSize(9.5);
          doc.setTextColor(70, 80, 95);
          doc.text(caption, margins.left, y, { maxWidth: contentWidth });
          y += 4;
        };

        const startSection = (tag, title) => {
          ensureSpace(16);
          doc.setFontSize(11);
          doc.setTextColor(22, 87, 132);
          doc.text(tag, margins.left, y);
          y += 5;
          doc.setFontSize(14);
          doc.setTextColor(0, 0, 0);
          doc.text(title, margins.left, y);
          tocEntries.push({
            title: `${tag} ${title}`,
            page: doc.getCurrentPageInfo().pageNumber,
          });
          y += 6;
        };

        const addSpacer = (amount = 3) => {
          y += amount;
        };

        const drawCover = () => {
          doc.setFillColor(226, 241, 252);
          doc.rect(0, 0, pageWidth, pageHeight, "F");
          doc.setFillColor(7, 116, 179);
          doc.rect(0, pageHeight * 0.65, pageWidth, pageHeight * 0.4, "F");
          doc.setFillColor(1, 155, 213);
          doc.ellipse(pageWidth * 0.3, pageHeight * 0.72, pageWidth * 0.35, 18, "F");
          doc.setFillColor(0, 126, 167);
          doc.ellipse(pageWidth * 0.72, pageHeight * 0.80, pageWidth * 0.4, 18, "F");
          if (data.logoDataUrl) {
            const logoProps = doc.getImageProperties(data.logoDataUrl);
            const logoWidth = 32;
            const logoHeight = (logoProps.height * logoWidth) / logoProps.width;
            doc.addImage(data.logoDataUrl, logoProps.fileType || "PNG", margins.left, 26, logoWidth, logoHeight);
          }
          doc.setFontSize(11);
          doc.setTextColor(30, 74, 110);
          doc.text("Laporan Profesional ‚Äì Kalkulator UMS Water", margins.left, 20);
          doc.setFontSize(22);
          doc.setTextColor(255, 255, 255);
          doc.text(
            "LAPORAN PERMINTAAN, BEKALAN DAN SUMBER AIR ALTERNATIF UNIVERSITI MALAYSIA SABAH",
            pageWidth / 2,
            pageHeight * 0.42,
            { align: "center", maxWidth: contentWidth }
          );
          doc.setFontSize(13);
          doc.text("Tarikh jana: " + data.generatedDate, pageWidth / 2, pageHeight * 0.50, {
            align: "center",
          });
          doc.setFontSize(11);
          doc.text(
            "Disediakan oleh: Prof. Madya Dr. Assis Kamu (Ketua); Dr. Fera @ Nony Cleophas; Dr. Sarimah Surianshah; Prof. Madya Ts. Dr. Mohd Sani Sarjadi",
            pageWidth / 2,
            pageHeight * 0.57,
            { align: "center", maxWidth: contentWidth }
          );
          doc.setFontSize(10);
          doc.text(
            "Tema air dengan margin kemas dan perenggan justify ‚Äì Halaman akan bernombor secara automatik.",
            pageWidth / 2,
            pageHeight * 0.63,
            { align: "center", maxWidth: contentWidth }
          );
        };

        drawCover();

        doc.addPage();
        const tocPage = doc.getCurrentPageInfo().pageNumber;
        y = margins.top;
        doc.setFontSize(16);
        doc.setTextColor(0, 0, 0);
        doc.text("Isi Kandungan", margins.left, y);
        y += 7;
        doc.setFontSize(10);
        doc.setTextColor(76, 94, 114);
        doc.text(
          "Isi kandungan ini akan diisi selepas seksyen siap dijana untuk memastikan nombor halaman tepat.",
          margins.left,
          y,
          { maxWidth: contentWidth }
        );

        doc.addPage();
        y = margins.top;

        startSection("A. Ringkasan Eksekutif", "Ringkasan Utama");
        addParagraph(
          `Permintaan purata kampus dianggarkan ${data.summary.text.avg} MLD dan permintaan puncak ${data.summary.text.peak} MLD. Bekalan asas (JANS) ${data.summary.text.supply} MLD digabungkan dengan sumber alternatif ${data.summary.text.alt} MLD, menghasilkan bekalan efektif ${data.summary.text.effective} MLD.`
        );
        addParagraph(
          `Status purata: ${data.summary.status.avg || "‚Äì"}. Status puncak: ${data.summary.status.peak || "‚Äì"}. Surplus/defisit purata ${data.summary.text.surplusAvg} MLD, manakala semasa puncak ${data.summary.text.surplusPeak} MLD.`
        );
        addKeyValueList("Sorotan kewangan & teknikal", [
          ["Jumlah CAPEX sumber alternatif", data.financeSummary.capex],
          ["OPEX tahunan", data.financeSummary.opex],
          ["Penjimatan tahunan (air + pembetungan)", data.financeSummary.saving],
          ["NPV projek / BCR / IRR", `${data.financeSummary.npv} / ${data.financeSummary.bcr} / ${data.financeSummary.irr}`],
        ]);
        addParagraph(
          "Bahagian seterusnya merangkumi latar belakang, objektif, kaedah, input pengguna, hasil analisis, jurang permintaan‚Äìbekalan, cadangan pelaksanaan serta lampiran ringkas yang menyenaraikan parameter utama."
        );

        startSection("B. Latar Belakang", "Keperluan dan konteks kampus");
        addParagraph(
          "Operasi akademik, asrama, kemudahan ibadah dan sukan UMS memerlukan bekalan air terawat yang stabil. Pertumbuhan populasi serta peluasan fasiliti menambah tekanan kepada bekalan asas dan menuntut integrasi sumber alternatif yang mampan."
        );
        addParagraph(
          "Kalkulator ini membolehkan pengguna menyesuaikan input populasi, kadar per kapita, faktor puncak, bekalan asas, tarif dan parameter kewangan untuk melihat kesan segera terhadap jurang permintaan‚Äìbekalan dan pulangan kewangan projek air alternatif."
        );

        startSection("C. Objektif", "Hala tuju analisis");
        addBullets([
          "Menganggarkan permintaan purata dan puncak mengikut kategori pengguna kampus.",
          "Membandingkan permintaan dengan bekalan asas JANS serta bekalan alternatif yang dimodelkan.",
          "Menilai kesan sumber alternatif terhadap penjimatan bil air dan pembetungan.",
          "Menjana indikator kewangan utama (CAPEX, OPEX, penjimatan, NPV, BCR, IRR, payback).",
          "Menyusun cadangan fasa pelaksanaan berdasarkan impak dan kecekapan kos.",
        ]);

        startSection("D. Kaedah & Andaian", "Pendekatan pengiraan");
        addParagraph(
          "Permintaan dikira menggunakan populasi √ó kadar per kapita, ditukar kepada m¬≥/hari dan diselaraskan dengan faktor puncak. Bekalan asas diambil daripada input JANS, manakala bekalan alternatif menggunakan kapasiti teknikal, utiliti harian, OPEX tetap/berubah dan jangka hayat aset. Penjimatan tahunan dikira berdasarkan tarif air + pembetungan, kemudian dianalisis dengan kadar diskaun dan tempoh analisis yang ditetapkan."
        );
        addBullets([
          "Pengiraan payback menggunakan CAPEX / aliran tunai bersih tahunan (jika positif).",
          "NPV dan BCR menggunakan diskaun berasaskan tempoh analisis atau jangka hayat sumber.",
          "Graf dan jadual dibina daripada input semasa tanpa memerlukan beban muat semula halaman.",
        ]);

        startSection("E. Input Data & Parameter", "Ringkasan andaian pengguna");
        addKeyValueList("Parameter utama", [
          ["Bekalan asas (JANS)", `${data.assumptions.supply || "‚Äì"} MLD`],
          ["Tarif air (RM/m¬≥)", data.assumptions.tariffWater || "‚Äì"],
          ["Tarif pembetungan (RM/m¬≥)", data.assumptions.tariffSewer || "‚Äì"],
          ["Tempoh analisis (tahun)", data.assumptions.years || "‚Äì"],
          ["Kadar diskaun (%)", data.assumptions.discount || "‚Äì"],
          ["Bil. kategori dimodelkan", `${data.demandByCategory.length}`],
          ["Bil. sumber alternatif", `${data.altSources.length}`],
        ]);
        if (data.categoryInputs.length) {
          addParagraph("Input kategori utama:");
          data.categoryInputs.slice(0, 6).forEach((row, idx) => {
            addParagraph(
              `${idx + 1}. ${row.name || "Kategori"} ‚Äì Populasi ${row.pop || "‚Äì"}, per kapita ${row.percap || "‚Äì"} L/org/hari, faktor puncak ${row.peak || "‚Äì"}.`
            );
          });
        }

        startSection("F. Hasil Analisis", "Permintaan, bekalan & kewangan");
        addKeyValueList("Permintaan vs bekalan", [
          ["Permintaan purata", `${data.summary.text.avg} MLD`],
          ["Permintaan puncak", `${data.summary.text.peak} MLD`],
          ["Bekalan asas (JANS)", `${data.summary.text.supply} MLD`],
          ["Bekalan alternatif", `${data.summary.text.alt} MLD`],
          ["Bekalan efektif", `${data.summary.text.effective} MLD`],
          ["Surplus/defisit purata", `${data.summary.text.surplusAvg} MLD`],
          ["Surplus/defisit puncak", `${data.summary.text.surplusPeak} MLD`],
        ]);
        addKeyValueList("Ringkasan kewangan alternatif", [
          ["CAPEX agregat", data.altTotals.capex],
          ["OPEX tahunan agregat", data.altTotals.opex],
          ["Penjimatan tahunan agregat", data.altTotals.saving],
          ["Aliran tunai bersih tahunan", data.altTotals.netcf],
          ["NPV projek", data.altTotals.npv],
          ["BCR projek", data.altTotals.bcr],
        ]);
        addParagraph(
          "Jadual ringkas sumber alternatif (maksimum 6 entri dipaparkan untuk kesesuaian halaman):"
        );
        data.altSources.slice(0, 6).forEach((row, idx) => {
          addParagraph(
            `${idx + 1}. ${row.name} ‚Äì Kapasiti ${row.capacity} m¬≥/hari, utiliti ${row.util}% hari, volum ${row.volume} m¬≥/tahun, CAPEX ${row.capex}, OPEX ${row.opex}, penjimatan ${row.saving}, NPV ${row.npv}, BCR ${row.bcr}.`
          );
        });
        addChart(data.charts.supplyDemand, "Rajah: Permintaan purata & puncak berbanding bekalan efektif.");
        addChart(data.charts.altComposition, "Rajah: Komposisi bekalan berkesan sumber alternatif.");
        addChart(data.charts.demandByCategory, "Rajah: Permintaan mengikut kategori pengguna.");
        addChart(data.charts.cbaNPV, "Rajah: NPV mengikut sumber alternatif.");

        startSection("G. Jurang Permintaan‚ÄìBekalan & Implikasi", "Analisis dan tindakan segera");
        addParagraph(
          "Jurang bekalan ditentukan oleh perbezaan antara permintaan puncak dengan bekalan efektif. Sekiranya defisit kekal, risiko gangguan operasi meningkat dan kebergantungan kepada JANS perlu dikurangkan melalui intervensi pengurusan permintaan serta sumber alternatif yang paling pantas dilaksanakan."
        );
        addBullets([
          "Prioritikan sumber dengan payback terpendek dan CAPEX sederhana untuk menutup defisit puncak.",
          "Laksanakan audit kebocoran, retrofit peralatan dan kempen kesedaran bagi menurunkan permintaan per kapita.",
          "Pantau penggunaan sebenar selepas intervensi untuk mengemas kini anggaran penjimatan dan aliran tunai.",
        ]);

        startSection("H. Cadangan Pelaksanaan", "Fasa & keutamaan");
        addBullets([
          "Fasa 1 (0‚Äì6 bulan): tangkapan air hujan berskala kecil, pengumpulan kondensasi AC, audit kebocoran dalaman serta pemasangan meter sub-zon.",
          "Fasa 2 (6‚Äì18 bulan): sistem reuse untuk tandas/pembersihan, sambungan ke tangki penimbal utama, semakan tarif dan OPEX mengikut kontrak sebenar.",
          "Fasa 3 (18‚Äì36 bulan): penskalaan sumber tasik/kolam rawatan awal, integrasi SCADA/IoT untuk pemantauan dan pengoptimuman campuran sumber.",
        ]);
        addParagraph(
          "Keutamaan fasa boleh dilaras mengikut bajet tahunan, sasaran penjimatan dan risiko operasi. Pelaksanaan perlu disertai pemantauan prestasi bagi mengesahkan NPV, BCR dan IRR sebenar."
        );

        startSection("I. Lampiran", "Butiran tambahan & penafian");
        addParagraph("Ringkasan item CAPEX/OPEX yang dimasukkan pengguna (dipendekkan hingga 8 baris):");
        data.capexOpexItems.slice(0, 8).forEach((item, idx) => {
          addParagraph(
            `${idx + 1}. [${item.type}] ${item.name || "Item"} ‚Äì Kuantiti ${item.qty || "‚Äì"}, kos seunit ${item.cost || "‚Äì"}, jumlah ${item.total || "‚Äì"}${item.note ? `, nota: ${item.note}` : ""}.`
          );
        });
        addParagraph(
          `Penafian: ${data.disclaimerText} Sebarang keputusan kejuruteraan atau pelaburan hendaklah dirujuk kepada data meter rasmi dan pengesahan pihak berkuasa berkaitan.`
        );

        doc.setPage(tocPage);
        let tocY = margins.top;
        doc.setFontSize(16);
        doc.setTextColor(0, 0, 0);
        doc.text("Isi Kandungan", margins.left, tocY);
        tocY += 7;
        doc.setFontSize(10);
        doc.setTextColor(76, 94, 114);
        doc.text(
          "Penomboran halaman dijana automatik berdasarkan halaman sebenar PDF.",
          margins.left,
          tocY
        );
        tocY += 6;
        doc.setFontSize(11);
        doc.setTextColor(0, 0, 0);
        tocEntries.forEach((entry) => {
          if (tocY + 6 > pageHeight - margins.bottom) return;
          doc.text(entry.title, margins.left, tocY);
          doc.text(String(entry.page), pageWidth - margins.right, tocY, { align: "right" });
          tocY += 6;
        });

        const finalTotalPages = doc.getNumberOfPages();
        for (let i = 1; i <= finalTotalPages; i += 1) {
          if (i === 1) continue; // Skip cover for header/footer
          doc.setPage(i);
          doc.setFontSize(9);
          doc.setTextColor(70, 80, 95);
          doc.text("Laporan Permintaan & Bekalan Air UMS", margins.left, 12);
          doc.text(data.generatedDate, pageWidth - margins.right, 12, { align: "right" });
          doc.text(
            "Sulit/Untuk Kegunaan Dalaman (Jika perlu)",
            margins.left,
            pageHeight - 8
          );
          doc.text(
            `Halaman ${i} daripada ${finalTotalPages}`,
            pageWidth - margins.right,
            pageHeight - 8,
            { align: "right" }
          );
        }

        doc.save(`Laporan_UMS_Water_Profesional_${data.fileDate}.pdf`);
      }

      downloadReportBtn.addEventListener("click", () => {
        generateProfessionalReport();
      });

      // Kiraan awal dengan nilai contoh
      loadUmsLogoDataUrl();
      recalcCapexOpexItems();
      calculate();
    });
  </script>
</body>
</html>
