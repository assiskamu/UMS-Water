<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <title>Kalkulator Permintaan & Bekalan Air UMS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Chart.js (graf) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- SheetJS (Export Excel) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- jsPDF (PDF report) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root {
      --primary: #0d6efd;
      --primary-light: #e0f4ff;
      --primary-dark: #054a91;
      --accent: #00bcd4;
      --danger: #ff1744;
      --success: #00c853;
      --bg: #f5fbff;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        Roboto, sans-serif;
      color: #12324a;
      background:
        radial-gradient(circle at top, #cbe9ff 0, #f5fbff 45%, #ffffff 100%);
      position: relative;
      overflow-x: hidden;
    }

    /* background ‚Äúair‚Äù halus */
    body::before {
      content: "";
      position: fixed;
      inset: -20vh -10vw auto;
      height: 60vh;
      background:
        radial-gradient(circle at 20% 20%, rgba(255,255,255,0.7) 0, transparent 55%),
        radial-gradient(circle at 80% 10%, rgba(255,255,255,0.6) 0, transparent 55%),
        linear-gradient(135deg, rgba(13,110,253,0.25), rgba(0,188,212,0.15));
      opacity: 0.7;
      z-index: -2;
      pointer-events: none;
    }

    header {
      background: linear-gradient(135deg, var(--primary-dark), var(--accent));
      color: #fff;
      padding: 1.4rem 1rem;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.18);
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(6px);
    }

    .header-inner {
      max-width: 1100px;
      margin: 0 auto;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }

    header h1 {
      margin: 0;
      font-size: 1.45rem;
      letter-spacing: 0.02em;
    }

    header p {
      margin: 0.15rem 0 0;
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.35rem 0.8rem;
      border-radius: 999px;
      background-color: rgba(255, 255, 255, 0.15);
      font-size: 0.8rem;
      align-self: flex-start;
    }

    .badge span { font-size: 1.1rem; }

    main {
      max-width: 1100px;
      margin: 1.5rem auto 2.5rem;
      padding: 0 1rem;
    }

    .card {
      background: #ffffff;
      border-radius: 1rem;
      padding: 1.3rem 1.5rem;
      margin-bottom: 1.3rem;
      box-shadow: 0 8px 25px rgba(13, 110, 253, 0.08);
      border: 1px solid rgba(13, 110, 253, 0.09);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: auto -30% -40%;
      height: 120px;
      background:
        radial-gradient(circle at 10% 0%, rgba(13,110,253,0.06) 0, transparent 55%),
        radial-gradient(circle at 90% 40%, rgba(0,188,212,0.06) 0, transparent 55%);
      z-index: -1;
    }

    .card h2 {
      margin-top: 0;
      font-size: 1.15rem;
      color: var(--primary-dark);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .card h2 span.icon { font-size: 1.25rem; }

    .card p.lead {
      margin-top: 0;
      font-size: 0.9rem;
      color: #476582;
    }

    label {
      font-size: 0.85rem;
      font-weight: 600;
      color: #23405b;
      display: block;
      margin-bottom: 0.2rem;
    }

    input[type="number"],
    input[type="text"],
    select {
      width: 100%;
      padding: 0.4rem 0.55rem;
      border-radius: 0.5rem;
      border: 1px solid #c5d9ec;
      font-size: 0.9rem;
      outline: none;
      background-color: #fafdff;
    }

    input[type="number"]:focus,
    input[type="text"]:focus,
    select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.15);
      background-color: #ffffff;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
      margin-top: 0.5rem;
      background-color: #fdfefe;
    }

    th,
    td {
      padding: 0.4rem 0.5rem;
      border-bottom: 1px solid #dde7f3;
      text-align: right;
      white-space: nowrap;
    }

    th:first-child,
    td:first-child { text-align: left; }

    thead {
      background: linear-gradient(
        90deg,
        rgba(13, 110, 253, 0.1),
        rgba(0, 188, 212, 0.06)
      );
    }

    tfoot td {
      font-weight: 700;
      background-color: #f3f8ff;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      margin-top: 0.6rem;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 0.45rem 0.9rem;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      transition: transform 0.05s ease, box-shadow 0.12s ease,
        background-color 0.12s ease;
    }

    button.primary {
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color: #fff;
      box-shadow: 0 4px 12px rgba(13, 110, 253, 0.35);
    }

    button.secondary {
      background-color: var(--primary-light);
      color: var(--primary-dark);
    }

    button.export {
      background: linear-gradient(135deg, #00c853, #00e676);
      color: #fff;
      box-shadow: 0 4px 12px rgba(0, 200, 83, 0.4);
    }

    button:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }

    .two-column {
      display: grid;
      grid-template-columns: minmax(0, 1.5fr) minmax(0, 1.2fr);
      gap: 1.2rem;
    }

    .status-pill {
      display: inline-flex;
      border-radius: 999px;
      padding: 0.18rem 0.6rem;
      font-size: 0.8rem;
      font-weight: 600;
      align-items: center;
      gap: 0.35rem;
    }

    .status-surplus {
      background-color: #e0ffe9;
      color: #008a2f;
      border: 1px solid #00c853;
    }

    .status-deficit {
      background-color: #ffebee;
      color: #c62828;
      border: 1px solid #ff1744;
    }

    .summary-text {
      font-size: 0.88rem;
      margin-top: 0.5rem;
      color: #36526f;
    }

    .note {
      font-size: 0.78rem;
      color: #627d96;
      margin-top: 0.2rem;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.75rem;
      padding: 0.2rem 0.5rem;
      border-radius: 999px;
      background-color: rgba(13, 110, 253, 0.05);
      color: #2d4c69;
      margin-right: 0.4rem;
      margin-top: 0.2rem;
    }

    canvas {
      background: radial-gradient(circle at top, #f2fbff, #ffffff);
      border-radius: 0.8rem;
      padding: 0.5rem;
    }

    .summary-row-surplus td:nth-child(2),
    .summary-row-surplus td:nth-child(4) {
      background-color: #e0ffe9;
      color: #006622;
      font-weight: 700;
    }

    .summary-row-deficit td:nth-child(2),
    .summary-row-deficit td:nth-child(4) {
      background-color: #ffebee;
      color: #b71c1c;
      font-weight: 700;
    }

    .disclaimer {
      font-size: 0.8rem;
      color: #455a64;
      line-height: 1.5;
    }

    footer {
      text-align: center;
      padding: 0.8rem 1rem 1.2rem;
      font-size: 0.78rem;
      color: #607d8b;
      background: #f1f7fd;
      border-top: 1px solid #d3e1f2;
    }

    .input-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 0.8rem 1rem;
      margin-top: 0.6rem;
    }

    .mini {
      font-size: 0.78rem;
      color: #607d8b;
    }

    @media (max-width: 768px) {
      header { padding: 1.15rem 1rem; }
      header h1 { font-size: 1.25rem; }
      .two-column { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div>
        <h1>Kalkulator Permintaan & Bekalan Air UMS</h1>
        <p>
          Anggaran demand‚Äìsupply air kampus termasuk sumber alternatif
          (tangkapan air hujan, reuse, air tasik, kondensasi penghawa dingin)
          dan analisis kos‚Äìfaedah asas.
        </p>
      </div>
      <div class="badge">
        <span>üíß</span> Planning-level water & CBA tool
      </div>
    </div>
  </header>

  <main>
    <!-- INPUT KATEGORI DEMAND -->
    <section class="card">
      <h2><span class="icon">üì•</span> Input Permintaan Air Mengikut Kategori</h2>
      <p class="lead">
        Tetapkan kategori (contoh: Asrama, Fakulti & Pentadbiran, Masjid, Sukan)
        bersama bilangan pengguna, kadar penggunaan per kapita, dan faktor
        permintaan puncak (peak factor).
      </p>

      <div class="note">
        Tip: 1 m¬≥/hari = 1,000 L/hari. Peak factor biasa 1.2‚Äì1.5 untuk asrama
        & kawasan tumpuan pelajar.
      </div>

      <div style="overflow-x: auto; margin-top: 0.6rem;">
        <table id="category-input-table">
          <thead>
            <tr>
              <th>Kategori</th>
              <th>Populasi (orang)</th>
              <th>Per kapita (L/org/hari)</th>
              <th>Faktor puncak</th>
            </tr>
          </thead>
          <tbody id="category-body">
            <tr class="category-row">
              <td><input type="text" class="cat-name" value="Asrama" /></td>
              <td><input type="number" class="cat-pop" value="6621" min="0" /></td>
              <td><input type="number" class="cat-percap" value="200" min="0" /></td>
              <td><input type="number" class="cat-peak" value="1.3" min="1" step="0.05" /></td>
            </tr>
            <tr class="category-row">
              <td>
                <input type="text" class="cat-name" value="Fakulti & Pentadbiran" />
              </td>
              <td><input type="number" class="cat-pop" value="8000" min="0" /></td>
              <td><input type="number" class="cat-percap" value="50" min="0" /></td>
              <td><input type="number" class="cat-peak" value="1.2" min="1" step="0.05" /></td>
            </tr>
            <tr class="category-row">
              <td><input type="text" class="cat-name" value="Masjid & Surau" /></td>
              <td><input type="number" class="cat-pop" value="3000" min="0" /></td>
              <td><input type="number" class="cat-percap" value="15" min="0" /></td>
              <td><input type="number" class="cat-peak" value="1.5" min="1" step="0.05" /></td>
            </tr>
            <tr class="category-row">
              <td><input type="text" class="cat-name" value="Sukan & Rekreasi" /></td>
              <td><input type="number" class="cat-pop" value="1500" min="0" /></td>
              <td><input type="number" class="cat-percap" value="60" min="0" /></td>
              <td><input type="number" class="cat-peak" value="1.4" min="1" step="0.05" /></td>
            </tr>
            <tr class="category-row">
              <td>
                <input type="text" class="cat-name"
                       placeholder="Kategori tambahan (jika ada)" />
              </td>
              <td><input type="number" class="cat-pop" min="0" /></td>
              <td><input type="number" class="cat-percap" min="0" /></td>
              <td><input type="number" class="cat-peak" value="1.3" min="1" step="0.05" /></td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="btn-row">
        <button id="add-row-btn" type="button" class="secondary">
          ‚ûï Tambah baris kategori
        </button>
        <button id="calculate-btn" type="button" class="primary">
          üîç Kira permintaan & banding dengan bekalan
        </button>
      </div>
    </section>

    <!-- INPUT SUPPLY (JANS) -->
    <section class="card">
      <h2><span class="icon">üö∞</span> Input Bekalan Air (Supply Sedia Ada)</h2>
      <p class="lead">
        Masukkan anggaran kapasiti bekalan air harian yang diterima kampus
        (daripada JANS dan sumber utama lain). Nilai dalam juta liter sehari (MLD).
      </p>

      <label for="supply-mld">Kapasiti bekalan harian sedia ada (MLD)</label>
      <input type="number" id="supply-mld" value="5" min="0" step="0.1" />
      <div class="note">
        Contoh: jika UMS menerima sekitar 4.5‚Äì5.0 MLD daripada loji rawatan.
      </div>
    </section>

    <!-- PARAMETER TARIF & KEWANGAN -->
    <section class="card">
      <h2><span class="icon">üíπ</span> Parameter Tarif & Kewangan</h2>
      <p class="lead">
        Parameter ini digunakan untuk mengira penjimatan bil air & pembetungan
        serta NPV, BCR dan anggaran payback bagi setiap sumber air alternatif.
      </p>

      <div class="input-grid">
        <div>
          <label for="tariff-water">Tarif air terawat (RM/m¬≥)</label>
          <input type="number" id="tariff-water" value="1.20" min="0" step="0.01" />
        </div>
        <div>
          <label for="tariff-sewer">Kadar pembetungan (RM/m¬≥)</label>
          <input type="number" id="tariff-sewer" value="0.80" min="0" step="0.01" />
        </div>
        <div>
          <label for="analysis-years">Tempoh analisis kewangan (tahun)</label>
          <input type="number" id="analysis-years" value="20" min="1" step="1" />
        </div>
        <div>
          <label for="discount-rate">Kadar diskaun (% setahun)</label>
          <input type="number" id="discount-rate" value="5" min="0" step="0.1" />
        </div>
      </div>

      <div class="note">
        Kebiasaannya kadar diskaun 3‚Äì7% digunakan untuk projek infrastruktur
        awam, bergantung kepada garis panduan agensi.
      </div>
    </section>

    <!-- INPUT SUMBER AIR ALTERNATIF -->
    <section class="card">
      <h2><span class="icon">üíß</span> Sumber Air Alternatif (Extra Supply & CBA)</h2>
      <p class="lead">
        Masukkan kapasiti teknikal, faktor penggunaan, CAPEX, OPEX dan nota
        perincian kos bagi setiap sumber air alternatif. Sumber ini akan menambah
        bekalan efektif dan digunakan dalam analisis kos‚Äìfaedah.
      </p>

      <div style="overflow-x: auto; margin-top: 0.6rem;">
        <table id="alt-input-table">
          <thead>
            <tr>
              <th>Sumber</th>
              <th>Kapasiti (m¬≥/hari)</th>
              <th>Faktor penggunaan (% hari/tahun)</th>
              <th>CAPEX (RM)</th>
              <th>Butiran CAPEX (ringkas)</th>
              <th>OPEX tetap (RM/tahun)</th>
              <th>OPEX berubah (RM/m¬≥)</th>
              <th>Butiran OPEX (ringkas)</th>
              <th>Jangka hayat (tahun)</th>
            </tr>
          </thead>
          <tbody id="alt-body">
            <tr class="alt-row">
              <td><input type="text" class="alt-name" value="Tangkapan air hujan" /></td>
              <td><input type="number" class="alt-capacity" value="300" min="0" /></td>
              <td><input type="number" class="alt-util" value="80" min="0" max="100" /></td>
              <td><input type="number" class="alt-capex" value="1200000" min="0" /></td>
              <td><input type="text" class="alt-capex-note"
                     value="Struktur tangki, gutter, paip agihan, pam dan panel kawalan" /></td>
              <td><input type="number" class="alt-opex-fixed" value="60000" min="0" /></td>
              <td><input type="number" class="alt-opex-var" value="0.10" min="0" step="0.01" /></td>
              <td><input type="text" class="alt-opex-note"
                     value="Elektrik pam, penyelenggaraan berkala dan pembersihan tangki" /></td>
              <td><input type="number" class="alt-life" value="25" min="1" /></td>
            </tr>
            <tr class="alt-row">
              <td><input type="text" class="alt-name" value="Air tasik / tasik kampus" /></td>
              <td><input type="number" class="alt-capacity" value="200" min="0" /></td>
              <td><input type="number" class="alt-util" value="70" min="0" max="100" /></td>
              <td><input type="number" class="alt-capex" value="900000" min="0" /></td>
              <td><input type="text" class="alt-capex-note"
                     value="Pam pengabstrakan, paip penghantaran, sistem penapisan" /></td>
              <td><input type="number" class="alt-opex-fixed" value="45000" min="0" /></td>
              <td><input type="number" class="alt-opex-var" value="0.15" min="0" step="0.01" /></td>
              <td><input type="text" class="alt-opex-note"
                     value="Elektrik pam, bahan kimia dan penyelenggaraan penapis" /></td>
              <td><input type="number" class="alt-life" value="20" min="1" /></td>
            </tr>
            <tr class="alt-row">
              <td><input type="text" class="alt-name" value="Reuse (greywater / RO)" /></td>
              <td><input type="number" class="alt-capacity" value="250" min="0" /></td>
              <td><input type="number" class="alt-util" value="80" min="0" max="100" /></td>
              <td><input type="number" class="alt-capex" value="1500000" min="0" /></td>
              <td><input type="text" class="alt-capex-note"
                     value="Unit rawatan, tangki imbangan, sistem paip dwi-saluran" /></td>
              <td><input type="number" class="alt-opex-fixed" value="90000" min="0" /></td>
              <td><input type="number" class="alt-opex-var" value="0.25" min="0" step="0.01" /></td>
              <td><input type="text" class="alt-opex-note"
                     value="Bahan kimia, tenaga elektrik dan operator" /></td>
              <td><input type="number" class="alt-life" value="20" min="1" /></td>
            </tr>
            <tr class="alt-row">
              <td><input type="text" class="alt-name" value="Kondensasi penghawa dingin" /></td>
              <td><input type="number" class="alt-capacity" value="50" min="0" /></td>
              <td><input type="number" class="alt-util" value="90" min="0" max="100" /></td>
              <td><input type="number" class="alt-capex" value="200000" min="0" /></td>
              <td><input type="text" class="alt-capex-note"
                     value="Pengumpulan kondensat, tangki kecil dan pam pemindahan" /></td>
              <td><input type="number" class="alt-opex-fixed" value="15000" min="0" /></td>
              <td><input type="number" class="alt-opex-var" value="0.05" min="0" step="0.01" /></td>
              <td><input type="text" class="alt-opex-note"
                     value="Elektrik tambahan dan penyelenggaraan" /></td>
              <td><input type="number" class="alt-life" value="15" min="1" /></td>
            </tr>
            <tr class="alt-row">
              <td><input type="text" class="alt-name" placeholder="Sumber tambahan" /></td>
              <td><input type="number" class="alt-capacity" min="0" /></td>
              <td><input type="number" class="alt-util" min="0" max="100" /></td>
              <td><input type="number" class="alt-capex" min="0" /></td>
              <td><input type="text" class="alt-capex-note"
                     placeholder="Butiran CAPEX (jika ada)" /></td>
              <td><input type="number" class="alt-opex-fixed" min="0" /></td>
              <td><input type="number" class="alt-opex-var" min="0" step="0.01" /></td>
              <td><input type="text" class="alt-opex-note"
                     placeholder="Butiran OPEX (jika ada)" /></td>
              <td><input type="number" class="alt-life" min="1" /></td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="btn-row">
        <button id="add-alt-row-btn" type="button" class="secondary">
          ‚ûï Tambah baris sumber alternatif
        </button>
      </div>
      <p class="mini">
        Nota: Butiran CAPEX dan OPEX membantu penjajaran dengan garis panduan EPU/MOF
        (contoh pecahan kepada infrastruktur, peralatan, tenaga kerja, O&M).
      </p>
    </section>

    <!-- PENGIRAAN TERPERINCI CAPEX & OPEX MENGIKUT ITEM -->
    <section class="card">
      <h2><span class="icon">üßæ</span> Pengiraan Terperinci CAPEX & OPEX Mengikut Item</h2>
      <p class="lead">
        Jadual mini ini membolehkan pecahan CAPEX dan OPEX mengikut item
        (contoh: tangki, pam, paip, operator, elektrik). Jumlah CAPEX dan OPEX
        boleh dirujuk semula apabila mengisi jadual sumber air alternatif.
      </p>

      <div style="overflow-x:auto;">
        <table id="capex-opex-items-table">
          <thead>
            <tr>
              <th>Jenis</th>
              <th>Item / Komponen</th>
              <th>Kuantiti</th>
              <th>Kos seunit (RM)</th>
              <th>Jumlah kos (RM)</th>
              <th>Catatan</th>
            </tr>
          </thead>
          <tbody id="capex-opex-body">
            <tr class="capex-opex-row">
              <td>
                <select class="item-type">
                  <option value="CAPEX">CAPEX</option>
                  <option value="OPEX">OPEX</option>
                </select>
              </td>
              <td><input type="text" class="item-name" value="Tangki simpanan air hujan" /></td>
              <td><input type="number" class="item-qty" value="2" min="0" step="0.01" /></td>
              <td><input type="number" class="item-cost" value="150000" min="0" step="0.01" /></td>
              <td class="item-total">0.00</td>
              <td><input type="text" class="item-note" value="Termasuk asas konkrit dan pemasangan" /></td>
            </tr>
            <tr class="capex-opex-row">
              <td>
                <select class="item-type">
                  <option value="CAPEX">CAPEX</option>
                  <option value="OPEX">OPEX</option>
                </select>
              </td>
              <td><input type="text" class="item-name" value="Pam dan paip agihan utama" /></td>
              <td><input type="number" class="item-qty" value="1" min="0" step="0.01" /></td>
              <td><input type="number" class="item-cost" value="250000" min="0" step="0.01" /></td>
              <td class="item-total">0.00</td>
              <td><input type="text" class="item-note" value="Termasuk panel kawalan" /></td>
            </tr>
            <tr class="capex-opex-row">
              <td>
                <select class="item-type">
                  <option value="OPEX" selected>OPEX</option>
                  <option value="CAPEX">CAPEX</option>
                </select>
              </td>
              <td><input type="text" class="item-name" value="Elektrik pam air hujan" /></td>
              <td><input type="number" class="item-qty" value="12" min="0" step="1" /></td>
              <td><input type="number" class="item-cost" value="4000" min="0" step="0.01" /></td>
              <td class="item-total">0.00</td>
              <td><input type="text" class="item-note" value="Anggaran bil elektrik setahun" /></td>
            </tr>
          </tbody>
          <tfoot>
            <tr>
              <td colspan="4"><strong>Jumlah CAPEX (daripada jadual item)</strong></td>
              <td id="capex-items-total">0.00</td>
              <td></td>
            </tr>
            <tr>
              <td colspan="4"><strong>Jumlah OPEX (daripada jadual item)</strong></td>
              <td id="opex-items-total">0.00</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="btn-row">
        <button id="add-capex-opex-item-btn" type="button" class="secondary">
          ‚ûï Tambah baris item
        </button>
      </div>
      <p class="mini">
        Nota: Jumlah CAPEX dan OPEX di sini boleh dijadikan rujukan dan dipadankan
        secara manual dengan CAPEX/OPEX mengikut sumber air alternatif di atas.
      </p>
    </section>

    <!-- ANALISIS KATEGORI DEMAND -->
    <section class="card">
      <h2><span class="icon">üìä</span> Analisis Permintaan Air Mengikut Kategori</h2>
      <p class="lead">
        Jadual ini menunjukkan permintaan purata dan puncak (peak) bagi setiap
        kategori berdasarkan input yang dimasukkan.
      </p>

      <div style="overflow-x: auto;">
        <table id="results-table">
          <thead>
            <tr>
              <th>Kategori</th>
              <th>Populasi</th>
              <th>Per kapita (L/org/hari)</th>
              <th>Purata (m¬≥/hari)</th>
              <th>Faktor puncak</th>
              <th>Permintaan puncak (m¬≥/hari)</th>
            </tr>
          </thead>
          <tbody id="results-body">
            <!-- JS akan isi -->
          </tbody>
          <tfoot>
            <tr>
              <td>Jumlah</td>
              <td id="total-pop">‚Äì</td>
              <td>‚Äì</td>
              <td id="total-avg-m3">‚Äì</td>
              <td>‚Äì</td>
              <td id="total-peak-m3">‚Äì</td>
            </tr>
            <tr>
              <td>Jumlah dalam MLD</td>
              <td colspan="2"></td>
              <td id="total-avg-mld">‚Äì</td>
              <td></td>
              <td id="total-peak-mld">‚Äì</td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="chip">üîπ Purata = Populasi √ó Per kapita / 1,000</div>
      <div class="chip">üîπ Puncak = Purata √ó Faktor puncak</div>
    </section>

    <!-- DEMAND VS SUPPLY + EXPORT -->
    <section class="card">
      <h2><span class="icon">‚öñÔ∏è</span> Ringkasan Demand‚ÄìSupply (MLD)</h2>
      <div class="two-column">
        <div>
          <table id="summary-table">
            <thead>
              <tr>
                <th>Item</th>
                <th>Nilai (MLD)</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <tr id="row-avg">
                <td>Jumlah permintaan purata</td>
                <td id="summary-avg-mld">‚Äì</td>
                <td id="status-avg">‚Äì</td>
              </tr>
              <tr id="row-peak">
                <td>Jumlah permintaan puncak</td>
                <td id="summary-peak-mld">‚Äì</td>
                <td id="status-peak">‚Äì</td>
              </tr>
              <tr>
                <td>Bekalan sedia ada (JANS)</td>
                <td id="supply-avg-mld">‚Äì</td>
                <td></td>
              </tr>
              <tr>
                <td>Extra supply (air hujan / reuse / tasik / AC)</td>
                <td id="alt-supply-mld">‚Äì</td>
                <td></td>
              </tr>
              <tr>
                <td><strong>Bekalan efektif (JANS + sumber alternatif)</strong></td>
                <td id="effective-supply-mld">‚Äì</td>
                <td></td>
              </tr>
              <tr>
                <td>Surplus / Defisit purata</td>
                <td id="surplus-avg-mld">‚Äì</td>
                <td></td>
              </tr>
              <tr>
                <td>Surplus / Defisit semasa puncak</td>
                <td id="surplus-peak-mld">‚Äì</td>
                <td></td>
              </tr>
            </tbody>
          </table>

          <div class="btn-row" style="margin-top: 0.8rem;">
            <button id="export-excel-btn" type="button" class="export">
              üì§ Export Excel (.xlsx)
            </button>
            <button id="export-pdf-btn" type="button" class="secondary">
              üìÑ Jana Laporan PDF
            </button>
          </div>

          <div class="summary-text" id="summary-text">
            Tekan butang <strong>‚ÄúKira permintaan & banding dengan bekalan‚Äù</strong>
            untuk melihat ringkasan analisis termasuk kesan sumber alternatif.
          </div>
        </div>

        <div>
          <canvas id="demand-by-category-chart" height="200"></canvas>
        </div>
      </div>
    </section>

    <!-- PIE CHART DEMAND SHARE -->
    <section class="card">
      <h2><span class="icon">üìà</span> Agihan Permintaan Mengikut Kategori</h2>
      <p class="lead">
        Rajah menunjukkan sumbangan (%) setiap kategori kepada permintaan purata
        keseluruhan kampus.
      </p>
      <canvas id="demand-share-chart" height="200"></canvas>
    </section>

    <!-- ANALISIS CBA SUMBER ALTERNATIF -->
    <section class="card">
      <h2><span class="icon">üíº</span> Analisis Kewangan Sumber Air Alternatif</h2>
      <p class="lead">
        Jadual di bawah merumuskan volum, penjimatan, CAPEX, OPEX, aliran tunai
        bersih, payback period, NPV dan BCR bagi setiap sumber air alternatif.
      </p>

      <div style="overflow-x: auto;">
        <table id="alt-results-table">
          <thead>
            <tr>
              <th>Sumber</th>
              <th>Kapasiti (m¬≥/hari)</th>
              <th>Utilisasi (% hari)</th>
              <th>Vol. tahunan (m¬≥/tahun)</th>
              <th>CAPEX (RM)</th>
              <th>OPEX tahunan (RM/tahun)</th>
              <th>Saving air + pembetungan (RM/tahun)</th>
              <th>CF bersih (RM/tahun)</th>
              <th>Payback (tahun)</th>
              <th>NPV (RM)</th>
              <th>BCR</th>
            </tr>
          </thead>
          <tbody id="alt-results-body">
            <!-- JS akan isi -->
          </tbody>
          <tfoot>
            <tr>
              <td>Jumlah / Agregat</td>
              <td id="alt-total-capacity">‚Äì</td>
              <td>‚Äì</td>
              <td id="alt-total-volume">‚Äì</td>
              <td id="alt-total-capex">‚Äì</td>
              <td id="alt-total-opex">‚Äì</td>
              <td id="alt-total-saving">‚Äì</td>
              <td id="alt-total-netcf">‚Äì</td>
              <td>‚Äì</td>
              <td id="alt-total-npv">‚Äì</td>
              <td id="alt-total-bcr">‚Äì</td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="two-column" style="margin-top: 1rem;">
        <div>
          <h3 style="font-size:0.96rem; margin-top:0;">Ringkasan Kewangan Projek</h3>
          <table id="alt-summary-table">
            <tbody>
              <tr>
                <td>Jumlah CAPEX semua sumber</td>
                <td id="sum-capex">‚Äì</td>
              </tr>
              <tr>
                <td>Jumlah penjimatan air + pembetungan / tahun</td>
                <td id="sum-saving">‚Äì</td>
              </tr>
              <tr>
                <td>Jumlah OPEX / tahun</td>
                <td id="sum-opex">‚Äì</td>
              </tr>
              <tr>
                <td>Aliran tunai bersih tahunan</td>
                <td id="sum-netcf">‚Äì</td>
              </tr>
              <tr>
                <td>NPV projek (semua sumber)</td>
                <td id="sum-npv">‚Äì</td>
              </tr>
              <tr>
                <td>BCR projek (semua sumber)</td>
                <td id="sum-bcr">‚Äì</td>
              </tr>
              <tr>
                <td>Anggaran IRR projek (mengikut aliran tunai bersih)</td>
                <td id="sum-irr">‚Äì</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div>
          <canvas id="cba-npv-chart" height="200" style="margin-bottom:0.8rem;"></canvas>
          <canvas id="cba-payback-chart" height="200"></canvas>
        </div>
      </div>
    </section>

    <!-- METODOLOGI + DISCLAIMER -->
    <section class="card">
      <h2><span class="icon">üßÆ</span> Nota Metodologi (Ringkas) & Penafian</h2>
      <div class="disclaimer">
        <p><strong>Metodologi ringkas:</strong></p>
        <ul style="margin-top: 0.2rem; padding-left: 1.1rem;">
          <li>
            <strong>Langkah 1 ‚Äì Per kapita:</strong> Untuk setiap kategori demand,
            permintaan purata dikira berdasarkan bilangan pengguna dikali kadar
            penggunaan per kapita (L/org/hari), ditukar kepada m¬≥/hari.
          </li>
          <li>
            <strong>Langkah 2 ‚Äì Permintaan puncak:</strong> Nilai purata
            digandakan dengan faktor puncak (contoh 1.3) bagi menggambarkan hari
            atau masa penggunaan tertinggi.
          </li>
          <li>
            <strong>Langkah 3 ‚Äì Extra supply:</strong> Kapasiti sumber air
            alternatif ditukar kepada bekalan efektif (m¬≥/hari) menggunakan
            faktor penggunaan (% hari/tahun) dan ditambah kepada bekalan JANS.
          </li>
          <li>
            <strong>Langkah 4 ‚Äì Penjimatan & CBA:</strong> Volum air alternatif
            dikalikan dengan tarif air + pembetungan untuk mendapatkan penjimatan
            tahunan, ditolak OPEX untuk mendapatkan aliran tunai bersih.
            NPV dan BCR dikira menggunakan tempoh analisis dan kadar diskaun
            yang ditetapkan.
          </li>
        </ul>

        <p style="margin-top: 0.7rem;"><strong>Penafian:</strong></p>
        <p>
          Kalkulator ini disediakan untuk tujuan perancangan dan analisis awal
          (planning-level estimate) berdasarkan andaian input pengguna. Nilai
          yang dijana bukanlah rekod rasmi penggunaan atau bekalan air
          Universiti Malaysia Sabah dan tidak menggantikan data meter/bil air
          yang disahkan oleh pihak berkuasa berkaitan. Sebarang keputusan
          kejuruteraan atau pelaburan sebenar hendaklah dirujuk dan disahkan
          dengan data teknikal terperinci serta pihak berkepentingan rasmi.
        </p>
      </div>
    </section>
  </main>

  <footer>
    ¬© 2025 Assis, Fera, Sarimah & Sani @ RuWaS UMS. All rights reserved.
  </footer>

  <script>
    window.addEventListener("DOMContentLoaded", () => {
      const addRowBtn = document.getElementById("add-row-btn");
      const calcBtn = document.getElementById("calculate-btn");
      const exportBtn = document.getElementById("export-excel-btn");
      const pdfBtn = document.getElementById("export-pdf-btn");
      const categoryBody = document.getElementById("category-body");

      const addAltRowBtn = document.getElementById("add-alt-row-btn");
      const altBody = document.getElementById("alt-body");

      const resultsBody = document.getElementById("results-body");
      const totalPopEl = document.getElementById("total-pop");
      const totalAvgM3El = document.getElementById("total-avg-m3");
      const totalPeakM3El = document.getElementById("total-peak-m3");
      const totalAvgMLDEl = document.getElementById("total-avg-mld");
      const totalPeakMLDEl = document.getElementById("total-peak-mld");

      const supplyInput = document.getElementById("supply-mld");
      const summaryAvgMLDEl = document.getElementById("summary-avg-mld");
      const summaryPeakMLDEl = document.getElementById("summary-peak-mld");
      const supplyAvgMLDEl = document.getElementById("supply-avg-mld");
      const altSupplyMLDEl = document.getElementById("alt-supply-mld");
      const effectiveSupplyMLDEl = document.getElementById("effective-supply-mld");
      const surplusAvgMLDEl = document.getElementById("surplus-avg-mld");
      const surplusPeakMLDEl = document.getElementById("surplus-peak-mld");
      const statusAvgEl = document.getElementById("status-avg");
      const statusPeakEl = document.getElementById("status-peak");
      const summaryTextEl = document.getElementById("summary-text");

      const rowAvg = document.getElementById("row-avg");
      const rowPeak = document.getElementById("row-peak");

      // CBA elements
      const altResultsBody = document.getElementById("alt-results-body");
      const altTotalCapacityEl = document.getElementById("alt-total-capacity");
      const altTotalVolumeEl = document.getElementById("alt-total-volume");
      const altTotalCapexEl = document.getElementById("alt-total-capex");
      const altTotalOpexEl = document.getElementById("alt-total-opex");
      const altTotalSavingEl = document.getElementById("alt-total-saving");
      const altTotalNetCFEl = document.getElementById("alt-total-netcf");
      const altTotalNPVEl = document.getElementById("alt-total-npv");
      const altTotalBCREl = document.getElementById("alt-total-bcr");

      const sumCapexEl = document.getElementById("sum-capex");
      const sumSavingEl = document.getElementById("sum-saving");
      const sumOpexEl = document.getElementById("sum-opex");
      const sumNetCFEl = document.getElementById("sum-netcf");
      const sumNPVEl = document.getElementById("sum-npv");
      const sumBCREl = document.getElementById("sum-bcr");
      const sumIRREl = document.getElementById("sum-irr");

      const tariffWaterInput = document.getElementById("tariff-water");
      const tariffSewerInput = document.getElementById("tariff-sewer");
      const analysisYearsInput = document.getElementById("analysis-years");
      const discountRateInput = document.getElementById("discount-rate");

      // CAPEX/OPEX itemised
      const capexOpexBody = document.getElementById("capex-opex-body");
      const capexItemsTotalEl = document.getElementById("capex-items-total");
      const opexItemsTotalEl = document.getElementById("opex-items-total");
      const addItemBtn = document.getElementById("add-capex-opex-item-btn");

      const categoryChartCtx = document
        .getElementById("demand-by-category-chart")
        .getContext("2d");
      const shareChartCtx = document
        .getElementById("demand-share-chart")
        .getContext("2d");
      const cbaNPVCtx = document
        .getElementById("cba-npv-chart")
        .getContext("2d");
      const cbaPaybackCtx = document
        .getElementById("cba-payback-chart")
        .getContext("2d");

      let categoryChart = null;
      let shareChart = null;
      let cbaNpvChart = null;
      let cbaPaybackChart = null;

      let lastAltSources = [];

      function formatNumber(num) {
        if (!isFinite(num)) return "‚Äì";
        return num.toLocaleString("ms-MY", { maximumFractionDigits: 2 });
      }

      function createStatusPill(status, isPeak) {
        if (!status) return "";
        const cls =
          status === "Surplus" ? "status-surplus" : "status-deficit";
        const label =
          status === "Surplus"
            ? isPeak
              ? "Surplus (puncak)"
              : "Surplus"
            : isPeak
            ? "Defisit (puncak)"
            : "Defisit";
        return `<span class="status-pill ${cls}">${
          status === "Surplus" ? "‚úîÔ∏è" : "‚ö†Ô∏è"
        } ${label}</span>`;
      }

      function calculate() {
        // 1. Demand by category
        const rows = Array.from(document.querySelectorAll(".category-row"));
        const categoryNames = [];
        const peakDemands = [];
        const avgDemands = [];

        let totalPop = 0;
        let totalAvgM3 = 0;
        let totalPeakM3 = 0;

        resultsBody.innerHTML = "";

        rows.forEach((row) => {
          const nameInput = row.querySelector(".cat-name");
          const popInput = row.querySelector(".cat-pop");
          const perCapInput = row.querySelector(".cat-percap");
          const peakInput = row.querySelector(".cat-peak");

          const name = (nameInput.value || "").trim();
          const pop = parseFloat(popInput.value);
          const perCap = parseFloat(perCapInput.value);
          const peak = parseFloat(peakInput.value);

          if (!name || !isFinite(pop) || pop <= 0 || !isFinite(perCap)) {
            return;
          }

          const avgM3 = (pop * perCap) / 1000;
          const peakM3 = avgM3 * (isFinite(peak) && peak > 0 ? peak : 1);

          totalPop += pop;
          totalAvgM3 += avgM3;
          totalPeakM3 += peakM3;

          categoryNames.push(name);
          avgDemands.push(avgM3);
          peakDemands.push(peakM3);

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${name}</td>
            <td>${formatNumber(pop)}</td>
            <td>${formatNumber(perCap)}</td>
            <td>${formatNumber(avgM3)}</td>
            <td>${isFinite(peak) ? formatNumber(peak) : "‚Äì"}</td>
            <td>${formatNumber(peakM3)}</td>
          `;
          resultsBody.appendChild(tr);
        });

        const totalAvgMLD = totalAvgM3 / 1000;
        const totalPeakMLD = totalPeakM3 / 1000;

        totalPopEl.textContent = totalPop ? formatNumber(totalPop) : "‚Äì";
        totalAvgM3El.textContent = formatNumber(totalAvgM3);
        totalPeakM3El.textContent = formatNumber(totalPeakM3);
        totalAvgMLDEl.textContent = formatNumber(totalAvgMLD);
        totalPeakMLDEl.textContent = formatNumber(totalPeakMLD);

        // 2. Baseline supply (JANS)
        const supplyBaseMLD = parseFloat(supplyInput.value);
        const supplyValid = isFinite(supplyBaseMLD) && supplyBaseMLD >= 0;

        supplyAvgMLDEl.textContent = supplyValid
          ? formatNumber(supplyBaseMLD)
          : "‚Äì";

        // 3. Alternative supply + build altData for CBA
        const altRows = Array.from(document.querySelectorAll(".alt-row"));
        let altAvgM3PerDayTotal = 0;
        const altData = [];

        altRows.forEach((row) => {
          const name = (row.querySelector(".alt-name").value || "").trim();
          const cap = parseFloat(row.querySelector(".alt-capacity").value);
          const util = parseFloat(row.querySelector(".alt-util").value);
          const capex = parseFloat(row.querySelector(".alt-capex").value);
          const capexNote = (row.querySelector(".alt-capex-note")?.value || "").trim();
          const opexFixed = parseFloat(
            row.querySelector(".alt-opex-fixed").value
          );
          const opexVar = parseFloat(
            row.querySelector(".alt-opex-var").value
          );
          const opexNote = (row.querySelector(".alt-opex-note")?.value || "").trim();
          const lifeYears = parseFloat(row.querySelector(".alt-life").value);

          if (!name || !isFinite(cap) || cap <= 0 || !isFinite(util) || util <= 0) {
            return;
          }

          const avgM3PerDayEff = cap * (util / 100);
          altAvgM3PerDayTotal += avgM3PerDayEff;

          altData.push({
            name,
            capacity: cap,
            utilPercent: util,
            capex: isFinite(capex) ? capex : 0,
            capexNote,
            opexFixed: isFinite(opexFixed) ? opexFixed : 0,
            opexVar: isFinite(opexVar) ? opexVar : 0,
            opexNote,
            lifeYears: isFinite(lifeYears) ? lifeYears : NaN,
          });
        });

        const altSupplyMLD = altAvgM3PerDayTotal / 1000;
        altSupplyMLDEl.textContent = altData.length
          ? formatNumber(altSupplyMLD)
          : "0.00";

        const effectiveSupplyMLD = (supplyValid ? supplyBaseMLD : 0) + altSupplyMLD;
        effectiveSupplyMLDEl.textContent = effectiveSupplyMLD
          ? formatNumber(effectiveSupplyMLD)
          : "‚Äì";

        // 4. Demand vs effective supply
        summaryAvgMLDEl.textContent = formatNumber(totalAvgMLD);
        summaryPeakMLDEl.textContent = formatNumber(totalPeakMLD);

        let surplusAvg = null;
        let surplusPeak = null;
        let statusAvg = "";
        let statusPeak = "";

        rowAvg.classList.remove("summary-row-surplus", "summary-row-deficit");
        rowPeak.classList.remove("summary-row-surplus", "summary-row-deficit");

        if (effectiveSupplyMLD > 0) {
          surplusAvg = effectiveSupplyMLD - totalAvgMLD;
          surplusPeak = effectiveSupplyMLD - totalPeakMLD;

          surplusAvgMLDEl.textContent = formatNumber(surplusAvg);
          surplusPeakMLDEl.textContent = formatNumber(surplusPeak);

          if (totalAvgMLD > 0) {
            statusAvg = surplusAvg >= 0 ? "Surplus" : "Deficit";
          }
          if (totalPeakMLD > 0) {
            statusPeak = surplusPeak >= 0 ? "Surplus" : "Deficit";
          }

          if (statusAvg === "Surplus") {
            rowAvg.classList.add("summary-row-surplus");
          } else if (statusAvg === "Deficit") {
            rowAvg.classList.add("summary-row-deficit");
          }

          if (statusPeak === "Surplus") {
            rowPeak.classList.add("summary-row-surplus");
          } else if (statusPeak === "Deficit") {
            rowPeak.classList.add("summary-row-deficit");
          }
        } else {
          surplusAvgMLDEl.textContent = "‚Äì";
          surplusPeakMLDEl.textContent = "‚Äì";
        }

        statusAvgEl.innerHTML = createStatusPill(statusAvg, false);
        statusPeakEl.innerHTML = createStatusPill(statusPeak, true);

        // 5. Ringkasan teks
        if (!categoryNames.length) {
          summaryTextEl.innerHTML =
            "Sila masukkan sekurang-kurangnya satu kategori dengan populasi dan kadar per kapita untuk menjana analisis.";
        } else if (!supplyValid && !altData.length) {
          summaryTextEl.innerHTML =
            "Permintaan purata dianggarkan sebanyak <strong>" +
            formatNumber(totalAvgMLD) +
            " MLD</strong>, manakala permintaan puncak sebanyak <strong>" +
            formatNumber(totalPeakMLD) +
            " MLD</strong>. Sila masukkan nilai bekalan JANS dan/atau sumber alternatif untuk menilai surplus atau defisit.";
        } else {
          const baseText = supplyValid
            ? "Bekalan sedia ada (JANS) dianggarkan <strong>" +
              formatNumber(supplyBaseMLD) +
              " MLD</strong>."
            : "Bekalan JANS tidak ditetapkan dengan jelas.";

          const altText = altData.length
            ? " Sumber alternatif menambah kira-kira <strong>" +
              formatNumber(altSupplyMLD) +
              " MLD</strong> kepada bekalan."
            : " Tiada sumber alternatif dimasukkan setakat ini.";

          const effText =
            " Bekalan efektif (JANS + alternatif) dianggarkan <strong>" +
            formatNumber(effectiveSupplyMLD) +
            " MLD</strong>.";

          const avgWord = surplusAvg >= 0 ? "surplus" : "defisit";
          const peakWord = surplusPeak >= 0 ? "surplus" : "defisit";

          summaryTextEl.innerHTML =
            baseText +
            altText +
            effText +
            " Jumlah permintaan purata kampus dianggarkan <strong>" +
            formatNumber(totalAvgMLD) +
            " MLD</strong> (" +
            avgWord +
            " " +
            formatNumber(Math.abs(surplusAvg)) +
            " MLD), manakala permintaan puncak dianggarkan <strong>" +
            formatNumber(totalPeakMLD) +
            " MLD</strong> (" +
            peakWord +
            " " +
            formatNumber(Math.abs(surplusPeak)) +
            " MLD).";
        }

        // 6. Update demand charts
        updateDemandCharts(categoryNames, avgDemands, peakDemands);

        // 7. CBA for alternative sources
        calculateAltCBA(altData);
      }

      function updateDemandCharts(labels, avgData, peakData) {
        if (categoryChart) categoryChart.destroy();
        if (shareChart) shareChart.destroy();

        if (!labels.length) return;

        categoryChart = new Chart(categoryChartCtx, {
          type: "bar",
          data: {
            labels,
            datasets: [
              {
                label: "Purata (m¬≥/hari)",
                data: avgData,
                backgroundColor: "rgba(13, 110, 253, 0.7)",
                borderRadius: 6,
              },
              {
                label: "Puncak (m¬≥/hari)",
                data: peakData,
                backgroundColor: "rgba(0, 188, 212, 0.7)",
                borderRadius: 6,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: "top" },
              title: {
                display: true,
                text: "Permintaan Air Mengikut Kategori",
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                title: { display: true, text: "m¬≥/hari" },
              },
            },
          },
        });

        shareChart = new Chart(shareChartCtx, {
          type: "pie",
          data: {
            labels,
            datasets: [
              {
                data: avgData,
                backgroundColor: [
                  "rgba(13, 110, 253, 0.85)",
                  "rgba(0, 188, 212, 0.85)",
                  "rgba(3, 169, 244, 0.85)",
                  "rgba(0, 150, 136, 0.85)",
                  "rgba(63, 81, 181, 0.85)",
                  "rgba(33, 150, 243, 0.85)",
                ],
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: "right" },
              title: {
                display: true,
                text: "Agihan Permintaan Purata Mengikut Kategori",
              },
            },
          },
        });
      }

      function computeIRR(initialCapex, netCF, years) {
        if (!(isFinite(initialCapex) && isFinite(netCF) && initialCapex > 0 && netCF > 0 && years > 0)) {
          return NaN;
        }
        let low = 0.0;
        let high = 0.3; // 0%‚Äì30%
        function npv(rate) {
          let val = -initialCapex;
          for (let t = 1; t <= years; t++) {
            val += netCF / Math.pow(1 + rate, t);
          }
          return val;
        }
        let npvLow = npv(low);
        let npvHigh = npv(high);
        if (npvLow * npvHigh > 0) {
          return NaN;
        }
        for (let i = 0; i < 40; i++) {
          const mid = (low + high) / 2;
          const npvMid = npv(mid);
          if (Math.abs(npvMid) < 1e-3) {
            return mid;
          }
          if (npvLow * npvMid < 0) {
            high = mid;
            npvHigh = npvMid;
          } else {
            low = mid;
            npvLow = npvMid;
          }
        }
        return (low + high) / 2;
      }

      function calculateAltCBA(altData) {
        // Clear if no data
        altResultsBody.innerHTML = "";
        if (cbaNpvChart) cbaNpvChart.destroy();
        if (cbaPaybackChart) cbaPaybackChart.destroy();

        const tariffWater = parseFloat(tariffWaterInput.value) || 0;
        const tariffSewer = parseFloat(tariffSewerInput.value) || 0;
        const tariffTotal = tariffWater + tariffSewer;

        const analysisYears = parseInt(analysisYearsInput.value, 10) || 0;
        const discountRate = parseFloat(discountRateInput.value) || 0;
        const r = discountRate / 100;

        let totalCap = 0;
        let totalVol = 0;
        let totalCapex = 0;
        let totalOpex = 0;
        let totalSaving = 0;
        let totalNetCF = 0;

        let totalPVBenefits = 0;
        let totalPVCosts = 0;

        const labels = [];
        const npvData = [];
        const paybackData = [];

        if (!altData.length || analysisYears <= 0) {
          altTotalCapacityEl.textContent = "0.00";
          altTotalVolumeEl.textContent = "0.00";
          altTotalCapexEl.textContent = "0.00";
          altTotalOpexEl.textContent = "0.00";
          altTotalSavingEl.textContent = "0.00";
          altTotalNetCFEl.textContent = "0.00";
          altTotalNPVEl.textContent = "0.00";
          altTotalBCREl.textContent = "‚Äì";

          sumCapexEl.textContent = "0.00";
          sumSavingEl.textContent = "0.00";
          sumOpexEl.textContent = "0.00";
          sumNetCFEl.textContent = "0.00";
          sumNPVEl.textContent = "0.00";
          sumBCREl.textContent = "‚Äì";
          sumIRREl.textContent = "‚Äì";

          lastAltSources = [];
          return;
        }

        altData.forEach((s) => {
          const { name, capacity, utilPercent, capex, opexFixed, opexVar, lifeYears } = s;
          const volAnnual = capacity * (utilPercent / 100) * 365;

          const savingAnnual = volAnnual * tariffTotal;
          const opexAnnual = opexFixed + opexVar * volAnnual;
          const netCF = savingAnnual - opexAnnual;

          // Simple payback
          let payback = NaN;
          if (netCF > 0 && capex > 0) {
            payback = capex / netCF;
          }

          // NPV & BCR
          const horizon = isFinite(lifeYears) && lifeYears > 0
            ? Math.min(analysisYears, Math.round(lifeYears))
            : analysisYears;

          let pvBenefits = 0;
          let pvCosts = capex;

          for (let t = 1; t <= horizon; t++) {
            const df = Math.pow(1 + r, t);
            pvBenefits += savingAnnual / df;
            pvCosts += opexAnnual / df;
          }

          const npv = pvBenefits - pvCosts;
          const bcr = pvCosts > 0 ? pvBenefits / pvCosts : NaN;

          totalCap += capacity;
          totalVol += volAnnual;
          totalCapex += capex;
          totalOpex += opexAnnual;
          totalSaving += savingAnnual;
          totalNetCF += netCF;

          totalPVBenefits += pvBenefits;
          totalPVCosts += pvCosts;

          labels.push(name);
          npvData.push(npv);
          paybackData.push(isFinite(payback) ? payback : null);

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${name}</td>
            <td>${formatNumber(capacity)}</td>
            <td>${formatNumber(utilPercent)}</td>
            <td>${formatNumber(volAnnual)}</td>
            <td>${formatNumber(capex)}</td>
            <td>${formatNumber(opexAnnual)}</td>
            <td>${formatNumber(savingAnnual)}</td>
            <td>${formatNumber(netCF)}</td>
            <td>${isFinite(payback) ? formatNumber(payback) : "‚Äì"}</td>
            <td>${formatNumber(npv)}</td>
            <td>${isFinite(bcr) ? formatNumber(bcr) : "‚Äì"}</td>
          `;
          altResultsBody.appendChild(tr);
        });

        const totalNPV = totalPVBenefits - totalPVCosts;
        const totalBCR = totalPVCosts > 0 ? totalPVBenefits / totalPVCosts : NaN;

        altTotalCapacityEl.textContent = formatNumber(totalCap);
        altTotalVolumeEl.textContent = formatNumber(totalVol);
        altTotalCapexEl.textContent = formatNumber(totalCapex);
        altTotalOpexEl.textContent = formatNumber(totalOpex);
        altTotalSavingEl.textContent = formatNumber(totalSaving);
        altTotalNetCFEl.textContent = formatNumber(totalNetCF);
        altTotalNPVEl.textContent = formatNumber(totalNPV);
        altTotalBCREl.textContent = isFinite(totalBCR) ? formatNumber(totalBCR) : "‚Äì";

        sumCapexEl.textContent = formatNumber(totalCapex);
        sumSavingEl.textContent = formatNumber(totalSaving);
        sumOpexEl.textContent = formatNumber(totalOpex);
        sumNetCFEl.textContent = formatNumber(totalNetCF);
        sumNPVEl.textContent = formatNumber(totalNPV);
        sumBCREl.textContent = isFinite(totalBCR) ? formatNumber(totalBCR) : "‚Äì";

        // IRR anggaran untuk projek (menggunakan totalCapex & totalNetCF)
        const irr = computeIRR(totalCapex, totalNetCF, analysisYears);
        sumIRREl.textContent = isFinite(irr) ? (irr * 100).toFixed(2) + " %" : "‚Äì";

        // Simpan altData untuk laporan PDF (termasuk nota CAPEX/OPEX)
        lastAltSources = altData.slice();

        // Charts NPV & Payback
        if (labels.length) {
          cbaNpvChart = new Chart(cbaNPVCtx, {
            type: "bar",
            data: {
              labels,
              datasets: [
                {
                  label: "NPV (RM)",
                  data: npvData,
                  backgroundColor: "rgba(3, 169, 244, 0.8)",
                  borderRadius: 6,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: { display: false },
                title: { display: true, text: "NPV Mengikut Sumber Air Alternatif" },
              },
              scales: {
                y: { beginAtZero: false, title: { display: true, text: "RM" } },
              },
            },
          });

          cbaPaybackChart = new Chart(cbaPaybackCtx, {
            type: "bar",
            data: {
              labels,
              datasets: [
                {
                  label: "Payback (tahun)",
                  data: paybackData,
                  backgroundColor: "rgba(255, 193, 7, 0.9)",
                  borderRadius: 6,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: { display: false },
                title: { display: true, text: "Payback Period Mengikut Sumber" },
              },
              scales: {
                y: {
                  beginAtZero: true,
                  title: { display: true, text: "Tahun" },
                },
              },
            },
          });
        }
      }

      // CAPEX/OPEX itemised calculator
      function recalcCapexOpexItems() {
        const rows = Array.from(document.querySelectorAll(".capex-opex-row"));
        let capexTotal = 0;
        let opexTotal = 0;

        rows.forEach((row) => {
          const type = row.querySelector(".item-type").value;
          const qty = parseFloat(row.querySelector(".item-qty").value) || 0;
          const cost = parseFloat(row.querySelector(".item-cost").value) || 0;
          const total = qty * cost;
          row.querySelector(".item-total").textContent = formatNumber(total);
          if (type === "CAPEX") {
            capexTotal += total;
          } else {
            opexTotal += total;
          }
        });

        capexItemsTotalEl.textContent = formatNumber(capexTotal);
        opexItemsTotalEl.textContent = formatNumber(opexTotal);
      }

      addItemBtn.addEventListener("click", () => {
        const tr = document.createElement("tr");
        tr.className = "capex-opex-row";
        tr.innerHTML = `
          <td>
            <select class="item-type">
              <option value="CAPEX">CAPEX</option>
              <option value="OPEX">OPEX</option>
            </select>
          </td>
          <td><input type="text" class="item-name" placeholder="Nama item" /></td>
          <td><input type="number" class="item-qty" value="1" min="0" step="0.01" /></td>
          <td><input type="number" class="item-cost" value="0" min="0" step="0.01" /></td>
          <td class="item-total">0.00</td>
          <td><input type="text" class="item-note" placeholder="Catatan (jika ada)" /></td>
        `;
        capexOpexBody.appendChild(tr);
        recalcCapexOpexItems();
      });

      capexOpexBody.addEventListener("input", (e) => {
        if (
          e.target.classList.contains("item-qty") ||
          e.target.classList.contains("item-cost") ||
          e.target.classList.contains("item-type")
        ) {
          recalcCapexOpexItems();
        }
      });

      // Add rows for demand categories
      addRowBtn.addEventListener("click", () => {
        const tr = document.createElement("tr");
        tr.className = "category-row";
        tr.innerHTML = `
          <td><input type="text" class="cat-name" placeholder="Nama kategori" /></td>
          <td><input type="number" class="cat-pop" min="0" /></td>
          <td><input type="number" class="cat-percap" min="0" /></td>
          <td><input type="number" class="cat-peak" value="1.3" min="1" step="0.05" /></td>
        `;
        categoryBody.appendChild(tr);
      });

      // Add rows for alternative sources
      addAltRowBtn.addEventListener("click", () => {
        const tr = document.createElement("tr");
        tr.className = "alt-row";
        tr.innerHTML = `
          <td><input type="text" class="alt-name" placeholder="Nama sumber" /></td>
          <td><input type="number" class="alt-capacity" min="0" /></td>
          <td><input type="number" class="alt-util" min="0" max="100" /></td>
          <td><input type="number" class="alt-capex" min="0" /></td>
          <td><input type="text" class="alt-capex-note" placeholder="Butiran CAPEX (jika ada)" /></td>
          <td><input type="number" class="alt-opex-fixed" min="0" /></td>
          <td><input type="number" class="alt-opex-var" min="0" step="0.01" /></td>
          <td><input type="text" class="alt-opex-note" placeholder="Butiran OPEX (jika ada)" /></td>
          <td><input type="number" class="alt-life" min="1" /></td>
        `;
        altBody.appendChild(tr);
      });

      calcBtn.addEventListener("click", () => {
        recalcCapexOpexItems();
        calculate();
      });

      // Export Excel
      exportBtn.addEventListener("click", () => {
        try {
          if (typeof XLSX === "undefined") {
            alert("Library Excel (SheetJS) tidak dimuatkan.");
            return;
          }

          // Ensure latest calculations
          recalcCapexOpexItems();
          calculate();

          const wb = XLSX.utils.book_new();

          // Sheet 1: Kategori demand
          const catRows = [["Kategori", "Populasi", "Per kapita (L/org/hari)", "Purata (m¬≥/hari)", "Faktor puncak", "Permintaan puncak (m¬≥/hari)"]];
          document.querySelectorAll("#results-body tr").forEach((tr) => {
            const cells = Array.from(tr.querySelectorAll("td")).map((td) =>
              td.textContent.trim()
            );
            if (cells.length) catRows.push(cells);
          });
          const totalsRow1 = [
            "Jumlah",
            document.getElementById("total-pop").textContent,
            "",
            document.getElementById("total-avg-m3").textContent,
            "",
            document.getElementById("total-peak-m3").textContent,
          ];
          const totalsRow2 = [
            "Jumlah dalam MLD",
            "",
            "",
            document.getElementById("total-avg-mld").textContent,
            "",
            document.getElementById("total-peak-mld").textContent,
          ];
          catRows.push(totalsRow1, totalsRow2);
          const wsCat = XLSX.utils.aoa_to_sheet(catRows);
          XLSX.utils.book_append_sheet(wb, wsCat, "Kategori");

          // Sheet 2: Ringkasan demand‚Äìsupply
          const summaryRows = [
            ["Item", "Nilai (MLD)"],
            ["Jumlah permintaan purata", document.getElementById("summary-avg-mld").textContent],
            ["Jumlah permintaan puncak", document.getElementById("summary-peak-mld").textContent],
            ["Bekalan sedia ada (JANS)", document.getElementById("supply-avg-mld").textContent],
            ["Extra supply (alt sources)", document.getElementById("alt-supply-mld").textContent],
            ["Bekalan efektif", document.getElementById("effective-supply-mld").textContent],
            ["Surplus / Defisit purata", document.getElementById("surplus-avg-mld").textContent],
            ["Surplus / Defisit puncak", document.getElementById("surplus-peak-mld").textContent],
          ];
          const wsSum = XLSX.utils.aoa_to_sheet(summaryRows);
          XLSX.utils.book_append_sheet(wb, wsSum, "Ringkasan");

          // Sheet 3: CBA alternatif
          const cbaRows = [[
            "Sumber",
            "Kapasiti (m¬≥/hari)",
            "Utilisasi (% hari)",
            "Vol. tahunan (m¬≥/tahun)",
            "CAPEX (RM)",
            "OPEX tahunan (RM/tahun)",
            "Saving air + pembetungan (RM/tahun)",
            "CF bersih (RM/tahun)",
            "Payback (tahun)",
            "NPV (RM)",
            "BCR"
          ]];
          document.querySelectorAll("#alt-results-body tr").forEach((tr) => {
            const cells = Array.from(tr.querySelectorAll("td")).map((td) =>
              td.textContent.trim()
            );
            if (cells.length) cbaRows.push(cells);
          });
          const cbaTotalsRow = [
            "Jumlah / Agregat",
            document.getElementById("alt-total-capacity").textContent,
            "",
            document.getElementById("alt-total-volume").textContent,
            document.getElementById("alt-total-capex").textContent,
            document.getElementById("alt-total-opex").textContent,
            document.getElementById("alt-total-saving").textContent,
            document.getElementById("alt-total-netcf").textContent,
            "",
            document.getElementById("alt-total-npv").textContent,
            document.getElementById("alt-total-bcr").textContent,
          ];
          cbaRows.push(cbaTotalsRow);
          const wsCBA = XLSX.utils.aoa_to_sheet(cbaRows);
          XLSX.utils.book_append_sheet(wb, wsCBA, "CBA_Alt_Sources");

          // Sheet 4: Itemised CAPEX & OPEX
          const itemRows = [[
            "Jenis",
            "Item / Komponen",
            "Kuantiti",
            "Kos seunit (RM)",
            "Jumlah kos (RM)",
            "Catatan"
          ]];
          document.querySelectorAll("#capex-opex-body tr").forEach((tr) => {
            const type = tr.querySelector(".item-type").value || "";
            const name = tr.querySelector(".item-name").value || "";
            const qty = tr.querySelector(".item-qty").value || "";
            const cost = tr.querySelector(".item-cost").value || "";
            const total = tr.querySelector(".item-total").textContent || "";
            const note = tr.querySelector(".item-note").value || "";
            if (name.trim() || parseFloat(qty) > 0 || parseFloat(cost) > 0) {
              itemRows.push([type, name, qty, cost, total, note]);
            }
          });
          itemRows.push(
            ["Jumlah CAPEX", "", "", "", document.getElementById("capex-items-total").textContent, ""],
            ["Jumlah OPEX", "", "", "", document.getElementById("opex-items-total").textContent, ""]
          );
          const wsItems = XLSX.utils.aoa_to_sheet(itemRows);
          XLSX.utils.book_append_sheet(wb, wsItems, "CAPEX_OPEX_Itemised");

          XLSX.writeFile(wb, "UMS_Water_Demand_Supply_CBA.xlsx");
        } catch (e) {
          console.error(e);
          alert("Ralat semasa export Excel. Sila cuba lagi.");
        }
      });

      // Export PDF (EPU-style)
      pdfBtn.addEventListener("click", () => {
        try {
          if (!window.jspdf || !window.jspdf.jsPDF) {
            alert("Library PDF (jsPDF) tidak dimuatkan.");
            return;
          }
          recalcCapexOpexItems();
          calculate();

          const { jsPDF } = window.jspdf;
          const doc = new jsPDF("p", "mm", "a4");
          const today = new Date().toLocaleDateString("ms-MY");

          function addParagraph(title, text, startY) {
            let y = startY;
            doc.setFontSize(11);
            doc.setFont("helvetica", "bold");
            doc.text(title, 14, y);
            y += 5;
            doc.setFontSize(9);
            doc.setFont("helvetica", "normal");
            const lines = doc.splitTextToSize(text, 180);
            doc.text(lines, 14, y);
            y += lines.length * 4 + 4;
            return y;
          }

          // Muka surat 1: tajuk + naratif
          doc.setFontSize(14);
          doc.setFont("helvetica", "bold");
          doc.text("Laporan Ringkasan Permintaan, Bekalan dan Sumber Air Alternatif UMS", 14, 16);
          doc.setFontSize(10);
          doc.setFont("helvetica", "normal");
          doc.text("Tarikh jana: " + today, 14, 22);

          let y = 30;

          const latarText =
            "Universiti Malaysia Sabah (UMS) bergantung kepada bekalan air terawat " +
            "yang dibekalkan oleh pihak berkuasa air negeri bagi menyokong operasi " +
            "kampus, termasuk keperluan asrama pelajar, fakulti dan pentadbiran, " +
            "kemudahan ibadah serta sukan dan rekreasi. Pertumbuhan bilangan pelajar " +
            "dan aktiviti kampus dari semasa ke semasa meningkatkan permintaan air, " +
            "sekali gus menuntut perancangan bekalan yang lebih mampan dan berdaya tahan. " +
            "Selain itu, tekanan terhadap sumber air konvensional serta keperluan " +
            "pengurangan risiko gangguan bekalan memberi justifikasi kepada penilaian " +
            "sumber air alternatif seperti tangkapan air hujan, reuse (greywater/RO), " +
            "air tasik kampus dan kondensasi penghawa dingin.";

          const objektifText =
            "Objektif utama analisis ini adalah untuk: (i) menganggarkan permintaan air " +
            "kampus UMS mengikut kategori pengguna; (ii) membandingkan permintaan purata " +
            "dan puncak dengan kapasiti bekalan sedia ada; (iii) menilai potensi sumbangan " +
            "sumber air alternatif terhadap bekalan efektif kampus; dan (iv) menjalankan " +
            "analisis kos‚Äìfaedah kewangan ringkas bagi sumber air alternatif, termasuk " +
            "indikator seperti NPV, BCR, payback period dan anggaran IRR projek.";

          const kaedahText =
            "Kaedah penilaian merangkumi beberapa komponen utama. Pertama, permintaan air " +
            "dianggarkan menggunakan pendekatan per kapita mengikut kategori pengguna " +
            "(contoh: asrama, fakulti & pentadbiran, masjid & surau, sukan & rekreasi), " +
            "dengan mengambil kira faktor permintaan puncak (peak factor) untuk mencerminkan " +
            "hari dan masa penggunaan tertinggi. Kedua, kapasiti bekalan asas diambil " +
            "berdasarkan anggaran bekalan harian daripada loji rawatan (JANS). Ketiga, " +
            "sumber air alternatif dimodelkan melalui parameter kapasiti teknikal (m¬≥/hari), " +
            "faktor penggunaan tahunan, CAPEX, OPEX tetap dan OPEX berubah. Keempat, " +
            "analisis kewangan projek dijalankan dengan mengandaikan penjimatan bil air " +
            "dan pembetungan berkadar terus dengan volum air alternatif yang menggantikan " +
            "air terawat. Aliran tunai bersih tahunan dikira sebagai penjimatan bil " +
            "ditolak OPEX; NPV dan BCR dikira menggunakan tempoh analisis dan kadar diskaun " +
            "yang ditetapkan. Selain itu, anggaran IRR projek diperoleh berdasarkan " +
            "jumlah CAPEX dan aliran tunai bersih tahunan agregat.";

          y = addParagraph("1. Latar Belakang", latarText, y);
          y = addParagraph("2. Objektif Projek", objektifText, y);
          y = addParagraph("3. Kaedah Penilaian", kaedahText, y);

          // Muka surat 2: hasil + jadual
          doc.addPage();
          y = 20;

          doc.setFontSize(11);
          doc.setFont("helvetica", "bold");
          doc.text("4. Hasil Analisis Utama", 14, y);
          y += 6;

          // 4.1 Ringkasan demand‚Äìsupply
          doc.setFontSize(9);
          doc.setFont("helvetica", "normal");
          doc.text("4.1 Ringkasan Permintaan dan Bekalan Air (MLD)", 14, y);
          y += 4;

          doc.autoTable({
            startY: y,
            head: [["Item", "Nilai (MLD)"]],
            body: [
              ["Jumlah permintaan purata", document.getElementById("summary-avg-mld").textContent],
              ["Jumlah permintaan puncak", document.getElementById("summary-peak-mld").textContent],
              ["Bekalan sedia ada (JANS)", document.getElementById("supply-avg-mld").textContent],
              ["Extra supply (sumber alternatif)", document.getElementById("alt-supply-mld").textContent],
              ["Bekalan efektif (JANS + alternatif)", document.getElementById("effective-supply-mld").textContent],
              ["Surplus / Defisit purata", document.getElementById("surplus-avg-mld").textContent],
              ["Surplus / Defisit puncak", document.getElementById("surplus-peak-mld").textContent]
            ],
            styles: { fontSize: 8 },
            headStyles: { fillColor: [13, 110, 253] }
          });

          y = doc.lastAutoTable.finalY + 8;

          // 4.2 Ringkasan kewangan projek
          doc.setFontSize(9);
          doc.text("4.2 Ringkasan Analisis Kewangan Sumber Air Alternatif", 14, y);
          y += 4;

          doc.autoTable({
            startY: y,
            head: [["Indikator", "Nilai"]],
            body: [
              ["Jumlah CAPEX semua sumber (RM)", sumCapexEl.textContent],
              ["Jumlah OPEX tahunan (RM/tahun)", sumOpexEl.textContent],
              ["Penjimatan air + pembetungan (RM/tahun)", sumSavingEl.textContent],
              ["Aliran tunai bersih tahunan (RM/tahun)", sumNetCFEl.textContent],
              ["NPV projek (RM)", sumNPVEl.textContent],
              ["BCR projek", sumBCREl.textContent],
              ["Anggaran IRR projek", sumIRREl.textContent]
            ],
            styles: { fontSize: 8 },
            headStyles: { fillColor: [0, 188, 212] }
          });

          y = doc.lastAutoTable.finalY + 8;

          // 4.3 Perincian CAPEX & OPEX mengikut sumber
          doc.setFontSize(9);
          doc.text("4.3 Perincian CAPEX dan OPEX Mengikut Sumber Air Alternatif", 14, y);
          y += 4;

          if (lastAltSources && lastAltSources.length) {
            const capexOpexBody = lastAltSources.map(s => ([
              s.name || "-",
              s.capexNote || "-",
              s.opexNote || "-"
            ]));

            doc.autoTable({
              startY: y,
              head: [["Sumber", "Butiran CAPEX (ringkas)", "Butiran OPEX (ringkas)"]],
              body: capexOpexBody,
              styles: { fontSize: 8 },
              headStyles: { fillColor: [63, 81, 181] }
            });
            y = doc.lastAutoTable.finalY + 8;
          } else {
            doc.setFontSize(8);
            doc.text(
              "Tiada perincian CAPEX dan OPEX dimasukkan pada peringkat ini.",
              14,
              y
            );
            y += 6;
          }

          // 4.4 Ringkasan pengiraan terperinci CAPEX/OPEX item
          doc.setFontSize(9);
          doc.text("4.4 Ringkasan Pengiraan Terperinci CAPEX dan OPEX Mengikut Item", 14, y);
          y += 4;

          doc.autoTable({
            startY: y,
            head: [["Jenis", "Jumlah (RM)"]],
            body: [
              ["CAPEX (daripada jadual item)", capexItemsTotalEl.textContent],
              ["OPEX (daripada jadual item)", opexItemsTotalEl.textContent]
            ],
            styles: { fontSize: 8 },
            headStyles: { fillColor: [76, 175, 80] }
          });

          // Muka surat 3: cadangan & penafian
          doc.addPage();
          y = 20;

          const hasilText =
            "Secara keseluruhan, analisis menunjukkan bahawa jumlah permintaan purata " +
            "kampus adalah pada orde yang ditunjukkan dalam Jadual 4.1, manakala " +
            "permintaan puncak lebih tinggi mengikut faktor puncak yang digunakan. " +
            "Apabila hanya bekalan sedia ada (JANS) diambil kira, wujud risiko surplus " +
            "atau defisit bergantung kepada kombinasi permintaan purata dan puncak. " +
            "Dengan memasukkan sumber air alternatif, bekalan efektif kampus meningkat " +
            "dan jurang antara permintaan dan bekalan dapat dikurangkan, sekali gus " +
            "mengurangkan kebergantungan tunggal kepada air terawat sedia ada.\n\n" +
            "Daripada perspektif kewangan, jumlah CAPEX projek adalah pada magnitud " +
            sumCapexEl.textContent +
            ", manakala OPEX tahunan dianggarkan sekitar " +
            sumOpexEl.textContent +
            ". Penjimatan bil air dan pembetungan tahunan sekitar " +
            sumSavingEl.textContent +
            " menghasilkan aliran tunai bersih tahunan sebanyak " +
            sumNetCFEl.textContent +
            ". NPV projek sebanyak " +
            sumNPVEl.textContent +
            " dan BCR sekitar " +
            sumBCREl.textContent +
            " menunjukkan bahawa projek ini berpotensi " +
            "memberi pulangan kewangan yang munasabah, dengan anggaran IRR " +
            sumIRREl.textContent +
            " bergantung kepada andaian tarif dan tempoh analisis.";

          const cadanganText =
            "Berdasarkan dapatan ini, beberapa cadangan boleh dipertimbangkan:\n" +
            "(i) Memfasa pelaksanaan sumber air alternatif mengikut keutamaan kos dan impak, " +
            "contohnya memulakan dengan tangkapan air hujan dan kondensasi penghawa dingin " +
            "yang lazimnya memerlukan CAPEX yang lebih sederhana.\n" +
            "(ii) Menjalankan analisis teknikal terperinci di peringkat bangunan/zon bagi " +
            "memastikan infrastruktur paip, tangki dan sistem kawalan bersesuaian dengan " +
            "pola permintaan sebenar.\n" +
            "(iii) Mengemas kini parameter kewangan (tarif, OPEX, jangka hayat) berdasarkan " +
            "data terkini daripada agensi berkaitan dan pembekal teknologi.\n" +
            "(iv) Menggabungkan dimensi alam sekitar seperti pengurangan pelepasan karbon " +
            "dan penjimatan sumber air konvensional dalam penilaian projek, khususnya " +
            "apabila laporan dikemukakan untuk kelulusan peringkat lebih tinggi.\n" +
            "(v) Menyepadukan sistem pemantauan penggunaan air (metering dan data logger) " +
            "bagi membolehkan pengesahan dan kalibrasi model permintaan‚Äìbekalan dari semasa ke semasa.";

          const penafianText =
            "Laporan ini dijana secara automatik menggunakan kalkulator permintaan‚Äìbekalan " +
            "air UMS berasaskan input dan andaian pengguna. Nilai dan indikator kewangan " +
            "yang dipaparkan adalah anggaran untuk tujuan perancangan awal dan tidak " +
            "boleh dianggap sebagai angka muktamad. Sebarang keputusan pelaburan, reka bentuk " +
            "kejuruteraan atau komitmen kewangan hendaklah disokong dengan kajian teknikal " +
            "terperinci, data meter sebenar serta pengesahan oleh pihak berkuasa dan " +
            "pihak berkepentingan rasmi.";

          y = addParagraph("5. Hasil Analisis Utama (Rumusan Naratif)", hasilText, y);
          y = addParagraph("6. Cadangan dan Langkah Seterusnya", cadanganText, y);
          y = addParagraph("7. Penafian", penafianText, y);

          doc.save("Laporan_UMS_Water_Demand_Supply.pdf");
        } catch (e) {
          console.error(e);
          alert("Ralat semasa jana PDF. Sila cuba lagi.");
        }
      });

      // Kiraan awal dengan nilai contoh
      recalcCapexOpexItems();
      calculate();
    });
  </script>
</body>
</html>
