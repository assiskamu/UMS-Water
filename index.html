<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <title>Kalkulator Permintaan & Bekalan Air UMS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Chart.js (graf) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- SheetJS (Export Excel) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- jsPDF & AutoTable (PDF Laporan) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root {
      --primary: #0d6efd;
      --primary-light: #e0f4ff;
      --primary-dark: #054a91;
      --accent: #00bcd4;
      --danger: #ff1744;
      --success: #00c853;
      --bg: #f5fbff;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        Roboto, sans-serif;
      color: #12324a;
      background:
        radial-gradient(circle at top, #cbe9ff 0, #f5fbff 45%, #ffffff 100%);
      position: relative;
      overflow-x: hidden;
    }

    /* background ‚Äúair‚Äù halus */
    body::before {
      content: "";
      position: fixed;
      inset: -20vh -10vw auto;
      height: 60vh;
      background:
        radial-gradient(circle at 20% 20%, rgba(255,255,255,0.7) 0, transparent 55%),
        radial-gradient(circle at 80% 10%, rgba(255,255,255,0.6) 0, transparent 55%),
        linear-gradient(135deg, rgba(13,110,253,0.25), rgba(0,188,212,0.15));
      opacity: 0.7;
      z-index: -2;
      pointer-events: none;
    }

    header {
      background: linear-gradient(135deg, var(--primary-dark), var(--accent));
      color: #fff;
      padding: 1.4rem 1rem;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.18);
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(6px);
    }

    .header-inner {
      max-width: 1100px;
      margin: 0 auto;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }

    header h1 {
      margin: 0;
      font-size: 1.45rem;
      letter-spacing: 0.02em;
    }

    header p {
      margin: 0.15rem 0 0;
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.35rem 0.8rem;
      border-radius: 999px;
      background-color: rgba(255, 255, 255, 0.15);
      font-size: 0.8rem;
      align-self: flex-start;
    }

    .badge span { font-size: 1.1rem; }

    main {
      max-width: 1100px;
      margin: 1.5rem auto 2.5rem;
      padding: 0 1rem;
    }

    .card {
      background: #ffffff;
      border-radius: 1rem;
      padding: 1.3rem 1.5rem;
      margin-bottom: 1.3rem;
      box-shadow: 0 8px 25px rgba(13, 110, 253, 0.08);
      border: 1px solid rgba(13, 110, 253, 0.09);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: auto -30% -40%;
      height: 120px;
      background:
        radial-gradient(circle at 10% 0%, rgba(13,110,253,0.06) 0, transparent 55%),
        radial-gradient(circle at 90% 40%, rgba(0,188,212,0.06) 0, transparent 55%);
      z-index: -1;
    }

    .card h2 {
      margin-top: 0;
      font-size: 1.15rem;
      color: var(--primary-dark);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .card h2 span.icon { font-size: 1.25rem; }

    .card p.lead {
      margin-top: 0;
      font-size: 0.9rem;
      color: #476582;
    }

    label {
      font-size: 0.85rem;
      font-weight: 600;
      color: #23405b;
      display: block;
      margin-bottom: 0.2rem;
    }

    input[type="number"],
    input[type="text"] {
      width: 100%;
      padding: 0.4rem 0.55rem;
      border-radius: 0.5rem;
      border: 1px solid #c5d9ec;
      font-size: 0.9rem;
      outline: none;
      background-color: #fafdff;
    }

    input[type="number"]:focus,
    input[type="text"]:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.15);
      background-color: #ffffff;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
      margin-top: 0.5rem;
      background-color: #fdfefe;
    }

    th,
    td {
      padding: 0.4rem 0.5rem;
      border-bottom: 1px solid #dde7f3;
      text-align: right;
      white-space: nowrap;
    }

    th:first-child,
    td:first-child { text-align: left; }

    thead {
      background: linear-gradient(
        90deg,
        rgba(13, 110, 253, 0.1),
        rgba(0, 188, 212, 0.06)
      );
    }

    tfoot td {
      font-weight: 700;
      background-color: #f3f8ff;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      margin-top: 0.6rem;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 0.45rem 0.9rem;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      transition: transform 0.05s ease, box-shadow 0.12s ease,
        background-color 0.12s ease;
    }

    button.primary {
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color: #fff;
      box-shadow: 0 4px 12px rgba(13, 110, 253, 0.35);
    }

    button.secondary {
      background-color: var(--primary-light);
      color: var(--primary-dark);
    }

    button.export {
      background: linear-gradient(135deg, #00c853, #00e676);
      color: #fff;
      box-shadow: 0 4px 12px rgba(0, 200, 83, 0.4);
    }

    button:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }

    .two-column {
      display: grid;
      grid-template-columns: minmax(0, 1.5fr) minmax(0, 1.2fr);
      gap: 1.2rem;
    }

    .status-pill {
      display: inline-flex;
      border-radius: 999px;
      padding: 0.18rem 0.6rem;
      font-size: 0.8rem;
      font-weight: 600;
      align-items: center;
      gap: 0.35rem;
    }

    .status-surplus {
      background-color: #e0ffe9;
      color: #008a2f;
      border: 1px solid #00c853;
    }

    .status-deficit {
      background-color: #ffebee;
      color: #c62828;
      border: 1px solid #ff1744;
    }

    .summary-text {
      font-size: 0.88rem;
      margin-top: 0.5rem;
      color: #36526f;
    }

    .note {
      font-size: 0.78rem;
      color: #627d96;
      margin-top: 0.2rem;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.75rem;
      padding: 0.2rem 0.5rem;
      border-radius: 999px;
      background-color: rgba(13, 110, 253, 0.05);
      color: #2d4c69;
      margin-right: 0.4rem;
      margin-top: 0.2rem;
    }

    canvas {
      background: radial-gradient(circle at top, #f2fbff, #ffffff);
      border-radius: 0.8rem;
      padding: 0.5rem;
    }

    .summary-row-surplus td:nth-child(2),
    .summary-row-surplus td:nth-child(4) {
      background-color: #e0ffe9;
      color: #006622;
      font-weight: 700;
    }

    .summary-row-deficit td:nth-child(2),
    .summary-row-deficit td:nth-child(4) {
      background-color: #ffebee;
      color: #b71c1c;
      font-weight: 700;
    }

    .disclaimer {
      font-size: 0.8rem;
      color: #455a64;
      line-height: 1.5;
    }

    footer {
      text-align: center;
      padding: 0.8rem 1rem 1.2rem;
      font-size: 0.78rem;
      color: #607d8b;
      background: #f1f7fd;
      border-top: 1px solid #d3e1f2;
    }

    .input-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 0.8rem 1rem;
      margin-top: 0.6rem;
    }

    @media (max-width: 768px) {
      header { padding: 1.15rem 1rem; }
      header h1 { font-size: 1.25rem; }
      .two-column { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div>
        <h1>Kalkulator Permintaan & Bekalan Air UMS</h1>
        <p>
          Anggaran demand‚Äìsupply air kampus termasuk sumber alternatif
          (tangkapan air hujan, reuse, air tasik, kondensasi penghawa dingin)
          dan analisis kos‚Äìfaedah kewangan & ekonomi.
        </p>
      </div>
      <div class="badge">
        <span>üíß</span> Planning-level water & CBA tool (EPU-style)
      </div>
    </div>
  </header>

  <main>
    <!-- INPUT KATEGORI DEMAND -->
    <section class="card">
      <h2><span class="icon">üì•</span> Input Permintaan Air Mengikut Kategori</h2>
      <p class="lead">
        Tetapkan kategori (contoh: Asrama, Fakulti & Pentadbiran, Masjid, Sukan)
        bersama bilangan pengguna, kadar penggunaan per kapita, dan faktor
        permintaan puncak (peak factor).
      </p>

      <div class="note">
        Tip: 1 m¬≥/hari = 1,000 L/hari. Peak factor biasa 1.2‚Äì1.5 untuk asrama
        & kawasan tumpuan pelajar.
      </div>

      <div style="overflow-x: auto; margin-top: 0.6rem;">
        <table id="category-input-table">
          <thead>
            <tr>
              <th>Kategori</th>
              <th>Populasi (orang)</th>
              <th>Per kapita (L/org/hari)</th>
              <th>Faktor puncak</th>
            </tr>
          </thead>
          <tbody id="category-body">
            <tr class="category-row">
              <td><input type="text" class="cat-name" value="Asrama" /></td>
              <td><input type="number" class="cat-pop" value="6621" min="0" /></td>
              <td><input type="number" class="cat-percap" value="200" min="0" /></td>
              <td><input type="number" class="cat-peak" value="1.3" min="1" step="0.05" /></td>
            </tr>
            <tr class="category-row">
              <td>
                <input type="text" class="cat-name" value="Fakulti & Pentadbiran" />
              </td>
              <td><input type="number" class="cat-pop" value="8000" min="0" /></td>
              <td><input type="number" class="cat-percap" value="50" min="0" /></td>
              <td><input type="number" class="cat-peak" value="1.2" min="1" step="0.05" /></td>
            </tr>
            <tr class="category-row">
              <td><input type="text" class="cat-name" value="Masjid & Surau" /></td>
              <td><input type="number" class="cat-pop" value="3000" min="0" /></td>
              <td><input type="number" class="cat-percap" value="15" min="0" /></td>
              <td><input type="number" class="cat-peak" value="1.5" min="1" step="0.05" /></td>
            </tr>
            <tr class="category-row">
              <td><input type="text" class="cat-name" value="Sukan & Rekreasi" /></td>
              <td><input type="number" class="cat-pop" value="1500" min="0" /></td>
              <td><input type="number" class="cat-percap" value="60" min="0" /></td>
              <td><input type="number" class="cat-peak" value="1.4" min="1" step="0.05" /></td>
            </tr>
            <tr class="category-row">
              <td>
                <input type="text" class="cat-name"
                       placeholder="Kategori tambahan (jika ada)" />
              </td>
              <td><input type="number" class="cat-pop" min="0" /></td>
              <td><input type="number" class="cat-percap" min="0" /></td>
              <td><input type="number" class="cat-peak" value="1.3" min="1" step="0.05" /></td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="btn-row">
        <button id="add-row-btn" type="button" class="secondary">
          ‚ûï Tambah baris kategori
        </button>
        <button id="calculate-btn" type="button" class="primary">
          üîç Kira permintaan & banding dengan bekalan
        </button>
      </div>
    </section>

    <!-- INPUT SUPPLY (JANS) -->
    <section class="card">
      <h2><span class="icon">üö∞</span> Input Bekalan Air (Supply Sedia Ada)</h2>
      <p class="lead">
        Masukkan anggaran kapasiti bekalan air harian yang diterima kampus
        (daripada JANS dan sumber utama lain). Nilai dalam juta liter sehari (MLD).
      </p>

      <label for="supply-mld">Kapasiti bekalan harian sedia ada (MLD)</label>
      <input type="number" id="supply-mld" value="5" min="0" step="0.1" />
      <div class="note">
        Contoh: jika UMS menerima sekitar 4.5‚Äì5.0 MLD daripada loji rawatan.
      </div>
    </section>

    <!-- PARAMETER TARIF & KEWANGAN -->
    <section class="card">
      <h2><span class="icon">üíπ</span> Parameter Tarif & Kewangan</h2>
      <p class="lead">
        Parameter ini digunakan untuk mengira penjimatan bil air & pembetungan
        serta NPV, BCR dan IRR bagi projek sumber air alternatif.
      </p>

      <div class="input-grid">
        <div>
          <label for="tariff-water">Tarif air terawat (RM/m¬≥)</label>
          <input type="number" id="tariff-water" value="1.20" min="0" step="0.01" />
        </div>
        <div>
          <label for="tariff-sewer">Kadar pembetungan (RM/m¬≥)</label>
          <input type="number" id="tariff-sewer" value="0.80" min="0" step="0.01" />
        </div>
        <div>
          <label for="analysis-years">Tempoh analisis kewangan (tahun)</label>
          <input type="number" id="analysis-years" value="20" min="1" step="1" />
        </div>
        <div>
          <label for="discount-rate">Kadar diskaun (% setahun)</label>
          <input type="number" id="discount-rate" value="5" min="0" step="0.1" />
        </div>
      </div>

      <div class="note">
        Kebiasaannya kadar diskaun 3‚Äì7% digunakan untuk projek infrastruktur
        awam, bergantung kepada garis panduan agensi.
      </div>
    </section>

    <!-- ANALISIS EKONOMI & ALAM SEKITAR (INPUT + OUTPUT) -->
    <section class="card">
      <h2><span class="icon">üå±</span> Analisis Ekonomi & Alam Sekitar</h2>
      <p class="lead">
        Analisis ekonomi menggunakan harga bayangan (shadow price) air serta
        mengambil kira manfaat alam sekitar (pengurangan CO‚ÇÇ dan NRW).
      </p>

      <div class="input-grid">
        <div>
          <label for="shadow-price">Harga bayangan air (RM/m¬≥)</label>
          <input type="number" id="shadow-price" value="3.50" min="0" step="0.10" />
        </div>
        <div>
          <label for="econ-factor">Faktor pelarasan ekonomi (ECF)</label>
          <input type="number" id="econ-factor" value="1.00" min="0" step="0.05" />
        </div>
        <div>
          <label for="co2-factor">Faktor pelepasan air terawat (kg CO‚ÇÇ/m¬≥)</label>
          <input type="number" id="co2-factor" value="0.50" min="0" step="0.05" />
        </div>
        <div>
          <label for="carbon-price">Harga karbon bayangan (RM/ton CO‚ÇÇ)</label>
          <input type="number" id="carbon-price" value="100" min="0" step="10" />
        </div>
        <div>
          <label for="nrw-current">NRW sedia ada (% bekalan)</label>
          <input type="number" id="nrw-current" value="30" min="0" max="100" />
        </div>
        <div>
          <label for="nrw-reduction">Sasaran pengurangan NRW (%)</label>
          <input type="number" id="nrw-reduction" value="5" min="0" max="100" />
        </div>
      </div>

      <div style="overflow-x:auto; margin-top:0.7rem;">
        <table>
          <tbody>
            <tr>
              <td>Faedah ekonomi tahunan (RM)</td>
              <td id="eco-ann-benefit">‚Äì</td>
            </tr>
            <tr>
              <td>NPV ekonomi (RM)</td>
              <td id="eco-npv">‚Äì</td>
            </tr>
            <tr>
              <td>BCR ekonomi</td>
              <td id="eco-bcr">‚Äì</td>
            </tr>
            <tr>
              <td>CO‚ÇÇ dielakkan (tan/tahun)</td>
              <td id="co2-saved">‚Äì</td>
            </tr>
            <tr>
              <td>Nilai ekonomi karbon (RM/tahun)</td>
              <td id="carbon-value">‚Äì</td>
            </tr>
            <tr>
              <td>NRW dielakkan (m¬≥/tahun)</td>
              <td id="nrw-saved-vol">‚Äì</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- INPUT SUMBER AIR ALTERNATIF -->
    <section class="card">
      <h2><span class="icon">üíß</span> Sumber Air Alternatif (Extra Supply & CBA)</h2>
      <p class="lead">
        Masukkan kapasiti teknikal, faktor penggunaan, CAPEX dan OPEX bagi
        setiap sumber air alternatif. Sumber ini akan menambah bekalan efektif
        dan digunakan dalam analisis kos‚Äìfaedah.
      </p>

      <div style="overflow-x: auto; margin-top: 0.6rem;">
        <table id="alt-input-table">
          <thead>
            <tr>
              <th>Sumber</th>
              <th>Kapasiti (m¬≥/hari)</th>
              <th>Faktor penggunaan (% hari/tahun)</th>
              <th>CAPEX (RM)</th>
              <th>OPEX tetap (RM/tahun)</th>
              <th>OPEX berubah (RM/m¬≥)</th>
              <th>Jangka hayat (tahun)</th>
            </tr>
          </thead>
          <tbody id="alt-body">
            <tr class="alt-row">
              <td><input type="text" class="alt-name" value="Tangkapan air hujan" /></td>
              <td><input type="number" class="alt-capacity" value="300" min="0" /></td>
              <td><input type="number" class="alt-util" value="80" min="0" max="100" /></td>
              <td><input type="number" class="alt-capex" value="1200000" min="0" /></td>
              <td><input type="number" class="alt-opex-fixed" value="60000" min="0" /></td>
              <td><input type="number" class="alt-opex-var" value="0.10" min="0" step="0.01" /></td>
              <td><input type="number" class="alt-life" value="25" min="1" /></td>
            </tr>
            <tr class="alt-row">
              <td><input type="text" class="alt-name" value="Air tasik / tasik kampus" /></td>
              <td><input type="number" class="alt-capacity" value="200" min="0" /></td>
              <td><input type="number" class="alt-util" value="70" min="0" max="100" /></td>
              <td><input type="number" class="alt-capex" value="900000" min="0" /></td>
              <td><input type="number" class="alt-opex-fixed" value="45000" min="0" /></td>
              <td><input type="number" class="alt-opex-var" value="0.15" min="0" step="0.01" /></td>
              <td><input type="number" class="alt-life" value="20" min="1" /></td>
            </tr>
            <tr class="alt-row">
              <td><input type="text" class="alt-name" value="Reuse (greywater / RO)" /></td>
              <td><input type="number" class="alt-capacity" value="250" min="0" /></td>
              <td><input type="number" class="alt-util" value="80" min="0" max="100" /></td>
              <td><input type="number" class="alt-capex" value="1500000" min="0" /></td>
              <td><input type="number" class="alt-opex-fixed" value="90000" min="0" /></td>
              <td><input type="number" class="alt-opex-var" value="0.25" min="0" step="0.01" /></td>
              <td><input type="number" class="alt-life" value="20" min="1" /></td>
            </tr>
            <tr class="alt-row">
              <td><input type="text" class="alt-name" value="Kondensasi penghawa dingin" /></td>
              <td><input type="number" class="alt-capacity" value="50" min="0" /></td>
              <td><input type="number" class="alt-util" value="90" min="0" max="100" /></td>
              <td><input type="number" class="alt-capex" value="200000" min="0" /></td>
              <td><input type="number" class="alt-opex-fixed" value="15000" min="0" /></td>
              <td><input type="number" class="alt-opex-var" value="0.05" min="0" step="0.01" /></td>
              <td><input type="number" class="alt-life" value="15" min="1" /></td>
            </tr>
            <tr class="alt-row">
              <td><input type="text" class="alt-name" placeholder="Sumber tambahan" /></td>
              <td><input type="number" class="alt-capacity" min="0" /></td>
              <td><input type="number" class="alt-util" min="0" max="100" /></td>
              <td><input type="number" class="alt-capex" min="0" /></td>
              <td><input type="number" class="alt-opex-fixed" min="0" /></td>
              <td><input type="number" class="alt-opex-var" min="0" step="0.01" /></td>
              <td><input type="number" class="alt-life" min="1" /></td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="btn-row">
        <button id="add-alt-row-btn" type="button" class="secondary">
          ‚ûï Tambah baris sumber alternatif
        </button>
      </div>
    </section>

    <!-- PHASING SCENARIO -->
    <section class="card">
      <h2><span class="icon">‚è≥</span> Senario Pelaksanaan Berperingkat (Phasing)</h2>
      <p class="lead">
        Tetapkan peratus penggunaan kapasiti penuh mengikut tahun untuk
        analisis IRR dan NPV projek.
      </p>
      <table>
        <thead>
          <tr><th>Tahun</th><th>% kapasiti digunakan</th></tr>
        </thead>
        <tbody>
          <tr><td>Tahun 1</td><td><input type="number" class="phase-input" value="40" min="0" max="100" /></td></tr>
          <tr><td>Tahun 2</td><td><input type="number" class="phase-input" value="60" min="0" max="100" /></td></tr>
          <tr><td>Tahun 3</td><td><input type="number" class="phase-input" value="80" min="0" max="100" /></td></tr>
          <tr><td>Tahun 4</td><td><input type="number" class="phase-input" value="100" min="0" max="100" /></td></tr>
          <tr><td>Tahun 5+</td><td><input type="number" class="phase-input" value="100" min="0" max="100" /></td></tr>
        </tbody>
      </table>
      <div class="note">
        Contoh: projek dimulakan secara berperingkat dengan 40% kapasiti tahun pertama,
        meningkat kepada 100% mulai tahun keempat.
      </div>
    </section>

    <!-- ANALISIS KATEGORI DEMAND -->
    <section class="card">
      <h2><span class="icon">üìä</span> Analisis Permintaan Air Mengikut Kategori</h2>
      <p class="lead">
        Jadual ini menunjukkan permintaan purata dan puncak (peak) bagi setiap
        kategori berdasarkan input yang dimasukkan.
      </p>

      <div style="overflow-x: auto;">
        <table id="results-table">
          <thead>
            <tr>
              <th>Kategori</th>
              <th>Populasi</th>
              <th>Per kapita (L/org/hari)</th>
              <th>Purata (m¬≥/hari)</th>
              <th>Faktor puncak</th>
              <th>Permintaan puncak (m¬≥/hari)</th>
            </tr>
          </thead>
          <tbody id="results-body">
            <!-- JS akan isi -->
          </tbody>
          <tfoot>
            <tr>
              <td>Jumlah</td>
              <td id="total-pop">‚Äì</td>
              <td>‚Äì</td>
              <td id="total-avg-m3">‚Äì</td>
              <td>‚Äì</td>
              <td id="total-peak-m3">‚Äì</td>
            </tr>
            <tr>
              <td>Jumlah dalam MLD</td>
              <td colspan="2"></td>
              <td id="total-avg-mld">‚Äì</td>
              <td></td>
              <td id="total-peak-mld">‚Äì</td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="chip">üîπ Purata = Populasi √ó Per kapita / 1,000</div>
      <div class="chip">üîπ Puncak = Purata √ó Faktor puncak</div>
    </section>

    <!-- DEMAND VS SUPPLY + EXPORT + PDF -->
    <section class="card">
      <h2><span class="icon">‚öñÔ∏è</span> Ringkasan Demand‚ÄìSupply (MLD)</h2>
      <div class="two-column">
        <div>
          <table id="summary-table">
            <thead>
              <tr>
                <th>Item</th>
                <th>Nilai (MLD)</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <tr id="row-avg">
                <td>Jumlah permintaan purata</td>
                <td id="summary-avg-mld">‚Äì</td>
                <td id="status-avg">‚Äì</td>
              </tr>
              <tr id="row-peak">
                <td>Jumlah permintaan puncak</td>
                <td id="summary-peak-mld">‚Äì</td>
                <td id="status-peak">‚Äì</td>
              </tr>
              <tr>
                <td>Bekalan sedia ada (JANS)</td>
                <td id="supply-avg-mld">‚Äì</td>
                <td></td>
              </tr>
              <tr>
                <td>Extra supply (air hujan / reuse / tasik / AC)</td>
                <td id="alt-supply-mld">‚Äì</td>
                <td></td>
              </tr>
              <tr>
                <td><strong>Bekalan efektif (JANS + sumber alternatif)</strong></td>
                <td id="effective-supply-mld">‚Äì</td>
                <td></td>
              </tr>
              <tr>
                <td>Surplus / Defisit purata</td>
                <td id="surplus-avg-mld">‚Äì</td>
                <td></td>
              </tr>
              <tr>
                <td>Surplus / Defisit semasa puncak</td>
                <td id="surplus-peak-mld">‚Äì</td>
                <td></td>
              </tr>
            </tbody>
          </table>

          <div class="btn-row" style="margin-top: 0.8rem;">
            <button id="export-excel-btn" type="button" class="export">
              üì§ Export Excel (.xlsx)
            </button>
            <button id="download-pdf-btn" type="button" class="secondary">
              üìÑ Muat turun laporan PDF (EPU/RMK)
            </button>
          </div>

          <div class="summary-text" id="summary-text">
            Tekan butang <strong>‚ÄúKira permintaan & banding dengan bekalan‚Äù</strong>
            untuk melihat ringkasan analisis termasuk kesan sumber alternatif.
          </div>
        </div>

        <div>
          <canvas id="demand-by-category-chart" height="200"></canvas>
        </div>
      </div>
    </section>

    <!-- PIE CHART DEMAND SHARE -->
    <section class="card">
      <h2><span class="icon">üìà</span> Agihan Permintaan Mengikut Kategori</h2>
      <p class="lead">
        Rajah menunjukkan sumbangan (%) setiap kategori kepada permintaan purata
        keseluruhan kampus.
      </p>
      <canvas id="demand-share-chart" height="200"></canvas>
    </section>

    <!-- ANALISIS CBA SUMBER ALTERNATIF -->
    <section class="card">
      <h2><span class="icon">üíº</span> Analisis Kewangan Sumber Air Alternatif</h2>
      <p class="lead">
        Jadual di bawah merumuskan volum, penjimatan, CAPEX, OPEX, aliran tunai
        bersih, payback period, NPV dan BCR bagi setiap sumber air alternatif.
      </p>

      <div style="overflow-x: auto;">
        <table id="alt-results-table">
          <thead>
            <tr>
              <th>Sumber</th>
              <th>Kapasiti (m¬≥/hari)</th>
              <th>Utilisasi (% hari)</th>
              <th>Vol. tahunan (m¬≥/tahun)</th>
              <th>CAPEX (RM)</th>
              <th>OPEX tahunan (RM/tahun)</th>
              <th>Saving air + pembetungan (RM/tahun)</th>
              <th>CF bersih (RM/tahun)</th>
              <th>Payback (tahun)</th>
              <th>NPV (RM)</th>
              <th>BCR</th>
            </tr>
          </thead>
          <tbody id="alt-results-body">
            <!-- JS akan isi -->
          </tbody>
          <tfoot>
            <tr>
              <td>Jumlah / Agregat</td>
              <td id="alt-total-capacity">‚Äì</td>
              <td>‚Äì</td>
              <td id="alt-total-volume">‚Äì</td>
              <td id="alt-total-capex">‚Äì</td>
              <td id="alt-total-opex">‚Äì</td>
              <td id="alt-total-saving">‚Äì</td>
              <td id="alt-total-netcf">‚Äì</td>
              <td>‚Äì</td>
              <td id="alt-total-npv">‚Äì</td>
              <td id="alt-total-bcr">‚Äì</td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="two-column" style="margin-top: 1rem;">
        <div>
          <h3 style="font-size:0.96rem; margin-top:0;">Ringkasan Kewangan Projek</h3>
          <table id="alt-summary-table">
            <tbody>
              <tr>
                <td>Jumlah CAPEX semua sumber</td>
                <td id="sum-capex">‚Äì</td>
              </tr>
              <tr>
                <td>Jumlah penjimatan air + pembetungan / tahun</td>
                <td id="sum-saving">‚Äì</td>
              </tr>
              <tr>
                <td>Jumlah OPEX / tahun</td>
                <td id="sum-opex">‚Äì</td>
              </tr>
              <tr>
                <td>Aliran tunai bersih tahunan</td>
                <td id="sum-netcf">‚Äì</td>
              </tr>
              <tr>
                <td>NPV projek (semua sumber)</td>
                <td id="sum-npv">‚Äì</td>
              </tr>
              <tr>
                <td>BCR projek (semua sumber)</td>
                <td id="sum-bcr">‚Äì</td>
              </tr>
              <tr>
                <td>IRR projek (semua sumber)</td>
                <td id="sum-irr">‚Äì</td>
              </tr>
            </tbody>
          </table>

          <h3 style="font-size:0.96rem; margin-top:1rem;">Analisis Sensitiviti Tarif Air (¬±20%)</h3>
          <table>
            <thead>
              <tr><th>Senario</th><th>Tarif (RM/m¬≥)</th><th>NPV projek (RM)</th></tr>
            </thead>
            <tbody>
              <tr>
                <td>Rendah (‚àí20%)</td>
                <td id="sens-tariff-low">‚Äì</td>
                <td id="sens-npv-low">‚Äì</td>
              </tr>
              <tr>
                <td>Asas</td>
                <td id="sens-tariff-base">‚Äì</td>
                <td id="sens-npv-base">‚Äì</td>
              </tr>
              <tr>
                <td>Tinggi (+20%)</td>
                <td id="sens-tariff-high">‚Äì</td>
                <td id="sens-npv-high">‚Äì</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div>
          <canvas id="cba-npv-chart" height="200" style="margin-bottom:0.8rem;"></canvas>
          <canvas id="cba-payback-chart" height="200"></canvas>
        </div>
      </div>
    </section>

    <!-- METODOLOGI + DISCLAIMER -->
    <section class="card">
      <h2><span class="icon">üßÆ</span> Nota Metodologi (Ringkas) & Penafian</h2>
      <div class="disclaimer">
        <p><strong>Metodologi ringkas:</strong></p>
        <ul style="margin-top: 0.2rem; padding-left: 1.1rem;">
          <li>
            <strong>Langkah 1 ‚Äì Per kapita:</strong> Untuk setiap kategori demand,
            permintaan purata dikira berdasarkan bilangan pengguna dikali kadar
            penggunaan per kapita (L/org/hari), ditukar kepada m¬≥/hari.
          </li>
          <li>
            <strong>Langkah 2 ‚Äì Permintaan puncak:</strong> Nilai purata
            digandakan dengan faktor puncak (contoh 1.3) bagi menggambarkan hari
            atau masa penggunaan tertinggi.
          </li>
          <li>
            <strong>Langkah 3 ‚Äì Extra supply:</strong> Kapasiti sumber air
            alternatif ditukar kepada bekalan efektif (m¬≥/hari) menggunakan
            faktor penggunaan (% hari/tahun) dan ditambah kepada bekalan JANS.
          </li>
          <li>
            <strong>Langkah 4 ‚Äì Penjimatan & CBA:</strong> Volum air alternatif
            dikalikan dengan tarif air + pembetungan untuk mendapatkan penjimatan
            tahunan, ditolak OPEX untuk mendapatkan aliran tunai bersih.
            NPV, BCR dan IRR dikira menggunakan tempoh analisis dan kadar diskaun
            yang ditetapkan. Analisis ekonomi menggunakan harga bayangan air
            dan manfaat alam sekitar (CO‚ÇÇ & NRW).
          </li>
        </ul>

        <p style="margin-top: 0.7rem;"><strong>Penafian:</strong></p>
        <p>
          Kalkulator ini disediakan untuk tujuan perancangan dan analisis awal
          (planning-level estimate) berdasarkan andaian input pengguna. Nilai
          yang dijana bukanlah rekod rasmi penggunaan atau bekalan air
          Universiti Malaysia Sabah dan tidak menggantikan data meter/bil air
          yang disahkan oleh pihak berkuasa berkaitan. Sebarang keputusan
          kejuruteraan atau pelaburan sebenar hendaklah dirujuk dan disahkan
          dengan data teknikal terperinci serta pihak berkepentingan rasmi.
        </p>
      </div>
    </section>
  </main>

  <footer>
    ¬© 2025 UMS Water Demand‚ÄìSupply & CBA Calculator. All rights reserved.
  </footer>

  <script>
    window.addEventListener("DOMContentLoaded", () => {
      const addRowBtn = document.getElementById("add-row-btn");
      const calcBtn = document.getElementById("calculate-btn");
      const exportBtn = document.getElementById("export-excel-btn");
      const pdfBtn = document.getElementById("download-pdf-btn");
      const categoryBody = document.getElementById("category-body");

      const addAltRowBtn = document.getElementById("add-alt-row-btn");
      const altBody = document.getElementById("alt-body");

      const resultsBody = document.getElementById("results-body");
      const totalPopEl = document.getElementById("total-pop");
      const totalAvgM3El = document.getElementById("total-avg-m3");
      const totalPeakM3El = document.getElementById("total-peak-m3");
      const totalAvgMLDEl = document.getElementById("total-avg-mld");
      const totalPeakMLDEl = document.getElementById("total-peak-mld");

      const supplyInput = document.getElementById("supply-mld");
      const summaryAvgMLDEl = document.getElementById("summary-avg-mld");
      const summaryPeakMLDEl = document.getElementById("summary-peak-mld");
      const supplyAvgMLDEl = document.getElementById("supply-avg-mld");
      const altSupplyMLDEl = document.getElementById("alt-supply-mld");
      const effectiveSupplyMLDEl = document.getElementById("effective-supply-mld");
      const surplusAvgMLDEl = document.getElementById("surplus-avg-mld");
      const surplusPeakMLDEl = document.getElementById("surplus-peak-mld");
      const statusAvgEl = document.getElementById("status-avg");
      const statusPeakEl = document.getElementById("status-peak");
      const summaryTextEl = document.getElementById("summary-text");

      const rowAvg = document.getElementById("row-avg");
      const rowPeak = document.getElementById("row-peak");

      // CBA elements
      const altResultsBody = document.getElementById("alt-results-body");
      const altTotalCapacityEl = document.getElementById("alt-total-capacity");
      const altTotalVolumeEl = document.getElementById("alt-total-volume");
      const altTotalCapexEl = document.getElementById("alt-total-capex");
      const altTotalOpexEl = document.getElementById("alt-total-opex");
      const altTotalSavingEl = document.getElementById("alt-total-saving");
      const altTotalNetCFEl = document.getElementById("alt-total-netcf");
      const altTotalNPVEl = document.getElementById("alt-total-npv");
      const altTotalBCREl = document.getElementById("alt-total-bcr");

      const sumCapexEl = document.getElementById("sum-capex");
      const sumSavingEl = document.getElementById("sum-saving");
      const sumOpexEl = document.getElementById("sum-opex");
      const sumNetCFEl = document.getElementById("sum-netcf");
      const sumNPVEl = document.getElementById("sum-npv");
      const sumBCREl = document.getElementById("sum-bcr");
      const sumIRREl = document.getElementById("sum-irr");

      const tariffWaterInput = document.getElementById("tariff-water");
      const tariffSewerInput = document.getElementById("tariff-sewer");
      const analysisYearsInput = document.getElementById("analysis-years");
      const discountRateInput = document.getElementById("discount-rate");

      const phaseInputs = document.querySelectorAll(".phase-input");

      // Economic & environment elements
      const shadowPriceInput = document.getElementById("shadow-price");
      const econFactorInput = document.getElementById("econ-factor");
      const co2FactorInput = document.getElementById("co2-factor");
      const carbonPriceInput = document.getElementById("carbon-price");
      const nrwCurrentInput = document.getElementById("nrw-current");
      const nrwReductionInput = document.getElementById("nrw-reduction");

      const ecoAnnBenefitEl = document.getElementById("eco-ann-benefit");
      const ecoNPVEl = document.getElementById("eco-npv");
      const ecoBCREl = document.getElementById("eco-bcr");
      const co2SavedEl = document.getElementById("co2-saved");
      const carbonValueEl = document.getElementById("carbon-value");
      const nrwSavedVolEl = document.getElementById("nrw-saved-vol");

      // Sensitivity outputs
      const sensTariffLowEl = document.getElementById("sens-tariff-low");
      const sensTariffBaseEl = document.getElementById("sens-tariff-base");
      const sensTariffHighEl = document.getElementById("sens-tariff-high");
      const sensNPVLowEl = document.getElementById("sens-npv-low");
      const sensNPVBaseEl = document.getElementById("sens-npv-base");
      const sensNPVHighEl = document.getElementById("sens-npv-high");

      const categoryChartCtx = document
        .getElementById("demand-by-category-chart")
        .getContext("2d");
      const shareChartCtx = document
        .getElementById("demand-share-chart")
        .getContext("2d");
      const cbaNPVCtx = document
        .getElementById("cba-npv-chart")
        .getContext("2d");
      const cbaPaybackCtx = document
        .getElementById("cba-payback-chart")
        .getContext("2d");

      let categoryChart = null;
      let shareChart = null;
      let cbaNpvChart = null;
      let cbaPaybackChart = null;

      function formatNumber(num) {
        if (!isFinite(num)) return "‚Äì";
        return num.toLocaleString("ms-MY", { maximumFractionDigits: 2 });
      }

      function createStatusPill(status, isPeak) {
        if (!status) return "";
        const cls =
          status === "Surplus" ? "status-surplus" : "status-deficit";
        const label =
          status === "Surplus"
            ? isPeak
              ? "Surplus (puncak)"
              : "Surplus"
            : isPeak
            ? "Defisit (puncak)"
            : "Defisit";
        return `<span class="status-pill ${cls}">${
          status === "Surplus" ? "‚úîÔ∏è" : "‚ö†Ô∏è"
        } ${label}</span>`;
      }

      function calculateIRR(cashflows, guess = 0.1) {
        let rate = guess;
        for (let i = 0; i < 100; i++) {
          let npv = 0;
          let dnpv = 0;
          for (let t = 0; t < cashflows.length; t++) {
            const cf = cashflows[t];
            const df = Math.pow(1 + rate, t);
            npv += cf / df;
            if (t > 0) {
              dnpv += -t * cf / Math.pow(1 + rate, t + 1);
            }
          }
          if (Math.abs(dnpv) < 1e-10) break;
          const newRate = rate - npv / dnpv;
          if (!isFinite(newRate)) break;
          if (Math.abs(newRate - rate) < 1e-7) {
            rate = newRate;
            break;
          }
          rate = newRate;
        }
        return rate * 100;
      }

      function computeNPV_BCR_generic(annualBenefitFull, annualOpexTotal, capexTotal, analysisYears, phases, r) {
        let npv = -capexTotal;
        let pvB = 0;
        let pvC = capexTotal;

        for (let t = 1; t <= analysisYears; t++) {
          const f = phases.length
            ? (t <= phases.length ? phases[t - 1] : phases[phases.length - 1])
            : 1;
          const benefit = annualBenefitFull * f;
          const opexYear = annualOpexTotal * f;
          const df = Math.pow(1 + r, t);
          pvB += benefit / df;
          pvC += opexYear / df;
          npv += (benefit - opexYear) / df;
        }
        return { npv, bcr: pvC > 0 ? pvB / pvC : NaN, pvB, pvC };
      }

      function buildCFSeries(annualBenefitFull, annualOpexTotal, capexTotal, analysisYears, phases) {
        const cf = [-capexTotal];
        for (let t = 1; t <= analysisYears; t++) {
          const f = phases.length
            ? (t <= phases.length ? phases[t - 1] : phases[phases.length - 1])
            : 1;
          const benefit = annualBenefitFull * f;
          const opexYear = annualOpexTotal * f;
          cf.push(benefit - opexYear);
        }
        return cf;
      }

      function calculate() {
        // 1. Demand by category
        const rows = Array.from(document.querySelectorAll(".category-row"));
        const categoryNames = [];
        const peakDemands = [];
        const avgDemands = [];

        let totalPop = 0;
        let totalAvgM3 = 0;
        let totalPeakM3 = 0;

        resultsBody.innerHTML = "";

        rows.forEach((row) => {
          const nameInput = row.querySelector(".cat-name");
          const popInput = row.querySelector(".cat-pop");
          const perCapInput = row.querySelector(".cat-percap");
          const peakInput = row.querySelector(".cat-peak");

          const name = (nameInput.value || "").trim();
          const pop = parseFloat(popInput.value);
          const perCap = parseFloat(perCapInput.value);
          const peak = parseFloat(peakInput.value);

          if (!name || !isFinite(pop) || pop <= 0 || !isFinite(perCap)) {
            return;
          }

          const avgM3 = (pop * perCap) / 1000;
          const peakM3 = avgM3 * (isFinite(peak) && peak > 0 ? peak : 1);

          totalPop += pop;
          totalAvgM3 += avgM3;
          totalPeakM3 += peakM3;

          categoryNames.push(name);
          avgDemands.push(avgM3);
          peakDemands.push(peakM3);

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${name}</td>
            <td>${formatNumber(pop)}</td>
            <td>${formatNumber(perCap)}</td>
            <td>${formatNumber(avgM3)}</td>
            <td>${isFinite(peak) ? formatNumber(peak) : "‚Äì"}</td>
            <td>${formatNumber(peakM3)}</td>
          `;
          resultsBody.appendChild(tr);
        });

        const totalAvgMLD = totalAvgM3 / 1000;
        const totalPeakMLD = totalPeakM3 / 1000;

        totalPopEl.textContent = totalPop ? formatNumber(totalPop) : "‚Äì";
        totalAvgM3El.textContent = formatNumber(totalAvgM3);
        totalPeakM3El.textContent = formatNumber(totalPeakM3);
        totalAvgMLDEl.textContent = formatNumber(totalAvgMLD);
        totalPeakMLDEl.textContent = formatNumber(totalPeakMLD);

        // 2. Baseline supply (JANS)
        const supplyBaseMLD = parseFloat(supplyInput.value);
        const supplyValid = isFinite(supplyBaseMLD) && supplyBaseMLD >= 0;

        supplyAvgMLDEl.textContent = supplyValid
          ? formatNumber(supplyBaseMLD)
          : "‚Äì";

        // 3. Alternative supply + build altData for CBA
        const altRows = Array.from(document.querySelectorAll(".alt-row"));
        let altAvgM3PerDayTotal = 0;
        const altData = [];

        altRows.forEach((row) => {
          const name = (row.querySelector(".alt-name").value || "").trim();
          const cap = parseFloat(row.querySelector(".alt-capacity").value);
          const util = parseFloat(row.querySelector(".alt-util").value);
          const capex = parseFloat(row.querySelector(".alt-capex").value);
          const opexFixed = parseFloat(
            row.querySelector(".alt-opex-fixed").value
          );
          const opexVar = parseFloat(
            row.querySelector(".alt-opex-var").value
          );
          const lifeYears = parseFloat(row.querySelector(".alt-life").value);

          if (!name || !isFinite(cap) || cap <= 0 || !isFinite(util) || util <= 0) {
            return;
          }

          const avgM3PerDayEff = cap * (util / 100);
          altAvgM3PerDayTotal += avgM3PerDayEff;

          altData.push({
            name,
            capacity: cap,
            utilPercent: util,
            capex: isFinite(capex) ? capex : 0,
            opexFixed: isFinite(opexFixed) ? opexFixed : 0,
            opexVar: isFinite(opexVar) ? opexVar : 0,
            lifeYears: isFinite(lifeYears) ? lifeYears : NaN,
          });
        });

        const altSupplyMLD = altAvgM3PerDayTotal / 1000;
        altSupplyMLDEl.textContent = altData.length
          ? formatNumber(altSupplyMLD)
          : "0.00";

        const effectiveSupplyMLD = (supplyValid ? supplyBaseMLD : 0) + altSupplyMLD;
        effectiveSupplyMLDEl.textContent = effectiveSupplyMLD
          ? formatNumber(effectiveSupplyMLD)
          : "‚Äì";

        // 4. Demand vs effective supply
        summaryAvgMLDEl.textContent = formatNumber(totalAvgMLD);
        summaryPeakMLDEl.textContent = formatNumber(totalPeakMLD);

        let surplusAvg = null;
        let surplusPeak = null;
        let statusAvg = "";
        let statusPeak = "";

        rowAvg.classList.remove("summary-row-surplus", "summary-row-deficit");
        rowPeak.classList.remove("summary-row-surplus", "summary-row-deficit");

        if (effectiveSupplyMLD > 0) {
          surplusAvg = effectiveSupplyMLD - totalAvgMLD;
          surplusPeak = effectiveSupplyMLD - totalPeakMLD;

          surplusAvgMLDEl.textContent = formatNumber(surplusAvg);
          surplusPeakMLDEl.textContent = formatNumber(surplusPeak);

          if (totalAvgMLD > 0) {
            statusAvg = surplusAvg >= 0 ? "Surplus" : "Deficit";
          }
          if (totalPeakMLD > 0) {
            statusPeak = surplusPeak >= 0 ? "Surplus" : "Deficit";
          }

          if (statusAvg === "Surplus") {
            rowAvg.classList.add("summary-row-surplus");
          } else if (statusAvg === "Deficit") {
            rowAvg.classList.add("summary-row-deficit");
          }

          if (statusPeak === "Surplus") {
            rowPeak.classList.add("summary-row-surplus");
          } else if (statusPeak === "Deficit") {
            rowPeak.classList.add("summary-row-deficit");
          }
        } else {
          surplusAvgMLDEl.textContent = "‚Äì";
          surplusPeakMLDEl.textContent = "‚Äì";
        }

        statusAvgEl.innerHTML = createStatusPill(statusAvg, false);
        statusPeakEl.innerHTML = createStatusPill(statusPeak, true);

        // 5. Ringkasan teks
        if (!categoryNames.length) {
          summaryTextEl.innerHTML =
            "Sila masukkan sekurang-kurangnya satu kategori dengan populasi dan kadar per kapita untuk menjana analisis.";
        } else if (!supplyValid && !altData.length) {
          summaryTextEl.innerHTML =
            "Permintaan purata dianggarkan sebanyak <strong>" +
            formatNumber(totalAvgMLD) +
            " MLD</strong>, manakala permintaan puncak sebanyak <strong>" +
            formatNumber(totalPeakMLD) +
            " MLD</strong>. Sila masukkan nilai bekalan JANS dan/atau sumber alternatif untuk menilai surplus atau defisit.";
        } else {
          const baseText = supplyValid
            ? "Bekalan sedia ada (JANS) dianggarkan <strong>" +
              formatNumber(supplyBaseMLD) +
              " MLD</strong>."
            : "Bekalan JANS tidak ditetapkan dengan jelas.";

          const altText = altData.length
            ? " Sumber alternatif menambah kira-kira <strong>" +
              formatNumber(altSupplyMLD) +
              " MLD</strong> kepada bekalan."
            : " Tiada sumber alternatif dimasukkan setakat ini.";

          const effText =
            " Bekalan efektif (JANS + alternatif) dianggarkan <strong>" +
            formatNumber(effectiveSupplyMLD) +
            " MLD</strong>.";

          const avgWord = surplusAvg >= 0 ? "surplus" : "defisit";
          const peakWord = surplusPeak >= 0 ? "surplus" : "defisit";

          summaryTextEl.innerHTML =
            baseText +
            altText +
            effText +
            " Jumlah permintaan purata kampus dianggarkan <strong>" +
            formatNumber(totalAvgMLD) +
            " MLD</strong> (" +
            avgWord +
            " " +
            formatNumber(Math.abs(surplusAvg)) +
            " MLD), manakala permintaan puncak dianggarkan <strong>" +
            formatNumber(totalPeakMLD) +
            " MLD</strong> (" +
            peakWord +
            " " +
            formatNumber(Math.abs(surplusPeak)) +
            " MLD).";
        }

        // 6. Update demand charts
        updateDemandCharts(categoryNames, avgDemands, peakDemands);

        // 7. CBA for alternative sources + Econ & Environment
        calculateAltCBA(altData, altAvgM3PerDayTotal, supplyBaseMLD);
      }

      function updateDemandCharts(labels, avgData, peakData) {
        if (categoryChart) categoryChart.destroy();
        if (shareChart) shareChart.destroy();

        if (!labels.length) return;

        categoryChart = new Chart(categoryChartCtx, {
          type: "bar",
          data: {
            labels,
            datasets: [
              {
                label: "Purata (m¬≥/hari)",
                data: avgData,
                backgroundColor: "rgba(13, 110, 253, 0.7)",
                borderRadius: 6,
              },
              {
                label: "Puncak (m¬≥/hari)",
                data: peakData,
                backgroundColor: "rgba(0, 188, 212, 0.7)",
                borderRadius: 6,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: "top" },
              title: {
                display: true,
                text: "Permintaan Air Mengikut Kategori",
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                title: { display: true, text: "m¬≥/hari" },
              },
            },
          },
        });

        shareChart = new Chart(shareChartCtx, {
          type: "pie",
          data: {
            labels,
            datasets: [
              {
                data: avgData,
                backgroundColor: [
                  "rgba(13, 110, 253, 0.85)",
                  "rgba(0, 188, 212, 0.85)",
                  "rgba(3, 169, 244, 0.85)",
                  "rgba(0, 150, 136, 0.85)",
                  "rgba(63, 81, 181, 0.85)",
                  "rgba(33, 150, 243, 0.85)",
                ],
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: "right" },
              title: {
                display: true,
                text: "Agihan Permintaan Purata Mengikut Kategori",
              },
            },
          },
        });
      }

      function calculateAltCBA(altData, altAvgM3PerDayTotal, supplyBaseMLD) {
        // Clear if no data
        altResultsBody.innerHTML = "";
        if (cbaNpvChart) cbaNpvChart.destroy();
        if (cbaPaybackChart) cbaPaybackChart.destroy();

        const tariffWater = parseFloat(tariffWaterInput.value) || 0;
        const tariffSewer = parseFloat(tariffSewerInput.value) || 0;
        const tariffTotal = tariffWater + tariffSewer;

        const analysisYears = parseInt(analysisYearsInput.value, 10) || 0;
        const discountRate = parseFloat(discountRateInput.value) || 0;
        const r = discountRate / 100;

        const phases = Array.from(phaseInputs).map((inp) => {
          const v = parseFloat(inp.value);
          return isFinite(v) && v >= 0 ? v / 100 : 1;
        });

        // Economic parameters
        const shadowPrice = parseFloat(shadowPriceInput.value) || 0;
        const econFactor = parseFloat(econFactorInput.value) || 1;

        const co2Factor = parseFloat(co2FactorInput.value) || 0;
        const carbonPrice = parseFloat(carbonPriceInput.value) || 0;
        const nrwCurrent = parseFloat(nrwCurrentInput.value) || 0;
        const nrwReduction = parseFloat(nrwReductionInput.value) || 0;

        let totalCap = 0;
        let totalVol = 0;
        let totalCapex = 0;
        let totalOpex = 0;
        let totalSaving = 0;
        let totalNetCF = 0;

        const labels = [];
        const npvData = [];
        const paybackData = [];

        if (!altData.length || analysisYears <= 0) {
          altTotalCapacityEl.textContent = "0.00";
          altTotalVolumeEl.textContent = "0.00";
          altTotalCapexEl.textContent = "0.00";
          altTotalOpexEl.textContent = "0.00";
          altTotalSavingEl.textContent = "0.00";
          altTotalNetCFEl.textContent = "0.00";
          altTotalNPVEl.textContent = "0.00";
          altTotalBCREl.textContent = "‚Äì";

          sumCapexEl.textContent = "0.00";
          sumSavingEl.textContent = "0.00";
          sumOpexEl.textContent = "0.00";
          sumNetCFEl.textContent = "0.00";
          sumNPVEl.textContent = "0.00";
          sumBCREl.textContent = "‚Äì";
          sumIRREl.textContent = "‚Äì";

          ecoAnnBenefitEl.textContent = "0.00";
          ecoNPVEl.textContent = "0.00";
          ecoBCREl.textContent = "‚Äì";
          co2SavedEl.textContent = "0.00";
          carbonValueEl.textContent = "0.00";
          nrwSavedVolEl.textContent = "0.00";

          sensTariffLowEl.textContent = "0.00";
          sensTariffBaseEl.textContent = "0.00";
          sensTariffHighEl.textContent = "0.00";
          sensNPVLowEl.textContent = "0.00";
          sensNPVBaseEl.textContent = "0.00";
          sensNPVHighEl.textContent = "0.00";

          return;
        }

        altData.forEach((s) => {
          const { name, capacity, utilPercent, capex, opexFixed, opexVar, lifeYears } = s;
          const volAnnual = capacity * (utilPercent / 100) * 365;

          const savingAnnual = volAnnual * tariffTotal;
          const opexAnnual = opexFixed + opexVar * volAnnual;
          const netCF = savingAnnual - opexAnnual;

          // Simple payback
          let payback = NaN;
          if (netCF > 0 && capex > 0) {
            payback = capex / netCF;
          }

          // NPV & BCR per sumber (tanpa phasing ‚Äì indicative)
          const horizon = isFinite(lifeYears) && lifeYears > 0
            ? Math.min(analysisYears, Math.round(lifeYears))
            : analysisYears;

          let pvBenefits = 0;
          let pvCosts = capex;

          for (let t = 1; t <= horizon; t++) {
            const df = Math.pow(1 + r, t);
            pvBenefits += savingAnnual / df;
            pvCosts += opexAnnual / df;
          }

          const npv = pvBenefits - pvCosts;
          const bcr = pvCosts > 0 ? pvBenefits / pvCosts : NaN;

          totalCap += capacity;
          totalVol += volAnnual;
          totalCapex += capex;
          totalOpex += opexAnnual;
          totalSaving += savingAnnual;
          totalNetCF += netCF;

          labels.push(name);
          npvData.push(npv);
          paybackData.push(isFinite(payback) ? payback : null);

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${name}</td>
            <td>${formatNumber(capacity)}</td>
            <td>${formatNumber(utilPercent)}</td>
            <td>${formatNumber(volAnnual)}</td>
            <td>${formatNumber(capex)}</td>
            <td>${formatNumber(opexAnnual)}</td>
            <td>${formatNumber(savingAnnual)}</td>
            <td>${formatNumber(netCF)}</td>
            <td>${isFinite(payback) ? formatNumber(payback) : "‚Äì"}</td>
            <td>${formatNumber(npv)}</td>
            <td>${isFinite(bcr) ? formatNumber(bcr) : "‚Äì"}</td>
          `;
          altResultsBody.appendChild(tr);
        });

        altTotalCapacityEl.textContent = formatNumber(totalCap);
        altTotalVolumeEl.textContent = formatNumber(totalVol);
        altTotalCapexEl.textContent = formatNumber(totalCapex);
        altTotalOpexEl.textContent = formatNumber(totalOpex);
        altTotalSavingEl.textContent = formatNumber(totalSaving);
        altTotalNetCFEl.textContent = formatNumber(totalNetCF);

        sumCapexEl.textContent = formatNumber(totalCapex);
        sumSavingEl.textContent = formatNumber(totalSaving);
        sumOpexEl.textContent = formatNumber(totalOpex);
        sumNetCFEl.textContent = formatNumber(totalNetCF);

        // Project-level NPV, BCR, IRR with phasing
        const totalVolAnnual = totalVol; // m¬≥/year
        const annualBenefitFinFull = totalVolAnnual * tariffTotal;

        const baseRes = computeNPV_BCR_generic(
          annualBenefitFinFull,
          totalOpex,
          totalCapex,
          analysisYears,
          phases,
          r
        );

        const npvProject = baseRes.npv;
        const bcrProject = baseRes.bcr;

        altTotalNPVEl.textContent = formatNumber(npvProject);
        altTotalBCREl.textContent = isFinite(bcrProject) ? formatNumber(bcrProject) : "‚Äì";

        sumNPVEl.textContent = formatNumber(npvProject);
        sumBCREl.textContent = isFinite(bcrProject) ? formatNumber(bcrProject) : "‚Äì";

        const cfBase = buildCFSeries(
          annualBenefitFinFull,
          totalOpex,
          totalCapex,
          analysisYears,
          phases
        );
        const irrProj = totalCapex > 0 ? calculateIRR(cfBase) : NaN;
        sumIRREl.textContent = isFinite(irrProj) ? irrProj.toFixed(2) : "‚Äì";

        // Sensitivity (¬±20% tarif)
        const annualBenefitLow = annualBenefitFinFull * 0.8;
        const annualBenefitHigh = annualBenefitFinFull * 1.2;

        const lowRes = computeNPV_BCR_generic(
          annualBenefitLow,
          totalOpex,
          totalCapex,
          analysisYears,
          phases,
          r
        );
        const highRes = computeNPV_BCR_generic(
          annualBenefitHigh,
          totalOpex,
          totalCapex,
          analysisYears,
          phases,
          r
        );

        sensTariffLowEl.textContent = (tariffTotal * 0.8).toFixed(2);
        sensTariffBaseEl.textContent = tariffTotal.toFixed(2);
        sensTariffHighEl.textContent = (tariffTotal * 1.2).toFixed(2);

        sensNPVLowEl.textContent = formatNumber(lowRes.npv);
        sensNPVBaseEl.textContent = formatNumber(npvProject);
        sensNPVHighEl.textContent = formatNumber(highRes.npv);

        // Economic analysis (shadow price)
        const annualBenefitEconFull = totalVolAnnual * shadowPrice * econFactor;
        const econRes = computeNPV_BCR_generic(
          annualBenefitEconFull,
          totalOpex,
          totalCapex,
          analysisYears,
          phases,
          r
        );

        ecoAnnBenefitEl.textContent = formatNumber(annualBenefitEconFull);
        ecoNPVEl.textContent = formatNumber(econRes.npv);
        ecoBCREl.textContent = isFinite(econRes.bcr) ? formatNumber(econRes.bcr) : "‚Äì";

        // Environmental co-benefits
        const co2SavedTon = totalVolAnnual * co2Factor / 1000;
        const carbonValue = co2SavedTon * carbonPrice;
        co2SavedEl.textContent = formatNumber(co2SavedTon);
        carbonValueEl.textContent = formatNumber(carbonValue);

        const supplyBaseMLDVal = isFinite(supplyBaseMLD) ? supplyBaseMLD : 0;
        const nrwSavedVol = supplyBaseMLDVal * 1000 * 365 * (nrwReduction / 100);
        nrwSavedVolEl.textContent = formatNumber(nrwSavedVol);

        // Charts NPV & Payback
        if (labels.length) {
          cbaNpvChart = new Chart(cbaNPVCtx, {
            type: "bar",
            data: {
              labels,
              datasets: [
                {
                  label: "NPV (RM)",
                  data: npvData,
                  backgroundColor: "rgba(3, 169, 244, 0.8)",
                  borderRadius: 6,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: { display: false },
                title: { display: true, text: "NPV Mengikut Sumber Air Alternatif" },
              },
              scales: {
                y: { beginAtZero: false, title: { display: true, text: "RM" } },
              },
            },
          });

          cbaPaybackChart = new Chart(cbaPaybackCtx, {
            type: "bar",
            data: {
              labels,
              datasets: [
                {
                  label: "Payback (tahun)",
                  data: paybackData,
                  backgroundColor: "rgba(255, 193, 7, 0.9)",
                  borderRadius: 6,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: { display: false },
                title: { display: true, text: "Payback Period Mengikut Sumber" },
              },
              scales: {
                y: {
                  beginAtZero: true,
                  title: { display: true, text: "Tahun" },
                },
              },
            },
          });
        }
      }

      // Add rows for demand categories
      addRowBtn.addEventListener("click", () => {
        const tr = document.createElement("tr");
        tr.className = "category-row";
        tr.innerHTML = `
          <td><input type="text" class="cat-name" placeholder="Nama kategori" /></td>
          <td><input type="number" class="cat-pop" min="0" /></td>
          <td><input type="number" class="cat-percap" min="0" /></td>
          <td><input type="number" class="cat-peak" value="1.3" min="1" step="0.05" /></td>
        `;
        categoryBody.appendChild(tr);
      });

      // Add rows for alternative sources
      addAltRowBtn.addEventListener("click", () => {
        const tr = document.createElement("tr");
        tr.className = "alt-row";
        tr.innerHTML = `
          <td><input type="text" class="alt-name" placeholder="Nama sumber" /></td>
          <td><input type="number" class="alt-capacity" min="0" /></td>
          <td><input type="number" class="alt-util" min="0" max="100" /></td>
          <td><input type="number" class="alt-capex" min="0" /></td>
          <td><input type="number" class="alt-opex-fixed" min="0" /></td>
          <td><input type="number" class="alt-opex-var" min="0" step="0.01" /></td>
          <td><input type="number" class="alt-life" min="1" /></td>
        `;
        altBody.appendChild(tr);
      });

      calcBtn.addEventListener("click", calculate);

      // Export Excel
      exportBtn.addEventListener("click", () => {
        try {
          if (typeof XLSX === "undefined") {
            alert("Library Excel (SheetJS) tidak dimuatkan.");
            return;
          }

          // Ensure latest calculations
          calculate();

          const wb = XLSX.utils.book_new();

          // Sheet 1: Kategori demand
          const catRows = [["Kategori", "Populasi", "Per kapita (L/org/hari)", "Purata (m¬≥/hari)", "Faktor puncak", "Permintaan puncak (m¬≥/hari)"]];
          document.querySelectorAll("#results-body tr").forEach((tr) => {
            const cells = Array.from(tr.querySelectorAll("td")).map((td) =>
              td.textContent.trim()
            );
            if (cells.length) catRows.push(cells);
          });
          const totalsRow1 = [
            "Jumlah",
            document.getElementById("total-pop").textContent,
            "",
            document.getElementById("total-avg-m3").textContent,
            "",
            document.getElementById("total-peak-m3").textContent,
          ];
          const totalsRow2 = [
            "Jumlah dalam MLD",
            "",
            "",
            document.getElementById("total-avg-mld").textContent,
            "",
            document.getElementById("total-peak-mld").textContent,
          ];
          catRows.push(totalsRow1, totalsRow2);
          const wsCat = XLSX.utils.aoa_to_sheet(catRows);
          XLSX.utils.book_append_sheet(wb, wsCat, "Kategori");

          // Sheet 2: Ringkasan demand‚Äìsupply
          const summaryRows = [
            ["Item", "Nilai (MLD)"],
            ["Jumlah permintaan purata", document.getElementById("summary-avg-mld").textContent],
            ["Jumlah permintaan puncak", document.getElementById("summary-peak-mld").textContent],
            ["Bekalan sedia ada (JANS)", document.getElementById("supply-avg-mld").textContent],
            ["Extra supply (alt sources)", document.getElementById("alt-supply-mld").textContent],
            ["Bekalan efektif", document.getElementById("effective-supply-mld").textContent],
            ["Surplus / Defisit purata", document.getElementById("surplus-avg-mld").textContent],
            ["Surplus / Defisit puncak", document.getElementById("surplus-peak-mld").textContent],
          ];
          const wsSum = XLSX.utils.aoa_to_sheet(summaryRows);
          XLSX.utils.book_append_sheet(wb, wsSum, "Ringkasan");

          // Sheet 3: CBA alternatif
          const cbaRows = [[
            "Sumber",
            "Kapasiti (m¬≥/hari)",
            "Utilisasi (% hari)",
            "Vol. tahunan (m¬≥/tahun)",
            "CAPEX (RM)",
            "OPEX tahunan (RM/tahun)",
            "Saving air + pembetungan (RM/tahun)",
            "CF bersih (RM/tahun)",
            "Payback (tahun)",
            "NPV (RM)",
            "BCR"
          ]];
          document.querySelectorAll("#alt-results-body tr").forEach((tr) => {
            const cells = Array.from(tr.querySelectorAll("td")).map((td) =>
              td.textContent.trim()
            );
            if (cells.length) cbaRows.push(cells);
          });
          const cbaTotalsRow = [
            "Jumlah / Agregat",
            document.getElementById("alt-total-capacity").textContent,
            "",
            document.getElementById("alt-total-volume").textContent,
            document.getElementById("alt-total-capex").textContent,
            document.getElementById("alt-total-opex").textContent,
            document.getElementById("alt-total-saving").textContent,
            document.getElementById("alt-total-netcf").textContent,
            "",
            document.getElementById("alt-total-npv").textContent,
            document.getElementById("alt-total-bcr").textContent,
          ];
          cbaRows.push(cbaTotalsRow);
          const wsCBA = XLSX.utils.aoa_to_sheet(cbaRows);
          XLSX.utils.book_append_sheet(wb, wsCBA, "CBA_Alt_Sources");

          XLSX.writeFile(wb, "UMS_Water_Demand_Supply_CBA.xlsx");
        } catch (e) {
          console.error(e);
          alert("Ralat semasa export Excel. Sila cuba lagi.");
        }
      });

      // PDF Report (EPU/RMK-style, ringkas)
      pdfBtn.addEventListener("click", () => {
        try {
          if (!window.jspdf) {
            alert("Library PDF tidak dimuatkan.");
            return;
          }
          // Pastikan nilai terkini
          calculate();

          const { jsPDF } = window.jspdf;
          const doc = new jsPDF("p","mm","a4");

          doc.setFontSize(14);
          doc.text("Analisis Permintaan, Penawaran & Kos‚ÄìFaedah Air UMS",105,15,{align:"center"});
          doc.setFontSize(10);
          doc.text("1. Ringkasan Demand‚ÄìSupply",14,25);

          doc.autoTable({
            startY: 29,
            head: [["Item","Nilai"]],
            body: [
              ["Permintaan purata (MLD)", document.getElementById("total-avg-mld").textContent],
              ["Permintaan puncak (MLD)", document.getElementById("total-peak-mld").textContent],
              ["Bekalan JANS (MLD)", document.getElementById("supply-avg-mld").textContent],
              ["Extra supply (MLD)", document.getElementById("alt-supply-mld").textContent],
              ["Bekalan efektif (MLD)", document.getElementById("effective-supply-mld").textContent],
              ["Surplus/Defisit purata (MLD)", document.getElementById("surplus-avg-mld").textContent],
              ["Surplus/Defisit puncak (MLD)", document.getElementById("surplus-peak-mld").textContent],
            ]
          });

          let y = doc.lastAutoTable.finalY + 8;
          doc.text("2. Ringkasan Kewangan Projek",14,y);
          doc.autoTable({
            startY: y + 4,
            head: [["Indikator","Nilai"]],
            body: [
              ["Jumlah CAPEX (RM)", sumCapexEl.textContent],
              ["Jumlah penjimatan tahunan (RM)", sumSavingEl.textContent],
              ["Jumlah OPEX tahunan (RM)", sumOpexEl.textContent],
              ["Aliran tunai bersih tahunan (RM)", sumNetCFEl.textContent],
              ["NPV kewangan (RM)", sumNPVEl.textContent],
              ["BCR kewangan", sumBCREl.textContent],
              ["IRR (%)", sumIRREl.textContent]
            ]
          });

          y = doc.lastAutoTable.finalY + 8;
          doc.text("3. Analisis Ekonomi & Alam Sekitar",14,y);
          doc.autoTable({
            startY: y + 4,
            head: [["Indikator","Nilai"]],
            body: [
              ["Faedah ekonomi tahunan (RM)", ecoAnnBenefitEl.textContent],
              ["NPV ekonomi (RM)", ecoNPVEl.textContent],
              ["BCR ekonomi", ecoBCREl.textContent],
              ["CO‚ÇÇ dielakkan (tan/tahun)", co2SavedEl.textContent],
              ["Nilai ekonomi karbon (RM/tahun)", carbonValueEl.textContent],
              ["NRW dielakkan (m¬≥/tahun)", nrwSavedVolEl.textContent]
            ]
          });

          y = doc.lastAutoTable.finalY + 8;
          doc.text("4. Penafian",14,y);
          doc.text(
            "Analisis ini merupakan anggaran awal (planning-level estimate) dan tertakluk kepada semakan teknikal dan kewangan terperinci oleh pihak berkuasa berkaitan.",
            14,
            y + 6,
            { maxWidth: 180 }
          );

          doc.save("UMS_Water_Demand_Supply_CBA_Report.pdf");
        } catch (e) {
          console.error(e);
          alert("Ralat semasa menjana PDF. Sila cuba lagi.");
        }
      });

      // Kiraan awal dengan nilai contoh
      calculate();
    });
  </script>
</body>
</html>
